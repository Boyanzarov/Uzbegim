<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>O'zbegim MFY</title>
  
  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="O'zbegim">
  <meta name="application-name" content="O'zbegim MFY">
  <meta name="theme-color" content="#7c3aed">
  <meta name="msapplication-TileColor" content="#7c3aed">
  <meta name="description" content="Mahalla fuqarolar yig'ini - Aholi va Tadbirkorlik ro'yxatga olish tizimi">
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèòÔ∏è</text></svg>">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- SIGNATURE PAD LIBRARY -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap');
    :root{--bg-color:#f7f6ff;--surface-color:#fff;--primary-color:#7c3aed;--primary-light:#a78bfa;--primary-glow:rgba(124,58,237,.15);--success-color:#10b981;--danger-color:#ef4444;--secondary-color:#64748b;--warning-color:#f59e0b;--warning-glow:rgba(245,158,11,.2);--text-dark:#0f172a;--text-light:#475569;--border-color:rgba(226,232,240,1);--radius-md:12px;--radius-lg:16px;--shadow-sm:0 4px 6px -1px rgba(0,0,0,.05),0 2px 4px -2px rgba(0,0,0,.05);--shadow-md:0 10px 15px -3px rgba(0,0,0,.07),0 4px 6px -4px rgba(0,0,0,.07);--transition-fast:.2s ease;--transition-slow:.4s cubic-bezier(.25,1,.5,1)}
    /* Dark Mode - Eye Comfort (ko'zni charchatmaydigan) */
    [data-theme=dark]{--bg-color:#0f0f1a;--surface-color:#1a1a2e;--primary-color:#9d7cf6;--primary-light:#b8a4fa;--primary-glow:rgba(157,124,246,.2);--text-dark:#e8e6f0;--text-light:#a8a5b8;--border-color:rgba(80,75,100,.5);--warning-color:#fcd34d;--warning-glow:rgba(252,211,77,.2);--success-color:#34d399;--danger-color:#f87171;--secondary-color:#94a3b8}
    *{box-sizing:border-box;margin:0;padding:0}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:var(--bg-color);color:var(--text-dark);-webkit-font-smoothing:antialiased;transition:background-color var(--transition-fast);-webkit-tap-highlight-color:transparent}.hidden{display:none!important}.permission-hidden{display:none!important}.app-shell{max-width:1000px;margin:2rem auto;padding:1rem;display:none}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding:0 .5rem}.header h1{display:flex;align-items:center;gap:.8rem;font-size:1.8rem;font-weight:700;color:var(--text-dark);cursor:pointer}.header h1 i{color:var(--primary-color)}.header-actions{display:flex;gap:.5rem}.header-btn{width:45px;height:45px;border-radius:50%;background:var(--surface-color);border:1px solid var(--border-color);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all var(--transition-fast)}.header-btn:hover{border-color:var(--primary-color);transform:translateY(-2px)}#notification-bell-container{position:relative;}#notification-count{position:absolute;top:-5px;right:-8px;background-color:var(--danger-color);color:white;border-radius:50%;width:22px;height:22px;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;border:2px solid var(--surface-color);}.card{background:var(--surface-color);padding:2rem;border-radius:var(--radius-lg);border:1px solid var(--border-color);margin-bottom:2rem;box-shadow:var(--shadow-md)}.view{display:none}.view.active{display:block;animation:slideUpFadeIn .5s cubic-bezier(.16,1,.3,1) forwards}@keyframes slideUpFadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.search-options{display:flex;flex-wrap:wrap;border-radius:16px;margin-bottom:1.5rem;overflow:hidden;background:linear-gradient(135deg,rgba(124,58,237,0.05),rgba(6,182,212,0.05));padding:0.35rem;border:1px solid rgba(124,58,237,0.1)}.search-option-btn{flex:1;min-width:80px;padding:.85rem;border:none;background:transparent;cursor:pointer;font-size:.9rem;font-weight:600;color:var(--text-light);transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);border-radius:12px;display:flex;align-items:center;justify-content:center;gap:.5rem}.search-option-btn:hover{color:var(--primary-color);background:rgba(124,58,237,0.08)}.search-option-btn.active{background:linear-gradient(135deg,var(--primary-color),#8b5cf6);color:white;box-shadow:0 4px 15px rgba(124,58,237,0.3)}.search-option-btn.active i{color:white}.search-panel{display:none;animation:fadeSlideUp 0.3s ease}.search-panel.active{display:block}@keyframes fadeSlideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}input,select,textarea{width:100%;padding:.9rem;font-size:1rem;border:1px solid var(--border-color);border-radius:12px;background:var(--bg-color);color:var(--text-dark);transition:all var(--transition-fast)}input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 4px var(--primary-glow);background:var(--surface-color)}label{margin-bottom:.5rem;display:block;font-weight:500;color:var(--text-light)}.btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:.9rem 1.25rem;font-size:1rem;font-weight:600;cursor:pointer;text-align:center;border-radius:12px;border:none;color:#fff;transition:all var(--transition-fast);margin-top:1rem;position:relative;overflow:hidden}.btn i{margin-right:.5rem}.btn:disabled{opacity:.6;cursor:not-allowed}.btn:hover:not(:disabled){transform:translateY(-3px);box-shadow:var(--shadow-md)}.btn-primary{background:linear-gradient(90deg,#6d28d9,#8b5cf6);box-shadow:0 4px 20px -5px var(--primary-glow)}.btn-success{background:linear-gradient(90deg,#10b981,#34d399);box-shadow:0 4px 20px -5px rgba(16,185,129,.5)}.btn-secondary{background:transparent;color:var(--secondary-color);font-weight:600;border:2px solid var(--border-color);}.btn-secondary:hover{border-color:var(--secondary-color);background:rgba(100,116,139,.05)}.btn-secondary-outline {background:transparent;color:var(--text-light);font-weight:600;border:2px solid var(--border-color);}.btn-secondary-outline:hover {border-color:var(--primary-light);color:var(--primary-color);background:var(--primary-glow);}.btn-cancel{background:transparent;color:var(--danger-color);font-weight:700;border:2px solid var(--danger-color)}.btn-cancel:hover{background:var(--danger-color);color:#fff}
    .fab-container{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);z-index:2000;display:flex;flex-direction:row;align-items:center;justify-content:center;gap:0.75rem;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);padding:0.75rem 1.25rem;border-radius:35px;border:1px solid rgba(255,255,255,0.2);box-shadow:0 8px 32px rgba(0,0,0,0.15)}
    .fab{width:52px;height:52px;border-radius:50%;color:#fff;border:none;box-shadow:0 4px 15px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;font-size:1.4rem;cursor:pointer;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);position:relative;overflow:hidden}
    .fab::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(255,255,255,0.2),transparent);opacity:0;transition:opacity 0.3s}
    .fab:hover::before{opacity:1}
    .fab-add{background:linear-gradient(135deg,#7c3aed,#a78bfa);width:60px;height:60px;font-size:1.6rem}
    .fab-add:hover{transform:scale(1.15) rotate(90deg);box-shadow:0 8px 25px rgba(124,58,237,0.5)}
    .fab-summary{background:linear-gradient(135deg,#64748b,#94a3b8)}
    .fab-summary:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(100,116,139,0.4)}
    .fab-list{background:linear-gradient(135deg,#0d9488,#14b8a6)}
    .fab-list:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(13,148,136,0.4)}
    .fab-objects {background:linear-gradient(135deg,#f59e0b,#fbbf24)}
    .fab-objects:hover {transform:scale(1.1);box-shadow:0 6px 20px rgba(245,158,11,0.4)}
    .fab-ai{background:linear-gradient(135deg,#ec4899,#f472b6)}
    .fab-ai:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(236,72,153,0.4)}
    .fab-analytics{background:linear-gradient(135deg,#3b82f6,#60a5fa)}
    .fab-analytics:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(59,130,246,0.4)}
    .result-card{display:flex;gap:1.5rem;align-items:flex-start;background:var(--surface-color);padding:1.5rem;border:1px solid var(--border-color);border-radius:var(--radius-lg);margin-bottom:1.5rem;box-shadow:var(--shadow-sm);transition:all var(--transition-fast);position:relative}
    .result-card.archived { opacity: 0.6; background: var(--bg-color); }
    .result-card.archived .result-header h3 { text-decoration: line-through; }
    .result-card-avatar { flex-shrink: 0; }
    .result-card-avatar img, .avatar-placeholder-sm { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-glow); cursor: pointer; }
    .avatar-placeholder-sm { display:flex; align-items:center; justify-content:center; background: var(--bg-color); font-size: 2.5rem; color: var(--border-color); }
    .result-card-content { flex-grow: 1; }
    .result-card.incomplete-data { border-left: 4px solid var(--warning-color); background: var(--warning-glow); }
    .incomplete-warning { display: flex; align-items: center; gap: .5rem; background-color: var(--warning-glow); color: var(--warning-color); font-weight: 500; font-size: 0.85rem; padding: 0.5rem 0.75rem; border-radius: 8px; margin-bottom: 1rem; }
    .result-card.main-person-card {border-left: 4px solid var(--primary-color);}.result-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}.result-header h3{margin:0;font-size:1.25rem;color:var(--primary-color);font-weight:600;}.result-header .badge{background:var(--primary-glow);color:var(--primary-color);padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600}.result-header .badge.archived-badge { background: var(--secondary-color); color: #fff; }.result-table{width:100%;border-collapse:collapse;font-size:.95rem}.result-table td{padding:.75rem .25rem;border-bottom:1px solid var(--border-color)}.result-table tr:last-child td{border-bottom:none}.result-table td:first-child{font-weight:500;color:var(--text-light);width:40%;vertical-align:top}.result-table td:last-child{font-weight:600;color:var(--text-dark)}#address-family-suggestions { margin-top: 1rem; padding: 1.5rem; background-color: var(--bg-color); border-radius: var(--radius-lg); display: none; }#address-family-suggestions h6 { margin-bottom: 1rem; color: var(--text-dark); font-weight: 500; font-size: 0.9rem; opacity: 0.8; }.suggestion-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 1rem; }.suggestion-item:last-child { border-bottom: none; padding-bottom: 0;}.suggestion-item .btn { margin-top: 0; padding: 0.6rem 1.2rem; font-size: 0.9rem; flex-shrink: 0; width: 100%;}@media(min-width: 600px){ .suggestion-item .btn { width: auto; } }.suggestion-item-info { display: flex; flex-direction: column; }.suggestion-item-info span { font-weight: 600; color: var(--text-dark); }.suggestion-item-info small { color: var(--text-light); font-size: 0.9rem; }.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;margin-top:1rem}.summary-stat-card{background:var(--surface-color);border:1px solid var(--border-color);border-radius:12px;padding:1.25rem 1rem;text-align:center;transition:all var(--transition-fast);cursor:pointer}.summary-stat-card .icon{font-size:2rem;color:var(--primary-color);margin-bottom:.75rem}.summary-stat-card .number{font-size:2rem;font-weight:700;color:var(--text-dark)}.summary-stat-card .label{font-size:.9rem;font-weight:500;color:var(--text-light);margin-top:.25rem}.summary-stat-card:hover{transform:translateY(-5px);box-shadow:var(--shadow-sm)}.summary-stat-card[data-category="shubhali"] .icon { color: var(--danger-color); }.summary-stat-card[data-category="problem"] .icon { color: var(--warning-color); }.summary-stat-card[data-category="toifadagilar"] .icon { color: #8b5cf6; }.summary-stat-card.restricted { opacity: 0.6; cursor: not-allowed; }.modal-overlay{position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.4);backdrop-filter:blur(8px);display:none;justify-content:center;align-items:center;animation:fadeIn .3s}.modal-box{background:var(--surface-color);border:1px solid var(--border-color);padding:2rem;border-radius:16px;width:90%;max-width:900px;text-align:left;animation:zoomIn .25s;box-shadow:var(--shadow-md);position:relative;max-height:90vh;overflow-y:auto}
    #summary-modal .modal-box { padding: 1rem; display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto !important; }
    #summary-modal #summary-content-wrapper { overflow-y: visible !important; }
    #summary-modal #summary-grid-container { overflow-y: visible !important; }
    #family-modal .modal-box { max-width: 95%; width: 1000px; }
    #family-modal-content { max-height: 70vh; overflow-y: auto; padding-right: 1rem; margin-top: 1.5rem; }
    #family-modal-content .result-card { background-color: var(--bg-color); box-shadow: none; border-color: var(--primary-glow); }
    .modal-close-btn{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;color:var(--text-light);cursor:pointer;transition:all var(--transition-fast)}.modal-close-btn:hover{color:var(--danger-color);transform:rotate(90deg)}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes zoomIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}.form-row{display:grid;grid-template-columns:1fr;gap:1rem 1.5rem}@media(min-width:600px){.form-row{grid-template-columns:1fr 1fr}}.full-width{grid-column:1 / -1}.form-group{position:relative;margin-top:1rem}.conditional-field{display:none}.passport-inputs,.metrka-inputs{display:flex;gap:.5rem}.passport-inputs input:first-child{text-transform:uppercase;flex-basis:80px;flex-grow:0}.form-progress{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:2.5rem;position:relative}.form-progress-bar{position:absolute;top:12px;left:16.66%;height:2px;width:0;background:var(--primary-color);transform:translateY(0);transition:width var(--transition-slow);z-index:2}.form-progress::after{content:'';position:absolute;top:12px;left:16.66%;right:16.66%;height:2px;background:var(--border-color);z-index:1}.progress-step{display:flex;flex-direction:column;align-items:center;width:33.33%;position:relative;z-index:3;color:var(--text-light);font-weight:500;font-size:.9rem;text-align:center}.progress-step::before{content:'';display:block;width:24px;height:24px;border-radius:50%;background-color:var(--surface-color);border:2px solid var(--border-color);margin-bottom:.5rem;transition:all var(--transition-fast)}.progress-step.active{color:var(--primary-color);font-weight:600}.progress-step.active::before{background-color:var(--primary-color);border-color:var(--primary-color);content:'‚úì';color:#fff;display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:700;line-height:1}.form-step{display:none; animation: slideUpFadeIn 0.5s ease-in-out;}.form-step.active{display:block}.app-footer{text-align:center;margin-top:3rem;padding:1.5rem;color:var(--text-light);font-size:.9rem;border-top:1px solid var(--border-color)}.app-footer span{font-weight:600;background:-webkit-linear-gradient(45deg,var(--primary-color),#2dd4bf);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.loader-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.4);backdrop-filter:blur(5px);display:none;justify-content:center;align-items:center;z-index:9999}.loader{width:50px;height:50px;border:5px solid var(--border-color);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
    .context-highlight{padding: .6rem .8rem; margin-bottom: 1rem; border-radius: var(--radius-md); font-weight: 600;}.context-highlight.problem{background-color: var(--warning-glow); color: var(--warning-color); border-left: 4px solid var(--warning-color);}.context-highlight.toifadagilar{background-color: var(--primary-glow); color: var(--primary-color); border-left: 4px solid var(--primary-color);}.context-highlight .label{font-weight: 500; opacity: .8; margin-right: .5rem;}
    #toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 12px 24px; border-radius: 8px; box-shadow: var(--shadow-md); z-index: 10001; font-weight: 600; font-size: 0.95rem; transition: bottom 0.5s ease-in-out; display: flex; align-items: center; gap: 10px; }
    #toast-notification.show { bottom: 20px; }
    #pdf-render-container { display: none; }
    #details-modal-box, #object-details-modal .modal-box, #staff-details-modal .modal-box { background: #1a1a27; color: #f1f5f9; border: 1px solid rgba(51, 65, 85, .6); max-width: 800px; }
    #details-content .profile-header, #object-details-content .profile-header, #staff-details-content .profile-header { text-align: center; margin-bottom: 1.5rem; }
    #details-content .profile-pic, #object-details-content .profile-pic, #staff-details-content .profile-pic { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary-color); box-shadow: 0 0 20px rgba(139,92,246, .5); margin: 0 auto 1rem auto; display: block; cursor: pointer; }
    #details-content .profile-name, #object-details-content .profile-name, #staff-details-content .profile-name { font-size: 1.75rem; font-weight: bold; color: #fff; padding-bottom: 1rem; border-bottom: 1px solid rgba(51, 65, 85, .6); }
    #details-content .section-title, #object-details-content .section-title, #staff-details-content .section-title { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: .5rem; border-bottom: 1px solid rgba(51, 65, 85, .6); }
    #details-content .data-grid, #object-details-content .data-grid, #staff-details-content .data-grid { display: grid; grid-template-columns: 1fr; gap: .5rem; }
    @media(min-width: 600px) { #details-content .data-grid, #object-details-content .data-grid, #staff-details-content .data-grid { grid-template-columns: 1fr 1fr; } }
    #details-content .data-item, #object-details-content .data-item, #staff-details-content .data-item { display: flex; justify-content: space-between; align-items: center; padding: .6rem; border-radius: 8px; transition: background-color .2s; }
    #details-content .data-item:hover, #object-details-content .data-item:hover, #staff-details-content .data-item:hover { background-color: rgba(255,255,255, .05); }
    #details-content .data-label, #object-details-content .data-label, #staff-details-content .data-label { color: #94a3b8; font-size: .9rem; }
    #details-content .data-value, #object-details-content .data-value, #staff-details-content .data-value { font-weight: 600; color: #ffffff; font-family: 'Fira Code', monospace; }
    #details-content .muammo-box { margin-top: 1.5rem; padding: 1rem; background: rgba(239, 68, 68, .1); border-left: 4px solid #ef4444; border-radius: 8px; }
    #details-content .muammo-box .muammo-title { color: #ef4444; font-weight: bold; margin-bottom: .5rem; display: block; }
    .solved-problem-box { margin-top: 1.5rem; padding: 1rem; background: rgba(16, 185, 129, .1); border-left: 4px solid #10b981; border-radius: 8px; }
    .solved-problem-box .solved-title { color: #10b981; font-weight: bold; margin-bottom: .5rem; display: block; }
    #pdf-render-container { display: none; }
    #toifa-checkboxes-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: .5rem; }
    #toifa-checkboxes-container label { display: flex; align-items: center; gap: .5rem; background-color: var(--bg-color); padding: .75rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); cursor: pointer; }
    #toifa-checkboxes-container input[type="checkbox"] { width: auto; }
    #camera-modal .modal-box { max-width: 640px; }
    #camera-feed, #photo-preview { width: 100%; border-radius: var(--radius-md); background: #000; }
    #photo-preview { display: none; }
    #camera-controls { display: flex; gap: 1rem; justify-content: center; margin-top: 1rem; flex-wrap: wrap;}
    .photo-preview-container { margin-top: 1rem; text-align: center;}
    #form-photo-preview, #staff-photo-preview { max-width: 100px; max-height: 100px; border-radius: 50%; border: 2px solid var(--primary-color); margin: 0 auto; display: none; }
    #image-viewer-modal .modal-box { display: flex; flex-direction: column; max-width: 90vw; max-height: 90vh; padding: 1rem; background: #12122c; }
    #image-viewer-modal img { max-width: 100%; max-height: 80vh; display: block; margin: auto; border-radius: var(--radius-md); }
    #details-content .meetings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    #details-content .meeting-btn { background: rgba(255,255,255, .05); border: 1px solid rgba(51, 65, 85, .6); padding: .75rem 1rem; border-radius: var(--radius-md); text-align: center; cursor: pointer; transition: all .2s ease; }
    #details-content .meeting-btn:hover { background: rgba(139, 92, 246, .2); border-color: var(--primary-color); }
    #details-content .meeting-btn .date { font-weight: 600; color: #fff; display: block; }
    #details-content .meeting-btn .type { font-size: 0.85rem; color: #94a3b8; }
    .hacker-modal-box { background: rgba(26, 26, 39, 0.9); color: #e0e0e0; border: 1px solid rgba(0, 255, 255, 0.4); box-shadow: 0 0 25px rgba(0, 255, 255, 0.3), inset 0 0 10px rgba(0, 255, 255, 0.2); max-width: 700px; font-family: 'Fira Code', monospace; }
    .hacker-modal-box .modal-close-btn { color: rgba(0, 255, 255, 0.7); }
    .hacker-modal-box .modal-close-btn:hover { color: #ff4d4d; }
    .hacker-modal-header { font-size: 1.5rem; color: #00ffff; text-shadow: 0 0 5px #00ffff; border-bottom: 1px solid rgba(0, 255, 255, 0.4); padding-bottom: 1rem; margin-bottom: 1.5rem; text-align: center; }
    .notification-list { list-style: none; padding: 0; max-height: 60vh; overflow-y: auto; }
    .notification-item { background: rgba(0, 255, 255, 0.05); border-left: 4px solid #00ffff; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; transition: background .3s; }
    .notification-item:hover { background: rgba(0, 255, 255, 0.1); }
    .notification-item.type-problem { border-left-color: #facc15; }
    .notification-item.type-problem:hover { background: rgba(250, 204, 21, 0.1); }
    .notification-item.type-overdue { border-left-color: var(--danger-color); }
    .notification-item.type-overdue:hover { background: rgba(239, 68, 68, 0.1); }
    .notification-title { font-weight: bold; font-size: 1.1rem; margin-bottom: .5rem; }
    .notification-title .fio { color: #ffffff; }
    .notification-title .type { color: #00ffff; }
    .notification-item.type-problem .notification-title .type { color: #facc15; }
    .notification-item.type-overdue .notification-title .type { color: var(--danger-color); }
    .notification-details { font-size: 0.9rem; margin-bottom: 1rem; }
    .notification-details .detail-item { display: flex; align-items: center; gap: .75rem; margin-bottom: .5rem; color: #c0c0c0; }
    .notification-details .detail-item i { width: 15px; text-align: center; color: var(--primary-color); opacity: .8; }
    .notification-details .detail-item.problem-text { color: #a0a0a0; margin-top: .75rem; line-height: 1.4; }
    .notification-details .detail-item:last-child { margin-bottom: 0; }
    .notification-actions .btn { margin-top: 0; font-family: 'Inter', sans-serif; }
    .header h1 { gap: 1rem; }
    .header-logo-svg { color: var(--primary-color); flex-shrink: 0; }
    .header-title-wrapper { display: flex; flex-direction: column; line-height: 1.2; }
    .header-main-title { font-size: 1.6rem; font-weight: 700; color: var(--text-dark); letter-spacing: 0.5px; }
    .header-sub-title { font-size: 0.8rem; font-weight: 500; color: var(--text-light); letter-spacing: 0.5px; }
    .modal-actions { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
    .modal-actions .btn { width: auto; flex-grow: 1; margin-top: 0; }
    #full-list-modal .modal-box { background: rgba(26, 26, 39, 0.95); border: 1px solid rgba(0, 255, 255, 0.4); box-shadow: 0 0 30px rgba(0, 255, 255, 0.3), inset 0 0 15px rgba(0, 255, 255, 0.2); color: #e0e0e0; max-width: 95%; width: 1100px; padding: 1.5rem; }
    #full-list-modal #full-list-header { border-bottom: 1px solid rgba(0, 255, 255, 0.4); padding-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    #full-list-modal #full-list-title { color: #00ffff; text-shadow: 0 0 5px #00ffff; font-family: 'Fira Code', monospace; margin: 0; flex-grow: 1; }
    #list-export-buttons { flex-shrink: 0; }
    #full-list-modal #full-list-search { background: rgba(0,0,0,0.3); border-color: rgba(0, 255, 255, 0.3); color: #e0e0e0; font-family: 'Fira Code', monospace; text-align: center; }
    #full-list-modal #full-list-search:focus { border-color: #00ffff; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5); background: rgba(0,0,0,0.5); }
    #full-list-modal #full-list-table-container { max-width: 900px; width: 100%; margin: 0 auto; }
    /* Full list modal - result cards */
    #full-list-modal .result-card { background: var(--surface-color); border: 1px solid var(--border-color); border-left: 4px solid var(--primary-color); box-shadow: var(--shadow-sm); }
    #full-list-modal .result-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    [data-theme=dark] #full-list-modal .result-card { background: rgba(0, 255, 255, 0.07); border: 1px solid rgba(0, 255, 255, 0.1); border-left: 4px solid #00ffff; box-shadow: none; }
    #full-list-modal .result-header h3 { color: #ffffff; }
    #full-list-modal .result-header .badge { background: rgba(0, 255, 255, 0.2); color: #00ffff; }
    #full-list-modal .result-table td:first-child { color: #a0a0a0; }
    #full-list-modal .result-table td:last-child { color: #e0e0e0; font-family: 'Fira Code', monospace; }
    #full-list-modal .btn-secondary-outline { color: #a0a0a0; border-color: rgba(0, 255, 255, 0.3); }
    #full-list-modal .btn-secondary-outline:hover { color: #00ffff; border-color: #00ffff; background: rgba(0, 255, 255, 0.1); }
    #full-list-modal .modal-close-btn { position: static; transform: none; color: rgba(0, 255, 255, 0.7); flex-shrink: 0; }
    #full-list-modal .modal-close-btn:hover { color: #ff4d4d; }
    #full-list-modal #list-export-buttons .btn-success { background: linear-gradient(90deg,#0d9488,#14b8a6); box-shadow: none; }
    #full-list-modal .summary-grid { max-width: 900px; margin: 1rem auto; }
    #full-list-modal .summary-stat-card { background: rgba(0, 255, 255, 0.07); border-color: rgba(0, 255, 255, 0.1); }
    #full-list-modal .summary-stat-card .number { color: #e0e0e0; }
    #full-list-modal .summary-stat-card .label { color: #a0a0a0; }
    #login-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10000; display: flex; justify-content: center; align-items: center; color: #fff; background: #0a0a1a; transition: opacity .5s ease; overflow: hidden; }
    /* Xarita fon (blur) - OpenStreetMap static */
    #login-map-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('https://tile.openstreetmap.org/14/11526/5943.png'), url('https://tile.openstreetmap.org/14/11527/5943.png'), url('https://tile.openstreetmap.org/14/11526/5944.png'), url('https://tile.openstreetmap.org/14/11527/5944.png'), linear-gradient(135deg, #0a0a2e 0%, #1a1a3e 100%); background-size: 50% 50%, 50% 50%, 50% 50%, 50% 50%, cover; background-position: 0 0, 100% 0, 0 100%, 100% 100%, center; filter: blur(4px) brightness(0.25) saturate(0.7); opacity: 0.8; z-index: 0; }
    /* Mesh Gradient Animation */
    .mesh-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(124, 58, 237, 0.4) 0%, transparent 40%), linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, transparent 40%), linear-gradient(225deg, rgba(236, 72, 153, 0.25) 0%, transparent 40%), linear-gradient(315deg, rgba(6, 182, 212, 0.35) 0%, transparent 40%); background-size: 200% 200%; animation: meshMove 12s ease-in-out infinite; z-index: 1; }
    @keyframes meshMove { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
    #login-screen::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.2) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.15) 0%, transparent 50%), radial-gradient(circle at 50% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 70%); animation: bgFloat 20s ease-in-out infinite; pointer-events: none; z-index: 2; }
    @keyframes bgFloat { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 33% { transform: translate(30px, -30px) rotate(5deg); } 66% { transform: translate(-20px, 20px) rotate(-5deg); } }
    /* Glassmorphism Login Box */
    .login-box { position: relative; width: 90%; max-width: 520px; background: rgba(15, 15, 35, 0.5); border: 1px solid rgba(139, 92, 246, 0.35); border-radius: 28px; padding: 2.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6), 0 0 80px rgba(139, 92, 246, 0.2), inset 0 1px 1px rgba(255,255,255,0.1); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); text-align: center; z-index: 10; }
    /* Greeting Message */
    .greeting-animated { font-size: 1.05rem; color: rgba(255,255,255,0.95); margin-bottom: 1.25rem; padding: 0.6rem 1.25rem; background: linear-gradient(135deg, rgba(124,58,237,0.35), rgba(16,185,129,0.25)); border-radius: 50px; display: inline-block; animation: greetingPulse 3s ease-in-out infinite; border: 1px solid rgba(255,255,255,0.1); }
    @keyframes greetingPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(124,58,237,0.3); } 50% { transform: scale(1.02); box-shadow: 0 0 35px rgba(124,58,237,0.5); } }
    .login-box h2 { font-size: 2rem; margin-bottom: 0.5rem; color: #fff; display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
    .login-box h2 .logo-svg { color: #a78bfa; filter: drop-shadow(0 0 15px rgba(167, 139, 250, 0.6)); animation: logoPulse 2s ease-in-out infinite; }
    @keyframes logoPulse { 0%, 100% { filter: drop-shadow(0 0 15px rgba(167, 139, 250, 0.6)); transform: scale(1); } 50% { filter: drop-shadow(0 0 25px rgba(167, 139, 250, 0.9)); transform: scale(1.05); } }
    .login-box p { margin-bottom: 2rem; color: rgba(255, 255, 255, 0.5); font-weight: 500; font-size: 0.95rem; }
    #role-selection-view, #password-view { animation: fadeIn .4s ease; }
    #role-selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .role-btn { background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.25); color: #fff; padding: 1rem 0.75rem; font-size: 0.9rem; font-weight: 600; border-radius: 14px; cursor: pointer; transition: all .3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; backdrop-filter: blur(10px); }
    .role-btn:hover { background: rgba(139, 92, 246, 0.25); border-color: #a78bfa; transform: translateY(-4px) scale(1.02); box-shadow: 0 15px 35px -10px rgba(139, 92, 246, 0.5); }
    #password-view { text-align: left; }
    #password-view #selected-role-display { background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(16, 185, 129, 0.1)); padding: .8rem 1.2rem; border-radius: 12px; margin-bottom: 1.5rem; font-weight: 600; text-align: center; border: 1px solid rgba(139, 92, 246, 0.3); }
    #password-view label { color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; }
    #login-password-input { background: rgba(0,0,0,0.3); border: 2px solid rgba(139, 92, 246, 0.3); color: #fff; text-align: center; font-size: 1.8rem; letter-spacing: .6em; padding: 1rem; border-radius: 12px; }
    #login-password-input:focus { background: rgba(0,0,0,0.5); border-color: #a78bfa; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2), 0 0 30px rgba(139, 92, 246, 0.2); }
    #login-submit-btn { background: linear-gradient(135deg, #7c3aed, #a78bfa); border: none; font-size: 1rem; padding: 1rem; border-radius: 12px; font-weight: 700; letter-spacing: 0.5px; box-shadow: 0 10px 30px -10px rgba(124, 58, 237, 0.5); }
    #login-submit-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 40px -10px rgba(124, 58, 237, 0.6); }
    .login-footer-info { position: fixed; bottom: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: flex-end; font-family: 'Fira Code', monospace; font-size: 0.85rem; color: rgba(255, 255, 255, 0.5); pointer-events: none; z-index: 11; }
    #clock-display .time { font-size: 1.3rem; font-weight: 700; color: rgba(255, 255, 255, 0.9); text-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
    #clock-display .date { color: rgba(255, 255, 255, 0.5); margin-top: 2px; }
    #system-status { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(0,0,0,0.3); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
    #system-status.online { color: #10b981; border-color: rgba(16, 185, 129, 0.3); }
    #system-status.offline { color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); }
    #quote-of-the-day { max-width: 280px; text-align: right; font-style: italic; line-height: 1.4; color: rgba(255, 255, 255, 0.4); }
    /* Objects Stats Modal - Light va Dark mode */
    #objects-stats-modal .modal-box { background: var(--surface-color); border: 1px solid var(--border-color); }
    #objects-stats-modal h3 { color: var(--primary-color); }
    #objects-stats-modal h4 { color: var(--text-dark); }
    #objects-stats-modal .modal-close-btn { color: var(--text-light); }
    #objects-stats-modal #add-new-object-btn { background: linear-gradient(90deg, #d97706, #f59e0b); box-shadow: 0 4px 20px -5px rgba(245,158,11,.5); }
    #objects-stats-modal .summary-stat-card { background: var(--surface-color); border: 1px solid var(--border-color); cursor: pointer; transition: all 0.3s ease; }
    #objects-stats-modal .summary-stat-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--warning-color); }
    #objects-stats-modal .summary-stat-card .icon { color: var(--warning-color); }
    #objects-stats-modal .summary-stat-card .number { color: var(--text-dark); font-size: 2rem; font-weight: 700; }
    #objects-stats-modal .summary-stat-card .label { color: var(--text-light); }
    /* Dark mode */
    [data-theme=dark] #objects-stats-modal .modal-box { background: rgba(26, 26, 39, 0.95); border: 1px solid rgba(250, 204, 21, 0.4); box-shadow: 0 0 30px rgba(250, 204, 21, 0.2), inset 0 0 15px rgba(250, 204, 21, 0.1); color: #e0e0e0; }
    [data-theme=dark] #objects-stats-modal h3 { color: #facc15; text-shadow: 0 0 5px #facc15; }
    [data-theme=dark] #objects-stats-modal .modal-close-btn { color: rgba(250, 204, 21, 0.7); }
    [data-theme=dark] #objects-stats-modal .summary-stat-card { background: rgba(250, 204, 21, 0.07); border-color: rgba(250, 204, 21, 0.2); }
    [data-theme=dark] #objects-stats-modal .summary-stat-card:hover { box-shadow: 0 5px 15px rgba(250, 204, 21, 0.1); }
    [data-theme=dark] #objects-stats-modal .summary-stat-card .icon { color: #facc15; }
    [data-theme=dark] #objects-stats-modal .summary-stat-card .number { color: #fff; }
    [data-theme=dark] #objects-stats-modal .summary-stat-card .label { color: #ccc; }
    .object-result-card { background: rgba(0, 255, 255, 0.07); border: 1px solid rgba(0, 255, 255, 0.1); display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; }
    .object-result-card .card-icon { font-size: 2rem; color: #00ffff; flex-shrink: 0; width: 40px; text-align: center; }
    .object-result-card .card-content h4 { margin: 0 0 0.25rem 0; color: #fff; font-size: 1.1rem; }
    .object-result-card .card-content p { margin: 0; font-size: 0.9rem; color: #a0a0a0; font-family: 'Fira Code', monospace;}
    .object-result-card .card-actions { margin-left: auto; }
    #full-list-modal .object-result-card .btn-secondary-outline { padding: 0.5rem 1rem; font-size: 0.9rem; }
    #object-details-content .data-value.location-link { text-decoration: underline; cursor: pointer; color: var(--primary-light); }
    #object-details-content .staff-section { margin-top: 1.5rem; }
    #object-details-content .staff-member-card { display: flex; align-items: center; gap: 1rem; background: rgba(255,255,255, .05); padding: 1rem; border-radius: var(--radius-md); margin-bottom: .75rem; border-left: 4px solid var(--primary-color); cursor: pointer; transition: background .2s; }
    #object-details-content .staff-member-card:hover { background: rgba(139,92,246, .2); }
    #object-details-content .staff-avatar img, #object-details-content .staff-avatar .avatar-placeholder-sm { width: 50px; height: 50px; font-size: 1.5rem; }
    #object-details-content .staff-details .staff-name { font-weight: 600; color: #fff; }
    #object-details-content .staff-details .staff-position { color: #94a3b8; font-size: .9rem; }
    #add-object-modal .modal-box, #add-staff-modal .modal-box { max-width: 600px; }
    .staff-list-item { display: flex; align-items: center; justify-content: space-between; padding: .75rem; background-color: var(--bg-color); border-radius: var(--radius-md); margin-bottom: .5rem; }
    .staff-list-item .staff-info { font-weight: 600; }
    .staff-list-item .staff-info span { font-weight: 500; color: var(--text-light); font-size: .9rem; margin-left: .5rem; }
    .staff-list-item .remove-staff-btn { color: var(--danger-color); cursor: pointer; font-size: 1.1rem; }
    #signature-modal .modal-box { max-width: 95vw; max-height: 90vh; }
    #signature-pad-canvas { 
      border: 3px solid var(--border-color); 
      border-radius: var(--radius-md); 
      cursor: crosshair; 
      width: 100%;
      min-height: 300px;
      height: 400px;
      background: #fff;
      box-shadow: var(--shadow-md);
      touch-action: none;
    }
    @media (max-width: 768px) {
      #signature-pad-canvas {
        height: 300px;
      }
    }
    #signature-pad-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
    .signature-preview-container { margin-top: 1rem; }
    .signature-preview-container img { max-height: 50px; border: 1px solid var(--border-color); border-radius: 4px; background: #fff; }
    .signature-preview-container p { font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem; }
    
    /* Murojaatlar uchun stillar */
    #appeals-modal .nav-tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1.5rem; }
    #appeals-modal .nav-tab { padding: .8rem 1.2rem; cursor: pointer; font-weight: 600; color: var(--text-light); border-bottom: 2px solid transparent; margin-bottom: -2px; }
    #appeals-modal .nav-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    #appeals-modal .tab-content { display: none; }
    #appeals-modal .tab-content.active { display: block; }
    .appeal-card { background: var(--bg-color); border: 1px solid var(--border-color); border-left: 4px solid var(--primary-color); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1rem; cursor: pointer; }
    .appeal-card.status-yechilgan { border-left-color: var(--success-color); opacity: 0.7; }
    .appeal-card.status-jarayonda { border-left-color: var(--warning-color); }
    .appeal-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: .5rem; }
    .appeal-card-title { font-weight: 600; font-size: 1.1rem; }
    .appeal-card-badge { font-size: .8rem; font-weight: 600; padding: .25rem .75rem; border-radius: 20px; background: var(--primary-glow); color: var(--primary-color); }
    .appeal-card-badge.status-jarayonda { background: var(--warning-glow); color: var(--warning-color); }
    .appeal-card-badge.status-yechilgan { background: rgba(16, 185, 129, .1); color: var(--success-color); }
    .appeal-card-meta { font-size: .9rem; color: var(--text-light); }
    .stats-card { background: var(--surface-color); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color); margin-bottom: 1rem; }
    .stats-card h4 { margin-top: 0; margin-bottom: 1.5rem; }
    .stat-item { display: flex; align-items: center; justify-content: space-between; padding: .75rem 0; border-bottom: 1px solid var(--border-color); }
    .stat-item:last-child { border-bottom: none; }
    .stat-item-label { font-weight: 500; color: var(--text-light); }
    .stat-item-value { font-weight: 700; font-size: 1.2rem; }
    .stat-item-value .solved { color: var(--success-color); }
    .stat-item-value .pending { color: var(--warning-color); }
    
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QO'SHIMCHA BO'LIMLAR UCHUN ZAMONAVIY STIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .extra-sections-container { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
    .extra-section { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; }
    .extra-section:hover { border-color: var(--primary-light); box-shadow: 0 4px 12px rgba(124,58,237,0.1); }
    .extra-section-header { width: 100%; padding: 1rem 1.25rem; background: var(--bg-color); border: none; display: flex; align-items: center; gap: 0.75rem; font-weight: 600; font-size: 0.95rem; color: var(--text-dark); cursor: pointer; transition: all 0.2s ease; }
    .extra-section-header:hover { background: linear-gradient(135deg, var(--primary-glow) 0%, transparent 100%); }
    .extra-section-header.active { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%); color: white; }
    .extra-section-header.active .section-icon { background: rgba(255,255,255,0.2); color: white; }
    .extra-section-header.active .chevron-icon { transform: rotate(180deg); }
    .section-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.2s; }
    .section-icon.blue { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .section-icon.green { background: rgba(16,185,129,0.15); color: #10b981; }
    .section-icon.orange { background: rgba(249,115,22,0.15); color: #f97316; }
    .section-icon.purple { background: rgba(139,92,246,0.15); color: #8b5cf6; }
    .section-icon.red { background: rgba(239,68,68,0.15); color: #ef4444; }
    .section-icon.cyan { background: rgba(6,182,212,0.15); color: #06b6d4; }
    .section-title-text { flex: 1; text-align: left; }
    .chevron-icon { font-size: 0.85rem; color: var(--text-light); transition: transform 0.3s ease; }
    .extra-section-header.active .chevron-icon { color: white; }
    .extra-section-content { padding: 1.25rem; border: 2px solid rgba(124,58,237,0.1); border-top: none; border-radius: 0 0 16px 16px; display: none; animation: slideDown 0.3s ease; background: var(--surface-color); }
    .extra-section.active .extra-section-content { display: block; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .mini-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem; }
    .mini-card { display: flex; flex-direction: column; align-items: center; padding: 0.75rem; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .mini-card:hover { border-color: var(--primary-color); background: var(--primary-glow); }
    .mini-card.selected { border-color: var(--primary-color); background: var(--primary-glow); box-shadow: 0 0 0 2px var(--primary-glow); }
    .mini-card input[type="checkbox"] { display: none; }
    .mini-card-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .mini-card-text { font-size: 0.8rem; font-weight: 500; color: var(--text-dark); }
    .inspector-only-section { display: none; }
    body[data-user-role="inspector"] .inspector-only-section { display: block; }
    
    /* ZAMONAVIY FORMA STILLARI */
    .form-step-title { font-size: 1.15rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--primary-glow); display: flex; align-items: center; gap: 0.5rem; background: linear-gradient(90deg, rgba(124,58,237,0.08), transparent); padding: 0.75rem 1rem; border-radius: 10px; }
    .form-step-title i { font-size: 1.2rem; background: linear-gradient(135deg, var(--primary-color), #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .form-step { padding: 0.5rem 0; }
    .form-group label { font-size: 0.85rem; font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.4rem; }
    .form-group label i { color: var(--primary-color); font-size: 0.9rem; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.9rem 1rem; border: 2px solid var(--border-color); border-radius: 12px; font-size: 0.95rem; background: var(--bg-color); color: var(--text-dark); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .form-group input:hover, .form-group select:hover { border-color: rgba(124,58,237,0.4); }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px var(--primary-glow), 0 4px 12px rgba(124,58,237,0.15); outline: none; transform: translateY(-1px); }
    .form-group input::placeholder { color: var(--text-light); opacity: 0.6; }
    .form-group select { cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%237c3aed' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.5rem; -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 2.5rem; }
    .form-group select option { padding: 0.5rem; }
    .photo-preview-container { width: 120px; height: 120px; border-radius: 50%; border: 3px dashed var(--primary-color); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; overflow: hidden; background: linear-gradient(135deg, rgba(124,58,237,0.05), rgba(6,182,212,0.05)); transition: all 0.3s; box-shadow: 0 4px 20px rgba(124,58,237,0.1); }
    .photo-preview-container:hover { border-color: var(--primary-light); transform: scale(1.05); box-shadow: 0 8px 30px rgba(124,58,237,0.2); }
    .photo-preview-container img { width: 100%; height: 100%; object-fit: cover; }
    #take-photo-btn { display: block; margin: 0 auto 1.5rem; background: linear-gradient(135deg, #06b6d4, #0891b2); border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(6,182,212,0.3); }
    #take-photo-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(6,182,212,0.4); }
    .form-row { margin-bottom: 0.5rem; }
    .btn { border-radius: 12px; font-weight: 600; padding: 0.9rem 1.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, #8b5cf6 50%, #06b6d4 100%); border: none; box-shadow: 0 4px 15px rgba(124,58,237,0.3); background-size: 200% 200%; animation: gradientShift 3s ease infinite; }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(124,58,237,0.4); }
    @keyframes gradientShift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
    /* Kengaytiriluvchi bo'limlar uchun zamonaviy stil */
    .extra-section { margin-bottom: 1rem; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.06); transition: all 0.3s; }
    .extra-section:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .extra-section-header { background: linear-gradient(135deg, rgba(124,58,237,0.08), rgba(6,182,212,0.08)); padding: 1rem 1.25rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 2px solid rgba(124,58,237,0.15); border-radius: 16px; transition: all 0.3s; }
    .extra-section-header:hover { background: linear-gradient(135deg, rgba(124,58,237,0.12), rgba(6,182,212,0.12)); border-color: rgba(124,58,237,0.3); }
    .extra-section.active .extra-section-header { background: linear-gradient(135deg, #7c3aed, #8b5cf6); border-color: #7c3aed; border-radius: 16px 16px 0 0; }
    .extra-section.active .extra-section-header span, .extra-section.active .extra-section-header .section-title-text { color: white; }
    .extra-section.active .section-icon { background: rgba(255,255,255,0.2) !important; }
    .extra-section.active .section-icon i { color: white !important; background: none !important; -webkit-text-fill-color: white !important; }
    .extra-section-header span { font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 0.6rem; }
    .extra-section-header i:first-child { font-size: 1.1rem; background: linear-gradient(135deg, var(--primary-color), #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .extra-section-header i:last-child { transition: transform 0.3s; color: var(--primary-color); }
    .extra-section.active .extra-section-header i:last-child { transform: rotate(180deg); color: white; }
    /* Aqlli kiritish - dublikat bildirishnomasi */
    .smart-alert { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 0.75rem 1rem; margin-top: 0.5rem; display: none; animation: slideDown 0.3s ease; }
    .smart-alert.danger { background: linear-gradient(135deg, #fee2e2, #fecaca); border-color: #ef4444; }
    .smart-alert.info { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-color: #3b82f6; }
    .smart-alert.success { background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-color: #10b981; }
    .smart-alert-icon { font-size: 1.1rem; margin-right: 0.5rem; }
    .smart-alert-text { font-size: 0.85rem; font-weight: 500; }
    .smart-alert-link { color: var(--primary-color); cursor: pointer; text-decoration: underline; font-weight: 600; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Filter citizen cards */
    .filter-citizen-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    [data-theme="dark"] .filter-citizen-card { background: var(--surface-color) !important; }
    
    /* ===== YANGI YIL BEZAKLARI ===== */
    /* Qor animatsiyasi - Login screen uchun */
    #snowfall-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: hidden; }
    /* Global qor animatsiyasi - butun ilova uchun */
    #global-snowfall { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
    .snowflake { position: absolute; color: #fff; font-size: 1rem; text-shadow: 0 0 5px rgba(255,255,255,0.8); animation: snowfall linear infinite; opacity: 0.8; }
    [data-theme="light"] .snowflake { color: #a5b4fc; text-shadow: 0 0 5px rgba(99,102,241,0.5); }
    @keyframes snowfall {
        0% { transform: translateY(-10vh) translateX(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(110vh) translateX(100px) rotate(360deg); opacity: 0.3; }
    }
    
    /* Yangi yil banner */
    .new-year-banner { 
        background: linear-gradient(135deg, #dc2626, #16a34a); 
        color: white; 
        padding: 0.6rem 1.5rem; 
        border-radius: 30px; 
        font-size: 0.95rem; 
        font-weight: 700; 
        margin-bottom: 1rem; 
        display: inline-block;
        animation: bannerGlow 2s ease-in-out infinite;
        box-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
    }
    .new-year-banner span { 
        background: linear-gradient(90deg, #fbbf24, #fff, #fbbf24); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent;
        background-size: 200% auto;
        animation: shimmer 3s linear infinite;
    }
    @keyframes bannerGlow {
        0%, 100% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.5), 0 0 40px rgba(22, 163, 74, 0.3); }
        50% { box-shadow: 0 0 30px rgba(220, 38, 38, 0.8), 0 0 60px rgba(22, 163, 74, 0.5); }
    }
    @keyframes shimmer {
        0% { background-position: -200% center; }
        100% { background-position: 200% center; }
    }
  </style>
</head>
<body>
  <!-- YANGI KIRISH OYNASI -->
  <div id="login-screen">
      <!-- Xarita fon (blur) -->
      <div id="login-map-bg"></div>
      <!-- Mesh gradient animatsiya -->
      <div class="mesh-gradient"></div>
      <!-- Qor animatsiyasi -->
      <div id="snowfall-container"></div>
      
      <div class="login-box">
          <!-- Yangi yil bezagi -->
          <div class="new-year-banner">
            üéÑ <span>Yangi 2026-yil bilan!</span> üéÖ
          </div>
          <!-- Vaqtga qarab salom -->
          <div id="greeting-message" class="greeting-animated"></div>
          <h2>
              <svg width="30" height="30" viewBox="0 0 40 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="logo-svg">
                  <circle cx="20" cy="7" r="7" fill="currentColor"></circle>
                  <path d="M20 28C26.0751 28 31 23.0751 31 17H9C9 23.0751 13.9249 28 20 28Z" fill="currentColor"></path>
                  <circle cx="8" cy="9" r="5" fill="currentColor" style="opacity: 0.6;"></circle>
                  <path d="M8 23C12.4183 23 16 19.4183 16 15H0C0 19.4183 3.58172 23 8 23Z" fill="currentColor" style="opacity: 0.6;"></path>
                  <circle cx="32" cy="9" r="5" fill="currentColor" style="opacity: 0.6;"></circle>
                  <path d="M32 23C36.4183 23 40 19.4183 40 15H24C24 19.4183 27.5817 23 32 23Z" fill="currentColor" style="opacity: 0.6;"></path>
              </svg>
              O'zbegim MFY
          </h2>
          <p>Aholi va Tadbirkorlik sub'ektlarini ro'yxatga olish tizimi</p>
          <div id="role-selection-view">
              <label style="color: #fff; margin-bottom: 1rem; display: block;">Davom etish uchun o'z rolingizni tanlang</label>
              <div id="role-selection-grid">
                  <!-- Rollar bu yerga JS orqali qo'shiladi -->
              </div>
          </div>
          <div id="password-view" class="hidden">
              <button class="btn btn-secondary" id="back-to-role-selection" style="width: auto; position: absolute; top: 1.5rem; left: 1.5rem; padding: 0.5rem 0.8rem; font-size: 0.9rem; margin:0;"><i class="fas fa-arrow-left"></i></button>
              <div id="selected-role-display"></div>
              <div class="form-group" style="margin-top:1rem;">
                  <label for="login-password-input" style="margin-bottom:.5rem;display:block;">Parolni kiriting:</label>
                  <input type="password" id="login-password-input" placeholder="****" inputmode="numeric">
                  <p id="login-password-error" style="display:none;color:var(--danger-color);margin-top:.5rem;font-size:.95rem;">Parol noto'g'ri!</p>
              </div>
              <button class="btn btn-primary" id="login-submit-btn" style="width:100%;margin-top:1rem;">Kirish</button>
          </div>
      </div>
      <div class="login-footer-info">
          <div id="clock-display">
              <div class="time">00:00:00</div>
              <div class="date">01.01.2025</div>
          </div>
          <div id="quote-of-the-day"></div>
          <div id="system-status">
              <i class="fas fa-circle-notch fa-spin"></i> Tekshirilmoqda...
          </div>
      </div>
  </div>
  <!-- GLOBAL QOR ANIMATSIYASI -->
  <div id="global-snowfall"></div>
  <div class="loader-overlay" id="loader-overlay"><div class="loader"></div></div>
  <div id="toast-notification"><i class="fas fa-check-circle"></i><span id="toast-message"></span></div>
  <div id="pdf-render-container"></div> 
  <div class="app-shell">
    <header class="header">
      <h1 id="home-link">
        <svg width="45" height="45" viewBox="0 0 40 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="header-logo-svg">
            <circle cx="20" cy="7" r="7" fill="currentColor"></circle>
            <path d="M20 28C26.0751 28 31 23.0751 31 17H9C9 23.0751 13.9249 28 20 28Z" fill="currentColor"></path>
            <circle cx="8" cy="9" r="5" fill="currentColor" style="opacity: 0.6;"></circle>
            <path d="M8 23C12.4183 23 16 19.4183 16 15H0C0 19.4183 3.58172 23 8 23Z" fill="currentColor" style="opacity: 0.6;"></path>
            <circle cx="32" cy="9" r="5" fill="currentColor" style="opacity: 0.6;"></circle>
            <path d="M32 23C36.4183 23 40 19.4183 40 15H24C24 19.4183 27.5817 23 32 23Z" fill="currentColor" style="opacity: 0.6;"></path>
        </svg>
        <div class="header-title-wrapper">
          <span class="header-main-title">O‚Äòzbegim</span>
          <span class="header-sub-title">Mahalla Fuqarolar Yig‚Äòini</span>
        </div>
      </h1>
      <div class="header-actions">
        <div id="notification-bell-container">
            <button class="header-btn" id="notification-bell" title="Eslatmalar"><i class="fas fa-bell"></i></button>
            <span id="notification-count" class="hidden">0</span>
        </div>
        <button class="header-btn" id="refresh-btn" title="Bazani yangilash"><i class="fas fa-sync"></i></button>
        <button class="header-btn" id="theme-switcher" title="Mavzu"><i class="fas fa-moon"></i></button>
      </div>
    </header>
    <main>
      <div id="search-view" class="card view active">
        <div class="search-options">
          <button class="search-option-btn active" data-tab="name-search"><i class="fas fa-user"></i> F.I.O.</button>
          <button class="search-option-btn" data-tab="passport-search"><i class="fas fa-id-card"></i> Hujjat</button>
          <button class="search-option-btn" data-tab="dob-search"><i class="fas fa-calendar-alt"></i> Sana</button>
          <button class="search-option-btn" data-tab="address-search"><i class="fas fa-map-marker-alt"></i> Manzil</button>
        </div>
        <div class="search-content">
          <div id="name-search" class="search-panel active">
            <input type="text" id="searchNameInput" placeholder="F.I.O. yoki uning bir qismimini kiriting...">
            <button class="btn btn-primary js-search-name"><i class="fas fa-search"></i> Qidirish</button>
          </div>
          <div id="passport-search" class="search-panel">
            <div class="passport-inputs">
              <input type="text" id="searchPassportSeries" placeholder="AA" maxlength="2" class="js-alpha-upper-input">
              <input type="text" id="searchPassportNumber" placeholder="1234567" maxlength="7" inputmode="numeric" class="js-numeric-input">
            </div>
            <button class="btn btn-primary js-search-passport"><i class="fas fa-search"></i> Qidirish</button>
          </div>
          <div id="dob-search" class="search-panel">
            <input type="text" id="searchDobInput" placeholder="DD.MM.YYYY" maxlength="10" inputmode="numeric" class="js-date-input">
            <button class="btn btn-primary js-search-dob"><i class="fas fa-search"></i> Qidirish</button>
          </div>
          <div id="address-search" class="search-panel">
            <input type="text" id="searchAddressInput" placeholder="Masalan: Musayev 12">
            <button class="btn btn-primary js-search-address"><i class="fas fa-search"></i> Qidirish</button>
          </div>
        </div>
        <div id="search-result"></div>
      </div>
      <div id="add-view" class="card view">
        <div class="form-title-wrapper" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
          <h3 id="form-title">Yangi Fuqaro Qo'shish</h3>
          <i class="fas fa-user-secret shubhali-toggle js-shubhali-toggle" title="Shubhali shaxs sifatida belgilash" style="font-size:1.6rem;color:var(--secondary-color);cursor:pointer"></i>
        </div>
        <div class="form-progress">
          <div class="form-progress-bar"></div>
          <div class="progress-step active" data-step="1">Shaxsiy</div>
          <div class="progress-step" data-step="2">Manzil</div>
          <div class="progress-step" data-step="3">Ijtimoiy</div>
        </div>
        <form id="add-form">
          <input type="hidden" name="shubhali_shaxs" value="Yo'q">
          <input type="hidden" name="selected_family_id" value="">
          <input type="hidden" name="update_unique_id" value="">
          <input type="hidden" name="photoBase64" value="">
          <input type="hidden" name="signatureBase64" value="">
          <div class="form-step active" data-step="1">
            <h4 class="form-step-title"><i class="fas fa-user"></i> Shaxsiy ma'lumotlar</h4>
            <div class="photo-preview-container">
                <img id="form-photo-preview" src="" alt="Rasm ko'rinishi">
            </div>
            <button type="button" class="btn btn-secondary" id="take-photo-btn" style="margin-top:0;"><i class="fas fa-camera"></i> Rasmga Olish</button>
            <div class="form-row"><div class="form-group"><label>F.I.O.</label><input name="fio" class="js-alpha-input js-transliterate" required></div><div class="form-group"><label>Hujjat turi</label><select name="hujjat_turi" class="js-hujjat-turi" required><option value="" selected disabled>Tanlang...</option><option value="Pasport">Pasport</option><option value="Metrka">Metrka</option><option value="Chet el fuqarosi">Chet el fuqarosi</option></select></div></div>
            <div class="form-row conditional-field js-passport-fields"><div class="form-group"><label><i class="fas fa-id-card"></i> Pasport seriyasi va raqami</label><div class="passport-inputs"><input name="passport_series" placeholder="AA" maxlength="2" class="js-alpha-upper-input"><input name="passport_number" placeholder="1234567" maxlength="7" inputmode="numeric" class="js-numeric-input"></div></div><div class="form-group"><label><i class="fas fa-fingerprint"></i> JSHSHIR (14 ta raqam)</label><input name="jshshir" id="main-jshshir-input" maxlength="14" inputmode="numeric" class="js-numeric-input" placeholder="31234567890123"></div><div class="form-group full-width"><label><i class="fas fa-calendar-alt"></i> Tug'ilgan sana</label><input name="dob" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric"></div></div>
            <div class="form-row conditional-field js-metrka-fields"><div class="form-group full-width"><label>Guvohnoma seriyasi va raqami</label><div class="metrka-input-group"><select name="metrka_series" class="js-metrka-series"></select><input name="metrka_number" maxlength="8" inputmode="numeric" class="js-numeric-input"></div></div><div class="form-group full-width"><label>Tug'ilgan sana</label><input name="metrka_dob" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric"></div></div>
            <div class="form-row conditional-field js-chet-el-fields">
              <div class="form-group">
                <label><i class="fas fa-globe" style="color: #3b82f6;"></i> Davlat</label>
                <select name="chet_el_davlati" class="js-country-select">
                    <option value="">Davlatni tanlang...</option>
                    <optgroup label="MDH davlatlari">
                        <option value="Rossiya">üá∑üá∫ Rossiya</option>
                        <option value="Qozog'iston">üá∞üáø Qozog'iston</option>
                        <option value="Qirg'iziston">üá∞üá¨ Qirg'iziston</option>
                        <option value="Tojikiston">üáπüáØ Tojikiston</option>
                        <option value="Turkmaniston">üáπüá≤ Turkmaniston</option>
                        <option value="Ozarbayjon">üá¶üáø Ozarbayjon</option>
                        <option value="Armaniston">üá¶üá≤ Armaniston</option>
                        <option value="Gruziya">üá¨üá™ Gruziya</option>
                        <option value="Belarus">üáßüáæ Belarus</option>
                        <option value="Ukraina">üá∫üá¶ Ukraina</option>
                        <option value="Moldova">üá≤üá© Moldova</option>
                    </optgroup>
                    <optgroup label="Osiyo">
                        <option value="Xitoy">üá®üá≥ Xitoy</option>
                        <option value="Hindiston">üáÆüá≥ Hindiston</option>
                        <option value="Pokiston">üáµüá∞ Pokiston</option>
                        <option value="Afg'oniston">üá¶üá´ Afg'oniston</option>
                        <option value="Eron">üáÆüá∑ Eron</option>
                        <option value="Turkiya">üáπüá∑ Turkiya</option>
                        <option value="Saudiya Arabistoni">üá∏üá¶ Saudiya Arabistoni</option>
                        <option value="BAA">üá¶üá™ Birlashgan Arab Amirliklari</option>
                        <option value="Yaponiya">üáØüáµ Yaponiya</option>
                        <option value="Janubiy Koreya">üá∞üá∑ Janubiy Koreya</option>
                    </optgroup>
                    <optgroup label="Yevropa">
                        <option value="Germaniya">üá©üá™ Germaniya</option>
                        <option value="Fransiya">üá´üá∑ Fransiya</option>
                        <option value="Buyuk Britaniya">üá¨üáß Buyuk Britaniya</option>
                        <option value="Italiya">üáÆüáπ Italiya</option>
                        <option value="Ispaniya">üá™üá∏ Ispaniya</option>
                        <option value="Polsha">üáµüá± Polsha</option>
                    </optgroup>
                    <optgroup label="Amerika">
                        <option value="AQSH">üá∫üá∏ AQSH</option>
                        <option value="Kanada">üá®üá¶ Kanada</option>
                        <option value="Braziliya">üáßüá∑ Braziliya</option>
                    </optgroup>
                </select>
              </div>
              <div class="form-group"><label><i class="fas fa-passport" style="color: #8b5cf6;"></i> Pasport seriya va raqami</label><input name="chet_el_pasport"></div>
              <div class="form-group full-width"><label><i class="fas fa-calendar-alt" style="color: #f59e0b;"></i> Tug'ilgan sana</label><input name="chet_el_dob" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric"></div>
            </div>
            <div class="form-row"><div class="form-group"><label>Jinsi</label><select name="jinsi" required><option value="" disabled selected>Tanlang...</option><option value="Erkak">Erkak</option><option value="Ayol">Ayol</option></select></div><div class="form-group"><label>Telefon (9 raqam)</label><input name="telefon_number" maxlength="9" class="js-numeric-input" placeholder="901234567" inputmode="numeric" required></div></div>
            <div class="form-group full-width" style="display: none;"><label>Xatlovchi</label><select name="xatlovchi" id="xatlovchi-select" required><option value="" selected disabled>Tanlang...</option><option>MFY raisi</option><option>Yoshlar yetakchisi</option><option>Xotin qizlar faoli</option><option>Profilaktika inspektori</option><option>Xokim yordamchisi</option><option>Soliq hodimi</option><option>Ijtimoiy hodim</option><option>Javohir</option><option>Ruzimukhammed</option><option>Ravshanbek</option></select></div>
          </div>
          <div class="form-step" data-step="2">
            <h4 class="form-step-title"><i class="fas fa-map-marker-alt"></i> Yashash manzili</h4>
            <div class="form-group full-width"><label>Xonadon turi</label><select name="xonadon_turi" class="js-xonadon-turi" required><option value="" selected disabled>Tanlang...</option><option value="kop_qavatli">Ko'p qavatli</option><option value="xovli">Hovli</option></select></div>
            <div class="full-width">
                <div class="form-row full-width conditional-field js-kop-qavatli-fields"><div class="form-group"><label>Ko'chasi</label><select name="kop_qavatli_kochasi" class="js-street-select" data-type="kop_qavatli"></select></div><div class="form-group conditional-field js-other-street-group" data-type="kop_qavatli"><label>Boshqa ko'cha nomi</label><input class="js-other-street-input js-transliterate" data-type="kop_qavatli"></div><div class="form-group"><label>Dom raqami</label><input name="dom_raqami" maxlength="3" inputmode="numeric" class="js-numeric-input"></div><div class="form-group"><label>Kvartira raqami</label><input name="kvartira_raqami" maxlength="3" inputmode="numeric" class="js-numeric-input"></div></div>
                <div class="form-row full-width conditional-field js-xovli-fields"><div class="form-group"><label>Ko'chasi</label><select name="xovli_kochasi" class="js-street-select" data-type="xovli"></select></div><div class="form-group conditional-field js-other-street-group" data-type="xovli"><label>Boshqa ko'cha nomi</label><input class="js-other-street-input js-transliterate" data-type="xovli"></div><div class="form-group"><label>Uy raqami</label><input name="uy_raqami" maxlength="4" inputmode="numeric" class="js-numeric-input"></div></div>
                <div id="address-family-suggestions"></div>
            </div>
            <div class="form-group" style="display: none;"><label>MFY</label><select name="mfy" required><option value="O'zbegim" selected>O'zbegim</option></select></div>
            <div class="form-row">
              <div class="form-group"><label>Qarindoshligi</label><select name="qarindoshligi" required><option value="" disabled selected>Tanlang...</option><option>Oila boshi</option><option>Turmush o'rtog'i</option><option>O'g'li</option><option>Qizi</option><option>Otasi</option><option>Onasi</option><option>Akasi</option><option>Ukasi</option><option>Opasi</option><option>Singlisi</option><option>Ijarachi</option><option>Boshqa</option></select></div>
              <div class="form-group"><label>Yashash holati</label><select name="registrationType" class="js-reg-type" required><option value="" disabled selected>Tanlang...</option><option>Doimiy</option><option>Ijara</option><option>Vaqtincha</option></select></div>
            </div>
            <div class="form-group conditional-field js-vaqtincha-info"><label>Qancha vaqt turadi</label><input name="vaqtinchaInfo" data-optional="true"></div>
            
            <div class="form-row full-width conditional-field js-ijara-details">
                <div class="form-group">
                    <label>Uy egasi F.I.O.</label>
                    <input name="uy_egasi_fio" data-optional="true" class="js-transliterate">
                </div>
                <div class="form-group">
                    <label>Uy egasi telefoni</label>
                    <input name="uy_egasi_telefon" data-optional="true" inputmode="numeric" class="js-numeric-input" placeholder="901234567" maxlength="9">
                </div>
                <div class="form-group">
                    <label>Uy egasining tug'ilgan sanasi</label>
                    <input name="uy_egasi_dob" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric" data-optional="true">
                </div>
                <div class="form-group">
                    <label>Qayerdan kelgan (Davlat)</label>
                    <select name="kelgan_davlat" id="kelgan_davlat_select" data-optional="true">
                        <option value="" selected>Tanlang...</option>
                    </select>
                </div>
                <div class="form-group conditional-field js-uzbek-viloyat" style="display:none;">
                    <label>Qayerdan kelgan (Viloyat)</label>
                    <select name="kelgan_viloyati" id="kelgan_viloyati_select" data-optional="true">
                        <option value="" selected>Tanlang...</option>
                    </select>
                </div>
                <div class="form-group conditional-field js-uzbek-tuman" style="display:none;">
                    <label>Qayerdan kelgan (Tuman)</label>
                    <select name="kelgan_tumani" id="kelgan_tumani_select" data-optional="true">
                        <option value="">Avval viloyatni tanlang</option>
                    </select>
                </div>
                <div class="form-group conditional-field js-uzbek-mfy" style="display:none;">
                    <label>MFY nomi</label>
                    <input name="kelgan_mfy" data-optional="true" placeholder="MFY nomini kiriting">
                </div>
            </div>

          </div>
          <div class="form-step" data-step="3">
            <h4 class="form-step-title"><i class="fas fa-users"></i> Ijtimoiy holati</h4>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Ijtimoiy holati</label>
                    <select name="socialStatus" class="js-social-status" required>
                        <option value="" disabled selected>Tanlang...</option>
                        <option>Turmush qurgan</option>
                        <option>Turmush qurmagan</option>
                        <option>Ajrashgan</option>
                        <option>Beva</option>
                        <option>Ajrim yoqasida</option>
                        <option>Shariy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Oila a'zolari soni</label>
                    <input name="oila_azolari_soni" type="number" placeholder="" maxlength="2" class="js-numeric-input" data-optional="true">
                </div>
            </div>

            <div class="form-row conditional-field js-shariy-info">
                <div class="form-group">
                    <label>Kim bilan (F.I.O.)</label>
                    <input name="shariyInfo" data-optional="true" class="js-alpha-input js-transliterate">
                </div>
                <div class="form-group">
                    <label>Tug'ilgan sanasi</label>
                    <input name="shariyDob" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric" data-optional="true">
                </div>
            </div>
            
            <div class="form-row">
              <div class="form-group"><label>Bandlik holati</label>
                <select name="employmentStatus" class="js-employment-status" required>
                    <option value="" disabled selected>Tanlang...</option>
                    <option>Ishsiz</option>
                    <option>Rasmiy band</option>
                    <option>Norasmiy band</option>
                    <option>Tadbirkor</option>
                    <option>Talaba</option>
                    <option>Maktab o'quchisi</option>
                    <option>Bog'cha</option>
                    <option>Ona qaramog'ida</option>
                    <option>Nafaqada</option>
                    <option>Nogironligi bor</option>
                    <option>Uy bekasi</option>
                    <option value="Dekret">Dekret</option>
                    <option value="Migratsiya">Migratsiyada</option>
                    <option value="Migratsiyadan qaytgan">Migratsiyadan qaytgan</option>
                </select>
              </div>
            </div>

            <div class="form-group full-width conditional-field js-employment-details"><label>Ish joyi</label><input name="employmentDetails" class="js-transliterate"></div>
             <div class="form-row full-width conditional-field js-study-details"><div class="form-group"><label class="js-oqish-joyi-label">O'qish joyi</label><input name="oqish_joyi" class="js-transliterate"></div><div class="form-group"><label class="js-kursi-sinfi-label">Kursi/Sinfi</label><input name="kursi_sinfi" inputmode="numeric"></div></div>
             <div class="form-group full-width conditional-field js-bogcha-details"><label>Bog'cha nomi yoki raqami</label><input name="bogcha_nomi" class="js-transliterate"></div>
             <div class="form-group full-width conditional-field js-disability-group"><label>Nogironlik guruhi</label><select name="disabilityGroup"><option value="" disabled selected>Tanlang...</option><option>1-guruh</option><option>2-guruh</option><option>3-guruh</option><option>Bolalikdan nogiron</option></select></div>
             
             <!-- ISHSIZ UCHUN QOSHIMCHA MA'LUMOTLAR -->
             <div class="form-row full-width conditional-field js-unemployed-details" style="display: none;">
               <div class="form-group">
                   <label><i class="fas fa-graduation-cap" style="color: #8b5cf6;"></i> Ma'lumoti</label>
                   <select name="malumoti" class="js-education-level">
                       <option value="">Tanlang...</option>
                       <option value="Oliy">Oliy</option>
                       <option value="O'rta-maxsus">O'rta-maxsus</option>
                       <option value="O'rta">O'rta</option>
                       <option value="Boshlang'ich">Boshlang'ich</option>
                       <option value="To'liqsiz o'rta">To'liqsiz o'rta</option>
                   </select>
               </div>
               <div class="form-group">
                   <label><i class="fas fa-briefcase" style="color: #10b981;"></i> Qanday ishda ishlamoqchi</label>
                   <select name="ishlash_yonalishi" class="js-job-category">
                       <option value="">Ish yo'nalishini tanlang...</option>
                       <optgroup label="üèóÔ∏è Qurilish va Ta'mirlash">
                           <option value="Qurilishchi">Qurilishchi</option>
                           <option value="Elektrik">Elektrik</option>
                           <option value="Santexnik">Santexnik</option>
                           <option value="Suvokchi">Suvokchi</option>
                           <option value="Bo'yoqchi">Bo'yoqchi</option>
                           <option value="Duradgor">Duradgor / Yog'ochchi</option>
                           <option value="Payvandchi">Payvandchi</option>
                           <option value="Chinakchi">G'ishtchi / Chinakchi</option>
                           <option value="Plitachi">Plitachi / Kofechi</option>
                           <option value="Konditsioner ustasi">Konditsioner ustasi</option>
                       </optgroup>
                       <optgroup label="üöó Transport va Haydovchilik">
                           <option value="Yengil avtomobil haydovchisi">Yengil avtomobil haydovchisi</option>
                           <option value="Yuk mashinasi haydovchisi">Yuk mashinasi haydovchisi</option>
                           <option value="Avtobus haydovchisi">Avtobus haydovchisi</option>
                           <option value="Taksi haydovchisi">Taksi haydovchisi</option>
                           <option value="Kuryer">Kuryer / Yetkazib beruvchi</option>
                           <option value="Traktor haydovchisi">Traktor haydovchisi</option>
                           <option value="Ekskavator operatori">Ekskavator operatori</option>
                       </optgroup>
                       <optgroup label="üè≠ Ishlab chiqarish">
                           <option value="Ishchi">Oddiy ishchi</option>
                           <option value="Operator">Mashina operatori</option>
                           <option value="Omborchi">Omborchi / Yuklovchi</option>
                           <option value="Qadoqlovchi">Qadoqlovchi</option>
                           <option value="Tokar">Tokar / Frezerchi</option>
                           <option value="Slesar">Slesar / Mexanik</option>
                       </optgroup>
                       <optgroup label="üç≥ Oshxona va Oziq-ovqat">
                           <option value="Oshpaz">Oshpaz</option>
                           <option value="Oshpaz yordamchisi">Oshpaz yordamchisi</option>
                           <option value="Ofitsiant">Ofitsiant</option>
                           <option value="Barmen">Barmen</option>
                           <option value="Novvoy">Novvoy / Non pishiruvchi</option>
                           <option value="Qandolat ustasi">Qandolat ustasi</option>
                       </optgroup>
                       <optgroup label="üßµ Tikuvchilik va To'qimachilik">
                           <option value="Tikuvchi">Tikuvchi</option>
                           <option value="Kesuvchi">Kesuvchi / Bichovchi</option>
                           <option value="Andozachi">Andozachi</option>
                           <option value="Kashtachi">Kashtachi</option>
                           <option value="Trikotaj tikuvchisi">Trikotaj tikuvchisi</option>
                       </optgroup>
                       <optgroup label="üíá Go'zallik xizmatlari">
                           <option value="Sartarosh erkaklar">Sartarosh (erkaklar)</option>
                           <option value="Sartarosh ayollar">Sartarosh (ayollar)</option>
                           <option value="Kosmetolog">Kosmetolog</option>
                           <option value="Manikurchi">Manikurchi / Pedikurchi</option>
                           <option value="Vizajist">Vizajist</option>
                           <option value="Massajist">Massajist</option>
                       </optgroup>
                       <optgroup label="üè¢ Ofis va Xizmat">
                           <option value="Buxgalter">Buxgalter</option>
                           <option value="Kotiba">Kotiba / Ofis-menejer</option>
                           <option value="Kassir">Kassir</option>
                           <option value="Sotuvchi">Sotuvchi / Konsultant</option>
                           <option value="Menejer">Menejer</option>
                           <option value="Qo'riqchi">Qo'riqchi / Xavfsizlik</option>
                           <option value="Farrosh">Farrosh / Tozalagich</option>
                           <option value="Administrator">Administrator</option>
                       </optgroup>
                       <optgroup label="üíª IT va Texnologiya">
                           <option value="Dasturchi">Dasturchi / Programmer</option>
                           <option value="Veb-dizayner">Veb-dizayner</option>
                           <option value="Grafik dizayner">Grafik dizayner</option>
                           <option value="SMM mutaxassisi">SMM mutaxassisi</option>
                           <option value="Kompyuter ustasi">Kompyuter ustasi</option>
                           <option value="Videograf">Videograf / Videomontajchi</option>
                           <option value="Fotograf">Fotograf</option>
                       </optgroup>
                       <optgroup label="üè• Tibbiyot va Salomatlik">
                           <option value="Hamshira">Hamshira</option>
                           <option value="Tibbiy xodim">Tibbiy xodim</option>
                           <option value="Farmatsevt">Farmatsevt</option>
                           <option value="Laborant">Laborant</option>
                           <option value="Enaga">Enaga / Parvarish</option>
                       </optgroup>
                       <optgroup label="üéì Ta'lim">
                           <option value="O'qituvchi">O'qituvchi</option>
                           <option value="Tarbiyachi">Tarbiyachi</option>
                           <option value="Repetitor">Repetitor</option>
                           <option value="Til o'rgatuvchi">Til o'rgatuvchi</option>
                       </optgroup>
                       <optgroup label="üåæ Qishloq xo'jaligi">
                           <option value="Dehqon">Dehqon / Fermer</option>
                           <option value="Bog'bon">Bog'bon</option>
                           <option value="Chorvador">Chorvador</option>
                           <option value="Veterinar">Veterinar</option>
                       </optgroup>
                       <optgroup label="üîß Texnik xizmatlar">
                           <option value="Avtomexanik">Avtomexanik / Avtomaster</option>
                           <option value="Telefon ustasi">Telefon ustasi</option>
                           <option value="Maishiy texnika ustasi">Maishiy texnika ustasi</option>
                           <option value="Lift ustasi">Lift ustasi</option>
                       </optgroup>
                       <optgroup label="üì¶ Boshqa">
                           <option value="Istalgan ish">Istalgan ish</option>
                           <option value="Boshqa">Boshqa</option>
                       </optgroup>
                   </select>
               </div>
               <div class="form-group full-width conditional-field js-boshqa-ish-input" style="display: none;">
                   <label><i class="fas fa-edit" style="color: #8b5cf6;"></i> Qanday ishda ishlamoqchi (yozing)</label>
                   <input name="boshqa_ish_turi" class="js-transliterate" placeholder="Masalan: Mebelchi, Avtoelektrik...">
               </div>
             </div>
             
             <div class="form-row full-width conditional-field js-migration-details"><div class="form-group"><label>Qaysi davlatda</label><input name="migration_country" class="js-alpha-input js-transliterate"></div><div class="form-group"><label>Ketgan sanasi</label><input name="migration_duration" class="js-date-input" placeholder="DD.MM.YYYY" maxlength="10"></div></div>
             <div class="form-row full-width conditional-field js-returned-migration-details"><div class="form-group"><label>Qaysi davlatdan qaytgan</label><input name="returned_migration_country" class="js-alpha-input js-transliterate"></div><div class="form-group"><label>Qachon qaytgan</label><input name="returned_migration_date" class="js-date-input" placeholder="DD.MM.YYYY" maxlength="10" inputmode="numeric"></div><div class="form-group"><label>Hozirgi holati</label><select name="returned_migration_current_status" class="js-employment-status-sub" data-optional="true"></select></div></div>
            <div class="form-group full-width conditional-field js-toifa-turi inspector-only-section">
                <label>Toifa turi</label>
                <div id="toifa-checkboxes-container"></div>
            </div>
            
            <!-- Shaxs toifasi - faqat inspektor uchun -->
            <div class="form-group full-width inspector-only-section">
                <label>Shaxs toifasi</label>
                <select name="shaxs_toifasi" class="js-shaxs-toifasi">
                    <option value="Yo'q" selected>Yo'q</option>
                    <option value="Ha">Ha</option>
                </select>
            </div>
            
            <div id="pxt-details" class="form-row full-width conditional-field inspector-only-section">
                <div class="form-group"><label>PXT Uchrashuv Sanasi</label><input name="uchrashuv_sanasi" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric"></div>
                <div class="form-group"><label>PXT Yakuniy Sana</label><input name="yakuniy_sana" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric"></div>
            </div>
            <div id="probatsiya-details" class="form-row full-width conditional-field inspector-only-section">
                <div class="form-group"><label>Probatsiya Uchrashuv Sanasi</label><input name="probatsiya_uchrashuv_sanasi" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric"></div>
                <div class="form-group"><label>Probatsiya Yakuniy Sana</label><input name="probatsiya_yakuniy_sana" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric"></div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- QO'SHIMCHA BO'LIMLAR - ZAMONAVIY DIZAYN -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="extra-sections-container">

                <!-- 1. XAVFSIZLIK VA NAZORAT (Faqat Inspektor) -->
                <div class="extra-section inspector-only-section" id="section-security">
                    <button type="button" class="extra-section-header" onclick="toggleExtraSection(this)">
                        <div class="section-icon red"><i class="fas fa-shield-alt"></i></div>
                        <span class="section-title-text">Xavfsizlik va Nazorat</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </button>
                    <div class="extra-section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Sudlanganlik holati</label>
                                <select name="sudlanganlik" class="js-sudlanganlik">
                                    <option value="Yo'q" selected>Yo'q</option>
                                    <option value="Ha">Ha</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Qurolga egalik</label>
                                <select name="qurol_egalik" class="js-qurol-egalik">
                                    <option value="Yo'q" selected>Yo'q</option>
                                    <option value="Ha">Ha</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row conditional-field js-sudlanganlik-details" style="display: none;">
                            <div class="form-group">
                                <label>JK moddasi</label>
                                <input name="jk_moddasi" placeholder="168-modda (o'g'irlik)" data-optional="true">
                            </div>
                            <div class="form-group">
                                <label>Ozodlikka chiqqan sana</label>
                                <input name="jazo_qaytgan_sana" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric" data-optional="true">
                            </div>
                        </div>
                        <div class="conditional-field js-qurol-details" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Qurol turi/nomi</label>
                                    <select name="qurol_turi" data-optional="true">
                                        <option value="">Tanlang...</option>
                                        <option value="Ov miltig'i">Ov miltig'i</option>
                                        <option value="Gazli to'pponcha">Gazli to'pponcha</option>
                                        <option value="Travmatik">Travmatik qurol</option>
                                        <option value="Pnevmatik">Pnevmatik qurol</option>
                                        <option value="Xolodnoye">Xolodnoye qurol</option>
                                        <option value="Boshqa">Boshqa</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ruxsatnoma raqami</label>
                                    <input name="qurol_ruxsatnoma" placeholder="Raqam" data-optional="true">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ruxsatnoma tugash sanasi</label>
                                    <input name="qurol_tugash_sana" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric" data-optional="true">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. XONADON TEXNIK HOLATI -->
                <div class="extra-section" id="section-technical">
                    <button type="button" class="extra-section-header" onclick="toggleExtraSection(this)">
                        <div class="section-icon blue"><i class="fas fa-home"></i></div>
                        <span class="section-title-text">Xonadon Texnik Holati</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </button>
                    <div class="extra-section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Kadastr raqami</label>
                                <input name="kadastr_raqami" placeholder="XX:XX:XX:XX:XX:XXXX" data-optional="true">
                            </div>
                            <div class="form-group">
                                <label>Isitish tizimi</label>
                                <select name="isitish_tizimi" data-optional="true">
                                    <option value="">Tanlang...</option>
                                    <option value="Markaziy">Markaziy isitish</option>
                                    <option value="Individual gazli">Individual gazli kotyol</option>
                                    <option value="O'tin/ko'mir">O'tin/ko'mir pech</option>
                                    <option value="Elektr">Elektr isitgich</option>
                                    <option value="Yo'q">Yo'q / Ishlamaydi</option>
                                </select>
                            </div>
                        </div>
                        <!-- GAZ -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>üî• Gaz</label>
                                <select name="gaz_hisoblagich" class="js-gaz-hisoblagich" data-optional="true">
                                    <option value="">Tanlang...</option>
                                    <option value="Ha">Ha (oddiy)</option>
                                    <option value="Aqlli">Aqlli hisoblagich</option>
                                    <option value="Yo'q">Yo'q</option>
                                </select>
                            </div>
                            <div class="form-group conditional-field js-gaz-litsavoy">
                                <label>Gaz litsevoy hisobi</label>
                                <input name="gaz_litsavoy" placeholder="Litsevoy raqam" data-optional="true">
                            </div>
                        </div>
                        <!-- ELEKTR -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>‚ö° Elektr</label>
                                <select name="elektr_hisoblagich" class="js-elektr-hisoblagich" data-optional="true">
                                    <option value="">Tanlang...</option>
                                    <option value="Ha">Ha (oddiy)</option>
                                    <option value="Aqlli">Aqlli hisoblagich</option>
                                    <option value="Yo'q">Yo'q</option>
                                </select>
                            </div>
                            <div class="form-group conditional-field js-elektr-litsavoy">
                                <label>Elektr litsevoy hisobi</label>
                                <input name="elektr_litsavoy" placeholder="Litsevoy raqam" data-optional="true">
                            </div>
                        </div>
                        <!-- SUV -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>üíß Suv</label>
                                <select name="suv_hisoblagich" class="js-suv-hisoblagich" data-optional="true">
                                    <option value="">Tanlang...</option>
                                    <option value="Ha">Ha (oddiy)</option>
                                    <option value="Aqlli">Aqlli hisoblagich</option>
                                    <option value="Yo'q">Yo'q</option>
                                </select>
                            </div>
                            <div class="form-group conditional-field js-suv-litsavoy">
                                <label>Suv litsevoy hisobi</label>
                                <input name="suv_litsavoy" placeholder="Litsevoy raqam" data-optional="true">
                            </div>
                        </div>
                        <!-- CHIQINDI -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>üóëÔ∏è Chiqindi</label>
                                <select name="chiqindi_xizmat" class="js-chiqindi-hisoblagich" data-optional="true">
                                    <option value="">Tanlang...</option>
                                    <option value="Ha">Ha - shartnoma bor</option>
                                    <option value="Yo'q">Yo'q</option>
                                </select>
                            </div>
                            <div class="form-group conditional-field js-chiqindi-litsavoy">
                                <label>Chiqindi shartnoma raqami</label>
                                <input name="chiqindi_litsavoy" placeholder="Shartnoma raqam" data-optional="true">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. AVTOMOBIL VA TRANSPORT -->
                <div class="extra-section" id="section-transport">
                    <button type="button" class="extra-section-header" onclick="toggleExtraSection(this)">
                        <div class="section-icon green"><i class="fas fa-car"></i></div>
                        <span class="section-title-text">Avtomobil va Transport</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </button>
                    <div class="extra-section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Shaxsiy avtomobili bormi?</label>
                                <select name="avtomobil_bor" class="js-avtomobil-bor" data-optional="true">
                                    <option value="Yo'q" selected>Yo'q</option>
                                    <option value="Ha">Ha</option>
                                </select>
                            </div>
                        </div>
                        <div class="conditional-field js-avtomobil-details" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Rusumi</label>
                                    <select name="avto_rusumi" data-optional="true">
                                        <option value="">Tanlang...</option>
                                        <option>Chevrolet Nexia-3</option>
                                        <option>Chevrolet Cobalt</option>
                                        <option>Chevrolet Lacetti</option>
                                        <option>Chevrolet Malibu</option>
                                        <option>Chevrolet Spark</option>
                                        <option>Chevrolet Tracker</option>
                                        <option>Chevrolet Damas</option>
                                        <option>Chevrolet Labo</option>
                                        <option>Daewoo Matiz</option>
                                        <option>Daewoo Nexia</option>
                                        <option>Kia</option>
                                        <option>Hyundai</option>
                                        <option>Toyota</option>
                                        <option>Mercedes</option>
                                        <option>BMW</option>
                                        <option>Boshqa</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Davlat raqami</label>
                                    <input name="avto_raqami" placeholder="01 A 123 AA" style="text-transform: uppercase;" data-optional="true">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Rangi</label>
                                    <select name="avto_rangi" data-optional="true">
                                        <option value="">Tanlang...</option>
                                        <option value="Oq">Oq</option>
                                        <option value="Qora">Qora</option>
                                        <option value="Kumush">Kumush</option>
                                        <option value="Kulrang">Kulrang</option>
                                        <option value="Qizil">Qizil</option>
                                        <option value="Ko'k">Ko'k</option>
                                        <option value="Yashil">Yashil</option>
                                        <option value="Sariq">Sariq</option>
                                        <option value="Jigarrang">Jigarrang</option>
                                        <option value="Boshqa">Boshqa</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ishonchnoma?</label>
                                    <select name="avto_ishonchnoma" data-optional="true">
                                        <option value="Yo'q" selected>Yo'q - O'z nomida</option>
                                        <option value="Ha">Ha - Ishonchnoma</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Gaz o'rnatilgan?</label>
                                    <select name="avto_gaz" data-optional="true">
                                        <option value="Yo'q" selected>Yo'q</option>
                                        <option value="Metan">Metan (HBO)</option>
                                        <option value="Propan">Propan</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. PSIXOLOGIK PORTRET VA QIZIQISHLAR -->
                <div class="extra-section" id="section-psychology">
                    <button type="button" class="extra-section-header" onclick="toggleExtraSection(this)">
                        <div class="section-icon purple"><i class="fas fa-brain"></i></div>
                        <span class="section-title-text">Psixologik Portret va Qiziqishlar</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </button>
                    <div class="extra-section-content">
                        <div class="form-group full-width">
                            <label style="margin-bottom: 0.75rem;">Qiziqishlari (Xobbi)</label>
                            <div class="mini-card-grid">
                                <label class="mini-card">
                                    <input type="checkbox" name="hobbi" value="Kitob o'qish" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                    <span class="mini-card-icon">üìö</span>
                                    <span class="mini-card-text">Kitob o'qish</span>
                                </label>
                                <label class="mini-card">
                                    <input type="checkbox" name="hobbi" value="Tikuvchilik" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                    <span class="mini-card-icon">üßµ</span>
                                    <span class="mini-card-text">Tikuvchilik</span>
                                </label>
                                <label class="mini-card">
                                    <input type="checkbox" name="hobbi" value="Sport" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                    <span class="mini-card-icon">‚öΩ</span>
                                    <span class="mini-card-text">Sport</span>
                                </label>
                                <label class="mini-card">
                                    <input type="checkbox" name="hobbi" value="Bog'dorchilik" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                    <span class="mini-card-icon">üå±</span>
                                    <span class="mini-card-text">Bog'dorchilik</span>
                                </label>
                                <label class="mini-card">
                                    <input type="checkbox" name="hobbi" value="Pazandachilik" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                    <span class="mini-card-icon">üç≥</span>
                                    <span class="mini-card-text">Pazandachilik</span>
                                </label>
                                <label class="mini-card">
                                    <input type="checkbox" name="hobbi" value="Texnika" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                    <span class="mini-card-icon">üîß</span>
                                    <span class="mini-card-text">Texnika</span>
                                </label>
                                <label class="mini-card">
                                    <input type="checkbox" name="hobbi" value="Musiqa" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                    <span class="mini-card-icon">üéµ</span>
                                    <span class="mini-card-text">Musiqa</span>
                                </label>
                                <label class="mini-card">
                                    <input type="checkbox" name="hobbi" value="Dasturlash" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                    <span class="mini-card-icon">üíª</span>
                                    <span class="mini-card-text">Dasturlash</span>
                                </label>
                                <label class="mini-card">
                                    <input type="checkbox" name="hobbi" value="Shaxmat" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                    <span class="mini-card-icon">‚ôüÔ∏è</span>
                                    <span class="mini-card-text">Shaxmat</span>
                                </label>
                                <label class="mini-card">
                                    <input type="checkbox" name="hobbi" value="Til o'rganish" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                    <span class="mini-card-icon">üåç</span>
                                    <span class="mini-card-text">Til o'rganish</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Psixologik yordamga ehtiyoj</label>
                                <select name="psixologik_yordam" data-optional="true">
                                    <option value="">Tanlang...</option>
                                    <option value="Yo'q">Yo'q</option>
                                    <option value="Ha">Ha</option>
                                    <option value="Bilmayman">Bilmayman</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label>Mahallaga qanday yordam berishi mumkin?</label>
                            <textarea name="mahalla_yordam" rows="2" placeholder="Masalan: yoshlarga shaxmat o'rgataman, payvandlash ishlarini qilaman..." data-optional="true" style="resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 5. AQLLI MAHALLA VA HUQUQIY MADAD -->
                <div class="extra-section" id="section-legal">
                    <button type="button" class="extra-section-header" onclick="toggleExtraSection(this)">
                        <div class="section-icon cyan"><i class="fas fa-balance-scale"></i></div>
                        <span class="section-title-text">Aqlli Mahalla va Huquqiy Madad</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </button>
                    <div class="extra-section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telegram kanaliga a'zomi?</label>
                                <select name="telegram_azo" data-optional="true">
                                    <option value="">Tanlang...</option>
                                    <option value="Ha">Ha</option>
                                    <option value="Yo'q">Yo'q</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Aliment muammosi</label>
                                <select name="aliment_muammo" data-optional="true">
                                    <option value="Yo'q" selected>Yo'q</option>
                                    <option value="Ha">Ha</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Yuridik maslahatga ehtiyoj</label>
                                <select name="yuridik_maslahat" data-optional="true">
                                    <option value="Yo'q" selected>Yo'q</option>
                                    <option value="Ha">Ha</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mulk hujjatlarida muammo</label>
                                <select name="mulk_muammo" data-optional="true">
                                    <option value="Yo'q" selected>Yo'q</option>
                                    <option value="Ha">Ha</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. OILANING IQTISODIY BARQARORLIGI -->
                <div class="extra-section" id="section-economy">
                    <button type="button" class="extra-section-header" onclick="toggleExtraSection(this)">
                        <div class="section-icon orange"><i class="fas fa-chart-line"></i></div>
                        <span class="section-title-text">Oilaning Iqtisodiy Barqarorligi</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </button>
                    <div class="extra-section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>O'rtacha oylik daromad</label>
                                <select name="oylik_daromad" data-optional="true">
                                    <option value="">Tanlang...</option>
                                    <option value="2 mln gacha">2 mln so'mgacha</option>
                                    <option value="2-5 mln">2-5 mln so'm</option>
                                    <option value="5-10 mln">5-10 mln so'm</option>
                                    <option value="10 mln+">10 mln so'mdan yuqori</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Oilada nechta kishi ishlaydi?</label>
                                <select name="ishlovchilar_soni" data-optional="true">
                                    <option value="">Tanlang...</option>
                                    <option value="0">Hech kim</option>
                                    <option value="1">1 kishi</option>
                                    <option value="2">2 kishi</option>
                                    <option value="3+">3 va undan ko'p</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
			<!-- 7. IJTIMOIY DAFTARLAR VA MODDIY YORDAM -->
<div class="extra-section" id="section-social-notebooks">
    <button type="button" class="extra-section-header" onclick="toggleExtraSection(this)">
        <div class="section-icon" style="background: rgba(236, 72, 153, 0.15); color: #ec4899;"><i class="fas fa-book-open"></i></div>
        <span class="section-title-text">Ijtimoiy Daftarlar va Moddiy Yordam</span>
        <i class="fas fa-chevron-down chevron-icon"></i>
    </button>
    <div class="extra-section-content">
        <div class="form-row">
            <div class="form-group">
                <label><i class="fas fa-female" style="color: #ec4899;"></i> Ayollar daftari</label>
                <select name="ayollar_daftari" data-optional="true">
                    <option value="">Tanlang...</option>
                    <option value="Ro'yxatda turadi">Ro'yxatda turadi (A'zo)</option>
                    <option value="Ro'yxatga olish kerak">Ro'yxatga olish kerak (Nomzod)</option>
                    <option value="Chiqarilgan">Daftardan chiqarilgan</option>
                    <option value="Yo'q" selected>Yo'q</option>
                </select>
            </div>
            <div class="form-group">
                <label><i class="fas fa-user-graduate" style="color: #8b5cf6;"></i> Yoshlar daftari</label>
                <select name="yoshlar_daftari" data-optional="true">
                    <option value="">Tanlang...</option>
                    <option value="Ro'yxatda turadi">Ro'yxatda turadi (A'zo)</option>
                    <option value="Ro'yxatga olish kerak">Ro'yxatga olish kerak (Nomzod)</option>
                    <option value="Chiqarilgan">Daftardan chiqarilgan</option>
                    <option value="Yo'q" selected>Yo'q</option>
                </select>
            </div>
        </div>
        <div class="form-group full-width">
            <label><i class="fas fa-hand-holding-usd" style="color: #10b981;"></i> Kambag'allik va Nafaqa</label>
            <select name="moddiy_yordam" data-optional="true">
                <option value="">Tanlang...</option>
                <option value="Bola puli oladi">Bola puli oladi</option>
                <option value="Nafaqa oladi">Moddiy yordam/Nafaqa oladi</option>
                <option value="Yo'q" selected>Yo'q</option>
            </select>
        </div>
    </div>
</div>
            <!-- QO'SHIMCHA BO'LIMLAR TUGADI -->

            <hr style="border:none; border-top:1px solid var(--border-color); margin: 1.5rem 0;">
            <button type="button" class="btn btn-secondary js-add-signature" data-form-id="add-form"><i class="fas fa-signature"></i> Imzo qo'shish</button>
            <div class="signature-preview-container" id="add-form-signature-preview"></div>
          </div>
        </form>
        <div class="form-navigation" style="display:flex;gap:1rem;margin-top:2rem;"><button type="button" class="btn btn-secondary js-prev-step" style="width:auto; flex-grow:1; margin-top:0;"><i class="fas fa-arrow-left"></i> Orqaga</button><button type="button" class="btn btn-primary js-next-step" style="width:auto; flex-grow:1; margin-top:0;">Davom etish <i class="fas fa-arrow-right"></i></button><button type="button" class="btn btn-success js-save-citizen" style="display:none; width:auto; flex-grow:1; margin-top:0;"><i class="fas fa-save"></i> Saqlash</button></div>
      </div>
      
      <div id="add-family-view" class="card view">
        <div class="form-title-wrapper" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <h3><span class="js-main-person-fio" style="font-weight:700; color:var(--primary-color);"></span> oila a'zosini qo'shish</h3>
          <i class="fas fa-user-secret shubhali-toggle js-shubhali-toggle" title="Shubhali shaxs sifatida belgilash" style="font-size:1.4rem;color:var(--secondary-color);cursor:pointer"></i>
        </div>
        <form id="add-family-form">
          <input type="hidden" name="shubhali_shaxs" value="Yo'q">
          <div class="form-row"><div class="form-group"><label>Qarindoshligi</label><select name="qarindoshligi" required><option selected disabled value="">Tanlang...</option><option>Oila boshi</option><option>Otasi</option><option>Onasi</option><option>Akasi</option><option>Opasi</option><option>Ukasi</option><option>Singlisi</option><option>Turmush o'rtog'i</option><option>O'g'li</option><option>Qizi</option><option>Boshqa</option></select></div><div class="form-group"><label>F.I.O.</label><input name="fio" class="js-alpha-input js-transliterate" required></div></div>
          <div class="form-row"><div class="form-group"><label>Jinsi</label><select name="jinsi" required><option value="" disabled selected>Tanlang...</option><option value="Erkak">Erkak</option><option value="Ayol">Ayol</option></select></div><div class="form-group"><label>Telefon raqami (9 raqam)</label><input name="telefon_number" maxlength="9" class="js-numeric-input" placeholder="901234567" inputmode="numeric" required></div></div>
          <div class="form-row"><div class="form-group full-width"><label>Hujjat turi</label><select name="hujjat_turi" class="js-hujjat-turi" required><option value="" selected disabled>Tanlang...</option><option value="Pasport">Pasport</option><option value="Metrka">Guvohnoma</option><option value="Chet el fuqarosi">Chet el fuqarosi</option></select></div></div>
          <div class="form-row conditional-field js-passport-fields"><div class="form-group"><label>Pasport seriyasi va raqami</label><div class="passport-inputs"><input name="passport_series" placeholder="AA" maxlength="2" class="js-alpha-upper-input"><input name="passport_number" placeholder="1234567" maxlength="7" inputmode="numeric" class="js-numeric-input"></div></div><div class="form-group"><label>JSHSHIR (14 ta raqam)</label><input name="jshshir" maxlength="14" inputmode="numeric" class="js-numeric-input"></div><div class="form-group"><label>Tug'ilgan sana</label><input name="dob" placeholder="DD.MM.YYYY" maxlength="10" inputmode="numeric" class="js-date-input"></div></div>
          <div class="form-row conditional-field js-metrka-fields"><div class="form-group full-width"><label>Guvohnoma seriyasi va raqami</label><div class="metrka-input-group"><select name="metrka_series" class="js-metrka-series"></select><input name="metrka_number" maxlength="8" inputmode="numeric" class="js-numeric-input"></div></div><div class="form-group"><label>Tug'ilgan sana</label><input name="metrka_dob" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric"></div></div>
          <div class="form-row conditional-field js-chet-el-fields">
                <div class="form-group">
                    <label><i class="fas fa-globe" style="color: #3b82f6;"></i> Davlat</label>
                    <select name="chet_el_davlati" class="js-country-select">
                        <option value="">Davlatni tanlang...</option>
                        <optgroup label="MDH davlatlari">
                            <option value="Rossiya">üá∑üá∫ Rossiya</option>
                            <option value="Qozog'iston">üá∞üáø Qozog'iston</option>
                            <option value="Qirg'iziston">üá∞üá¨ Qirg'iziston</option>
                            <option value="Tojikiston">üáπüáØ Tojikiston</option>
                            <option value="Turkmaniston">üáπüá≤ Turkmaniston</option>
                            <option value="Ozarbayjon">üá¶üáø Ozarbayjon</option>
                            <option value="Armaniston">üá¶üá≤ Armaniston</option>
                            <option value="Gruziya">üá¨üá™ Gruziya</option>
                            <option value="Belarus">üáßüáæ Belarus</option>
                            <option value="Ukraina">üá∫üá¶ Ukraina</option>
                            <option value="Moldova">üá≤üá© Moldova</option>
                        </optgroup>
                        <optgroup label="Osiyo">
                            <option value="Xitoy">üá®üá≥ Xitoy</option>
                            <option value="Hindiston">üáÆüá≥ Hindiston</option>
                            <option value="Pokiston">üáµüá∞ Pokiston</option>
                            <option value="Afg'oniston">üá¶üá´ Afg'oniston</option>
                            <option value="Eron">üáÆüá∑ Eron</option>
                            <option value="Turkiya">üáπüá∑ Turkiya</option>
                            <option value="Saudiya Arabistoni">üá∏üá¶ Saudiya Arabistoni</option>
                            <option value="BAA">üá¶üá™ Birlashgan Arab Amirliklari</option>
                            <option value="Qator">üá∂üá¶ Qator</option>
                            <option value="Kuvayt">üá∞üáº Kuvayt</option>
                            <option value="Iroq">üáÆüá∂ Iroq</option>
                            <option value="Isroil">üáÆüá± Isroil</option>
                            <option value="Yaponiya">üáØüáµ Yaponiya</option>
                            <option value="Janubiy Koreya">üá∞üá∑ Janubiy Koreya</option>
                            <option value="Malayziya">üá≤üáæ Malayziya</option>
                            <option value="Singapur">üá∏üá¨ Singapur</option>
                            <option value="Tailand">üáπüá≠ Tailand</option>
                            <option value="Vetnam">üáªüá≥ Vetnam</option>
                            <option value="Indoneziya">üáÆüá© Indoneziya</option>
                            <option value="Filippin">üáµüá≠ Filippin</option>
                            <option value="Bangladesh">üáßüá© Bangladesh</option>
                            <option value="Nepal">üá≥üáµ Nepal</option>
                            <option value="Shri-Lanka">üá±üá∞ Shri-Lanka</option>
                        </optgroup>
                        <optgroup label="Yevropa">
                            <option value="Germaniya">üá©üá™ Germaniya</option>
                            <option value="Fransiya">üá´üá∑ Fransiya</option>
                            <option value="Buyuk Britaniya">üá¨üáß Buyuk Britaniya</option>
                            <option value="Italiya">üáÆüáπ Italiya</option>
                            <option value="Ispaniya">üá™üá∏ Ispaniya</option>
                            <option value="Polsha">üáµüá± Polsha</option>
                            <option value="Niderlandiya">üá≥üá± Niderlandiya</option>
                            <option value="Belgiya">üáßüá™ Belgiya</option>
                            <option value="Shveytsariya">üá®üá≠ Shveytsariya</option>
                            <option value="Avstriya">üá¶üáπ Avstriya</option>
                            <option value="Chexiya">üá®üáø Chexiya</option>
                            <option value="Vengriya">üá≠üá∫ Vengriya</option>
                            <option value="Ruminiya">üá∑üá¥ Ruminiya</option>
                            <option value="Bolgariya">üáßüá¨ Bolgariya</option>
                            <option value="Serbiya">üá∑üá∏ Serbiya</option>
                            <option value="Xorvatiya">üá≠üá∑ Xorvatiya</option>
                            <option value="Gretsiya">üá¨üá∑ Gretsiya</option>
                            <option value="Portugaliya">üáµüáπ Portugaliya</option>
                            <option value="Shvetsiya">üá∏üá™ Shvetsiya</option>
                            <option value="Norvegiya">üá≥üá¥ Norvegiya</option>
                            <option value="Daniya">üá©üá∞ Daniya</option>
                            <option value="Finlyandiya">üá´üáÆ Finlyandiya</option>
                            <option value="Latviya">üá±üáª Latviya</option>
                            <option value="Litva">üá±üáπ Litva</option>
                            <option value="Estoniya">üá™üá™ Estoniya</option>
                        </optgroup>
                        <optgroup label="Amerika">
                            <option value="AQSH">üá∫üá∏ Amerika Qo'shma Shtatlari</option>
                            <option value="Kanada">üá®üá¶ Kanada</option>
                            <option value="Meksika">üá≤üáΩ Meksika</option>
                            <option value="Braziliya">üáßüá∑ Braziliya</option>
                            <option value="Argentina">üá¶üá∑ Argentina</option>
                            <option value="Chili">üá®üá± Chili</option>
                            <option value="Kolumbiya">üá®üá¥ Kolumbiya</option>
                            <option value="Peru">üáµüá™ Peru</option>
                            <option value="Venesuela">üáªüá™ Venesuela</option>
                            <option value="Kuba">üá®üá∫ Kuba</option>
                        </optgroup>
                        <optgroup label="Afrika">
                            <option value="Misr">üá™üá¨ Misr</option>
                            <option value="Marokash">üá≤üá¶ Marokash</option>
                            <option value="Jazoir">üá©üáø Jazoir</option>
                            <option value="Tunis">üáπüá≥ Tunis</option>
                            <option value="Liviya">üá±üáæ Liviya</option>
                            <option value="Janubiy Afrika">üáøüá¶ Janubiy Afrika</option>
                            <option value="Nigeriya">üá≥üá¨ Nigeriya</option>
                            <option value="Keniya">üá∞üá™ Keniya</option>
                            <option value="Efiopiya">üá™üáπ Efiopiya</option>
                        </optgroup>
                        <optgroup label="Okeaniya">
                            <option value="Avstraliya">üá¶üá∫ Avstraliya</option>
                            <option value="Yangi Zelandiya">üá≥üáø Yangi Zelandiya</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-passport" style="color: #8b5cf6;"></i> Pasport seriya va raqami</label>
                    <input name="chet_el_pasport" placeholder="Xorijiy pasport">
                </div>
                <div class="form-group full-width">
                    <label><i class="fas fa-calendar-alt" style="color: #f59e0b;"></i> Tug'ilgan sana</label>
                    <input name="chet_el_dob" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric">
                </div>
          </div>
          <div class="form-row"><div class="form-group full-width"><label>Bandlik holati</label>
            <select name="employmentStatus" class="js-employment-status" required>
                <option value="" disabled selected>Tanlang...</option>
                <option>Ishsiz</option>
                <option>Rasmiy band</option>
                <option>Norasmiy band</option>
                <option>Tadbirkor</option>
                <option>Talaba</option>
                <option>Maktab o'quchisi</option>
                <option>Bog'cha</option>
                <option>Ona qaramog'ida</option>
                <option>Nafaqada</option>
                <option>Nogironligi bor</option>
                <option>Uy bekasi</option>
                <option value="Dekret">Dekret</option>
                <option value="Migratsiya">Migratsiyada</option>
                <option value="Migratsiyadan qaytgan">Migratsiyadan qaytgan</option>
            </select>
          </div>
          <div class="form-row full-width conditional-field js-study-details"><div class="form-group"><label class="js-oqish-joyi-label">O'qish joyi</label><input name="oqish_joyi" class="js-transliterate"></div><div class="form-group"><label class="js-kursi-sinfi-label">Kursi/Sinfi</label><input name="kursi_sinfi" inputmode="numeric"></div></div><div class="form-group full-width conditional-field js-employment-details"><label>Ish joyi</label><input name="employmentDetails" class="js-transliterate"></div><div class="form-group full-width conditional-field js-bogcha-details"><label>Bog'cha nomi yoki raqami</label><input name="bogcha_nomi" class="js-transliterate"></div><div class="form-group full-width conditional-field js-disability-group"><label>Nogironlik guruhi</label><select name="disabilityGroup"><option value="" disabled selected>Tanlang...</option><option>1-guruh</option><option>2-guruh</option><option>3-guruh</option><option>Bolalikdan nogiron</option></select></div>
          
          <!-- ISHSIZ UCHUN QOSHIMCHA MA'LUMOTLAR -->
          <div class="form-row full-width conditional-field js-unemployed-details" style="display: none;">
            <div class="form-group">
                <label><i class="fas fa-graduation-cap" style="color: #8b5cf6;"></i> Ma'lumoti</label>
                <select name="malumoti" class="js-education-level">
                    <option value="">Tanlang...</option>
                    <option value="Oliy">Oliy</option>
                    <option value="O'rta-maxsus">O'rta-maxsus</option>
                    <option value="O'rta">O'rta</option>
                    <option value="Boshlang'ich">Boshlang'ich</option>
                    <option value="To'liqsiz o'rta">To'liqsiz o'rta</option>
                </select>
            </div>
            <div class="form-group">
                <label><i class="fas fa-briefcase" style="color: #10b981;"></i> Qanday ishda ishlamoqchi</label>
                <select name="ishlash_yonalishi" class="js-job-category">
                    <option value="">Ish yo'nalishini tanlang...</option>
                    <optgroup label="üèóÔ∏è Qurilish va Ta'mirlash">
                        <option value="Qurilishchi">Qurilishchi</option>
                        <option value="Elektrik">Elektrik</option>
                        <option value="Santexnik">Santexnik</option>
                        <option value="Suvokchi">Suvokchi</option>
                        <option value="Bo'yoqchi">Bo'yoqchi</option>
                        <option value="Duradgor">Duradgor / Yog'ochchi</option>
                        <option value="Payvandchi">Payvandchi</option>
                        <option value="Chinakchi">G'ishtchi / Chinakchi</option>
                        <option value="Plitachi">Plitachi / Kofechi</option>
                        <option value="Konditsioner ustasi">Konditsioner ustasi</option>
                    </optgroup>
                    <optgroup label="üöó Transport va Haydovchilik">
                        <option value="Yengil avtomobil haydovchisi">Yengil avtomobil haydovchisi</option>
                        <option value="Yuk mashinasi haydovchisi">Yuk mashinasi haydovchisi</option>
                        <option value="Avtobus haydovchisi">Avtobus haydovchisi</option>
                        <option value="Taksi haydovchisi">Taksi haydovchisi</option>
                        <option value="Kuryer">Kuryer / Yetkazib beruvchi</option>
                        <option value="Traktor haydovchisi">Traktor haydovchisi</option>
                        <option value="Ekskavator operatori">Ekskavator operatori</option>
                    </optgroup>
                    <optgroup label="üè≠ Ishlab chiqarish">
                        <option value="Ishchi">Oddiy ishchi</option>
                        <option value="Operator">Mashina operatori</option>
                        <option value="Omborchi">Omborchi / Yuklovchi</option>
                        <option value="Qadoqlovchi">Qadoqlovchi</option>
                        <option value="Tokar">Tokar / Frezerchi</option>
                        <option value="Slesar">Slesar / Mexanik</option>
                    </optgroup>
                    <optgroup label="üç≥ Oshxona va Oziq-ovqat">
                        <option value="Oshpaz">Oshpaz</option>
                        <option value="Oshpaz yordamchisi">Oshpaz yordamchisi</option>
                        <option value="Ofitsiant">Ofitsiant</option>
                        <option value="Barmen">Barmen</option>
                        <option value="Novvoy">Novvoy / Non pishiruvchi</option>
                        <option value="Qandolat ustasi">Qandolat ustasi</option>
                    </optgroup>
                    <optgroup label="üßµ Tikuvchilik va To'qimachilik">
                        <option value="Tikuvchi">Tikuvchi</option>
                        <option value="Kesuvchi">Kesuvchi / Bichovchi</option>
                        <option value="Andozachi">Andozachi</option>
                        <option value="Kashtachi">Kashtachi</option>
                        <option value="Trikotaj tikuvchisi">Trikotaj tikuvchisi</option>
                    </optgroup>
                    <optgroup label="üíá Go'zallik xizmatlari">
                        <option value="Sartarosh erkaklar">Sartarosh (erkaklar)</option>
                        <option value="Sartarosh ayollar">Sartarosh (ayollar)</option>
                        <option value="Kosmetolog">Kosmetolog</option>
                        <option value="Manikurchi">Manikurchi / Pedikurchi</option>
                        <option value="Vizajist">Vizajist</option>
                        <option value="Massajist">Massajist</option>
                    </optgroup>
                    <optgroup label="üè¢ Ofis va Xizmat">
                        <option value="Buxgalter">Buxgalter</option>
                        <option value="Kotiba">Kotiba / Ofis-menejer</option>
                        <option value="Kassir">Kassir</option>
                        <option value="Sotuvchi">Sotuvchi / Konsultant</option>
                        <option value="Menejer">Menejer</option>
                        <option value="Qo'riqchi">Qo'riqchi / Xavfsizlik</option>
                        <option value="Farrosh">Farrosh / Tozalagich</option>
                        <option value="Administrator">Administrator</option>
                    </optgroup>
                    <optgroup label="üíª IT va Texnologiya">
                        <option value="Dasturchi">Dasturchi / Programmer</option>
                        <option value="Veb-dizayner">Veb-dizayner</option>
                        <option value="Grafik dizayner">Grafik dizayner</option>
                        <option value="SMM mutaxassisi">SMM mutaxassisi</option>
                        <option value="Kompyuter ustasi">Kompyuter ustasi</option>
                        <option value="Videograf">Videograf / Videomontajchi</option>
                        <option value="Fotograf">Fotograf</option>
                    </optgroup>
                    <optgroup label="üè• Tibbiyot va Salomatlik">
                        <option value="Hamshira">Hamshira</option>
                        <option value="Tibbiy xodim">Tibbiy xodim</option>
                        <option value="Farmatsevt">Farmatsevt</option>
                        <option value="Laborant">Laborant</option>
                        <option value="Enaga">Enaga / Parvarish</option>
                    </optgroup>
                    <optgroup label="üéì Ta'lim">
                        <option value="O'qituvchi">O'qituvchi</option>
                        <option value="Tarbiyachi">Tarbiyachi</option>
                        <option value="Repetitor">Repetitor</option>
                        <option value="Til o'rgatuvchi">Til o'rgatuvchi</option>
                    </optgroup>
                    <optgroup label="üåæ Qishloq xo'jaligi">
                        <option value="Dehqon">Dehqon / Fermer</option>
                        <option value="Bog'bon">Bog'bon</option>
                        <option value="Chorvador">Chorvador</option>
                        <option value="Veterinar">Veterinar</option>
                    </optgroup>
                    <optgroup label="üîß Texnik xizmatlar">
                        <option value="Avtomexanik">Avtomexanik / Avtomaster</option>
                        <option value="Telefon ustasi">Telefon ustasi</option>
                        <option value="Maishiy texnika ustasi">Maishiy texnika ustasi</option>
                        <option value="Lift ustasi">Lift ustasi</option>
                    </optgroup>
                    <optgroup label="üì¶ Boshqa">
                        <option value="Istalgan ish">Istalgan ish</option>
                        <option value="Boshqa">Boshqa</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group full-width conditional-field js-boshqa-ish-input" style="display: none;">
                <label><i class="fas fa-edit" style="color: #8b5cf6;"></i> Qanday ishda ishlamoqchi (yozing)</label>
                <input name="boshqa_ish_turi" class="js-transliterate" placeholder="Masalan: Mebelchi, Avtoelektrik...">
            </div>
          </div>
          
          <div class="form-row full-width conditional-field js-migration-details"><div class="form-group"><label>Qaysi davlatda</label><input name="migration_country" class="js-alpha-input js-transliterate"></div><div class="form-group"><label>Ketgan sanasi</label><input name="migration_duration" class="js-date-input" placeholder="DD.MM.YYYY" maxlength="10"></div></div>
          <div class="form-row full-width conditional-field js-returned-migration-details"><div class="form-group"><label>Qaysi davlatdan qaytgan</label><input name="returned_migration_country" class="js-alpha-input js-transliterate"></div><div class="form-group"><label>Qachon qaytgan</label><input name="returned_migration_date" class="js-date-input" placeholder="DD.MM.YYYY" maxlength="10" inputmode="numeric"></div>
          <div class="form-group"><label>Hozirgi holati</label><select name="returned_migration_current_status" class="js-employment-status-sub" data-optional="true"></select></div></div>
          <div class="form-group full-width"><label>Muammosi</label><textarea name="izoh" data-optional="true" rows="3" class="js-transliterate"></textarea></div></div>
        </form>
        <button class="btn btn-success js-save-family-member" style="margin-top:2rem;"><i class="fas fa-save"></i> Oila A'zosini Saqlash</button>
        <button class="btn btn-cancel js-cancel"><i class="fas fa-times"></i> Bekor qilish</button>
      </div>

    </main>
    <div class="fab-container">
        <button id="fab-show-ai" class="fab fab-list" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" title="O'zbegim AI - Har qanday savol bering!"><i class="fas fa-brain"></i></button>
        <button id="fab-show-full-list" class="fab fab-list" title="Jami ro'yxat"><i class="fas fa-list-ul"></i></button>
        <button id="fab-show-objects" class="fab fab-objects" title="Ijtimoiy ob'ektlar va Xarita"><i class="fas fa-store-alt"></i></button>
        <button id="fab-show-summary" class="fab fab-summary" title="Aholi statistikasi"><i class="fas fa-chart-pie"></i></button>
        <button id="fab-analytics" class="fab fab-list" style="background:#3b82f6;" title="Analitika"><i class="fas fa-chart-bar"></i></button>
        <button id="fab-add-citizen" class="fab fab-add" title="Yangi fuqaro qo'shish"><i class="fas fa-plus"></i></button>
    </div>
    <div id="alert-modal" class="modal-overlay"><div class="modal-box"><h4 id="alert-title">Xabar</h4><p id="alert-message">Matn</p><div class="button-group" style="display:flex;gap:1rem;margin-top:1.5rem;"><button class="btn btn-primary js-alert-ok" style="width:auto;flex-grow:1;">OK</button><button class="btn btn-cancel js-alert-cancel" style="width:auto;flex-grow:1;margin-top:0;">Bekor</button></div></div></div>
    <div id="details-modal" class="modal-overlay">
      <div id="details-modal-box" class="modal-box">
        <button class="modal-close-btn js-back-to-previous-view" id="details-modal-close"><i class="fas fa-times"></i></button>
        <div id="details-content"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary js-back-to-previous-view"><i class="fas fa-arrow-left"></i> Qaytish</button>
            <button class="btn btn-primary" id="js-download-pdf"><i class="fas fa-file-pdf"></i> PDF Yuklab Olish</button>
        </div>
      </div>
    </div>
    <div id="summary-modal" class="modal-overlay">
      <div class="modal-box" style="max-width: 95%; width: 1100px; max-height: 90vh; overflow-y: auto;">
        <button class="modal-close-btn js-back-to-previous-view" id="summary-modal-close"><i class="fas fa-times"></i></button>
        <div id="summary-content-wrapper">
          <div id="summary-grid-container">
            <h3 id="summary-title" style="margin-bottom: 1.5rem;"><i class="fas fa-chart-pie"></i> Aholi Statistikasi</h3>
            
            <!-- ASOSIY STATISTIKA -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
              <div class="summary-stat-card" data-category="total" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer;">
                <div style="font-size: 2rem; font-weight: 700;" id="stat-total">0</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Jami aholi</div>
              </div>
              <div class="summary-stat-card" data-category="households" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer;">
                <div style="font-size: 2rem; font-weight: 700;" id="stat-households">0</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Xonadonlar</div>
              </div>
              <div class="summary-stat-card" data-category="families" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer;">
                <div style="font-size: 2rem; font-weight: 700;" id="stat-families">0</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Oilalar</div>
              </div>
              <div class="summary-stat-card" data-category="problem" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer;">
                <div style="font-size: 2rem; font-weight: 700;" id="stat-problem">0</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Muammosi bor</div>
              </div>
            </div>
            
            <!-- DEMOGRAFIK -->
            <h4 style="margin: 1rem 0 0.75rem; color: var(--primary-color);"><i class="fas fa-users"></i> Demografik ko'rsatkichlar</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem;">
              <div class="summary-stat-card" data-category="men" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-male" style="font-size: 1.25rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-men">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Erkaklar</div>
              </div>
              <div class="summary-stat-card" data-category="women" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-female" style="font-size: 1.25rem; color: #ec4899; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-women">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Ayollar</div>
              </div>
              <div class="summary-stat-card" data-category="youth" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-user-graduate" style="font-size: 1.25rem; color: #8b5cf6; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-youth">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Yoshlar (14-30)</div>
              </div>
              <div class="summary-stat-card" data-category="seniors" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-person-cane" style="font-size: 1.25rem; color: #f97316; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-seniors">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Keksalar (80+)</div>
              </div>
              <div class="summary-stat-card" data-category="disabled" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-wheelchair" style="font-size: 1.25rem; color: #06b6d4; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-disabled">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Nogironlar</div>
              </div>
            </div>
            
            <!-- BANDLIK HOLATI -->
            <h4 style="margin: 1rem 0 0.75rem; color: #10b981;"><i class="fas fa-briefcase"></i> Bandlik holati</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem;">
              <div class="summary-stat-card" data-category="employed" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-user-tie" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-employed">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Band</div>
              </div>
              <div class="summary-stat-card" data-category="unemployed" style="background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-user-clock" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-unemployed">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Ishsiz</div>
              </div>
              <div class="summary-stat-card" data-category="students" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-graduation-cap" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-students">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Talabalar</div>
              </div>
              <div class="summary-stat-card" data-category="migrants" style="background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-plane-departure" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-migrants">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Migrantlar</div>
              </div>
              <div class="summary-stat-card" data-category="returned-migrants" style="background: linear-gradient(135deg, #14b8a6 0%, #2dd4bf 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-plane-arrival" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-returned-migrants">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Qaytgan</div>
              </div>
            </div>
            
            <!-- OILAVIY HOLAT -->
            <h4 style="margin: 1rem 0 0.75rem; color: #ec4899;"><i class="fas fa-heart"></i> Oilaviy holat</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem;">
              <div class="summary-stat-card" data-category="divorced" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-heart-crack" style="font-size: 1.25rem; color: #ef4444; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-divorced">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Ajrashgan</div>
              </div>
              <div class="summary-stat-card" data-category="verge-of-divorce" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-people-arrows" style="font-size: 1.25rem; color: #f97316; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-verge-of-divorce">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Ajrim yoqasida</div>
              </div>
              <div class="summary-stat-card" data-category="renters" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-key" style="font-size: 1.25rem; color: #8b5cf6; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-renters">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Ijarachilar</div>
              </div>
              <div class="summary-stat-card" data-category="temporary" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-clock" style="font-size: 1.25rem; color: #06b6d4; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-temporary">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Vaqtincha</div>
              </div>
            </div>
            
            <!-- XONADON TEXNIK HOLATI -->
            <h4 style="margin: 1rem 0 0.75rem; color: #3b82f6;"><i class="fas fa-home"></i> Xonadon Texnik Holati</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem;">
              <div class="summary-stat-card" data-category="gaz-aqlli" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-fire" style="font-size: 1.25rem; color: #f97316; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-gaz-aqlli">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Aqlli gaz</div>
              </div>
              <div class="summary-stat-card" data-category="elektr-aqlli" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-bolt" style="font-size: 1.25rem; color: #eab308; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-elektr-aqlli">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Aqlli elektr</div>
              </div>
              <div class="summary-stat-card" data-category="suv-aqlli" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-tint" style="font-size: 1.25rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-suv-aqlli">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Aqlli suv</div>
              </div>
              <div class="summary-stat-card" data-category="isitish-yoq" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-snowflake" style="font-size: 1.25rem; color: #ef4444; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-isitish-yoq">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Isitish yo'q</div>
              </div>
              <div class="summary-stat-card" data-category="avtomobil" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-car" style="font-size: 1.25rem; color: #10b981; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-avtomobil">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Avtomobil</div>
              </div>
              <div class="summary-stat-card" data-category="ishonchnoma" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-file-signature" style="font-size: 1.25rem; color: #8b5cf6; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-ishonchnoma">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Ishonchnoma</div>
              </div>
            </div>
            
            <!-- HUQUQIY HOLAT -->
            <h4 style="margin: 1rem 0 0.75rem; color: #8b5cf6;"><i class="fas fa-balance-scale"></i> Huquqiy Holat</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem;">
              <div class="summary-stat-card" data-category="aliment" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-child" style="font-size: 1.25rem; color: #ef4444; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-aliment">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Aliment</div>
              </div>
              <div class="summary-stat-card" data-category="yuridik" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-gavel" style="font-size: 1.25rem; color: #8b5cf6; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-yuridik">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Yuridik yordam</div>
              </div>
              <div class="summary-stat-card" data-category="mulk-muammo" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-file-alt" style="font-size: 1.25rem; color: #f97316; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-mulk-muammo">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Mulk muammo</div>
              </div>
              <div class="summary-stat-card" data-category="telegram-yoq" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fab fa-telegram" style="font-size: 1.25rem; color: #0088cc; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-telegram-yoq">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Telegram emas</div>
              </div>
              <div class="summary-stat-card" data-category="daromad-past" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-coins" style="font-size: 1.25rem; color: #ef4444; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-daromad-past">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Past daromad</div>
              </div>
              <div class="summary-stat-card" data-category="ishlovchi-yoq" style="background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-user-slash" style="font-size: 1.25rem; color: #f97316; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-ishlovchi-yoq">0</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">Ishlovchi yo'q</div>
              </div>
            </div>
            
            <!-- IJTIMOIY DAFTARLAR VA MODDIY YORDAM -->
            <h4 style="margin: 1rem 0 0.75rem; color: #ec4899;"><i class="fas fa-book-open"></i> Ijtimoiy Daftarlar va Moddiy Yordam</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem;">
              <div class="summary-stat-card" data-category="ayollar-daftari" style="background: linear-gradient(135deg, #db2777 0%, #ec4899 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-female" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-ayollar-daftari">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Ayollar daftari</div>
              </div>
              <div class="summary-stat-card" data-category="yoshlar-daftari" style="background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-user-graduate" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-yoshlar-daftari">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Yoshlar daftari</div>
              </div>
              <div class="summary-stat-card" data-category="moddiy-yordam" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-hand-holding-usd" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-moddiy-yordam">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Moddiy yordam</div>
              </div>
              <div class="summary-stat-card" data-category="neet" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-exclamation-triangle" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-neet">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">NEET yoshlar</div>
              </div>
              <div class="summary-stat-card" data-category="xavfli" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                <i class="fas fa-shield-alt" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.5rem; font-weight: 700;" id="stat-xavfli">0</div>
                <div style="font-size: 0.75rem; opacity: 0.9;">Xavfli fuqarolar</div>
              </div>
            </div>
            
            <!-- INSPEKTOR STATISTIKASI (faqat maxsus rollarga) -->
            <div id="summary-inspector-section" style="display: none;">
              <h4 style="margin: 1rem 0 0.75rem; color: #ef4444;"><i class="fas fa-shield-alt"></i> Profilaktika Inspektori</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
                <div class="summary-stat-card" data-category="shubhali" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                  <i class="fas fa-user-secret" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                  <div style="font-size: 1.5rem; font-weight: 700;" id="stat-shubhali">0</div>
                  <div style="font-size: 0.75rem; opacity: 0.9;">Shubhali</div>
                </div>
                <div class="summary-stat-card" data-category="toifadagilar" style="background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                  <i class="fas fa-user-shield" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                  <div style="font-size: 1.5rem; font-weight: 700;" id="stat-toifadagilar">0</div>
                  <div style="font-size: 0.75rem; opacity: 0.9;">Toifadagi</div>
                </div>
                <div class="summary-stat-card" data-category="pxt" style="background: linear-gradient(135deg, #be123c 0%, #e11d48 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                  <i class="fas fa-gavel" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                  <div style="font-size: 1.5rem; font-weight: 700;" id="stat-pxt">0</div>
                  <div style="font-size: 0.75rem; opacity: 0.9;">PXT</div>
                </div>
                <div class="summary-stat-card" data-category="probatsiya" style="background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                  <i class="fas fa-user-check" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                  <div style="font-size: 1.5rem; font-weight: 700;" id="stat-probatsiya">0</div>
                  <div style="font-size: 0.75rem; opacity: 0.9;">Probatsiya</div>
                </div>
                <div class="summary-stat-card" data-category="sudlangan" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                  <i class="fas fa-balance-scale" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                  <div style="font-size: 1.5rem; font-weight: 700;" id="stat-sudlangan">0</div>
                  <div style="font-size: 0.75rem; opacity: 0.9;">Sudlangan</div>
                </div>
                <div class="summary-stat-card" data-category="qurol" style="background: linear-gradient(135deg, #78350f 0%, #92400e 100%); color: white; padding: 1rem; border-radius: 10px; text-align: center; cursor: pointer;">
                  <i class="fas fa-crosshairs" style="font-size: 1.25rem; margin-bottom: 0.5rem;"></i>
                  <div style="font-size: 1.5rem; font-weight: 700;" id="stat-qurol">0</div>
                  <div style="font-size: 0.75rem; opacity: 0.9;">Qurol</div>
                </div>
              </div>
            </div>
            
          </div>
        </div>
        <button class="btn btn-secondary js-back-to-previous-view" style="width:auto; margin-top:1rem;"><i class="fas fa-arrow-left"></i> Qaytish</button>
      </div>
    </div>

    <!-- ANALITIKA MODAL - GRAFIKLAR VA BANDLIK -->
    <div id="analytics-modal" class="modal-overlay">
      <div class="modal-box" style="max-width: 95%; width: 1200px; max-height: 90vh; overflow-y: auto;">
        <button class="modal-close-btn" id="analytics-modal-close" onclick="document.getElementById('analytics-modal').style.display='none'; showScreen('search-view');"><i class="fas fa-times"></i></button>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
          <h3 style="margin: 0;"><i class="fas fa-chart-bar"></i> Analitika va Grafiklar</h3>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-primary" id="btn-backup-data" style="width: auto; margin: 0;"><i class="fas fa-download"></i> Zaxira</button>
            <button class="btn btn-secondary" id="btn-restore-data" style="width: auto; margin: 0;"><i class="fas fa-upload"></i> Tiklash</button>
            <button class="btn btn-success" id="export-analytics-excel" style="width: auto; margin: 0;"><i class="fas fa-file-excel"></i> Excel</button>
          </div>
        </div>
        
        <!-- Tezkor statistika kartochkalari -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="analytics-top-card" onclick="showCategoryDetail('all')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <div style="font-size: 2.5rem; font-weight: 700;" id="analytics-total">0</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Jami aholi</div>
          </div>
          <div class="analytics-top-card" onclick="showCategoryDetail('band')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <div style="font-size: 2.5rem; font-weight: 700;" id="analytics-employed">0</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Band</div>
          </div>
          <div class="analytics-top-card" onclick="showCategoryDetail('ishsiz')" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <div style="font-size: 2.5rem; font-weight: 700;" id="analytics-unemployed">0</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Ishsiz</div>
          </div>
          <div class="analytics-top-card" onclick="showCategoryDetail('ijara')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <div style="font-size: 2.5rem; font-weight: 700;" id="analytics-renters">0</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Ijarachilar</div>
          </div>
        </div>
        
        <!-- NEET Yoshlar va Risk Skoring -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="analytics-top-card" onclick="showCategoryDetail('neet')" style="background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white; padding: 1rem; border-radius: 12px; cursor: pointer;">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <i class="fas fa-exclamation-triangle" style="font-size: 2rem;"></i>
              <div>
                <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-neet">0</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">NEET Yoshlar (18-30, ishsiz, o'qimaydi)</div>
              </div>
            </div>
          </div>
          <div class="analytics-top-card" onclick="showCategoryDetail('risk')" style="background: linear-gradient(135deg, #f12711 0%, #f5af19 100%); color: white; padding: 1rem; border-radius: 12px; cursor: pointer;">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <i class="fas fa-shield-alt" style="font-size: 2rem;"></i>
              <div>
                <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-highrisk">0</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Yuqori xavf darajasidagi fuqarolar</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- YANGI STATISTIKA - Texnik va Huquqiy -->
        <h4 style="margin: 1.5rem 0 1rem; color: var(--text-light);"><i class="fas fa-home"></i> Xonadon va Huquqiy Holat</h4>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="analytics-top-card" onclick="showCategoryDetail('avtomobil')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <i class="fas fa-car" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-avtomobil">0</div>
            <div style="font-size: 0.8rem; opacity: 0.9;">Avtomobil</div>
          </div>
          <div class="analytics-top-card" onclick="showCategoryDetail('telegram-yoq')" style="background: linear-gradient(135deg, #0088cc 0%, #00d4ff 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <i class="fab fa-telegram" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-telegram-yoq">0</div>
            <div style="font-size: 0.8rem; opacity: 0.9;">Telegram emas</div>
          </div>
          <div class="analytics-top-card" onclick="showCategoryDetail('aliment')" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <i class="fas fa-child" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-aliment">0</div>
            <div style="font-size: 0.8rem; opacity: 0.9;">Aliment muammo</div>
          </div>
          <div class="analytics-top-card" onclick="showCategoryDetail('yuridik')" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <i class="fas fa-balance-scale" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-yuridik">0</div>
            <div style="font-size: 0.8rem; opacity: 0.9;">Yuridik yordam</div>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="analytics-top-card" onclick="showCategoryDetail('daromad-past')" style="background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <i class="fas fa-coins" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-daromad-past">0</div>
            <div style="font-size: 0.8rem; opacity: 0.9;">Past daromad</div>
          </div>
          <div class="analytics-top-card" onclick="showCategoryDetail('ishlovchi-yoq')" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <i class="fas fa-user-slash" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-ishlovchi-yoq">0</div>
            <div style="font-size: 0.8rem; opacity: 0.9;">Ishlovchi yo'q</div>
          </div>
          <div class="analytics-top-card" onclick="showCategoryDetail('gaz-aqlli')" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <i class="fas fa-fire" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-gaz-aqlli">0</div>
            <div style="font-size: 0.8rem; opacity: 0.9;">Aqlli gaz</div>
          </div>
          <div class="analytics-top-card" onclick="showCategoryDetail('isitish-yoq')" style="background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
            <i class="fas fa-snowflake" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-isitish-yoq">0</div>
            <div style="font-size: 0.8rem; opacity: 0.9;">Isitish yo'q</div>
          </div>
        </div>
        
        <!-- INSPEKTOR STATISTIKASI (faqat 2304, 2528, 4161, 1909 rollari) -->
        <div id="inspector-analytics-section" style="display: none;">
          <h4 style="margin: 1.5rem 0 1rem; color: #ef4444;"><i class="fas fa-shield-alt"></i> Profilaktika Inspektori Statistikasi</h4>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            <div class="analytics-top-card" onclick="showCategoryDetail('pxt')" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
              <i class="fas fa-user-secret" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-pxt">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">PXT nazoratida</div>
            </div>
            <div class="analytics-top-card" onclick="showCategoryDetail('probatsiya')" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
              <i class="fas fa-gavel" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-probatsiya">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Probatsiya</div>
            </div>
            <div class="analytics-top-card" onclick="showCategoryDetail('sudlangan')" style="background: linear-gradient(135deg, #7c2d12 0%, #9a3412 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
              <i class="fas fa-balance-scale" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-sudlangan">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Sudlanganlar</div>
            </div>
            <div class="analytics-top-card" onclick="showCategoryDetail('qurol')" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
              <i class="fas fa-crosshairs" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-qurol">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Qurol egalari</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            <div class="analytics-top-card" onclick="showCategoryDetail('shubhali')" style="background: linear-gradient(135deg, #be123c 0%, #e11d48 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
              <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-shubhali">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Shubhali shaxslar</div>
            </div>
            <div class="analytics-top-card" onclick="showCategoryDetail('toifadagi')" style="background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
              <i class="fas fa-users" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-toifadagi">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Toifadagilar</div>
            </div>
            <div class="analytics-top-card" onclick="showCategoryDetail('jazodan-qaytgan')" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer;">
              <i class="fas fa-door-open" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.5rem; font-weight: 700;" id="analytics-jazodan-qaytgan">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Jazodan qaytgan</div>
            </div>
          </div>
        </div>
        
        <!-- Grafiklar -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
          <div style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem;">
            <h4 style="margin: 0 0 1rem 0;"><i class="fas fa-venus-mars"></i> Jinsi bo'yicha taqsimot</h4>
            <div style="height: 250px;"><canvas id="gender-chart"></canvas></div>
          </div>
          <div style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem;">
            <h4 style="margin: 0 0 1rem 0;"><i class="fas fa-birthday-cake"></i> Yosh bo'yicha taqsimot</h4>
            <div style="height: 250px;"><canvas id="age-chart"></canvas></div>
          </div>
        </div>
        
        <!-- Bandlik holati kartochkalari -->
        <div style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h4 style="margin: 0;"><i class="fas fa-briefcase"></i> Bandlik holati bo'yicha taqsimot</h4>
            <button class="btn btn-secondary" id="export-employment-excel" style="width: auto; margin: 0; padding: 0.5rem 1rem;"><i class="fas fa-download"></i> Excel</button>
          </div>
          <div id="employment-cards-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;"></div>
        </div>
        
        <!-- IJTIMOIY DAFTARLAR VA MODDIY YORDAM -->
        <div style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem; margin-top: 1.5rem;">
          <h4 style="margin: 0 0 1rem 0;"><i class="fas fa-book-open" style="color: #ec4899;"></i> Ijtimoiy Daftarlar va Moddiy Yordam</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
            <div class="analytics-top-card" onclick="showCategoryDetail('ayollar-daftari')" style="background: linear-gradient(135deg, #db2777 0%, #ec4899 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(219,39,119,0.3); transition: all 0.3s;">
              <i class="fas fa-female" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.8rem; font-weight: 700;" id="analytics-ayollar-daftari">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Ayollar daftari</div>
            </div>
            <div class="analytics-top-card" onclick="showCategoryDetail('yoshlar-daftari')" style="background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(124,58,237,0.3); transition: all 0.3s;">
              <i class="fas fa-user-graduate" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.8rem; font-weight: 700;" id="analytics-yoshlar-daftari">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Yoshlar daftari</div>
            </div>
            <div class="analytics-top-card" onclick="showCategoryDetail('moddiy-yordam')" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(5,150,105,0.3); transition: all 0.3s;">
              <i class="fas fa-hand-holding-usd" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.8rem; font-weight: 700;" id="analytics-moddiy-yordam">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Moddiy yordam</div>
            </div>
            <div class="analytics-top-card" onclick="showCategoryDetail('migrants')" style="background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(2,132,199,0.3); transition: all 0.3s;">
              <i class="fas fa-plane-departure" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.8rem; font-weight: 700;" id="analytics-migrants">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Migrantlar</div>
            </div>
            <div class="analytics-top-card" onclick="showCategoryDetail('disabled')" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(8,145,178,0.3); transition: all 0.3s;">
              <i class="fas fa-wheelchair" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
              <div style="font-size: 1.8rem; font-weight: 700;" id="analytics-disabled">0</div>
              <div style="font-size: 0.8rem; opacity: 0.9;">Nogironlar</div>
            </div>
          </div>
        </div>
        
        <button class="btn btn-secondary" style="width: auto; margin-top: 1rem;" onclick="document.getElementById('analytics-modal').style.display='none'; showScreen('search-view');"><i class="fas fa-arrow-left"></i> Orqaga</button>
      </div>
    </div>
    
    <!-- BATAFSIL RO'YXAT MODAL -->
    <div id="detail-list-modal" class="modal-overlay">
      <div class="modal-box" style="max-width: 95%; width: 1000px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: sticky; top: 0; background: var(--surface-color); padding: 1rem; margin: -1.5rem -1.5rem 1rem -1.5rem; border-radius: 12px 12px 0 0; z-index: 10;">
          <h4 id="detail-list-title" style="margin: 0;"><i class="fas fa-users"></i> Ro'yxat</h4>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-success" id="export-detail-list-excel" style="width: auto; margin: 0; padding: 0.5rem 1rem;"><i class="fas fa-file-excel"></i></button>
            <button class="btn btn-secondary js-back-to-previous-view" style="width: auto; margin: 0; padding: 0.5rem 1rem;"><i class="fas fa-times"></i></button>
          </div>
        </div>
        <div id="detail-list-content"></div>
      </div>
    </div>

    <!-- AI YORDAMCHI MODAL -->
    <div id="ai-chat-modal" class="modal-overlay">
      <div class="modal-box" style="max-width: 600px; padding: 0; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem;">
          <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
            <i class="fas fa-brain"></i>
          </div>
          <div>
            <h4 style="margin: 0;">O'zbegim AI Yordamchi</h4>
            <small style="opacity: 0.9;"><i class="fas fa-circle" style="color: #10b981; font-size: 0.6rem;"></i> OpenAI GPT-4o-mini</small>
          </div>
          <button class="modal-close-btn js-back-to-previous-view" style="position: static; margin-left: auto; color: white;"><i class="fas fa-times"></i></button>
        </div>
        <div id="ai-chat-body" style="height: 450px; overflow-y: auto; padding: 1rem; background: var(--bg-color);">
          <div class="ai-message" style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
            <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <i class="fas fa-brain" style="color: white; font-size: 0.9rem;"></i>
            </div>
            <div style="background: var(--surface-color); padding: 0.75rem 1rem; border-radius: 0 12px 12px 12px; max-width: 85%; box-shadow: var(--shadow-sm);">
              Assalomu alaykum! üëã Men <strong>O'zbegim AI</strong> - haqiqiy sun'iy intellekt yordamchisiman.<br><br>
              Men <strong>ChatGPT kabi</strong> ishl–∞yman - <strong>HAR QANDAY</strong> savolingizga javob bera olaman! üöÄ<br><br>
              <strong>Namuna savollar:</strong><br>
              ‚Ä¢ "Mahalladagi ishsizlik muammosini qanday hal qilish mumkin?"<br>
              ‚Ä¢ "NEET yoshlar ro'yxatini ber va tahlil qil"<br>
              ‚Ä¢ "Yoshlar uchun qanday davlat dasturlari bor?"<br>
              ‚Ä¢ "Biznesni qanday boshlash kerak?"<br>
              ‚Ä¢ Yoki istalgan boshqa savol! üí¨
            </div>
          </div>
        </div>
        <div style="padding: 1rem; background: var(--surface-color); border-top: 1px solid var(--border-color); display: flex; gap: 0.5rem;">
          <input type="text" id="ai-chat-input" placeholder="Har qanday savol bering..." style="flex: 1; margin: 0; padding: 0.75rem 1rem;">
          <button id="ai-send-btn" class="btn btn-primary" style="width: auto; margin: 0; padding: 0.75rem 1.25rem;"><i class="fas fa-paper-plane" style="margin: 0;"></i></button>
        </div>
      </div>
    </div>

    <div id="full-list-modal" class="modal-overlay">
      <div class="modal-box">
        <div id="full-list-header">
          <h3 id="full-list-title">Umumiy Ro'yxat (<span>0</span>)</h3>
          <div id="list-export-buttons">
            <button class="btn btn-success" id="export-list-csv" style="margin-top:0; padding: .6rem 1rem; font-size: 0.9rem;"><i class="fas fa-file-excel"></i> Excel (CSV)</button>
            <button class="btn btn-success" id="export-objects-csv" style="margin-top:0; padding: .6rem 1rem; font-size: 0.9rem; display:none;"><i class="fas fa-file-excel"></i> Ob'ektlar CSV</button>
          </div>
          <button class="modal-close-btn js-back-to-previous-view" id="full-list-modal-close"><i class="fas fa-times"></i></button>
        </div>
        <div id="full-list-table-container-wrapper" style="margin-top:1rem;">
          <div class="form-group" style="margin-top:0;margin-bottom:1rem; max-width: 900px; margin-left: auto; margin-right: auto;"><input type="text" id="full-list-search" placeholder="Qidirish (F.I.O., manzil, telefon...)" style="background:var(--bg-color);"></div>
          <div id="full-list-table-container"></div>
        </div>
      </div>
    </div>
    <div id="family-modal" class="modal-overlay">
      <div class="modal-box">
        <button class="modal-close-btn js-back-to-previous-view"><i class="fas fa-times"></i></button>
        <h3 id="family-modal-title" style="margin-bottom: 1rem; color: var(--primary-color);">Oila a'zolari</h3>
        <div id="family-modal-content"></div>
        <button class="btn btn-secondary js-back-to-previous-view" style="width:auto; margin-top:2rem;"><i class="fas fa-arrow-left"></i> Qaytish</button>
      </div>
    </div>
    <div id="problem-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px; text-align: center;">
            <h3 style="color:var(--warning-color);">Muammo mavjudmi?</h3>
            <p style="margin: 1rem 0; color: var(--text-light);">Fuqaroning hal etilishi kerak bo'lgan muammosi bormi?</p>
            <div id="problem-input-container" style="display:none; margin-top:1.5rem;">
                <label for="problem-textarea">Muammo tavsifi:</label>
                <textarea id="problem-textarea" rows="4" class="js-transliterate"></textarea>
                <button id="save-with-problem-btn" class="btn btn-success" style="width:100%;"><i class="fas fa-save"></i> Muammo bilan saqlash</button>
            </div>
            <div id="problem-choice-buttons" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem;">
                <button id="problem-yes-btn" class="btn btn-secondary" style="flex:1; margin:0; border-color:var(--warning-color); color:var(--warning-color);">Ha, bor</button>
                <button id="problem-no-btn" class="btn btn-primary" style="flex:1; margin:0;">Yo'q, hammasi joyida</button>
                <button id="problem-cancel-btn" class="btn btn-cancel" style="width: 100%; margin-top: 0.5rem;"><i class="fas fa-times"></i> Bekor qilish</button>
            </div>
        </div>
    </div>
    <div id="camera-modal" class="modal-overlay">
      <div class="modal-box">
        <button class="modal-close-btn js-back-to-previous-view"><i class="fas fa-times"></i></button>
        <h3>Rasmga olish</h3>
        <video id="camera-feed" autoplay playsinline></video>
        <canvas id="photo-canvas" class="hidden"></canvas>
        <img id="photo-preview" src="">
        <div id="camera-controls">
            <button id="snap-photo-btn" class="btn btn-primary" style="width:auto;flex-grow:1;"><i class="fas fa-camera"></i> Rasmga olish</button>
            <button id="switch-camera-btn" class="btn btn-secondary" style="width:auto;margin-top:0;"><i class="fas fa-sync-alt"></i> Almashtirish</button>
            <button id="retake-photo-btn" class="btn btn-secondary hidden" style="width:auto;flex-grow:1;margin-top:0;"><i class="fas fa-sync"></i> Qayta olish</button>
            <button id="save-photo-btn" class="btn btn-success hidden" style="width:auto;flex-grow:1;margin-top:0;"><i class="fas fa-save"></i> Rasmni Saqlash</button>
        </div>
      </div>
    </div>
    <!-- Eslatmalar Markazi (Hacker Style) -->
    <div id="notification-modal" class="modal-overlay">
        <div class="modal-box hacker-modal-box">
            <button class="modal-close-btn" id="notification-modal-close"><i class="fas fa-times"></i></button>
            <div class="hacker-modal-header">
                <i class="fas fa-satellite-dish"></i> Eslatmalar Markazi
            </div>
            <ul id="notification-list" class="notification-list">
                <!-- Eslatmalar shu yerga dinamik qo'shiladi -->
            </ul>
        </div>
    </div>
    <!-- Muammoni Hal Etish Modali (YANGILANGAN) -->
    <div id="solve-problem-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px;">
            <button class="modal-close-btn" id="solve-problem-modal-close"><i class="fas fa-times"></i></button>
            <h3 id="solve-problem-title" style="color:var(--success-color);">Muammo Yechimi</h3>
            <form id="solve-problem-form" style="margin-top: 1.5rem;">
                <input type="hidden" id="solve-problem-unique-id" value="">
                <input type="hidden" id="solve-problem-photo-base64">
                <div class="form-group">
                    <label for="solve-problem-comment">Yechim haqida qisqacha izoh:</label>
                    <textarea id="solve-problem-comment" rows="4"></textarea>
                </div>
                <div class="photo-preview-container" style="margin-top: 1rem; text-align: center;">
                    <img id="solve-problem-photo-preview" src="" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 2px solid var(--border-color); display: none;" alt="Yechim rasmi">
                </div>
                <div style="display: flex; gap: 1rem; width: 100%; margin-top: 0.5rem;">
                  <button type="button" id="take-solution-photo-btn" class="btn btn-secondary" style="flex:1; margin:0;"><i class="fas fa-camera"></i> Rasmga Olish</button>
                  <label id="upload-solution-photo-btn-label" for="upload-solution-photo-input" class="btn btn-secondary" style="flex:1; margin:0; display: none;">
                      <i class="fas fa-upload"></i> Galereyadan
                  </label>
                  <input type="file" id="upload-solution-photo-input" accept="image/*" class="hidden">
                </div>
                <button type="button" id="save-problem-solution-btn" class="btn btn-success" style="width:100%;"><i class="fas fa-check-circle"></i> Hal etildi deb saqlash</button>
            </form>
        </div>
    </div>
    <!-- YANGI OYNA: RASMNI KO'RISH UCHUN -->
    <div id="image-viewer-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-btn js-back-to-previous-view"><i class="fas fa-times"></i></button>
            <img id="viewer-image" src="" alt="Uchrashuv rasmi">
            <button class="btn btn-secondary js-back-to-previous-view" style="width:auto; margin: 1rem auto 0 auto;"><i class="fas fa-arrow-left"></i> Qaytish</button>
        </div>
    </div>
    <!-- IJTMOIY OB'EKTLAR MODULI (YANGI) -->
    <div id="objects-stats-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 95%; width: 1100px;">
            <button class="modal-close-btn js-back-to-previous-view"><i class="fas fa-times"></i></button>
            <h3>Ijtimoiy-Iqtisodiy Ob'ektlar va Xarita</h3>
            
            <!-- 1. YANGI OB'EKT TUGMASI - BOSHIDA -->
            <button id="add-new-object-btn" class="btn btn-primary" style="margin-top:1rem; margin-bottom: 1.5rem;"><i class="fas fa-plus-circle"></i> Yangi Ob'ekt Qo'shish</button>
            
            <!-- 2. OB'EKTLAR STATISTIKASI -->
            <div id="objects-summary-grid" class="summary-grid">
                <!-- Statistika bu yerga JS orqali chiziladi -->
            </div>
            
            <!-- 3. XARITA BO'LIMI - PASTDA -->
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
              <h4 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-map-marked-alt"></i> Xarita</h4>
              <!-- 1-QATOR filtrlar -->
              <div id="map-filter-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                <button type="button" class="map-filter-btn active" data-filter="all" style="background: linear-gradient(135deg, #64748b, #94a3b8); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-globe"></i> Barchasi</button>
                <button type="button" class="map-filter-btn" data-filter="objects" style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-store"></i> Ob'ektlar</button>
                <button type="button" class="map-filter-btn" data-filter="employed" style="background: linear-gradient(135deg, #10b981, #34d399); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-briefcase"></i> Band</button>
                <button type="button" class="map-filter-btn" data-filter="unemployed" style="background: linear-gradient(135deg, #ef4444, #f87171); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-user-times"></i> Ishsizlar</button>
                <button type="button" class="map-filter-btn" data-filter="renters" style="background: linear-gradient(135deg, #ec4899, #f472b6); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-key"></i> Ijarachilar</button>
                <button type="button" class="map-filter-btn" data-filter="neet" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-exclamation-triangle"></i> NEET</button>
                <button type="button" class="map-filter-btn" data-filter="risk" style="background: linear-gradient(135deg, #f12711, #f5af19); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-shield-alt"></i> Xavfli</button>
              </div>
              <!-- 2-QATOR filtrlar -->
              <div id="map-filter-buttons-2" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                <button type="button" class="map-filter-btn" data-filter="ayollar-daftari" style="background: linear-gradient(135deg, #db2777, #ec4899); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-female"></i> Ayollar daftari</button>
                <button type="button" class="map-filter-btn" data-filter="yoshlar-daftari" style="background: linear-gradient(135deg, #7c3aed, #8b5cf6); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-user-graduate"></i> Yoshlar daftari</button>
                <button type="button" class="map-filter-btn" data-filter="moddiy-yordam" style="background: linear-gradient(135deg, #059669, #10b981); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-hand-holding-usd"></i> Moddiy yordam</button>
                <button type="button" class="map-filter-btn" data-filter="migrants" style="background: linear-gradient(135deg, #0284c7, #0ea5e9); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-plane-departure"></i> Migrantlar</button>
                <button type="button" class="map-filter-btn" data-filter="disabled" style="background: linear-gradient(135deg, #0891b2, #06b6d4); color: white; border: none; padding: 0.6rem 1rem; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;"><i class="fas fa-wheelchair"></i> Nogironlar</button>
              </div>
              <div id="map-container" style="height: 350px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 1rem;"></div>
              <div id="map-info-container" style="display: none;"></div>
            </div>
        </div>
    </div>
    <div id="add-object-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-btn js-back-to-previous-view"><i class="fas fa-times"></i></button>
            <h3 id="add-object-form-title">Yangi Ob'ekt Qo'shish</h3>
            <div class="form-progress">
              <div class="form-progress-bar"></div>
              <div class="progress-step active" data-step="1">Asosiy</div>
              <div class="progress-step" data-step="2">Yuridik</div>
              <div class="progress-step" data-step="3">Xodimlar</div>
            </div>
            <form id="add-object-form">
                <input type="hidden" name="photoBase64">
                <input type="hidden" name="location">
                <div class="form-step active" data-step="1">
                    <div class="photo-preview-container">
                        <img id="object-photo-preview" src="" alt="Ob'ekt rasmi" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 2px solid var(--border-color); display: none;">
                    </div>
                    <button type="button" class="btn btn-secondary js-take-object-photo" id="take-object-photo-btn" style="margin-top:0;"><i class="fas fa-camera"></i> Ob'ekt Rasmi</button>
                    <div class="form-row">
                        <div class="form-group"><label>Asosiy kategoriya</label><select name="mainCategory" required></select></div>
                        <div class="form-group"><label>Aniq turi</label><input name="specificType" required></div>
                    </div>
                    <div class="form-group full-width"><label>Ob'ektning rasmiy nomi</label><input name="objectName" required></div>
                    <div class="form-group full-width"><label>Manzil</label><input name="address" required></div>
                    <button type="button" id="get-location-btn" class="btn btn-secondary"><i class="fas fa-map-marker-alt"></i> Joylashuvni aniqlash</button>
                </div>
                <div class="form-step" data-step="2">
                    <div class="form-group full-width"><label>Tashkiliy-huquqiy shakli</label><select name="orgType" required></select></div>
                    <div class="form-group full-width conditional-field" id="stir-field"><label>STIR (INN) raqami</label><input name="stir" class="js-numeric-input" maxlength="9" inputmode="numeric" pattern="[0-9]*" title="Faqat raqamlar kiritiladi"></div>
                    <div class="form-group full-width"><label>Hujjatlar holati</label><select name="hasDocuments"><option value="Mavjud">Mavjud</option><option value="Mavjud emas">Mavjud emas</option></select></div>
                    <div class="form-group full-width" style="background: var(--bg-color); padding: 1rem; border-radius: var(--radius-md);">
                        <label style="display:flex; align-items:center; gap: 1rem; margin:0;">
                            <input type="checkbox" name="isSelfBuilt" style="width: auto; height: 20px;">
                            <span>O'zboshimchalik bilan qurilgan/faoliyat yuritadi</span>
                        </label>
                    </div>
                </div>
                <div class="form-step" data-step="3">
                    <div class="form-row">
                        <div class="form-group"><label>Rasmiy shartnomadagilar</label><input name="officialStaff" type="number" value="0" min="0" class="js-numeric-input"></div>
                        <div class="form-group"><label>O'zini o'zi band qilganlar</label><input name="selfEmployedStaff" type="number" value="0" min="0" class="js-numeric-input"></div>
                    </div>
                    <div class="form-group full-width"><label>Norasmiy (shartnomasiz)lar</label><input name="unofficialStaff" type="number" value="0" min="0" class="js-numeric-input"></div>
                    <hr style="border:none; border-top:1px solid var(--border-color); margin: 1.5rem 0;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="margin:0;">Xodimlar ro'yxati</h4>
                        <button type="button" id="add-staff-btn" class="btn btn-secondary" style="width:auto; margin:0;"><i class="fas fa-user-plus"></i> Xodim qo'shish</button>
                    </div>
                    <div id="staff-list-container" style="margin-top:1rem; max-height: 200px; overflow-y:auto;"></div>
                </div>
            </form>
            <div class="form-navigation" style="display:flex;gap:1rem;margin-top:2rem;">
                <button type="button" class="btn btn-secondary js-prev-step" style="width:auto; flex-grow:1; margin-top:0;"><i class="fas fa-arrow-left"></i> Orqaga</button>
                <button type="button" class="btn btn-primary js-next-step" style="width:auto; flex-grow:1; margin-top:0;">Davom etish <i class="fas fa-arrow-right"></i></button>
                <button type="button" class="btn btn-success js-save-object" style="display:none; width:auto; flex-grow:1; margin-top:0;"><i class="fas fa-save"></i> Ob'ektni Saqlash</button>
            </div>
        </div>
    </div>
    <div id="add-staff-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-btn js-back-to-previous-view"><i class="fas fa-times"></i></button>
            <h3>Xodim Qo'shish</h3>
            <form id="add-staff-form">
                <input type="hidden" name="photoBase64">
                <input type="hidden" name="signatureBase64">
                <div class="photo-preview-container">
                    <img id="staff-photo-preview" src="" alt="Xodim rasmi">
                </div>
                <button type="button" class="btn btn-secondary js-take-staff-photo" id="take-staff-photo-btn" style="margin-top:0;"><i class="fas fa-camera"></i> Rasmga Olish</button>
                <div class="form-group"><label>Lavozimi</label><select name="position" required></select></div>
                <div class="form-group"><label>F.I.O.</label><input name="fio" required></div>
                <div class="form-group"><label>Telefon raqami (9 raqam)</label><input name="phone" maxlength="9" class="js-numeric-input" placeholder="901234567" inputmode="numeric"></div>
                <div class="form-group"><label>Pasport seriya va raqami</label><div class="passport-inputs"><input name="passport_series" placeholder="AA" maxlength="2" class="js-alpha-upper-input"><input name="passport_number" placeholder="1234567" maxlength="7" inputmode="numeric" class="js-numeric-input"></div></div>
                <div class="form-group"><label>JSHSHIR (14 ta raqam)</label><input name="jshshir" maxlength="14" inputmode="numeric" class="js-numeric-input"></div>
                <div class="form-group"><label>Tug'ilgan sana</label><input name="dob" placeholder="DD.MM.YYYY" maxlength="10" class="js-date-input" inputmode="numeric"></div>
                <hr style="border:none; border-top:1px solid var(--border-color); margin: 1.5rem 0;">
                <button type="button" class="btn btn-secondary js-add-signature" data-form-id="add-staff-form"><i class="fas fa-signature"></i> Imzo qo'shish</button>
                <div class="signature-preview-container" id="add-staff-form-signature-preview"></div>
            </form>
            <button id="save-staff-member-btn" class="btn btn-success"><i class="fas fa-user-check"></i> Xodimni qo'shish</button>
        </div>
    </div>
    <div id="object-details-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-btn js-back-to-previous-view"><i class="fas fa-times"></i></button>
            <div id="object-details-content"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary js-back-to-previous-view"><i class="fas fa-arrow-left"></i> Qaytish</button>
                <button class="btn btn-primary" id="js-download-object-pdf"><i class="fas fa-file-pdf"></i> PDF Yuklab Olish</button>
            </div>
        </div>
    </div>
    <!-- XODIM MA'LUMOTLARI UCHUN YANGI MODAL OYNA -->
    <div id="staff-details-modal" class="modal-overlay">
      <div class="modal-box">
        <button class="modal-close-btn js-back-to-previous-view"><i class="fas fa-times"></i></button>
        <div id="staff-details-content"></div>
        <div class="modal-actions">
          <button class="btn btn-secondary js-back-to-previous-view"><i class="fas fa-arrow-left"></i> Qaytish</button>
          <button class="btn btn-primary" id="js-download-staff-pdf"><i class="fas fa-file-pdf"></i> PDF Yuklab Olish</button>
        </div>
      </div>
    </div>
    <!-- IMZO QO'YISH UCHUN YANGI MODAL OYNA -->
    <div id="signature-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-btn js-back-to-previous-view"><i class="fas fa-times"></i></button>
            <h3>Imzo qoldiring</h3>
            <canvas id="signature-pad-canvas"></canvas>
            <div id="signature-pad-actions">
                <button class="btn btn-secondary" id="signature-clear-btn" style="flex:1; margin:0;"><i class="fas fa-eraser"></i> Tozalash</button>
                <button class="btn btn-success" id="signature-save-btn" style="flex:1; margin:0;"><i class="fas fa-save"></i> Saqlash</button>
            </div>
        </div>
    </div>
    
    <!-- ***** MUROJAATLAR MODULI UCHUN YANGI OYNALAR ***** -->

    <div id="appeals-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-btn js-back-to-previous-view"><i class="fas fa-times"></i></button>
            <h3>Murojaatlar boshqaruvi</h3>
            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="my-appeals">Mening Murojaatlarim</div>
                <div class="nav-tab" data-tab="new-appeal">Yangi Murojaat</div>
                <div class="nav-tab permission-hidden" id="staff-stats-tab" data-tab="staff-stats">Hodimlar Bo'yicha Hisobot</div>
            </div>

            <div class="tab-content active" id="my-appeals-content">
                <!-- Hodimga kelgan murojaatlar ro'yxati shu yerda ko'rsatiladi -->
            </div>

            <div class="tab-content" id="new-appeal-content">
                 <div id="appeal-citizen-search-step">
                    <h4>1-qadam: Murojaatchini toping yoki ro'yxatdan o'tkazing</h4>
                    <div id="appeal-search-panel">
                        <input type="text" id="appealSearchInput" placeholder="F.I.O. bo'yicha qidirish...">
                        <button class="btn btn-primary" id="appeal-search-btn"><i class="fas fa-search"></i> Qidirish</button>
                        <button class="btn btn-secondary" id="appeal-new-citizen-btn"><i class="fas fa-user-plus"></i> Yangi fuqaro</button>
                    </div>
                    <div id="appeal-search-result"></div>
                 </div>
                 <div id="internal-task-step" style="display: none;">
                    <h4>Ichki Vazifa Yaratish</h4>
                    <form id="internal-task-form">
                      <!-- Vazifa yaratish formasi shu yerda bo'ladi -->
                    </form>
                 </div>
            </div>

            <div class="tab-content" id="staff-stats-content">
                <!-- Hodimlar bo'yicha statistika shu yerda ko'rsatiladi -->
            </div>
        </div>
    </div>
    
    <footer class="app-footer">
      <i class="fas fa-code-branch"></i> &nbsp; Tizim muallifi: <span>Boynazarov Rozimuhammad</span>. Barcha huquqlar himoyalangan. &copy; 2025
    </footer>
  </div>
<script>
// Bu yerdan faqat bitta to'liq script bloki boshlanadi
/* ================== KONFIG ================== */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwz2rrxGrXmaPjBNuDrg61EneKNHBTktZpMqVzCg67nAP3Oq_u6bTVu41YpxKrILSn5uQ/exec';
const KOP_QAVATLI_STREETS=["Musaev","Lermontov","A.Temur","Mashrab","Leninizm","Shevchenko","B.Raximov","Shoxruxmirzo","Boshqa"];
const HOVLI_STREETS=["Musaev","Lermontov","Shevchenko","B.Raximov","Shoxruxmirzo","Ustalar","B.Turon","Muqumiy111","A.Temur","Boshqa"];
const METRKA_SERIES_LIST=["I-AN","I-BH","I-FR","I-GZ","I-HR","I-NA","I-NV","I-QD","I-QQ","I-SM","I-SR","I-SU","I-TN","I-TV","II-AN","II-BH","II-FR","II-GZ","II-HR","II-KS","II-NA","II-NV","II-QD","II-QQ","II-SM","II-SR","II-SU","II-TN","II-TS","II-TV","III-AN","III-BH","III-FR","III-GZ","III-HR","III-NA","III-NV","III-QD","III-QQ","III-SM","III-SR","III-SU","III-TN","III-TV","T","TA"];
const TOIFA_TURI_LIST = {
    "all": ["Janjalkash (Notinch oila)","Og'ir xulq atvor","G'ayriijtimoiy xulq atvor","Ruxiy kasal","Psixotrop","Ichkilikka ruju qo'ygan","Muqaddam sudlangan"],
    "inspector": ["PXT", "Probatsiya"]
};
const ROLES={"4161":{role:"MFY raisi",access:"full"},"1909":{role:"Yoshlar yetakchisi",access:"full"},"1983":{role:"Profilaktika inspektori",access:"inspector"},"5511":{role:"Xokim yordamchisi",access:"restricted"},"2233":{role:"Soliq hodimi",access:"restricted"},"4944":{role:"Ijtimoiy hodim",access:"restricted"},"2528":{role:"Javohir",access:"full"},"2304":{role:"Ruzimukhammed",access:"full"},"5252":{role:"Ravshanbek",access:"restricted"},"2025":{role:"Xotin qizlar faoli",access:"restricted"}};
let CURRENT_USER={role:null,access:"restricted",pass:null};
const NAZORAT_ICONS = {
    "Janjalkash (Notinch oila)": "fas fa-hand-fist",
    "Og'ir xulq atvor": "fas fa-skull-crossbones",
    "G'ayriijtimoiy xulq atvor": "fas fa-user-slash",
    "Ruxiy kasal": "fas fa-brain",
    "Psixotrop": "fas fa-pills",
    "Ichkilikka ruju qo'ygan": "fas fa-wine-glass-alt",
    "PXT": "fas fa-notes-medical",
    "Probatsiya": "fas fa-gavel",
    "Muqaddam sudlangan": "fas fa-user-lock",
    "Ajrashgan": "fas fa-heart-crack",
    "Ajrim yoqasida": "fas fa-people-arrows",
    "Migratsiyadan qaytgan": "fas fa-plane-arrival" 
};
// Ijtimoiy ob'ektlar uchun Konfiguratsiya
const OBJECT_CATEGORIES = {
    'Savdo': 'fa-shopping-cart',
    'Xizmat ko\'rsatish': 'fa-concierge-bell',
    'Umumiy ovqatlanish': 'fa-utensils',
    'Ta\'lim': 'fa-graduation-cap',
    'Tibbiyot': 'fa-briefcase-medical',
    'Sport va Ko\'ngilochar': 'fa-gamepad',
    'Noturar Bino': 'fa-building-user',
    'Boshqa': 'fa-question-circle'
};
const ORG_TYPES = ['MCHJ (Yuridik shaxs)', 'YaTT (Yakka tartibdagi tadbirkor)', 'O\'zini o\'zi band qilgan (Jismoniy shaxs)', 'Davlat tashkiloti', 'Hujjatsiz / Noma\'lum'];
const STAFF_POSITIONS = ['Direktor', 'O\'rinbosar', 'Ish boshqaruvchi', 'Sotuvchi', 'O\'qituvchi', 'Farmatsevt', 'Xizmatchi', 'Boshqa'];

// ================== DAVLATLAR, VILOYAT VA TUMANLAR MA'LUMOTLARI ==================

const davlatlar = [
    "O'zbekiston", "Rossiya", "Qozog'iston", "Qirg'iziston", "Tojikiston", "Turkmaniston",
    "Ozarbayjon", "Gruziya", "Ukraina", "Belorusiya", "Armaniston", "Moldova",
    "Turkiya", "Germaniya", "AQSH", "Buyuk Britaniya", "Fransiya", "Italiya",
    "Ispaniya", "Polsha", "Chexiya", "Vengriya", "Janubiy Koreya", "Yaponiya",
    "Xitoy", "Hindiston", "Pokiston", "Afg'oniston", "Eron", "Saudiya Arabistoni",
    "BAA", "Qatar", "Misr", "Boshqa"
];

const viloyatlar = [
    "Toshkent shahri", "Toshkent viloyati", "Andijon viloyati", "Buxoro viloyati",
    "Farg'ona viloyati", "Jizzax viloyati", "Xorazm viloyati", "Namangan viloyati",
    "Navoiy viloyati", "Qashqadaryo viloyati", "Qoraqalpog'iston Respublikasi",
    "Samarqand viloyati", "Sirdaryo viloyati", "Surxondaryo viloyati"
];

const tumanlarData = {
    "Toshkent shahri": ["Bektemir tumani", "Chilonzor tumani", "Mirobod tumani", "Mirzo Ulug'bek tumani", "Olmazor tumani", "Sergeli tumani", "Shayxontohur tumani", "Uchtepa tumani", "Yakkasaroy tumani", "Yashnobod tumani", "Yunusobod tumani"],
    "Toshkent viloyati": ["Angren shahri", "Bekobod shahri", "Chirchiq shahri", "Olmaliq shahri", "Nurafshon shahri", "Bekobod tumani", "Bo'stonliq tumani", "Bo'ka tumani", "Chinoz tumani", "Qibray tumani", "Ohangaron tumani", "Oqqo'rg'on tumani", "Parkent tumani", "Piskent tumani", "Quyi Chirchiq tumani", "Toshkent tumani", "O'rta Chirchiq tumani", "Yangiyo'l tumani", "Yuqori Chirchiq tumani", "Zangiota tumani"],
    "Andijon viloyati": ["Andijon shahri", "Xonobod shahri", "Andijon tumani", "Asaka tumani", "Baliqchi tumani", "Bo'ston tumani", "Buloqboshi tumani", "Izboskan tumani", "Jalaquduq tumani", "Xo'jaobod tumani", "Marhamat tumani", "Oltinko'l tumani", "Paxtaobod tumani", "Qo'rg'ontepa tumani", "Shahrixon tumani", "Ulug'nor tumani"],
    "Buxoro viloyati": ["Buxoro shahri", "Kogon shahri", "Buxoro tumani", "G'ijduvon tumani", "Jondor tumani", "Kogon tumani", "Olot tumani", "Peshku tumani", "Qorako'l tumani", "Qorovulbozor tumani", "Romitan tumani", "Shofirkon tumani", "Vobkent tumani"],
    "Farg'ona viloyati": ["Farg'ona shahri", "Marg'ilon shahri", "Quvasoy shahri", "Qo'qon shahri", "Bag'dod tumani", "Beshariq tumani", "Buvayda tumani", "Dang'ara tumani", "Farg'ona tumani", "Furqat tumani", "Oltiariq tumani", "O'zbekiston tumani", "Qo'shtepa tumani", "Quva tumani", "Rishton tumani", "So'x tumani", "Toshloq tumani", "Uchko'prik tumani", "Yozyovon tumani"],
    "Jizzax viloyati": ["Jizzax shahri", "Arnasoy tumani", "Baxmal tumani", "Do'stlik tumani", "Forish tumani", "G'allaorol tumani", "Mirzacho'l tumani", "Paxtakor tumani", "Sharof Rashidov tumani", "Yangiobod tumani", "Zafarobod tumani", "Zarbdor tumani", "Zomin tumani"],
    "Xorazm viloyati": ["Urganch shahri", "Xiva shahri", "Bog'ot tumani", "Gurlan tumani", "Xonqa tumani", "Hazorasp tumani", "Xiva tumani", "Q'o'shko'pir tumani", "Shovot tumani", "Urganch tumani", "Yangiariq tumani", "Yangibozor tumani"],
    "Namangan viloyati": ["Namangan shahri", "Chortoq tumani", "Chust tumani", "Kosonsoy tumani", "Mingbuloq tumani", "Namangan tumani", "Norin tumani", "Pop tumani", "To'raqo'rg'on tumani", "Uchqo'rg'on tumani", "Uychi tumani", "Yangiqo'rg'on tumani"],
    "Navoiy viloyati": ["Navoiy shahri", "Zarafshon shahri", "Karmana tumani", "Konimex tumani", "Navbahor tumani", "Nurota tumani", "Qiziltepa tumani", "Tomdi tumani", "Uchquduq tumani", "Xatirchi tumani"],
    "Qashqadaryo viloyati": ["Qarshi shahri", "Shahrisabz shahri", "Chiroqchi tumani", "Dehqonobod tumani", "G'uzor tumani", "Kasbi tumani", "Kitob tumani", "Koson tumani", "Mirishkor tumani", "Muborak tumani", "Nishon tumani", "Qamashi tumani", "Shahrisabz tumani", "Yakkabog' tumani"],
    "Qoraqalpog'iston Respublikasi": ["Nukus shahri", "Amudaryo tumani", "Beruniy tumani", "Chimboy tumani", "Ellikqal'a tumani", "Kegeyli tumani", "Mo'ynoq tumani", "Nukus tumani", "Qanliko'l tumani", "Qo'ng'irot tumani", "Qorao'zak tumani", "Shumanay tumani", "Taxtako'pir tumani", "To'rtko'l tumani", "Xo'jayli tumani"],
    "Samarqand viloyati": ["Samarqand shahri", "Kattaqo'rg'on shahri", "Bulung'ur tumani", "Ishtixon tumani", "Jomboy tumani", "Kattaqo'rg'on tumani", "Narpay tumani", "Nurobod tumani", "Oqdaryo tumani", "Past darg'om tumani", "Payariq tumani", "Qo'shrabot tumani", "Samarqand tumani", "Tayloq tumani", "Urgut tumani"],
    "Sirdaryo viloyati": ["Guliston shahri", "Yangiyer shahri", "Shirin shahri", "Boyovut tumani", "Guliston tumani", "Mirzaobod tumani", "Oqoltin tumani", "Sardoba tumani", "Sayxunobod tumani", "Sirdaryo tumani", "Xovos tumani"],
    "Surxondaryo viloyati": ["Termiz shahri", "Angor tumani", "Bandixon tumani", "Boysun tumani", "Denov tumani", "Jarqo'rg'on tumani", "Muzrabod tumani", "Oltinsoy tumani", "Qiziriq tumani", "Qumqo'rg'on tumani", "Sariosiyo tumani", "Sherobod tumani", "Sho'rchi tumani", "Termiz tumani", "Uzun tumani"]
};
// =======================================================================



/* ================== DOM & STATE ================== */
const DOM={appShell:document.querySelector('.app-shell'),loader:document.getElementById('loader-overlay'),searchView:document.getElementById('search-view'),addView:document.getElementById('add-view'),addFamilyView:document.getElementById('add-family-view'),searchResult:document.getElementById('search-result'),addForm:document.getElementById('add-form'),addFamilyForm:document.getElementById('add-family-form'),alertOverlay:document.getElementById('alert-modal'),alertTitle:document.getElementById('alert-title'),alertMessage:document.getElementById('alert-message'),loginScreen:document.getElementById('login-screen'),loginPasswordInput: document.getElementById('login-password-input'), loginPasswordError: document.getElementById('login-password-error'), loginSubmitBtn: document.getElementById('login-submit-btn'),detailsModal:document.getElementById('details-modal'),detailsContent:document.getElementById('details-content'),summaryModal:document.getElementById('summary-modal'),summaryTitle:document.getElementById('summary-title'),fullListModal:document.getElementById('full-list-modal'),fullListSearch:document.getElementById('full-list-search'),fullListTitle: document.getElementById('full-list-title'), fullListTableContainer:document.getElementById('full-list-table-container'),problemModal: document.getElementById('problem-modal'),toast: document.getElementById('toast-notification'),toastMessage: document.getElementById('toast-message'), familyModal: document.getElementById('family-modal'), familyModalTitle: document.getElementById('family-modal-title'), familyModalContent: document.getElementById('family-modal-content'), cameraModal: document.getElementById('camera-modal'), notificationModal: document.getElementById('notification-modal'), notificationList: document.getElementById('notification-list'), notificationBell: document.getElementById('notification-bell'), notificationCount: document.getElementById('notification-count'), solveProblemModal: document.getElementById('solve-problem-modal'), imageViewerModal: document.getElementById('image-viewer-modal'), viewerImage: document.getElementById('viewer-image'),
appealsModal: document.getElementById('appeals-modal'),
// Ob'ektlar uchun DOM elementlari
objectsStatsModal: document.getElementById('objects-stats-modal'),
addObjectModal: document.getElementById('add-object-modal'),
addObjectForm: document.getElementById('add-object-form'),
addStaffModal: document.getElementById('add-staff-modal'),
addStaffForm: document.getElementById('add-staff-form'),
objectDetailsModal: document.getElementById('object-details-modal'),
staffDetailsModal: document.getElementById('staff-details-modal'),
signatureModal: document.getElementById('signature-modal')
};
let citizenDatabase=[], archivedCitizenDatabase = [], socialObjectsDatabase = [], objectStaffDatabase = [], headers=[],currentMainPersonUniqueId=null,currentStep=1, newCitizenData = {}, currentDisplayedList = [], currentListTitle = '', cameraStream = null, currentFacingMode = 'user', notifications = [], currentMeetingData = {}, currentCameraTarget = null, tempStaffList = [], signaturePad = null, currentSignatureFormId = null;
var activeCitizenDatabase = []; // Global qilindi xarita uchun
window.activeCitizenDatabase = activeCitizenDatabase; // Window ga ham qo'shildi
let selectedRoleInfo = {};
const totalSteps=3; 
let dataReadyPromise = null;
let isDataLoading = false;
let previousScreenStack = ['search-view']; 
let isEditMode = false;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QO'SHIMCHA BO'LIMLAR TOGGLE FUNKSIYASI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleExtraSection(btn) {
    const section = btn.closest('.extra-section');
    const content = section.querySelector('.extra-section-content');
    const isOpen = section.classList.contains('active');
    
    if (isOpen) {
        section.classList.remove('active');
        btn.classList.remove('active');
        content.style.display = 'none';
    } else {
        section.classList.add('active');
        btn.classList.add('active');
        content.style.display = 'block';
    }
}

/* ================== UTIL ================== */
const showLoader=(v)=>DOM.loader.style.display=v?'flex':'none';
const showScreen=(id)=>{
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.modal-overlay:not(#camera-modal)').forEach(m=>m.style.display = 'none');
  const el=document.getElementById(id);
  if(el) {
    if (el.classList.contains('view')) el.classList.add('active');
    else if (el.classList.contains('modal-overlay')) el.style.display = 'flex';
  }
  if (previousScreenStack[previousScreenStack.length - 1] !== id) {
      previousScreenStack.push(id);
  }
  // FAB tugmalarni yashirish/ko'rsatish
  const fabContainer = document.querySelector('.fab-container');
  if (fabContainer) {
      const hideOnScreens = ['add-view', 'add-family-modal', 'details-modal', 'camera-modal', 'signature-modal'];
      if (hideOnScreens.includes(id)) {
          fabContainer.style.display = 'none';
      } else {
          fabContainer.style.display = 'flex';
      }
  }
};
const goBack = () => {
    if (previousScreenStack.length > 1) {
        const currentId = previousScreenStack.pop(); 
        const prevId = previousScreenStack[previousScreenStack.length - 1]; 
        const currentEl = document.getElementById(currentId);
        if (currentEl) {
          if (currentEl.classList.contains('view')) currentEl.classList.remove('active');
          else if (currentEl.classList.contains('modal-overlay')) currentEl.style.display = 'none';
        }
        const prevEl = document.getElementById(prevId);
        if (prevEl) {
            if (prevEl.classList.contains('view')) prevEl.classList.add('active');
            else if (prevEl.classList.contains('modal-overlay')) prevEl.style.display = 'flex';
        } else {
            showScreen('search-view'); 
        }
    } else {
        showScreen('search-view');
        previousScreenStack = ['search-view']; 
    }
};
const showCustomAlert=(message,title='Xabar',showCancel=false)=>{DOM.alertTitle.textContent=title;DOM.alertMessage.innerHTML=message;const okBtn=DOM.alertOverlay.querySelector('.js-alert-ok');const cancelBtn=DOM.alertOverlay.querySelector('.js-alert-cancel');if(showCancel){okBtn.textContent='Ha';cancelBtn.style.display='inline-flex';}else{okBtn.textContent='OK';cancelBtn.style.display='none';}showScreen('alert-modal');};
const showToast = (message, type = 'success') => {
    DOM.toastMessage.textContent = message;
    DOM.toast.style.backgroundColor = type === 'error' ? 'var(--danger-color)' : (type === 'info' ? 'var(--secondary-color)' : 'var(--success-color)');
    DOM.toast.classList.add('show');
    setTimeout(() => { DOM.toast.classList.remove('show'); }, 3000);
};
const formatDate = (dateStr) => {
    if (!dateStr) return '';
    const formatAsDdMmYyyy = (d) => {
        try {
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}.${mm}.${yyyy}`;
        } catch { return ''; }
    };
    if (dateStr instanceof Date) return formatAsDdMmYyyy(dateStr);
    if (typeof dateStr === 'string') {
        const parsedDate = new Date(dateStr);
        if (!isNaN(parsedDate.getTime())) return formatAsDdMmYyyy(parsedDate);
        const ddMmYyyyRegex = /^(\d{1,2})\.(\d{1,2})\.(\d{2,4})$/;
        if (ddMmYyyyRegex.test(dateStr)) return dateStr.endsWith('.') ? dateStr.slice(0, -1) : dateStr;
    }
    return String(dateStr);
};
const getAge = dob => {
    if (!dob) return null;
    const today = new Date();
    let birthDate;
    const dObj = new Date(dob);
    if (!isNaN(dObj.getTime())) {
        birthDate = dObj;
    } else {
        const sp = String(dob).split('.');
        if (sp.length !== 3) return null;
        const day = +sp[0], month = +sp[1] - 1, year = +sp[2];
        if (isNaN(day) || isNaN(month) || isNaN(year) || year < 1900 || year > today.getFullYear()) return null;
        birthDate = new Date(year, month, day);
        if (isNaN(birthDate.getTime())) return null;
    }
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
};
function transliterate(text){if(!text||typeof text!=='string')return'';const m={'–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'yo','–∂':'j','–∑':'z','–∏':'i','–π':'y','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'x','—Ü':'ts','—á':'ch','—à':'sh','—â':'shch','—ä':'','—ã':'y','—å':'','—ç':'e','—é':'yu','—è':'ya','—û':"o'",'“õ':'q','“ì':"g'",'“≥':'h','–ê':'A','–ë':'B','–í':'V','–ì':'G','–î':'D','–ï':'E','–Å':'Yo','–ñ':'J','–ó':'Z','–ò':'I','–ô':'Y','–ö':'K','–õ':'L','–ú':'–ú','–ù':'N','–û':'O','–ü':'P','–†':'R','–°':'S','–¢':'T','–£':'U','–§':'F','–•':'X','–¶':'Ts','–ß':'Ch','–®':'Sh','–©':'Shch','–™':'','–´':'Y','–¨':'','–≠':'E','–Æ':'Yu','–Ø':'Ya','–é':"O'",'“ö':'Q','“í':"G'",'“≤':'H'};return text.split('').map(c=>m[c]||c).join('');}
const normalizeAddress = (str) => {
    if (!str) return '';
    return transliterate(str)
        .toLowerCase()
        .replace(/[\.,\-]/g, ' ') 
        .replace(/\s+/g, ' ')
        .trim();
};
/* ================== DATA & CACHE ================== */
function populateCsvHeaders() {
    if (!citizenDatabase || citizenDatabase.length === 0) {
        headers = [];
        return;
    }
    const headerSet = new Set();
    citizenDatabase.forEach(person => {
        Object.keys(person).forEach(key => headerSet.add(key));
    });
    headers = [...headerSet];
}
async function apiCall(action, payload, showSpinner = true) {
    if (showSpinner) {
        showLoader(true);
    }
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action, payload }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        });
        const result = await response.json();
        if (result.status === 'success') {
            return result;
        } else {
            throw new Error(result.message || "Serverda noma'lum xatolik.");
        }
    } catch (error) {
        console.error(`API Call Error (${action}):`, error);
        if (showSpinner) {
            showCustomAlert("Server bilan aloqada xatolik yuz berdi. Internetga ulanishni tekshiring. Agar muammo davom etsa, sahifani yangilang.", "Server Xatoligi");
        }
        throw error;
    } finally {
        if (showSpinner) {
            showLoader(false);
        }
    }
}
async function fetchData(isManualRefresh = false, isSilent = false) {
    if (isDataLoading) return dataReadyPromise;
    isDataLoading = true;
    if (isManualRefresh && !isSilent) {
        showToast("Baza fonda yangilanmoqda...", "info");
    } else if (!isManualRefresh && !isSilent) {
        showLoader(true);
    }
    dataReadyPromise = new Promise(async (resolve, reject) => {
        try {
            const response = await fetch(`${SCRIPT_URL}?action=readAllData&t=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Server xatoligi: ${response.statusText}`);
            const result = await response.json();
            if (result.status === 'success') {
                citizenDatabase = result.data.citizenDatabase || [];
                activeCitizenDatabase = citizenDatabase.filter(p => p.arxiv_holati !== 'arxiv');
                window.activeCitizenDatabase = activeCitizenDatabase;
                archivedCitizenDatabase = citizenDatabase.filter(p => p.arxiv_holati === 'arxiv');
                socialObjectsDatabase = result.data.socialObjectsDatabase || [];
                objectStaffDatabase = result.data.objectStaffDatabase || [];
                populateCsvHeaders();
                localStorage.setItem('databases', JSON.stringify({
                    citizenDatabase,
                    socialObjectsDatabase,
                    objectStaffDatabase,
                    timestamp: new Date().getTime()
                }));
                checkAndShowNotifications();
                resolve();
            } else {
                throw new Error(result.message || "Noma'lum server xatoligi.");
            }
        } catch (error) {
            console.error("Ma'lumot yuklashda xatolik:", error);
            if(isManualRefresh && !isSilent) showToast("Baza bilan aloqa yo'q!", "error");
            loadDataFromCache();
            reject(error);
        } finally {
            isDataLoading = false;
            if (!isManualRefresh && !isSilent) showLoader(false);
        }
    });
    return dataReadyPromise;
}
function loadDataFromCache() {
    const cachedData = localStorage.getItem('databases');
    if (cachedData) {
        try {
            const d = JSON.parse(cachedData);
            citizenDatabase = d.citizenDatabase || [];
            activeCitizenDatabase = citizenDatabase.filter(p => p.arxiv_holati !== 'arxiv');
                window.activeCitizenDatabase = activeCitizenDatabase;
            archivedCitizenDatabase = citizenDatabase.filter(p => p.arxiv_holati === 'arxiv');
            socialObjectsDatabase = d.socialObjectsDatabase || [];
            objectStaffDatabase = d.objectStaffDatabase || [];
            populateCsvHeaders();
            showToast("Ma'lumotlar keshdan yuklandi.", "info");
        } catch (e) { localStorage.clear(); }
    }
}
function initializeApplicationData() {
    loadDataFromCache(); 
    setTimeout(() => {
        fetchData(false, true)
            .then(() => {
                checkAndShowNotifications();
            })
            .catch(err => {
                console.error("Fon rejimida yangilashda xatolik:", err.message);
            });
    }, 500);
    dataReadyPromise = Promise.resolve();
}
function updateLocalDatabase(updatedPersonData, isOptimistic = false) {
    if (!updatedPersonData) return;
    let idToFind = updatedPersonData.unique_id;
    if (isOptimistic && updatedPersonData.update_unique_id) {
        idToFind = updatedPersonData.update_unique_id;
    }
    if (!idToFind && updatedPersonData.update_unique_id) {
        idToFind = updatedPersonData.update_unique_id;
    }
    if (!idToFind) {
      if(updatedPersonData.jshshir) {
        idToFind = citizenDatabase.find(p => p.jshshir === updatedPersonData.jshshir)?.unique_id;
      }
      if(!idToFind) {
          citizenDatabase.unshift(updatedPersonData);
          localStorage.setItem('databases', JSON.stringify({ citizenDatabase, socialObjectsDatabase, objectStaffDatabase }));
          return;
      }
    }
    const index = citizenDatabase.findIndex(p => (p.unique_id || '').toString() === idToFind.toString());
    if (index > -1) {
        citizenDatabase[index] = { ...citizenDatabase[index], ...updatedPersonData };
    } else {
        citizenDatabase.unshift(updatedPersonData);
    }
    activeCitizenDatabase = citizenDatabase.filter(p => p.arxiv_holati !== 'arxiv');
                window.activeCitizenDatabase = activeCitizenDatabase;
    archivedCitizenDatabase = citizenDatabase.filter(p => p.arxiv_holati === 'arxiv');
    localStorage.setItem('databases', JSON.stringify({ citizenDatabase, socialObjectsDatabase, objectStaffDatabase }));
}
function refreshCurrentView() {
    if (DOM.searchResult.innerHTML.trim() !== '' && DOM.searchView.classList.contains('active')) {
        const currentCards = Array.from(DOM.searchResult.querySelectorAll('.result-card'));
        const uniqueIds = currentCards.map(card => {
            try { return JSON.parse(card.dataset.personData.replace(/&apos;/g, "'")).unique_id; } catch(e){ return null; }
        }).filter(Boolean);
        const updatedPersons = uniqueIds.map(id => citizenDatabase.find(p => p.unique_id === id)).filter(Boolean);
        displayResults(updatedPersons);
    }
    if (DOM.fullListModal.style.display === 'flex') {
        const updatedList = currentDisplayedList.map(p_old => activeCitizenDatabase.find(p_new => p_new.unique_id === p_old.unique_id) || p_old);
        const highlightCategory = (document.querySelector('#full-list-table-container .context-highlight')?.classList.contains('problem')) ? 'problem' : 
                                  (document.querySelector('#full-list-table-container .context-highlight')?.classList.contains('toifadagilar') ? 'toifadagilar' : null);
        displayFilteredList(updatedList, currentListTitle, highlightCategory);
    }
    if (DOM.familyModal.style.display === 'flex') {
        const firstCard = DOM.familyModalContent.querySelector('.result-card');
        if (firstCard && firstCard.dataset.personData) {
            const familyId = (JSON.parse(firstCard.dataset.personData.replace(/&apos;/g, "'"))).family_id;
            if (familyId) {
                const familyMembers = activeCitizenDatabase.filter(p => p.family_id === familyId);
                const familyHead = familyMembers.find(p => p.qarindoshligi === 'Oila boshi') || familyMembers[0];
                if (familyHead) {
                    DOM.familyModalTitle.textContent = `${familyHead.fio} oilasi`;
                    DOM.familyModalContent.innerHTML = familyMembers.map(member => createPersonCardHTML(member, member.unique_id === familyHead.unique_id, 'family-modal')).join('');
                }
            }
        }
    }
}
/* ================== RENDER HELPERS ================== */
function createFullDetailsHTML(p) {
    const personDataString = JSON.stringify(p).replace(/'/g, "&apos;");
    const render = (label, value) => {
        const val = value ? String(value).trim() : '';
        if (!val || val.toLowerCase() === 'yo\'q') return '';
        return `<div class="data-item"><span class="data-label">${label}</span><span class="data-value">${val}</span></div>`;
    };
    let meetingsHtml = '';
    if (p.uchrashuvlar_tarixi) {
      try {
        const meetings = JSON.parse(p.uchrashuvlar_tarixi);
        if (Array.isArray(meetings) && meetings.length > 0) {
          let historyTitle = "Uchrashuvlar Tarixi";
          const allSolutions = meetings.every(m => m.type === 'Muammo Yechimi');
          const containsSolutions = meetings.some(m => m.type === 'Muammo Yechimi');
          if (allSolutions) {
              historyTitle = "Muammo Yechimlari Tarixi";
          } else if (containsSolutions) {
              historyTitle = "Tadbirlar Tarixi";
          }
          meetingsHtml += `<div class="section-title">${historyTitle}</div><div class="meetings-grid">`;
          meetings.forEach(meeting => {
            meetingsHtml += `<button class="meeting-btn js-view-meeting-photo" data-image-id="${meeting.imageId}">
                               <span class="date">${meeting.date}</span>
                               <span class="type">${meeting.type}</span>
                             </button>`;
          });
          meetingsHtml += `</div>`;
        }
      } catch (e) {
        console.error("Uchrashuvlar tarixini o'qishda xatolik:", e);
      }
    }
    let html = `<div id="details-render-wrapper" data-person-data='${personDataString}'>
        <div class="profile-header">`;
    if (p.rasm_link) {
        html += `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" class="profile-pic js-view-profile-pic" alt="Fuqaro rasmi" onerror="this.onerror=null; this.style.display='none';">`;
    }
    html += `<div class="profile-name">${p.fio || 'F.I.O. Kiritilmagan'}</div>
        </div>
        <div class="section-title">Shaxsiy ma'lumotlar</div>
        <div class="data-grid">
            ${render("Hujjat", p.passport)}${render("JSHSHIR", p.jshshir)}${render("Tug'ilgan sana", formatDate(p.dob))}${render("Jinsi", p.jinsi)}${render("Telefon", p.telefon)}</div>
        <div class="section-title">Yashash manzili</div>
        <div class="data-grid">
             ${render("MFY", p.mfy)}${render("Ko'cha, uy", p.street)}${render("Yashash holati", p.registrationType)}</div>
        <div class="section-title">Ijtimoiy-Bandlik</div>
        <div class="data-grid">
             ${render("Ijtimoiy holati", p.socialStatus)}${render("Oila a'zolari", p.oila_azolari_soni)}${render("Bandlik holati", p.employmentStatus)}${render("Ish joyi", p.employmentDetails)}${render("O'qish joyi", p.oqish_joyi)}${render("Kursi/Sinfi", p.kursi_sinfi)}${render("Nogironlik guruhi", p.disabilityGroup)}</div>
        ${p.sudlanganlik === 'Ha' || p.qurol_egalik === 'Ha' ? `
        <div class="section-title" style="color: #ef4444;">üõ°Ô∏è Xavfsizlik va Nazorat</div>
        <div class="data-grid">
             ${render("Sudlanganlik", p.sudlanganlik)}${render("JK moddasi", p.jk_moddasi)}${render("Ozodlikka chiqqan", formatDate(p.jazo_qaytgan_sana))}${render("Qurolga egalik", p.qurol_egalik)}${render("Qurol turi", p.qurol_turi)}${render("Qurol ruxsatnomasi", p.qurol_ruxsatnoma)}${render("Ruxsat tugash", formatDate(p.qurol_tugash_sana))}</div>` : ''}
        ${p.kadastr_raqami || p.isitish_tizimi || p.gaz_hisoblagich || p.elektr_hisoblagich || p.suv_hisoblagich || p.chiqindi_xizmat ? `
        <div class="section-title" style="color: #3b82f6;">üè† Xonadon Texnik Holati</div>
        <div class="data-grid">
             ${render("Kadastr raqami", p.kadastr_raqami)}${render("Isitish tizimi", p.isitish_tizimi)}${render("Gaz", p.gaz_hisoblagich)}${render("Gaz litsavoy", p.gaz_litsavoy)}${render("Elektr", p.elektr_hisoblagich)}${render("Elektr litsavoy", p.elektr_litsavoy)}${render("Suv", p.suv_hisoblagich)}${render("Suv litsavoy", p.suv_litsavoy)}${render("Chiqindi", p.chiqindi_xizmat)}${render("Chiqindi shartnoma", p.chiqindi_litsavoy)}</div>` : ''}
        ${p.avtomobil_bor === 'Ha' ? `
        <div class="section-title" style="color: #10b981;">üöó Avtomobil</div>
        <div class="data-grid">
             ${render("Rusumi", p.avto_rusumi)}${render("Davlat raqami", p.avto_raqami)}${render("Rangi", p.avto_rangi)}${render("Ishonchnoma", p.avto_ishonchnoma)}${render("Gaz o'rnatilgan", p.avto_gaz)}</div>` : ''}
        ${p.hobbi || p.psixologik_yordam || p.mahalla_yordam ? `
        <div class="section-title" style="color: #8b5cf6;">üß† Psixologik Portret</div>
        <div class="data-grid">
             ${render("Qiziqishlari (Hobbi)", p.hobbi)}${render("Psixologik yordam", p.psixologik_yordam)}${render("Mahallaga yordami", p.mahalla_yordam)}</div>` : ''}
        ${p.telegram_azo || p.aliment_muammo === 'Ha' || p.yuridik_maslahat === 'Ha' || p.mulk_muammo === 'Ha' ? `
        <div class="section-title" style="color: #0088cc;">üì± Aqlli Mahalla va Huquqiy</div>
        <div class="data-grid">
             ${render("Telegram a'zo", p.telegram_azo)}${render("Aliment muammo", p.aliment_muammo)}${render("Yuridik maslahat", p.yuridik_maslahat)}${render("Mulk muammo", p.mulk_muammo)}</div>` : ''}
        ${p.oylik_daromad || p.ishlovchilar_soni ? `
        <div class="section-title" style="color: #f59e0b;">üí∞ Iqtisodiy Holat</div>
        <div class="data-grid">
             ${render("Oylik daromad", p.oylik_daromad)}${render("Ishlovchilar soni", p.ishlovchilar_soni)}</div>` : ''}
        ${meetingsHtml}
        <div class="section-title">Qo'shimcha</div>
        <div class="data-grid">
             ${render("Xatlovchi", p.xatlovchi)}${render("Ro'yxatga olingan", formatDate(p.regDate))}${render("Shubhali shaxs", p.shubhali_shaxs)}${render("Toifa turi", p.toifa_turi)}${render("PXT Uchrashuv Sanasi", formatDate(p.uchrashuv_sanasi))}${render("Probatsiya Uchrashuv Sanasi", formatDate(p.probatsiya_uchrashuv_sanasi))}</div>`;
    
    if (p.signatureBase64 || p.signatureLink) {
        const signatureSrc = p.signatureBase64 ? p.signatureBase64 : `https://lh3.googleusercontent.com/d/${p.signatureLink}`;
        html += `<div class="section-title">Imzo</div>
                  <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                    <img src="${signatureSrc}" style="max-height: 80px; background: #fff; border-radius: 4px;" ${p.signatureLink ? 'crossorigin="anonymous"' : ''}>
                  </div>`;
    }
    
    if (p.izoh && String(p.izoh).toLowerCase() !== 'yo\'q' && String(p.izoh).trim() !== '') {
        html += `<div class="muammo-box">
                    <span class="muammo-title">Asl Muammo</span>
                    <div class="data-value">${p.izoh}</div>
                 </div>`;
    }
    if (p.muammo_holati === 'Hal etildi') {
        html += `<div class="solved-problem-box">
                    <span class="solved-title">Muammo Yechimi</span>
                    <div class="data-value">${p.muammo_yechimi || "Izoh kiritilmagan."}</div>
                 </div>`;
    }
    html += `</div>`;
    return html;
}

function createPersonCardHTML(p, isMain = false, context = 'search', highlightCategory = null) {
    const personDataString = JSON.stringify(p).replace(/'/g, "&apos;");

    let isIncompleteFamily = false;
    const requiredFamilySize = p.oila_azolari_soni ? parseInt(p.oila_azolari_soni, 10) : 0;
    if (requiredFamilySize > 0 && p.family_id) {
        const currentFamilySize = citizenDatabase.filter(member => member.family_id === p.family_id).length;
        if (currentFamilySize < requiredFamilySize) {
            isIncompleteFamily = true;
        }
    }

    const isArchived = p.arxiv_holati === 'arxiv';
    let cardClasses = 'result-card';
    if (isIncompleteFamily) cardClasses += ' incomplete-data';
    if (isArchived) cardClasses += ' archived';

    let h = `<div class="${cardClasses}" data-person-data='${personDataString}'>
                <div class="result-card-avatar">`;
    if (p.rasm_link) {
        h += `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" alt="${p.fio}" class="js-view-profile-pic" onerror="this.onerror=null; this.parentElement.innerHTML = '<div class=\\'avatar-placeholder-sm\\'><i class=\\'fas fa-user\\'></i></div>';">`;
    } else {
        h += `<div class="avatar-placeholder-sm"><i class="fas fa-user"></i></div>`;
    }
    h += `</div><div class="result-card-content">
            <div class="result-header"><h3>${p.fio || 'F.I.O. Kiritilmagan'}</h3>`;
    
    if (isArchived) {
        h += `<span class="badge archived-badge"><i class="fas fa-archive"></i> ARXIVDA</span>`;
    } else {
        h += `<span class="badge">${p.qarindoshligi || "Noma'lum"}</span>`;
    }

    h += `</div>`;
    let highlightHTML = '';
    if (highlightCategory) {
        switch(highlightCategory) {
            case 'problem':
                if (p.izoh && String(p.izoh).toLowerCase() !== 'yo\'q' && String(p.izoh).trim() !== '' && p.muammo_holati !== 'Hal etildi') {
                    highlightHTML = `<div class="context-highlight problem"><span class="label">Muammosi:</span>${p.izoh}</div>`;
                }
                break;
            case 'toifadagilar':
                let toifa_text = '';
                if(p.toifa_turi) toifa_text = p.toifa_turi;
                else if (p.socialStatus === 'Ajrashgan' || p.socialStatus === 'Ajrim yoqasida') toifa_text = p.socialStatus;
                else if (p.employmentStatus === 'Migratsiyadan qaytgan') toifa_text = 'Migratsiyadan qaytgan';
                if(toifa_text) highlightHTML = `<div class="context-highlight toifadagilar"><span class="label">Toifasi:</span>${toifa_text}</div>`;
                break;
        }
    }
    h += highlightHTML;
    h += `<table class="result-table">
            <tr><td>Manzil</td><td>${p.street || 'Kiritilmagan'}</td></tr>
            <tr><td>JSHSHIR</td><td>${p.jshshir || 'Kiritilmagan'}</td></tr>
            <tr><td>T. sana</td><td>${formatDate(p.dob) || 'Kiritilmagan'}</td></tr>
          </table>
          <div style="margin-top:1rem;display:flex;gap:1rem;flex-wrap:wrap;">`;
    const canSeeDetails = CURRENT_USER.access === 'full' || CURRENT_USER.access === 'inspector' || (p.izoh && String(p.izoh).toLowerCase() !== 'yo\'q' && String(p.izoh).trim() !== '') || (p.shubhali_shaxs === 'Ha') || (p.shaxs_toifasi === 'Ha');
    if (canSeeDetails) {
        h += `<button class="btn btn-secondary-outline js-details-btn" style="flex:1;min-width:100px;margin-top:0;"><i class="fas fa-eye"></i> To'liq</button>`;
    } else {
        h += `<button class="btn btn-secondary-outline js-details-btn" style="flex:1;min-width:100px;margin-top:0; opacity:0.6; cursor:not-allowed;" data-restricted="true"><i class="fas fa-eye"></i> To'liq</button>`;
    }

    if (CURRENT_USER.access === 'full' && !isArchived) {
        h += `<button class="btn btn-secondary-outline js-fill-details-btn" style="flex:1;min-width:100px;margin-top:0;"><i class="fas fa-edit"></i> Tahrirlash</button>`;
    }
    if (context !== 'family-modal' && !isArchived) {
        h += `<button class="btn btn-secondary-outline js-toggle-family-view" style="flex:1;min-width:100px;margin-top:0;"><i class="fas fa-users"></i> Oila</button>`;
    }
    h += `</div></div></div>`;
    return h;
}

function displayResults(initialResults) {
    DOM.searchResult.innerHTML = ''; 
    if (!initialResults || initialResults.length === 0) {
        DOM.searchResult.innerHTML = `<p style="text-align:center;color:var(--danger-color);padding:2rem;">Hech qanday ma'lumot topilmadi.</p>`;
        return;
    }

    initialResults.sort((a, b) => {
        const dateB = b.regDate ? new Date(String(b.regDate).split('.').reverse().join('-')) : null;
        const dateA = a.regDate ? new Date(String(a.regDate).split('.').reverse().join('-')) : null;
        if ((!dateA || isNaN(dateA)) && (!dateB || isNaN(dateB))) return 0;
        if (!dateA || isNaN(dateA)) return 1;
        if (!dateB || isNaN(dateB)) return -1;
        return dateB - dateA;
    });

    const fragment = document.createDocumentFragment();

    initialResults.forEach((person) => {
        const cardHtml = createPersonCardHTML(person, false, 'search');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cardHtml;
        fragment.appendChild(tempDiv.firstChild);
    });

    const backBtn = document.createElement('button');
    backBtn.className = 'btn btn-secondary js-back-to-search';
    backBtn.style.cssText = 'width:auto; margin-top:1.5rem; margin-bottom:0;';
    backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Bosh sahifaga';
    fragment.appendChild(backBtn);
    
    DOM.searchResult.appendChild(fragment);
}
function displayFilteredList(list, title, highlightCategory = null) {
    currentDisplayedList = list;
    currentListTitle = title;
    DOM.fullListTableContainer.innerHTML = '';

    if (!list || list.length === 0) {
        DOM.fullListTitle.innerHTML = `${title} (<span>0</span>)`;
        DOM.fullListTableContainer.innerHTML = `<p style="text-align:center;padding:2rem;">Bu toifadagi ma'lumot topilmadi.</p>`;
        showScreen('full-list-modal');
        showLoader(false);
        return;
    }

    list.sort((a, b) => {
        const dateB = b.regDate ? new Date(String(b.regDate).split('.').reverse().join('-')) : null;
        const dateA = a.regDate ? new Date(String(a.regDate).split('.').reverse().join('-')) : null;
        if ((!dateA || isNaN(dateA)) && (!dateB || isNaN(dateB))) return 0;
        if (!dateA || isNaN(dateA)) return 1;
        if (!dateB || isNaN(dateB)) return -1;
        return dateB - dateA;
    });
    
    DOM.fullListTitle.innerHTML = `${title} (<span>${list.length}</span>)`;

    const fragment = document.createDocumentFragment();

    list.forEach(p => {
        const cardHtml = createPersonCardHTML(p, false, 'full-list-modal', highlightCategory);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cardHtml;
        fragment.appendChild(tempDiv.firstChild);
    });

    const backBtn = document.createElement('button');
    backBtn.className = 'btn btn-secondary js-back-to-previous-view';
    backBtn.style.cssText = 'width:auto; margin-top:1.5rem; margin-bottom:0;'; 
    backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Orqaga';
    fragment.appendChild(backBtn);

    DOM.fullListTableContainer.appendChild(fragment);
    
    showScreen('full-list-modal');
    
    DOM.fullListSearch.value = '';
    DOM.fullListSearch.oninput = (e) => {
        const query = transliterate(e.target.value.toLowerCase());
        const filteredList = list.filter(p => (transliterate((p.fio || '').toLowerCase()).includes(query) || (p.street || '').toLowerCase().includes(query) || (p.telefon || '').includes(query) || String(p.jshshir || '').includes(query)));
        displayFilteredList(filteredList, title, highlightCategory); 
    };
    showLoader(false);
}
/* ================== FORMS & SUBMIT ================== */
function validateForm(form, step = null) {
  const missing = [];
  const fields = step
    ? form.querySelectorAll(
        `.form-step[data-step="${step}"] input[name]:not([type="hidden"]), .form-step[data-step="${step}"] select[name], .form-step[data-step="${step}"] textarea[name]`
      )
    : form.querySelectorAll(
        'input[name]:not([type="hidden"]), select[name], textarea[name]'
      );
  let toifaTuriSelected = false; 
  const shaxsToifasiSelect = form.querySelector('select[name="shaxs_toifasi"]');
  const toifaTuriConditionalField = form.querySelector('.js-toifa-turi'); 
  const isShaxsToifasiHa = shaxsToifasiSelect && shaxsToifasiSelect.value === 'Ha';
  const isToifaTuriSectionVisible = toifaTuriConditionalField && window.getComputedStyle(toifaTuriConditionalField).display !== 'none';
  if (isShaxsToifasiHa && isToifaTuriSectionVisible) {
      const checkedCheckboxes = document.querySelectorAll('input[name="toifa_turi"]:checked');
      if (checkedCheckboxes.length > 0) {
          toifaTuriSelected = true;
      }
      if (!toifaTuriSelected) {
          missing.push('Toifa turi'); 
      }
  }
  for (const input of fields) {
    if (input.name === 'toifa_turi' && input.type === 'checkbox') {
        continue;
    }
    let visible = input.offsetParent !== null;
    const cond = input.closest('.conditional-field');
    if (cond && window.getComputedStyle(cond).display === 'none') {
      visible = false;
    }
    const disabled = input.disabled;
    const optional = input.dataset.optional !== undefined;
    if (visible && !disabled && !optional && !input.value) {
      const label = input.closest('.form-group')?.querySelector('label');
      missing.push(label ? label.textContent.replace(':', '') : input.name);
    }
  }
  return [...new Set(missing)];
}
function buildAddressFromForm(form,data){if(!data.xonadon_turi)return;const type=data.xonadon_turi;let streetSelect=form.querySelector(`select[name="${type}_kochasi"]`);let streetName=streetSelect?streetSelect.value:'';if(streetName==='Boshqa'){const other=form.querySelector(`.js-other-street-input[data-type="${type}"]`);streetName=other?other.value.trim():'';}const dom=data.dom_raqami?.trim()||'';const kv=data.kvartira_raqami?.trim()||'';const uy=data.uy_raqami?.trim()||'';let full='';if(type==='kop_qavatli'&&streetName&&dom&&kv)full=`${streetName} ko., ${dom}-dom, ${kv}-kv.`;if(type==='xovli'&&streetName&&uy)full=`${streetName} ko., ${uy}-uy`;data.street=transliterate(full);}
async function finalSubmit(data, formElement) {
    showToast("Ma'lumotlar qurilmaga saqlandi!", 'success');
    updateLocalDatabase(data, true);
    checkAndShowNotifications();
    refreshCurrentView();

    if (formElement && formElement.id === 'add-form') {
        resetFormToCreateMode();
    } else if (formElement) {
        formElement.reset();
    }
    showScreen('search-view');
    DOM.problemModal.style.display = 'none';

    showToast("Baza bilan sinxronizatsiya qilinmoqda...", 'info');
    try {
        const result = await apiCall('saveCitizen', data, false);
        showToast(result.message || "Baza bilan sinxronizatsiya yakunlandi!", 'success');
        await fetchData(true); 

    } catch (error) {
        showToast("Sinxronizatsiya xatosi. Ma'lumotlar keyinroq yangilanadi.", 'error');
        setTimeout(() => fetchData(true), 5000); 
    }
}
async function prepareAndConfirmSubmit(isFamily = false) { 
  try { 
    const form = isFamily ? DOM.addFamilyForm : DOM.addForm; 
    const fd = new FormData(form); 
    newCitizenData = {}; 
    for (const [k, v] of fd.entries()) {
        if (k !== 'toifa_turi') {
            const el = form.querySelector(`[name="${k}"]`); 
            let value = typeof v === 'string' ? v.trim() : v; 
            if (typeof value === 'string' && el && el.classList.contains('js-transliterate')) value = transliterate(value); 
            newCitizenData[k] = value; 
        }
    } 
    const selectedToifalar = Array.from(form.querySelectorAll('[name="toifa_turi"]:checked')).map(cb => cb.value);
    newCitizenData.toifa_turi = selectedToifalar.join(', ');
    // Hobbilarni yig'ish
    const selectedHobbies = Array.from(form.querySelectorAll('[name="hobbi"]:checked')).map(cb => cb.value);
    newCitizenData.hobbi = selectedHobbies.join(', ');
    if (isEditMode && !isFamily) newCitizenData.update_unique_id = DOM.addForm.querySelector('[name="update_unique_id"]').value;
    else if (!newCitizenData.update_unique_id) newCitizenData.unique_id = Date.now().toString() + Math.random().toString(36).substring(2, 8);
    const hujjatTuri = newCitizenData.hujjat_turi; 
    if (!newCitizenData.telefon_number || String(newCitizenData.telefon_number).length !== 9) return showCustomAlert("Telefon raqami to'liq, 9 ta raqamdan iborat bo'lishi shart."); 
    if (hujjatTuri === 'Pasport') { 
      if (!newCitizenData.jshshir || String(newCitizenData.jshshir).length !== 14) return showCustomAlert("JSHSHIR 14 ta raqamdan iborat bo'lishi shart."); 
      if (!newCitizenData.dob || newCitizenData.dob.replace(/\D/g, '').length !== 8) return showCustomAlert("Tug'ilgan sana to'liq kiritilishi shart (DD.MM.YYYY)."); 
    } else if (hujjatTuri === 'Metrka') { 
      if (!newCitizenData.metrka_dob || newCitizenData.metrka_dob.replace(/\D/g, '').length !== 8) return showCustomAlert("Tug'ilgan sana to'liq kiritilishi shart (DD.MM.YYYY)."); 
    } 
    await dataReadyPromise; 
    if (newCitizenData.jshshir && !newCitizenData.update_unique_id && !isFamily) { 
      const isDuplicate = citizenDatabase.find(p => String(p.jshshir || '').trim() === String(newCitizenData.jshshir || '').trim() && String(newCitizenData.jshshir || '').trim() !== ""); 
      if (isDuplicate) return showCustomAlert("Bu JSHSHIR raqamiga ega fuqaro bazada mavjud!"); 
    } 
    newCitizenData.regDate = newCitizenData.regDate || formatDate(new Date()); 
    if (!isFamily) newCitizenData.mfy = "O'zbegim"; 
    if (hujjatTuri === 'Pasport') newCitizenData.passport = (newCitizenData.passport_series || '').toUpperCase() + (newCitizenData.passport_number || ''); 
    else if (hujjatTuri === 'Metrka') { newCitizenData.passport = (newCitizenData.metrka_series || '') + ' ' + (newCitizenData.metrka_number || ''); newCitizenData.dob = newCitizenData.metrka_dob || ''; }
    else if (hujjatTuri === 'Chet el fuqarosi') { newCitizenData.passport = newCitizenData.chet_el_pasport || ''; newCitizenData.jshshir = newCitizenData.chet_el_davlati || ''; newCitizenData.dob = newCitizenData.chet_el_dob || ''; } 
    if (newCitizenData.telefon_number) newCitizenData.telefon = '+998' + newCitizenData.telefon_number; 
    if (newCitizenData.employmentStatus === "Migratsiya") { newCitizenData.returned_migration_country = ''; newCitizenData.returned_migration_date = ''; newCitizenData.returned_migration_current_status = '';
    } else if (newCitizenData.employmentStatus === "Migratsiyadan qaytgan") { newCitizenData.migration_country = ''; newCitizenData.migration_duration = ''; newCitizenData.returned_migration_current_status = newCitizenData.returned_migration_current_status || '';
    } else { newCitizenData.migration_country = ''; newCitizenData.migration_duration = ''; newCitizenData.returned_migration_country = ''; newCitizenData.returned_migration_date = ''; newCitizenData.returned_migration_current_status = ''; }
    if (isFamily) { 
        const mainPerson = citizenDatabase.find(p => String(p.unique_id || '').trim() === String(currentMainPersonUniqueId || '').trim()); 
        if (mainPerson) {
            newCitizenData.family_id = mainPerson.family_id || mainPerson.jshshir; 
            newCitizenData.street = mainPerson.street || ''; newCitizenData.mfy = mainPerson.mfy || "O'zbegim"; newCitizenData.registrationType = mainPerson.registrationType || ''; newCitizenData.xonadon_turi = mainPerson.xonadon_turi || ''; 
        } 
    } else {
        buildAddressFromForm(form, newCitizenData);
        if (newCitizenData.update_unique_id) {
            const existingPerson = citizenDatabase.find(p => String(p.unique_id) === String(newCitizenData.update_unique_id));
            if (existingPerson) newCitizenData.family_id = existingPerson.family_id;
        } else {
            if (newCitizenData.selected_family_id) {
                const selectedFamilyMember = citizenDatabase.find(p => p.unique_id === newCitizenData.selected_family_id);
                if (selectedFamilyMember) {
                    newCitizenData.family_id = selectedFamilyMember.family_id || selectedFamilyMember.jshshir;
                }
            } else if (newCitizenData.street) {
                const fullAddress = newCitizenData.street;
                const residentsAtAddress = activeCitizenDatabase.filter(p => p.street && normalizeAddress(p.street) === normalizeAddress(fullAddress));
                const isRenter = newCitizenData.registrationType === 'Ijara';
                const relevantResidents = residentsAtAddress.filter(p => (isRenter ? p.registrationType === 'Ijara' : p.registrationType !== 'Ijara'));
                if (relevantResidents.length > 0) {
                    const familyHead = relevantResidents.find(p => p.qarindoshligi === 'Oila boshi');
                    const familyRepresentative = familyHead || relevantResidents.find(p => p.family_id) || relevantResidents[0];
                    newCitizenData.family_id = familyRepresentative.family_id || familyRepresentative.jshshir;
                } else {
                    if (newCitizenData.jshshir) {
                        newCitizenData.family_id = newCitizenData.jshshir;
                    } else {
                       return showCustomAlert("Yangi oilaga birinchi fuqaroni kiritish uchun uning JSHSHIR raqami bo'lishi shart.");
                    }
                }
            }
        }
    }
    newCitizenData.xatlovchi = CURRENT_USER.role; 
    delete newCitizenData.metrka_dob; delete newCitizenData.chet_el_dob; delete newCitizenData.selected_family_id; 
    if (!newCitizenData.fio) return showCustomAlert("F.I.O. kerak."); 
    if (isFamily && !newCitizenData.jshshir && hujjatTuri === 'Pasport') return showCustomAlert("Oila a'zosi uchun JSHSHIR kiritilishi majburiy!"); 
    if (isFamily) { 
      const izoh = form.querySelector('[name="izoh"]').value.trim(); 
      newCitizenData.izoh = izoh ? izoh : 'Yo\'q'; 
      newCitizenData.muammo_holati = (izoh && String(izoh).toLowerCase() !== 'yo\'q') ? 'Jarayonda' : '';
      if(newCitizenData.muammo_holati === 'Jarayonda') newCitizenData.muammo_sanasi = formatDate(new Date());
      finalSubmit(newCitizenData, form); 
    }  else { 
      showScreen('problem-modal');
      document.getElementById('problem-input-container').style.display = 'none'; 
      document.getElementById('problem-choice-buttons').style.display = 'flex';
      const problemText = (newCitizenData.izoh && String(newCitizenData.izoh).toLowerCase() !== 'yo\'q') ? newCitizenData.izoh : '';
      document.getElementById('problem-textarea').value = problemText;
    } 
  } catch (error) { showCustomAlert(error.message, "Xatolik"); } 
}
/* ================== NOTIFICATIONS ================== */
function checkAndShowNotifications() {
    notifications = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const parseDate = (dateStr) => {
        if (!dateStr || typeof dateStr !== 'string') return null;
        const parts = dateStr.split('.').map(Number);
        if (parts.length !== 3 || parts.some(isNaN)) return null;
        return new Date(parts[2], parts[1] - 1, parts[0]);
    };
    const isManager = ['2304', '1909', '4161'].includes(CURRENT_USER.pass);
    activeCitizenDatabase.forEach(p => {
        try {
            if (CURRENT_USER.role === 'Profilaktika inspektori') {
                ['uchrashuv_sanasi', 'probatsiya_uchrashuv_sanasi'].forEach(dateKey => {
                    const meetingDate = parseDate(p[dateKey]);
                    if (!meetingDate) return;
                    const type = dateKey === 'uchrashuv_sanasi' ? 'PXT' : 'Probatsiya';
                    const diffTime = meetingDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays < 0) {
                        notifications.push({ type: type, citizen: p, details: `Muddati ${Math.abs(diffDays)} kun o'tgan! (${p[dateKey]})`, is_overdue: true });
                    } else if (diffDays <= 2) {
                        let detailText = diffDays === 0 ? `Uchrashuv BUGUNGA belgilangan (${p[dateKey]})` : `Uchrashuv ${diffDays} kundan keyin (${p[dateKey]})`;
                        notifications.push({ type: type, citizen: p, details: detailText });
                    }
                });
            }
            if (hasActiveProblem(p)) {
                const canSeeProblem = isManager || (p.xatlovchi === CURRENT_USER.role);
                if (canSeeProblem) {
                    const problemDate = parseDate(p.muammo_sanasi) || parseDate(p.regDate);
                    let isOld = false;
                    let titlePrefix = "MUAMMO";
                    if (problemDate) {
                        const problemAge = Math.ceil((today.getTime() - problemDate.getTime()) / (1000 * 60 * 60 * 24));
                        if (problemAge > 30) {
                            isOld = true;
                            titlePrefix = "ESKI MUAMMO";
                        }
                    }
                    notifications.push({ type: 'problem', citizen: p, details: p.izoh, is_old: isOld, title_prefix: titlePrefix });
                }
            }
        } catch(e) {
            console.error("Eslatma tekshirishda xatolik:", p.fio, e);
        }
    });
    DOM.notificationCount.textContent = notifications.length;
    DOM.notificationCount.classList.toggle('hidden', notifications.length === 0);
}
function renderNotifications() {
    if (notifications.length === 0) {
        DOM.notificationList.innerHTML = `<li style="text-align:center; padding: 2rem; color: #a0a0a0;">Hozircha yangi eslatmalar yo'q.</li>`;
        return;
    }
    let html = '';
    notifications.forEach(n => {
        const isProblem = n.type === 'problem';
        const isOverdue = n.is_overdue;
        let itemClass = isProblem ? 'type-problem' : '';
        if (isOverdue || n.is_old) itemClass = 'type-overdue';
        const titleType = n.title_prefix || (isOverdue ? "MUDDATI O'TGAN" : n.type.toUpperCase());
        html += `<li class="notification-item ${itemClass}">
            <div class="notification-title">
                <span class="type">[${titleType}]</span> <span class="fio">${n.citizen.fio}</span>
            </div>
            <div class="notification-details">`;
        if (isProblem) {
            html += `<div class="detail-item"><i class="fas fa-map-marker-alt"></i> ${n.citizen.street || 'Manzil kiritilmagan'}</div>
                     <div class="detail-item"><i class="fas fa-phone"></i> ${n.citizen.telefon || 'Telefon kiritilmagan'}</div>
                     <div class="detail-item problem-text"><i class="fas fa-comment-dots"></i> ${n.details}</div>`;
        } else {
            html += n.details;
        }
        html += `</div>
            <div class="notification-actions" style="display:flex; gap: 0.5rem; margin-top: 1rem;">`;
        if (isProblem) {
            html += `<button class="btn btn-success js-solve-problem" data-unique-id="${n.citizen.unique_id}" style="flex:1;"><i class="fas fa-check"></i> Hal etildi</button>
                     <button class="btn btn-secondary js-remind-later" style="flex:1;">Jarayonda</button>`;
        } else {
            html += `<button class="btn btn-primary js-start-meeting" data-unique-id="${n.citizen.unique_id}" data-meeting-type="${n.type}" style="flex:1;"><i class="fas fa-video"></i> Uchrashuv</button>
                     <button class="btn btn-secondary js-remind-later" style="flex:1;">Tushunarli</button>`;
        }
        html += `</div></li>`;
    });
    DOM.notificationList.innerHTML = html;
}
/* ================== STATS ================== */
const hasActiveProblem = (p) => {
    const izoh = String(p.izoh || '').trim(); 
    if (!izoh || izoh.toLowerCase() === "yo'q") {
        return false;
    }
    return String(p.muammo_holati || '').trim() !== 'Hal etildi';
};
function calculateAndDisplaySummary() {
    // Bazani tekshiramiz
    const d = activeCitizenDatabase;
    if (!d || d.length === 0) {
        showCustomAlert("Statistika uchun ma'lumotlar bazasi bo'sh.", "Ma'lumot yo'q");
        return;
    }

    // 1. ASOSIY RAQAMLARNI HISOBLASH
    const total = d.length;
    // Xonadonlarni ko'cha nomi va uy raqami bo'yicha unikal hisoblash
    const households = (new Set(d.map(p => {
        // Uy manzilini unikal identifikator qilish
        const type = p.xonadon_turi || '';
        const street = p.street || '';
        if (!street) return null;
        return street.toLowerCase().trim(); 
    }).filter(Boolean))).size;
    
    // Oilalarni family_id bo'yicha hisoblash
    const families = (new Set(d.map(p => p.family_id || p.jshshir).filter(Boolean))).size;
    
    // Muammosi borlarni aniqlash
    const problem = d.filter(hasActiveProblem).length;

    // 2. DEMOGRAFIK VA IJTIMOIY
    const men = d.filter(p => p.jinsi === 'Erkak').length;
    const women = d.filter(p => p.jinsi === 'Ayol').length;
    const youth = d.filter(p => { const age = getAge(p.dob); return age !== null && age >= 14 && age <= 30; }).length;
    const seniors = d.filter(p => { const age = getAge(p.dob); return age !== null && age >= 80; }).length;
    const disabled = d.filter(p => p.employmentStatus === 'Nogironligi bor' || p.disabilityGroup).length;
    
    const unemployed = d.filter(p => p.employmentStatus === 'Ishsiz').length;
    const employed = d.filter(p => ['Rasmiy band', 'Norasmiy band', 'Tadbirkor'].includes(p.employmentStatus)).length;
    const students = d.filter(p => ['Talaba', "Maktab o'quchisi"].includes(p.employmentStatus)).length;
    const migrants = d.filter(p => p.employmentStatus === 'Migratsiya').length;
    const returnedMigrants = d.filter(p => p.employmentStatus === 'Migratsiyadan qaytgan').length;
    
    const divorced = d.filter(p => p.socialStatus === 'Ajrashgan').length;
    const vergeOfDivorce = d.filter(p => p.socialStatus === 'Ajrim yoqasida').length;
    const renters = d.filter(p => p.registrationType === 'Ijara').length;
    const temporary = d.filter(p => p.registrationType === 'Vaqtincha').length;
    
    const shubhali = d.filter(p => p.shubhali_shaxs === 'Ha').length;
    const toifadagilar = d.filter(p => p.shaxs_toifasi === 'Ha').length;

    // 3. TEXNIK HOLAT (Siz so'ragan qism - Integratsiya shu yerda)
    // "Aqlli" deb belgilanganlarni hisoblaymiz. 
    // Agar formadagi qiymat "Aqlli" bo'lsa, hisobga olinadi.
    const gazAqlli = d.filter(p => p.gaz_hisoblagich === 'Aqlli').length;
    const elektrAqlli = d.filter(p => p.elektr_hisoblagich === 'Aqlli').length;
    const suvAqlli = d.filter(p => p.suv_hisoblagich === 'Aqlli').length;
    const isitishYoq = d.filter(p => p.isitish_tizimi === "Yo'q").length;
    
    // Transport
    const avtomobil = d.filter(p => p.avtomobil_bor === 'Ha').length;
    const ishonchnoma = d.filter(p => p.avto_ishonchnoma === 'Ha').length;

    // 4. HUQUQIY VA IQTISODIY
    const aliment = d.filter(p => p.aliment_muammo === 'Ha').length;
    const yuridik = d.filter(p => p.yuridik_maslahat === 'Ha').length;
    const mulkMuammo = d.filter(p => p.mulk_muammo === 'Ha').length;
    const telegramYoq = d.filter(p => p.telegram_azo === "Yo'q").length;
    const daromadPast = d.filter(p => p.oylik_daromad === '2 mln gacha').length;
    const ishlovchiYoq = d.filter(p => p.ishlovchilar_soni === '0').length;
    // ... avvalgi kodlar ...

    // 5. IJTIMOIY DAFTARLAR (YANGI QO'SHILDI)
    const ayollarDaftari = d.filter(p => p.ayollar_daftari && p.ayollar_daftari.includes('Ro\'yxatda')).length;
    const yoshlarDaftari = d.filter(p => p.yoshlar_daftari && p.yoshlar_daftari.includes('Ro\'yxatda')).length;
    const temirDaftar = d.filter(p => p.moddiy_yordam && p.moddiy_yordam.includes('Temir daftar')).length;
    const nafaqaxorlar = d.filter(p => p.moddiy_yordam && (p.moddiy_yordam.includes('Bola puli') || p.moddiy_yordam.includes('Nafaqa'))).length;

    // ... (DOM ga chiqarish qismi, "Asosiy kartalar"dan keyin qo'shing) ...
    // 5. EKRANGA CHIQARISH (DOM yangilash)
    // Asosiy kartalar
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-households').textContent = households;
    document.getElementById('stat-families').textContent = families;
    document.getElementById('stat-problem').textContent = problem;

    // Demografiya
    if(document.getElementById('stat-men')) document.getElementById('stat-men').textContent = men;
    if(document.getElementById('stat-women')) document.getElementById('stat-women').textContent = women;
    if(document.getElementById('stat-youth')) document.getElementById('stat-youth').textContent = youth;
    if(document.getElementById('stat-seniors')) document.getElementById('stat-seniors').textContent = seniors;
    if(document.getElementById('stat-disabled')) document.getElementById('stat-disabled').textContent = disabled;

    // Bandlik
    if(document.getElementById('stat-unemployed')) document.getElementById('stat-unemployed').textContent = unemployed;
    if(document.getElementById('stat-employed')) document.getElementById('stat-employed').textContent = employed;
    if(document.getElementById('stat-students')) document.getElementById('stat-students').textContent = students;
    if(document.getElementById('stat-migrants')) document.getElementById('stat-migrants').textContent = migrants;
    if(document.getElementById('stat-returned-migrants')) document.getElementById('stat-returned-migrants').textContent = returnedMigrants;

    // Oilaviy
    if(document.getElementById('stat-divorced')) document.getElementById('stat-divorced').textContent = divorced;
    if(document.getElementById('stat-verge-of-divorce')) document.getElementById('stat-verge-of-divorce').textContent = vergeOfDivorce;
    if(document.getElementById('stat-renters')) document.getElementById('stat-renters').textContent = renters;
    if(document.getElementById('stat-temporary')) document.getElementById('stat-temporary').textContent = temporary;
    if(document.getElementById('stat-shubhali')) document.getElementById('stat-shubhali').textContent = shubhali;
    if(document.getElementById('stat-toifadagilar')) document.getElementById('stat-toifadagilar').textContent = toifadagilar;

    // TEXNIK HOLAT (MUHIM: IDlar HTML bilan bir xil bo'lishi kerak)
    if(document.getElementById('stat-gaz-aqlli')) document.getElementById('stat-gaz-aqlli').textContent = gazAqlli;
    if(document.getElementById('stat-elektr-aqlli')) document.getElementById('stat-elektr-aqlli').textContent = elektrAqlli;
    if(document.getElementById('stat-suv-aqlli')) document.getElementById('stat-suv-aqlli').textContent = suvAqlli;
    if(document.getElementById('stat-isitish-yoq')) document.getElementById('stat-isitish-yoq').textContent = isitishYoq;
    if(document.getElementById('stat-avtomobil')) document.getElementById('stat-avtomobil').textContent = avtomobil;
    if(document.getElementById('stat-ishonchnoma')) document.getElementById('stat-ishonchnoma').textContent = ishonchnoma;

    // Huquqiy
    if(document.getElementById('stat-aliment')) document.getElementById('stat-aliment').textContent = aliment;
    if(document.getElementById('stat-yuridik')) document.getElementById('stat-yuridik').textContent = yuridik;
    if(document.getElementById('stat-mulk-muammo')) document.getElementById('stat-mulk-muammo').textContent = mulkMuammo;
    if(document.getElementById('stat-telegram-yoq')) document.getElementById('stat-telegram-yoq').textContent = telegramYoq;
    if(document.getElementById('stat-daromad-past')) document.getElementById('stat-daromad-past').textContent = daromadPast;
    if(document.getElementById('stat-ishlovchi-yoq')) document.getElementById('stat-ishlovchi-yoq').textContent = ishlovchiYoq;

    // INSPEKTOR STATISTIKASI (Agar ruxsat bo'lsa)
    const inspectorSection = document.getElementById('summary-inspector-section');
    const inspectorUsers = ['2304', '2528', '4161', '1909', '1983'];
    
    if (inspectorSection) {
        if (inspectorUsers.includes(CURRENT_USER.pass)) {
            inspectorSection.style.display = 'block';
            
            const pxt = d.filter(p => (p.toifa_turi || '').includes('PXT')).length;
            const probatsiya = d.filter(p => (p.toifa_turi || '').includes('Probatsiya')).length;
            const sudlangan = d.filter(p => p.sudlanganlik === 'Ha').length;
            const qurol = d.filter(p => p.qurol_egalik === 'Ha').length;

            if(document.getElementById('stat-pxt')) document.getElementById('stat-pxt').textContent = pxt;
            if(document.getElementById('stat-probatsiya')) document.getElementById('stat-probatsiya').textContent = probatsiya;
            if(document.getElementById('stat-sudlangan')) document.getElementById('stat-sudlangan').textContent = sudlangan;
            if(document.getElementById('stat-qurol')) document.getElementById('stat-qurol').textContent = qurol;
        } else {
            inspectorSection.style.display = 'none';
        }
    }
    
    // IJTIMOIY DAFTARLAR STATISTIKASI
    const ayollarDaftariStat = d.filter(p => p.ayollar_daftari === "Ro'yxatda turadi" || p.ayollar_daftari === "Ro'yxatga olish kerak").length;
    const yoshlarDaftariStat = d.filter(p => p.yoshlar_daftari === "Ro'yxatda turadi" || p.yoshlar_daftari === "Ro'yxatga olish kerak").length;
    const moddiyYordamStat = d.filter(p => p.moddiy_yordam === 'Bola puli oladi' || p.moddiy_yordam === 'Nafaqa oladi').length;
    
    // NEET yoshlar - 18-30 yosh, ishlamaydi (Ishsiz, Uy bekasi, bo'sh), o'qimaydi
    const neetStat = d.filter(p => {
        const age = getAge(p.dob);
        if (!age || age < 18 || age > 30) return false;
        const isUnemployed = p.employmentStatus === 'Ishsiz' || p.employmentStatus === 'Uy bekasi' || !p.employmentStatus;
        const isNotStudent = !['Talaba', "Maktab o'quchisi", "Bog'cha", "Talaba/O'quvchi"].includes(p.employmentStatus);
        return isUnemployed && isNotStudent;
    }).length;
    const xavfliStat = d.filter(p => {
        const risk = calculateRiskScore(p);
        return risk.level === 'YUQORI XAVF' || risk.level === "O'rta xavf";
    }).length;
    
    if(document.getElementById('stat-ayollar-daftari')) document.getElementById('stat-ayollar-daftari').textContent = ayollarDaftariStat;
    if(document.getElementById('stat-yoshlar-daftari')) document.getElementById('stat-yoshlar-daftari').textContent = yoshlarDaftariStat;
    if(document.getElementById('stat-moddiy-yordam')) document.getElementById('stat-moddiy-yordam').textContent = moddiyYordamStat;
    if(document.getElementById('stat-neet')) document.getElementById('stat-neet').textContent = neetStat;
    if(document.getElementById('stat-xavfli')) document.getElementById('stat-xavfli').textContent = xavfliStat;

    // Oynani ochish
    showScreen('summary-modal');
}
// 1. STATISTIKA TUGMALARI BOSILGANDA ISHLAYDIGAN FUNKSIYA
async function openStatDetails(category, categoryLabel) {
    // Aholi bazasi yuklanganini tekshirish
    if (!activeCitizenDatabase || activeCitizenDatabase.length === 0) {
        showToast("Bazada ma'lumot yo'q!", "error");
        return;
    }

    // Statistik oynani yopib, yuklash belgisini chiqaramiz
    document.getElementById('summary-modal').style.display = 'none';
    showLoader(true);
    
    // Ma'lumotlar tayyor bo'lishini kutamiz
    await dataReadyPromise;
    
    let list = [];
    const baza = activeCitizenDatabase;

    // "Toifadagilar" tugmasi uchun maxsus mantiq
    if (category === 'toifadagilar') {
        const toifalar = ["Janjalkash (Notinch oila)", "Og'ir xulq atvor", "G'ayriijtimoiy xulq atvor", "Ruxiy kasal", "Psixotrop", "Ichkilikka ruju qo'ygan", "PXT", "Probatsiya", "Muqaddam sudlangan", "Migratsiyadan qaytgan"];
        
        let html = `<h3 style="margin-bottom: 1.5rem;">Maxsus Nazoratdagi Toifalar</h3><div class="summary-grid">`;
        
        toifalar.forEach(toifa => {
            let count = 0;
            if (toifa === 'Migratsiyadan qaytgan') {
                count = baza.filter(p => p.employmentStatus === 'Migratsiyadan qaytgan').length;
            } else {
                count = baza.filter(p => (p.toifa_turi || '').includes(toifa)).length;
            }
            
            const iconClass = NAZORAT_ICONS[toifa] || "fas fa-user-tag";
            // Har bir toifa uchun alohida karta yaratamiz
            html += `
            <div class="summary-stat-card" data-category="toifa_detail" data-toifa="${toifa}">
                <div class="icon"><i class="${iconClass}"></i></div>
                <div class="number">${count}</div>
                <div class="label">${toifa}</div>
            </div>`;
        });
        html += `</div>`;
        
        // Natijani chiqaramiz
        const contentContainer = document.getElementById('full-list-table-container');
        const titleContainer = document.getElementById('full-list-title');
        
        if(titleContainer) titleContainer.innerHTML = `Maxsus Nazorat (<span>${baza.filter(p=>p.shaxs_toifasi==='Ha').length}</span>)`;
        if(contentContainer) contentContainer.innerHTML = html;
        
        showScreen('full-list-modal');
        showLoader(false);
        return; // Funksiyadan chiqamiz, chunki ro'yxat emas, menyu ochdik
    }

    // QOLGAN BARCHA TUGMALAR UCHUN FILTRLASH
    switch (category) {
        // ASOSIY
        case 'total': list = baza; break;
        case 'households': 
            const byAddr = {}; 
            baza.forEach(p => { const addr = p.street || ''; if (addr) byAddr[addr] = p; }); 
            list = Object.values(byAddr); 
            break;
        case 'families': 
            const familyHeads = {}; 
            baza.forEach(p => { if (p.family_id && !familyHeads[p.family_id]) familyHeads[p.family_id] = p; }); 
            list = Object.values(familyHeads); 
            break;
        case 'problem': list = baza.filter(hasActiveProblem); break;

        // DEMOGRAFIK
        case 'men': list = baza.filter(p => p.jinsi === 'Erkak'); break;
        case 'women': list = baza.filter(p => p.jinsi === 'Ayol'); break;
        case 'youth': list = baza.filter(p => { const age = getAge(p.dob); return age !== null && age >= 14 && age <= 30; }); break;
        case 'seniors': list = baza.filter(p => { const age = getAge(p.dob); return age !== null && age >= 80; }); break;
        case 'disabled': list = baza.filter(p => p.employmentStatus === 'Nogironligi bor'); break;

        // BANDLIK
        case 'employed': list = baza.filter(p => ['Rasmiy band', 'Norasmiy band', 'Tadbirkor'].includes(p.employmentStatus)); break;
        case 'unemployed': list = baza.filter(p => p.employmentStatus === 'Ishsiz'); break;
        case 'students': list = baza.filter(p => ['Talaba', "Maktab o'quchisi"].includes(p.employmentStatus)); break;
        case 'migrants': list = baza.filter(p => p.employmentStatus === 'Migratsiya'); break;
        case 'returned-migrants': list = baza.filter(p => p.employmentStatus === 'Migratsiyadan qaytgan'); break;

        // OILAVIY
        case 'divorced': list = baza.filter(p => p.socialStatus === 'Ajrashgan'); break;
        case 'verge-of-divorce': list = baza.filter(p => p.socialStatus === 'Ajrim yoqasida'); break;
        case 'renters': list = baza.filter(p => p.registrationType === 'Ijara'); break;
        case 'temporary': list = baza.filter(p => p.registrationType === 'Vaqtincha'); break;

        // TEXNIK
        case 'gaz-aqlli': list = baza.filter(p => p.gaz_hisoblagich === 'Aqlli'); break;
        case 'elektr-aqlli': list = baza.filter(p => p.elektr_hisoblagich === 'Aqlli'); break;
        case 'suv-aqlli': list = baza.filter(p => p.suv_hisoblagich === 'Aqlli'); break;
        case 'isitish-yoq': list = baza.filter(p => p.isitish_tizimi === "Yo'q"); break;
        case 'avtomobil': list = baza.filter(p => p.avtomobil_bor === 'Ha'); break;
        case 'ishonchnoma': list = baza.filter(p => p.avto_ishonchnoma === 'Ha'); break;

        // HUQUQIY & IQTISODIY
        case 'aliment': list = baza.filter(p => p.aliment_muammo === 'Ha'); break;
        case 'yuridik': list = baza.filter(p => p.yuridik_maslahat === 'Ha'); break;
        case 'mulk-muammo': list = baza.filter(p => p.mulk_muammo === 'Ha'); break;
        case 'telegram-yoq': list = baza.filter(p => p.telegram_azo === "Yo'q"); break;
        case 'daromad-past': list = baza.filter(p => p.oylik_daromad === '2 mln gacha'); break;
        case 'ishlovchi-yoq': list = baza.filter(p => p.ishlovchilar_soni === '0'); break;

        // INSPEKTOR
        case 'shubhali': list = baza.filter(p => p.shubhali_shaxs === 'Ha'); break;
        case 'pxt': list = baza.filter(p => (p.toifa_turi || '').includes('PXT')); break;
        case 'probatsiya': list = baza.filter(p => (p.toifa_turi || '').includes('Probatsiya')); break;
        case 'sudlangan': list = baza.filter(p => p.sudlanganlik === 'Ha'); break;
        case 'qurol': list = baza.filter(p => p.qurol_egalik === 'Ha'); break;

        // IJTIMOIY DAFTARLAR
        case 'ayollar-daftari': 
            list = baza.filter(p => p.ayollar_daftari && (p.ayollar_daftari.includes("Ro'yxatda") || p.ayollar_daftari.includes("kerak"))); 
            break;
        case 'yoshlar-daftari': 
            list = baza.filter(p => p.yoshlar_daftari && (p.yoshlar_daftari.includes("Ro'yxatda") || p.yoshlar_daftari.includes("kerak"))); 
            break;
        case 'moddiy-yordam': 
            list = baza.filter(p => p.moddiy_yordam && (p.moddiy_yordam.includes('Bola puli') || p.moddiy_yordam.includes('Nafaqa'))); 
            break;
        case 'neet': 
            list = baza.filter(p => {
                const age = getAge(p.dob);
                if (!age || age < 18 || age > 30) return false;
                const isUnemployed = p.employmentStatus === 'Ishsiz' || p.employmentStatus === 'Uy bekasi' || !p.employmentStatus;
                const isNotStudent = !['Talaba', "Maktab o'quchisi", "Bog'cha"].includes(p.employmentStatus);
                return isUnemployed && isNotStudent;
            }); 
            break;
        case 'xavfli': 
            list = baza.filter(p => {
                const risk = calculateRiskScore(p);
                return risk.level === 'YUQORI XAVF' || risk.level === "O'rta xavf";
            }); 
            break;

        default: list = [];
    }

    // Ro'yxatni chiqarish
    displayFilteredList(list, categoryLabel, category);
}

// 2. TUGMALARNI BOSISH HODISASI (Event Listener)
// Buni setupEventListeners() funksiyasi ichiga qo'shing yoki yangilang:
document.body.addEventListener('click', async (e) => {
    // ... boshqa kodlar ...

    // STATISTIKA KARTASI BOSILGANDA
    if (e.target.closest('.summary-stat-card')) {
        const card = e.target.closest('.summary-stat-card');
        const category = card.getAttribute('data-category');
        
        // Label ni topish - turli strukturalar uchun
        let label = 'Ro\'yxat';
        const labelDiv = card.querySelector('.label');
        if (labelDiv) {
            label = labelDiv.textContent;
        } else {
            // Inline style bilan yozilgan label (oxirgi div)
            const allDivs = card.querySelectorAll('div');
            if (allDivs.length > 0) {
                const lastDiv = allDivs[allDivs.length - 1];
                if (lastDiv && !lastDiv.id) {
                    label = lastDiv.textContent;
                }
            }
        }

        // Toifa ichidagi kichik kartalar bosilganda (Toifadagilar -> PXT)
        if (category === 'toifa_detail') {
            const clickedToifa = card.getAttribute('data-toifa');
            let filteredList = [];
            
            if (clickedToifa === "Migratsiyadan qaytgan") {
                filteredList = activeCitizenDatabase.filter(p => p.employmentStatus === 'Migratsiyadan qaytgan');
            } else {
                filteredList = activeCitizenDatabase.filter(p => ((p.toifa_turi || '').includes(clickedToifa)) || p.socialStatus === clickedToifa);
            }
            displayFilteredList(filteredList, `${clickedToifa} Ro'yxati`, 'toifadagilar');
            return;
        }

        // Oddiy statistika kartasi bosilganda
        if (category) {
            // Ruxsat tekshirish (faqat "Toifadagilar" uchun)
            if (category === 'toifadagilar') {
                const allowedRoles = ['2304', '4161', '1909', '1983'];
                if (!allowedRoles.includes(CURRENT_USER.pass)) {
                    showCustomAlert("Ushbu bo'limga kirishga ruxsat yo'q.", "Cheklangan");
                    return;
                }
            }
            openStatDetails(category, label);
        }
    }
});
function displayFullList(isArchive = false) {
    if (CURRENT_USER.access !== 'full') return showCustomAlert("Ushbu bo'limga ruxsat yo'q.", "Cheklangan");
    showLoader(true);
    try {
        const list = isArchive ? archivedCitizenDatabase : activeCitizenDatabase;
        const title = isArchive ? "Arxiv" : "Jami Ro'yxat";

        if (list.length === 0) {
             showLoader(false);
             DOM.fullListTitle.innerHTML = `${title} (<span>0</span>)`;
             DOM.fullListTableContainer.innerHTML = `<p style="text-align:center;padding:2rem;">Bu bo'limda ma'lumot yo'q.</p><button class="btn btn-secondary js-back-to-previous-view" style="width:auto; margin:1.5rem auto 0; display:block;"><i class="fas fa-arrow-left"></i> Orqaga</button>`;
             showScreen('full-list-modal');
             return;
        }

        currentDisplayedList = list;
        currentListTitle = title;
        DOM.fullListTitle.innerHTML = `${title} (<span>${list.length}</span>)`;
        let html = `<button class="btn btn-secondary js-back-to-previous-view" style="width:auto; margin-bottom:1.5rem; margin-top:0;"><i class="fas fa-arrow-left"></i> Orqaga</button>`;
        html += list.map(p => createPersonCardHTML(p, false, 'full-list-modal')).join('');
        DOM.fullListTableContainer.innerHTML = html;
        showScreen('full-list-modal');
        DOM.fullListSearch.value = '';
        DOM.fullListSearch.oninput = (e) => {
            const query = transliterate(e.target.value.toLowerCase());
            const filteredList = list.filter(p => {
                const fioMatch = (p.fio || '').toLowerCase().includes(query);
                const addressMatch = (p.street || '').toLowerCase().includes(query);
                const phoneMatch = (p.telefon || '').includes(query);
                const jshshirMatch = String(p.jshshir || '').includes(query);
                return fioMatch || addressMatch || phoneMatch || jshshirMatch;
            });
            currentDisplayedList = filteredList;
            const filteredHtml = `<button class="btn btn-secondary js-back-to-previous-view" style="width:auto; margin-bottom:1.5rem; margin-top:0;"><i class="fas fa-arrow-left"></i> Orqaga</button>` + filteredList.map(p => createPersonCardHTML(p, false, 'full-list-modal')).join('');
            DOM.fullListTableContainer.innerHTML = filteredHtml;
            DOM.fullListTitle.querySelector('span').textContent = filteredList.length;
        };
    } catch (error) {
        showCustomAlert(error.message, "Xatolik");
    } finally {
        showLoader(false);
    }
}
/* ================== INIT & STEPPER ================== */
function initializeSelects(){
    const fill=(sel,arr, isObj=false)=>{
        if(!sel)return;
        sel.innerHTML='<option value="" selected disabled>Tanlang...</option>';
        if (isObj) {
            for(const key in arr) {
                const o=document.createElement('option');o.value=key;o.textContent=key;sel.appendChild(o);
            }
        } else {
            arr.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;sel.appendChild(o);});
        }
    };
    fill(document.querySelector('select[name="kop_qavatli_kochasi"]'),KOP_QAVATLI_STREETS);
    fill(document.querySelector('select[name="xovli_kochasi"]'),HOVLI_STREETS);
    document.querySelectorAll('.js-metrka-series').forEach(s=>fill(s,METRKA_SERIES_LIST));
    const mainEmploymentStatusOptions = ["Ishsiz","Rasmiy band","Norasmiy band","Tadbirkor","Talaba","Maktab o'quchisi","Bog'cha","Ona qaramog'ida","Nafaqada","Nogironligi bor","Uy bekasi","Dekret","Ketish arafasida"];
    document.querySelectorAll('.js-employment-status-sub').forEach(s => {
        s.innerHTML = '<option value="" selected disabled>Tanlang...</option>';
        mainEmploymentStatusOptions.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; s.appendChild(o); });
    });
    const container = document.getElementById('toifa-checkboxes-container');
    container.innerHTML = '';
    const allToifalar = [...TOIFA_TURI_LIST.all, ...TOIFA_TURI_LIST.inspector];
    allToifalar.forEach(toifa => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'toifa_turi';
        checkbox.value = toifa;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(` ${toifa}`));
        container.appendChild(label);
    });
    fill(DOM.addObjectForm.querySelector('select[name="mainCategory"]'), OBJECT_CATEGORIES, true);
    fill(DOM.addObjectForm.querySelector('select[name="orgType"]'), ORG_TYPES);
    fill(DOM.addStaffForm.querySelector('select[name="position"]'), STAFF_POSITIONS);

    const viloyatSelect = document.getElementById('kelgan_viloyati_select');
    const tumanSelect = document.getElementById('kelgan_tumani_select');
    const davlatSelect = document.getElementById('kelgan_davlat_select');
    
    // Davlatlar ro'yxatini to'ldirish
    if (davlatSelect) {
        davlatSelect.innerHTML = '<option value="" selected>Tanlang...</option>';
        davlatlar.forEach(d => {
            const option = document.createElement('option');
            option.value = d;
            option.textContent = d;
            davlatSelect.appendChild(option);
        });
        
        davlatSelect.addEventListener('change', () => {
            const selectedDavlat = davlatSelect.value;
            const viloyatContainer = document.querySelector('.js-uzbek-viloyat');
            const tumanContainer = document.querySelector('.js-uzbek-tuman');
            const mfyContainer = document.querySelector('.js-uzbek-mfy');
            
            if (selectedDavlat === "O'zbekiston") {
                // O'zbekiston tanlansa - viloyat ko'rsatish
                if (viloyatContainer) viloyatContainer.style.display = 'block';
                if (tumanContainer) tumanContainer.style.display = 'none';
                if (mfyContainer) mfyContainer.style.display = 'none';
                
                // Viloyatlar ro'yxatini to'ldirish
                if (viloyatSelect) {
                    viloyatSelect.innerHTML = '<option value="" selected>Tanlang...</option>';
                    viloyatlar.forEach(v => {
                        const option = document.createElement('option');
                        option.value = v;
                        option.textContent = v;
                        viloyatSelect.appendChild(option);
                    });
                }
            } else {
                // Boshqa davlat tanlansa - yashirish
                if (viloyatContainer) viloyatContainer.style.display = 'none';
                if (tumanContainer) tumanContainer.style.display = 'none';
                if (mfyContainer) mfyContainer.style.display = 'none';
            }
        });
    }
    
    // Viloyat tanlanganda tumanlar
    if (viloyatSelect) {
        viloyatSelect.addEventListener('change', () => {
            const selectedViloyat = viloyatSelect.value;
            const tumanContainer = document.querySelector('.js-uzbek-tuman');
            const mfyContainer = document.querySelector('.js-uzbek-mfy');
            const tumanlar = tumanlarData[selectedViloyat] || [];

            if (tumanlar.length > 0 && tumanContainer) {
                tumanContainer.style.display = 'block';
                if (mfyContainer) mfyContainer.style.display = 'none';
                
                tumanSelect.innerHTML = '<option value="">Tanlang...</option>';
                tumanlar.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t;
                    option.textContent = t;
                    tumanSelect.appendChild(option);
                });
            } else {
                if (tumanContainer) tumanContainer.style.display = 'none';
                if (mfyContainer) mfyContainer.style.display = 'none';
            }
        });
    }
    
    // Tuman tanlanganda MFY
    if (tumanSelect) {
        tumanSelect.addEventListener('change', () => {
            const mfyContainer = document.querySelector('.js-uzbek-mfy');
            if (tumanSelect.value && mfyContainer) {
                mfyContainer.style.display = 'block';
            }
        });
    }
}
function navigateToStep(step, formContainer, totalStepsInForm){
    const steps = formContainer.querySelectorAll('.form-step');
    const progressSteps = formContainer.querySelectorAll('.progress-step');
    const progressBar = formContainer.querySelector('.form-progress-bar');
    const prevBtn = formContainer.querySelector('.js-prev-step');
    const nextBtn = formContainer.querySelector('.js-next-step');
    const saveBtn = formContainer.querySelector('.js-save-citizen') || formContainer.querySelector('.js-save-object');
    steps.forEach(s=>s.classList.remove('active'));
    formContainer.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
    progressSteps.forEach((p,i)=>{(i < step) ? p.classList.add('active') : p.classList.remove('active');});
    if(progressBar) {
      const progressPercentage = (step > 1) ? ((step - 1) / (totalStepsInForm - 1)) * 100 : 0;
      progressBar.style.width = `${progressPercentage}%`;
    }
    if(prevBtn) prevBtn.style.display = step > 1 ? 'inline-flex' : 'none';
    if(nextBtn) nextBtn.style.display = step < totalStepsInForm ? 'inline-flex' : 'none';
    if(saveBtn) saveBtn.style.display = step === totalStepsInForm ? 'inline-flex' : 'none';
    if(formContainer.id === 'add-object-modal' || formContainer.closest('#add-object-modal')) {
      objectCurrentStep = step;
    } else {
      currentStep = step;
    }
    return step;
}
function resetFormToCreateMode(){ 
  isEditMode = false;
  DOM.addForm.reset(); 
  DOM.addForm.querySelectorAll('[name="toifa_turi"]').forEach(cb => cb.checked = false);
  document.getElementById('form-title').textContent = "Yangi Fuqaro Qo'shish"; 
  DOM.addForm.querySelector('[name="update_unique_id"]').value = '';
  DOM.addForm.querySelector('[name="photoBase64"]').value = '';
  DOM.addForm.querySelector('[name="signatureBase64"]').value = '';
  document.getElementById('form-photo-preview').style.display = 'none';
  document.getElementById('form-photo-preview').src = '';
  document.getElementById('add-form-signature-preview').innerHTML = '';
  document.getElementById('address-family-suggestions').innerHTML = ''; 
  document.getElementById('address-family-suggestions').style.display = 'none'; 
  currentStep = navigateToStep(1, DOM.addForm.closest('.card'), 3);
  document.querySelectorAll('#add-view .conditional-field').forEach(e=>e.style.display='none'); 
  const shubBtn=DOM.addForm.querySelector('.js-shubhali-toggle'); 
  const shubHidden=DOM.addForm.querySelector('[name="shubhali_shaxs"]'); 
  if(shubBtn){shubBtn.classList.remove('active');shubBtn.style.color='var(--secondary-color)';} 
  if(shubHidden)shubHidden.value="Yo'q"; 
  const xs=document.getElementById('xatlovchi-select'); 
  if(xs&&CURRENT_USER.role){xs.value=CURRENT_USER.role;} 
  const shaxsToifasiSelect = DOM.addForm.querySelector('select[name="shaxs_toifasi"]');
  if (shaxsToifasiSelect) shaxsToifasiSelect.value = "";
}
/* ================== EVENT LISTENERS ================== */
function generateAndDownloadPdf() {
    showLoader(true);
    const detailsWrapper = DOM.detailsContent.querySelector('#details-render-wrapper');
    if (!detailsWrapper || !detailsWrapper.dataset.personData) {
        showLoader(false);
        return showCustomAlert("PDF yaratish uchun ma'lumot topilmadi.", "Xatolik");
    }

    const p = JSON.parse(detailsWrapper.dataset.personData.replace(/&apos;/g, "'"));
    const risk = calculateRiskScore(p);

    const render = (label, value) => {
        const val = value ? String(value).trim() : '';
        if (!val || val.toLowerCase() === "yo'q" || val === '') return '';
        return `
          <tr>
            <td style="padding:5px 4px;color:#555;font-size:9pt;">${label}</td>
            <td style="padding:5px 4px;color:#111;font-weight:600;font-size:9pt;text-align:right;">${val}</td>
          </tr>`;
    };

    const sectionTitle = (title, icon, color) => `
        <div style="font-size:11pt;font-weight:700;color:${color || '#7c3aed'};
                    margin-top:14px;margin-bottom:5px;padding:6px 8px;
                    background:${color}15;border-radius:6px;display:flex;align-items:center;">
            <span style="margin-right:6px;">${icon}</span> ${title}
        </div>`;

    let photoHtml = '';
    try {
        const photoSrc = p.photoBase64
            ? p.photoBase64
            : (p.rasm_link ? `https://lh3.googleusercontent.com/d/${p.rasm_link}` : null);
        if (photoSrc) {
            photoHtml = `
              <img src="${photoSrc}" 
                   style="width:90px;height:90px;border-radius:50%;object-fit:cover;
                          border:3px solid ${risk.color};margin-bottom:10px;"
                   ${p.rasm_link ? 'crossorigin="anonymous"' : ''}>`;
        }
    } catch (e) {
        console.warn("Fuqaro rasmini PDFga qo'shishda xatolik:", e);
        photoHtml = '';
    }

    let signatureHtmlBlock = '';
    try {
        const signatureSrc = p.signatureBase64
            ? p.signatureBase64
            : (p.signatureLink ? `https://lh3.googleusercontent.com/d/${p.signatureLink}` : null);
        if (signatureSrc) {
            signatureHtmlBlock = `
              ${sectionTitle("Imzo namunasi", "‚úçÔ∏è", "#7c3aed")}
              <div style="text-align:center;padding:12px;background:#f5f5f5;border-radius:8px;">
                  <img src="${signatureSrc}" 
                       style="max-height:80px;background:#fff;border-radius:6px;
                              padding:8px;border:2px solid #7c3aed;"
                       ${p.signatureLink ? 'crossorigin="anonymous"' : ''}>
              </div>`;
        }
    } catch (e) {
        console.warn("Imzoni PDFga qo'shishda xatolik:", e);
        signatureHtmlBlock = '';
    }

    let problemBlock = '';
    const hasProblem = p.izoh && String(p.izoh).trim() && String(p.izoh).toLowerCase() !== "yo'q";
    if (hasProblem) {
        const solved = String(p.muammo_holati || '').trim() === 'Hal etildi';
        problemBlock = `
          <div style="margin-top:14px;padding:10px 12px;
                      background:${solved ? '#e8f5e9' : '#fff8e1'};
                      border-left:4px solid ${solved ? '#22c55e' : '#f59e0b'};
                      border-radius:6px;">
            <div style="font-weight:700;font-size:10pt;margin-bottom:4px;
                        color:${solved ? '#166534' : '#92400e'};">
                ${solved ? '‚úÖ Muammo yechimi' : '‚ö†Ô∏è Muammosi'}
            </div>
            <div style="font-size:9pt;color:#111;font-weight:600;line-height:1.3;">
                ${solved ? (p.muammo_yechimi || p.izoh) : p.izoh}
            </div>
          </div>`;
    }

    const fio = p.fio || '';
    const titleFio = fio || "Fuqaro haqida ma'lumot";

    const fullHtml = `
      <div style="font-family:'Inter',sans-serif;background:#ffffff;color:#000000;
                  width:210mm;padding:12mm 14mm 10mm;box-sizing:border-box;font-size:9pt;">
        
        <!-- HEADER -->
        <div style="display:flex;align-items:center;gap:15px;margin-bottom:12px;padding-bottom:12px;border-bottom:3px solid #7c3aed;">
            <div style="flex-shrink:0;">${photoHtml}</div>
            <div style="flex:1;">
                <div style="font-size:18pt;font-weight:800;color:#111827;">${titleFio}</div>
                <div style="font-size:10pt;color:#666;margin-top:4px;">${p.street || ''} | ${p.jinsi || ''}, ${getAge(p.dob) || '?'} yosh</div>
                <div style="margin-top:6px;display:inline-block;padding:3px 10px;background:${risk.color}20;color:${risk.color};border-radius:12px;font-weight:700;font-size:9pt;">
                    ${risk.level} (${risk.score} ball)
                </div>
            </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 20px;">
        
        <!-- 1-USTUN -->
        <div>
            ${sectionTitle("Shaxsiy ma'lumotlar", "üë§", "#7c3aed")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("Hujjat", p.passport)}
                ${render("JSHSHIR", p.jshshir)}
                ${render("Tug'ilgan sana", formatDate(p.dob))}
                ${render("Jinsi", p.jinsi)}
                ${render("Telefon", p.telefon)}
                ${render("Qarindoshligi", p.qarindoshligi)}
            </table>
            
            ${sectionTitle("Yashash manzili", "üè†", "#3b82f6")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("MFY", p.mfy)}
                ${render("Ko'cha, uy", p.street)}
                ${render("Yashash holati", p.registrationType)}
                ${render("Uy egasi FIO", p.uy_egasi_fio)}
                ${render("Uy egasi tel", p.uy_egasi_telefon)}
            </table>
            
            ${sectionTitle("Ijtimoiy holati", "üë®‚Äçüë©‚Äçüëß‚Äçüë¶", "#8b5cf6")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("Ijtimoiy holati", p.socialStatus)}
                ${render("Oila a'zolari", p.oila_azolari_soni)}
                ${render("Bandlik holati", p.employmentStatus)}
                ${render("Ish joyi", p.employmentDetails)}
                ${render("O'qish joyi", p.oqish_joyi)}
                ${render("Kursi/Sinfi", p.kursi_sinfi)}
                ${render("Bog'cha nomi", p.bogcha_nomi)}
                ${render("Nogironlik guruhi", p.disabilityGroup)}
            </table>
            
            ${p.employmentStatus === 'Migratsiya' || p.employmentStatus === 'Migratsiyadan qaytgan' ? `
            ${sectionTitle("Migratsiya", "‚úàÔ∏è", "#f97316")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("Migratsiya davlati", p.migration_country || p.returned_migration_country)}
                ${render("Qancha vaqt", p.migration_duration)}
                ${render("Qaytgan sana", formatDate(p.returned_migration_date))}
                ${render("Hozirgi holati", p.returned_migration_current_status)}
            </table>
            ` : ''}
            
            ${sectionTitle("Xonadon texnik holati", "üè†", "#3b82f6")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("Kadastr raqami", p.kadastr_raqami)}
                ${render("Isitish tizimi", p.isitish_tizimi)}
                ${render("Gaz hisoblagich", p.gaz_hisoblagich)}
                ${render("Gaz litsevoy", p.gaz_litsavoy)}
                ${render("Elektr hisoblagich", p.elektr_hisoblagich)}
                ${render("Elektr litsevoy", p.elektr_litsavoy)}
                ${render("Suv hisoblagich", p.suv_hisoblagich)}
                ${render("Suv litsevoy", p.suv_litsavoy)}
                ${render("Chiqindi xizmat", p.chiqindi_xizmat)}
                ${render("Chiqindi shartnoma", p.chiqindi_litsavoy)}
            </table>
        </div>
        
        <!-- 2-USTUN -->
        <div>
            ${p.avtomobil_bor === 'Ha' ? `
            ${sectionTitle("Avtomobil", "üöó", "#10b981")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("Rusumi", p.avto_rusumi)}
                ${render("Davlat raqami", p.avto_raqami)}
                ${render("Rangi", p.avto_rangi)}
                ${render("Ishonchnoma", p.avto_ishonchnoma)}
                ${render("Gaz o'rnatilgan", p.avto_gaz)}
            </table>
            ` : ''}
            
            ${sectionTitle("Psixologik va qiziqishlar", "üß†", "#8b5cf6")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("Qiziqishlari (Hobbi)", p.hobbi)}
                ${render("Psixologik yordam", p.psixologik_yordam)}
                ${render("Mahalla yordami", p.mahalla_yordam)}
            </table>
            
            ${sectionTitle("Huquqiy holat", "‚öñÔ∏è", "#06b6d4")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("Telegram a'zo", p.telegram_azo)}
                ${render("Aliment muammo", p.aliment_muammo)}
                ${render("Yuridik maslahat", p.yuridik_maslahat)}
                ${render("Mulk muammo", p.mulk_muammo)}
            </table>
            
            ${sectionTitle("Iqtisodiy holat", "üí∞", "#f97316")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("Oylik daromad", p.oylik_daromad)}
                ${render("Ishlovchilar soni", p.ishlovchilar_soni)}
            </table>
            
            ${p.sudlanganlik === 'Ha' || p.qurol_egalik === 'Ha' || p.shubhali_shaxs === 'Ha' || p.shaxs_toifasi === 'Ha' ? `
            ${sectionTitle("Xavfsizlik va nazorat", "üõ°Ô∏è", "#ef4444")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("Shubhali shaxs", p.shubhali_shaxs)}
                ${render("Shaxs toifasi", p.shaxs_toifasi)}
                ${render("Toifa turi", p.toifa_turi)}
                ${render("Sudlanganlik", p.sudlanganlik)}
                ${render("JK moddasi", p.jk_moddasi)}
                ${render("Jazodan qaytgan", formatDate(p.jazo_qaytgan_sana))}
                ${render("Qurolga egalik", p.qurol_egalik)}
                ${render("Qurol turi", p.qurol_turi)}
                ${render("Qurol ruxsatnoma", p.qurol_ruxsatnoma)}
                ${render("Ruxsat tugash", formatDate(p.qurol_tugash_sana))}
            </table>
            ` : ''}
            
            ${sectionTitle("Qo'shimcha ma'lumotlar", "üìã", "#6b7280")}
            <table style="width:100%;border-collapse:collapse;">
                ${render("Xatlovchi", p.xatlovchi)}
                ${render("Ro'yxatga olingan", formatDate(p.regDate))}
                ${render("Kelgan viloyat", p.kelgan_viloyati)}
                ${render("Kelgan tuman", p.kelgan_tumani)}
                ${render("PXT uchrashuv", formatDate(p.uchrashuv_sanasi))}
                ${render("Probatsiya uchrashuv", formatDate(p.probatsiya_uchrashuv_sanasi))}
            </table>
            
            ${problemBlock}
            ${signatureHtmlBlock}
        </div>
        
        </div>

        <div style="margin-top:20px;text-align:center;font-size:8pt;color:#9ca3af;
                    border-top:1px solid #e5e7eb;padding-top:8px;">
            <strong>O'zbegim MFY</strong> ‚Äì Fuqarolar Ro'yxat Tizimi | ${new Date().toLocaleDateString('uz-UZ')}
        </div>
      </div>
    `;

    const safeFileName = (fio || 'fuqaro_malumoti').replace(/[\\/:*?"<>|]/g, '_');

    const opt = {
        margin: 0,
        filename: `${safeFileName}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
            scale: 2,
            useCORS: true,
            letterRendering: true,
            backgroundColor: '#ffffff',
            logging: false
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().from(fullHtml).set(opt).save().then(() => {
        showLoader(false);
        showToast("PDF fayl muvaffaqiyatli yuklandi!");
    }).catch(err => {
        showLoader(false);
        console.error("Fuqaro PDF yaratishda xatolik:", err);
        showCustomAlert("PDF yaratishda xatolik yuz berdi. Rasm yoki imzo havolalarini tekshiring.", "Xatolik");
    });
}
function setupEventListeners(){
  document.addEventListener('keydown', (e) => { 
    if (e.key === 'Escape') { 
      if(DOM.cameraModal.style.display === 'flex') { stopCamera(); goBack(); return; }
      if(DOM.imageViewerModal.style.display === 'flex') { goBack(); return; }
      if(DOM.solveProblemModal.style.display === 'flex') { goBack(); return; }
      if(DOM.notificationModal.style.display === 'flex') { goBack(); return; }
      if(DOM.alertOverlay.style.display === 'flex') { goBack(); return; }
      if(DOM.signatureModal.style.display === 'flex') { goBack(); return; }
      if (document.querySelector('.modal-overlay[style*="display: flex"]')) { goBack(); }
      else if (!DOM.searchView.classList.contains('active')) { showScreen('search-view'); }
    }
    
    // ENTER tugmasi - keyingi fieldga o'tish
    if (e.key === 'Enter') {
      const activeEl = document.activeElement;
      const form = activeEl?.closest('form');
      
      // Agar textarea ichida bo'lsa, yangi qator qo'shsin (Enter ni bloklamasin)
      if (activeEl?.tagName === 'TEXTAREA') return;
      
      // Agar form ichida input/select bo'lsa
      if (form && (activeEl?.tagName === 'INPUT' || activeEl?.tagName === 'SELECT')) {
        e.preventDefault();
        
        // Barcha ko'rinadigan inputlarni olish
        const allInputs = Array.from(form.querySelectorAll('input:not([type="hidden"]):not([type="checkbox"]):not([type="radio"]), select, textarea'))
          .filter(el => {
            // Faqat ko'rinadigan elementlarni olish
            const style = window.getComputedStyle(el);
            const parent = el.closest('.conditional-field, .form-group');
            const parentStyle = parent ? window.getComputedStyle(parent) : null;
            return style.display !== 'none' && style.visibility !== 'hidden' &&
                   (!parentStyle || (parentStyle.display !== 'none' && parentStyle.visibility !== 'hidden'));
          });
        
        const currentIndex = allInputs.indexOf(activeEl);
        
        if (currentIndex !== -1 && currentIndex < allInputs.length - 1) {
          // Keyingi fieldga o'tish
          const nextInput = allInputs[currentIndex + 1];
          nextInput.focus();
          
          // Agar select bo'lsa, ochish
          if (nextInput.tagName === 'SELECT') {
            // Qisqa vaqtdan keyin click eventini trigger qilish
            setTimeout(() => {
              const event = new MouseEvent('mousedown', { bubbles: true, cancelable: true, view: window });
              nextInput.dispatchEvent(event);
            }, 50);
          }
        }
      }
    }
  });
  DOM.detailsContent.addEventListener('click', (e) => {
    if (e.target.closest('.js-view-meeting-photo')) {
      const btn = e.target.closest('.js-view-meeting-photo');
      const imageId = btn.dataset.imageId;
      if (imageId && imageId !== 'saqlanmoqda...') {
        DOM.viewerImage.src = `https://lh3.googleusercontent.com/d/${imageId}`;
        showScreen('image-viewer-modal');
      } else if (imageId === 'saqlanmoqda...') {
        showToast("Rasm hali yuklanmadi, birozdan so'ng urinib ko'ring.", "info");
      }
      return;
    }
    let textToCopy = null;
    if (e.target.closest('.profile-name')) {
        textToCopy = e.target.closest('.profile-name').textContent;
    } else if (e.target.closest('.data-value')) {
        textToCopy = e.target.closest('.data-value').textContent;
    }
    if (textToCopy) {
      navigator.clipboard.writeText(textToCopy.trim())
        .then(() => showToast(`"${textToCopy.trim()}" nusxalandi!`))
        .catch(err => console.error('Nusxalashda xatolik:', err));
    }
  });
  document.getElementById('js-download-pdf').addEventListener('click', generateAndDownloadPdf);
  document.body.addEventListener('click', async (e) => {
    const t = e.target;
    if (t.classList.contains('js-view-profile-pic')) {
        const imgSrc = t.src;
        if (imgSrc && !imgSrc.endsWith('undefined')) {
            DOM.viewerImage.src = imgSrc;
            showScreen('image-viewer-modal');
        }
        return;
    }
    if(t.closest('.js-shubhali-toggle')){const btn=t.closest('.js-shubhali-toggle');const containerCard=btn.closest('.card')||document;const hidden=containerCard.querySelector('input[name="shubhali_shaxs"]');const isActive=btn.classList.toggle('active');if(hidden)hidden.value=isActive?"Ha":"Yo'q";try{btn.style.color=isActive?getComputedStyle(document.documentElement).getPropertyValue('--danger-color')||'#ef4444':getComputedStyle(document.documentElement).getPropertyValue('--secondary-color')||'#64748b';}catch{}}
    if(t.closest('#home-link') || t.closest('.js-back-to-search')){DOM.searchResult.innerHTML=''; document.getElementById('searchNameInput').value=''; showScreen('search-view'); previousScreenStack = ['search-view'];} 
    if(t.closest('.search-option-btn')){const tab=t.closest('.search-option-btn');document.querySelector('.search-option-btn.active').classList.remove('active');tab.classList.add('active');document.querySelectorAll('.search-panel').forEach(p=>p.classList.remove('active'));document.getElementById(tab.dataset.tab).classList.add('active');}
    if(t.closest('#fab-add-citizen')){ resetFormToCreateMode(); showScreen('add-view'); }
    if(t.closest('.js-back-to-previous-view')) { goBack(); return; }
    const addFormContainer = DOM.addForm.closest('.card');
    if (t.closest('.js-save-citizen')){ const miss=validateForm(DOM.addForm); if(miss.length>0) return showCustomAlert(`Iltimos, barcha majburiy maydonlarni to'ldiring:<br> - ${miss.join('<br> - ')}`); prepareAndConfirmSubmit(false); }
    if (t.closest('.js-next-step') && addFormContainer.contains(t)){ const miss = validateForm(DOM.addForm, currentStep); if (miss.length > 0) return showCustomAlert(`Iltimos, joriy bosqichdagi maydonlarni to'ldiring:<br> - ${miss.join('<br> - ')}`); if (currentStep < 3) currentStep = navigateToStep(currentStep + 1, addFormContainer, 3); }
    if (t.closest('.js-prev-step') && addFormContainer.contains(t)){ if (currentStep > 1) currentStep = navigateToStep(currentStep - 1, addFormContainer, 3); }
    if(t.closest('.js-save-family-member')){const miss=validateForm(DOM.addFamilyForm);if(miss.length>0)return showCustomAlert(`Iltimos, quyidagi maydonlarni to'ldiring:<br> - ${miss.join('<br> - ')}`);if(!currentMainPersonUniqueId)return showCustomAlert("Asosiy shaxs aniqlanmadi.");prepareAndConfirmSubmit(true);}
    if(t.closest('#theme-switcher')){const newTheme=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',newTheme);localStorage.setItem('theme',newTheme);t.closest('#theme-switcher').innerHTML=newTheme==='dark'?'<i class="fas fa-sun"></i>':'<i class="fas fa-moon"></i>';}
    if(t.closest('.js-cancel')){showScreen('search-view');resetFormToCreateMode();} 
    if(t.closest('.js-alert-ok')||t.closest('.js-alert-cancel')){ goBack(); }
    if(t.closest('.js-toggle-family-view')) {
        const card = t.closest('.result-card');
        if(!card || !card.dataset.personData) return;
        const personData = JSON.parse(card.dataset.personData.replace(/&apos;/g, "'"));
        const person = citizenDatabase.find(p => p.unique_id === personData.unique_id);
        if (!person) return showCustomAlert("Fuqaro ma'lumotlari topilmadi.");
        const familyId = person.family_id || (person.qarindoshligi === 'Oila boshi' ? person.jshshir : null);
        if (!familyId) return showCustomAlert("Bu fuqaro uchun oila ma'lumotlari topilmadi.");
        const familyMembers = activeCitizenDatabase.filter(p => p.family_id === familyId);
        const familyHead = familyMembers.find(p => p.qarindoshligi === 'Oila boshi') || person;
        DOM.familyModalTitle.textContent = `${familyHead.fio} oilasi`;
        if (familyMembers.length > 0) {
            DOM.familyModalContent.innerHTML = familyMembers.map(member => createPersonCardHTML(member, member.unique_id === familyHead.unique_id, 'family-modal')).join('');
        } else {
            DOM.familyModalContent.innerHTML = `<p style="text-align:center; padding: 2rem;">Boshqa oila a'zolari topilmadi.</p>`;
        }
        showScreen('family-modal');
    }
    if (t.closest('.summary-stat-card')) { 
      const card = t.closest('.summary-stat-card'); 
      const cat = card.getAttribute('data-category'); 
      const label = card.querySelector('.label').textContent; 
      if (card.closest('#summary-modal') && cat === 'toifadagilar') {
          const exemptUsers = ['2304', '4161', '1909', '1983'];
          if (exemptUsers.includes(CURRENT_USER.pass)) {
              openStatDetails(cat, label);
          } else {
              showCustomAlert("Ushbu bo'limga kirishga ruxsat yo'q.", "Cheklangan");
          }
          return;
      }
      if (card.closest('#summary-modal')) {
          openStatDetails(cat,label); 
          return;
      }
      if (card.closest('#full-list-modal') && card.dataset.category === 'toifa_detail') {
          const clickedToifa = card.dataset.toifa; let filteredList = [];
          if (clickedToifa === "Migratsiyadan qaytgan") filteredList = activeCitizenDatabase.filter(p => p.employmentStatus === 'Migratsiyadan qaytgan'); 
          else filteredList = activeCitizenDatabase.filter(p => ((p.toifa_turi || '').includes(clickedToifa)) || p.socialStatus === clickedToifa); 
          displayFilteredList(filteredList, `${clickedToifa} Ro'yxati`, 'toifadagilar'); return; 
      }
    }
    if(t.closest('#fab-show-summary')){ await dataReadyPromise; if (citizenDatabase.length === 0) showCustomAlert("Statistika uchun ma'lumotlar bazasi bo'sh.", "Ma'lumot yo'q"); else calculateAndDisplaySummary(); }
    else if (t.closest('#fab-show-full-list')) { await dataReadyPromise; displayFullList(false); }
    else if (t.closest('#archive-btn')) { await dataReadyPromise; displayFullList(true); }
    try {
        if(t.closest('.js-search-name') || t.closest('.js-search-passport') || t.closest('.js-search-dob') || t.closest('.js-search-address')){ 
          await dataReadyPromise; 
          showLoader(true);
          if(t.closest('.js-search-name')){const q=document.getElementById('searchNameInput').value.trim().toLowerCase();if(q.length<2){showLoader(false);return showCustomAlert("Kamida 2 ta harf kiriting.");} const tq=transliterate(q);const res=citizenDatabase.filter(c=>(c.fio&&typeof c.fio==='string')&&transliterate(c.fio.toLowerCase()).includes(tq));displayResults(res);}
          else if(t.closest('.js-search-passport')){const s=document.getElementById('searchPassportSeries').value.toUpperCase(); const n=document.getElementById('searchPassportNumber').value;const q=(s+n).replace(/\s/g,'').toUpperCase(); if(!q){showLoader(false); return;} const res=citizenDatabase.filter(c=>(c.passport&&typeof c.passport==='string')&&c.passport.replace(/\s/g,'').toUpperCase().includes(q));displayResults(res);}
          else if(t.closest('.js-search-dob')){const q=document.getElementById('searchDobInput').value.trim(); if(!q){showLoader(false); return;} const res=citizenDatabase.filter(c=>c.dob&&formatDate(c.dob)===q);displayResults(res);}
          else if(t.closest('.js-search-address')){const q=document.getElementById('searchAddressInput').value.trim().toLowerCase(); if(!q){showLoader(false);return;} const keywords=q.replace(/[\/\-\.,]/g,' ').split(' ').filter(Boolean);const res=citizenDatabase.filter(c=>(c.street&&typeof c.street==='string')&&keywords.every(kw=>transliterate(c.street.toLowerCase()).includes(transliterate(kw))));displayResults(res);}
          showLoader(false); 
        }
        else if (t.closest('.js-details-btn')) {
            const btn = t.closest('.js-details-btn');
            if (btn.dataset.restricted === 'true') {
                return showCustomAlert("Bu fuqaro haqida to'liq ma'lumotni ko'rishga sizda ruxsat yo'q.", "Ruxsat Cheklangan");
            }
            const card = btn.closest('.result-card');
            if (!card || !card.dataset.personData) return;
            const personData = JSON.parse(card.dataset.personData.replace(/&apos;/g, "'"));
            const p = citizenDatabase.find(citizen => citizen.unique_id === personData.unique_id) || personData;
                   showScreen('details-modal');
            DOM.detailsContent.innerHTML = createFullDetailsHTML(p);
        }
        else if(t.closest('.js-add-family-member-btn')) { 
            await dataReadyPromise;
            const uniqueId = t.closest('.result-card').dataset.personData.match(/"unique_id":"([^"]+)"/)[1];
            const clickedPerson = citizenDatabase.find(p => p.unique_id === uniqueId); 
            if (!clickedPerson) return showCustomAlert("Xatolik: Fuqaro topilmadi.");
            const familyId = clickedPerson.family_id || (clickedPerson.qarindoshligi === 'Oila boshi' ? clickedPerson.jshshir : null);
            const familyHead = familyId ? citizenDatabase.find(p => p.family_id === familyId && p.qarindoshligi === 'Oila boshi') || clickedPerson : clickedPerson;
            currentMainPersonUniqueId = familyHead.unique_id;
            DOM.addFamilyForm.reset(); 
            document.querySelectorAll('#add-family-view .conditional-field').forEach(f => f.style.display = 'none'); 
            document.querySelector('.js-main-person-fio').textContent = familyHead.fio || ''; 
            const fBtn=DOM.addFamilyForm.querySelector('.js-shubhali-toggle');const fHidden=DOM.addFamilyForm.querySelector('[name="shubhali_shaxs"]');if(fBtn){fBtn.classList.remove('active');fBtn.style.color='var(--secondary-color)';}if(fHidden)fHidden.value="Yo'q"; 
            showScreen('add-family-view'); 
        }
        else if (t.closest('.js-fill-details-btn')) {
            if (CURRENT_USER.access !== 'full') return showCustomAlert("Sizda ma'lumotlarni tahrirlashga ruxsat yo'q.", "Cheklangan");
            resetFormToCreateMode();
            const card = t.closest('.result-card') || document.getElementById('details-render-wrapper');
            if (!card || !card.dataset.personData) return;
            const personData = JSON.parse(card.dataset.personData.replace(/&apos;/g, "'"));
            isEditMode = true; 
            document.getElementById('form-title').textContent = `${personData.fio || 'F.I.O. Kiritilmagan'} ma'lumotlarini tahrirlash`;
            DOM.addForm.querySelector('[name="update_unique_id"]').value = personData.unique_id || '';
            for (const key in personData) {
                const input = DOM.addForm.querySelector(`[name="${key}"]`);
                if (input) {
                    if (['dob', 'metrka_dob', 'chet_el_dob', 'migration_duration', 'returned_migration_date', 'uy_egasi_dob'].includes(key)) input.value = formatDate(personData[key]);
                    else input.value = personData[key] || '';
                }
            }
            if(personData.toifa_turi){
                const selectedToifalar = (personData.toifa_turi || '').split(', ');
                document.querySelectorAll('input[name="toifa_turi"]').forEach(checkbox => {
                    checkbox.checked = selectedToifalar.includes(checkbox.value);
                });
            }
            // Hobbilarni tiklash
            if(personData.hobbi){
                const selectedHobbies = (personData.hobbi || '').split(', ');
                document.querySelectorAll('input[name="hobbi"]').forEach(checkbox => {
                    checkbox.checked = selectedHobbies.includes(checkbox.value);
                });
            }
            // Yangi maydonlarni tiklash
            if(personData.sudlanganlik === 'Ha') {
                const sudContainer = document.querySelector('.js-sudlanganlik-details');
                if(sudContainer) sudContainer.style.display = 'block';
            }
            if(personData.qurol_egalik === 'Ha') {
                const qurolContainer = document.querySelector('.js-qurol-details');
                if(qurolContainer) qurolContainer.style.display = 'block';
            }
            if(personData.gaz_hisoblagich === 'Ha' || personData.gaz_hisoblagich === 'Aqlli') {
                const gazContainer = document.querySelector('.js-gaz-litsavoy');
                if(gazContainer) gazContainer.style.display = 'block';
            }
            if(personData.elektr_hisoblagich === 'Ha' || personData.elektr_hisoblagich === 'Aqlli') {
                const elektrContainer = document.querySelector('.js-elektr-litsavoy');
                if(elektrContainer) elektrContainer.style.display = 'block';
            }
            if(personData.suv_hisoblagich === 'Ha' || personData.suv_hisoblagich === 'Aqlli') {
                const suvContainer = document.querySelector('.js-suv-litsavoy');
                if(suvContainer) suvContainer.style.display = 'block';
            }
            if(personData.chiqindi_xizmat === 'Ha') {
                const chiqindiContainer = document.querySelector('.js-chiqindi-litsavoy');
                if(chiqindiContainer) chiqindiContainer.style.display = 'block';
            }
            if(personData.avtomobil_bor === 'Ha') {
                const avtoContainer = document.querySelector('.js-avtomobil-details');
                if(avtoContainer) avtoContainer.style.display = 'block';
            }
            if (personData.passport) {
                const series = personData.passport.replace(/[^a-zA-Z]/g, '');
                const number = personData.passport.replace(/\D/g, '');
                const seriesInput = DOM.addForm.querySelector('[name="passport_series"]');
                const numberInput = DOM.addForm.querySelector('[name="passport_number"]');
                if (seriesInput) seriesInput.value = series;
                if (numberInput) numberInput.value = number;
            }
            if (personData.telefon && String(personData.telefon)) {
                const phoneInput = DOM.addForm.querySelector('[name="telefon_number"]');
                if (phoneInput) phoneInput.value = String(personData.telefon).slice(-9);
            }
            const xonadonTuri = personData.xonadon_turi;
            if (xonadonTuri) {
                const xonadonTuriSelect = DOM.addForm.querySelector('select[name="xonadon_turi"]');
                if (xonadonTuriSelect) xonadonTuriSelect.value = xonadonTuri;
                const fullStreet = personData.street || '';
                let streetNameFromData = '';
                const match = fullStreet.match(/^(.*?)\s+ko\.,?/);
                streetNameFromData = (match && match[1]) ? match[1].trim() : fullStreet.split(/(\d.*|ko\.)/)[0].trim();
                const streetSelectName = xonadonTuri === 'kop_qavatli' ? 'kop_qavatli_kochasi' : 'xovli_kochasi';
                const streetList = xonadonTuri === 'kop_qavatli' ? KOP_QAVATLI_STREETS : HOVLI_STREETS;
                const streetSelect = DOM.addForm.querySelector(`select[name="${streetSelectName}"]`);
                if (streetSelect) {
                    if (streetList.includes(streetNameFromData)) streetSelect.value = streetNameFromData;
                    else if (streetNameFromData) {
                        streetSelect.value = 'Boshqa';
                        const otherStreetInput = DOM.addForm.querySelector(`.js-other-street-input[data-type="${xonadonTuri}"]`);
                        if (otherStreetInput) otherStreetInput.value = streetNameFromData;
                    }
                }
            }
            DOM.addForm.querySelectorAll('select, input[type="checkbox"]').forEach(el => {
                if (el.name) el.dispatchEvent(new Event('change', { bubbles: true }));
            });
            const shubhaliStatus = personData.shubhali_shaxs === 'Ha';
            const shubBtn = DOM.addForm.querySelector('.js-shubhali-toggle');
            const shubHidden = DOM.addForm.querySelector('[name="shubhali_shaxs"]');
            if (shubhaliStatus) {
                if (shubBtn && !shubBtn.classList.contains('active')) shubBtn.classList.add('active');
                if (shubBtn) shubBtn.style.color = 'var(--danger-color)';
                if (shubHidden) shubHidden.value = "Ha";
            } else {
                if (shubBtn && shubBtn.classList.contains('active')) shubBtn.classList.remove('active');
                if (shubBtn) shubBtn.style.color = 'var(--secondary-color)';
                if (shubHidden) shubHidden.value = "Yo'q";
            }
            showScreen('add-view');
        }
    } catch (error) { showLoader(false); showCustomAlert(error.message, "Xatolik"); }
  });
  ['searchNameInput', 'searchPassportSeries', 'searchPassportNumber', 'searchDobInput', 'searchAddressInput'].forEach(id => {
    const input = document.getElementById(id);
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const buttonClass = `.js-search-${id.replace('Input', '').replace('search', '').replace('PassportSeries', 'passport').replace('PassportNumber', 'passport').toLowerCase()}`;
            document.querySelector(buttonClass).click();
        }
    });
  });
  document.getElementById('refresh-btn')?.addEventListener('click', () => { 
    fetchData(true, false)
        .then(() => showToast("Baza to'liq yangilandi!"))
        .catch(error => showCustomAlert(error.message, "Xatolik"));
  });
  document.body.addEventListener('input',(e)=>{
    if(e.target.matches('.js-numeric-input')) e.target.value=e.target.value.replace(/\D/g,'');
    else if(e.target.matches('.js-date-input')){let v=e.target.value.replace(/\D/g,'').slice(0,8);if(v.length>4)v=`${v.slice(0,2)}.${v.slice(2,4)}.${v.slice(4)}`;else if(v.length>2)v=`${v.slice(0,2)}.${v.slice(2)}`;e.target.value=v;}
    else if(e.target.matches('.js-alpha-upper-input')) e.target.value=e.target.value.replace(/[^a-zA-Z]/g,'').toUpperCase();
  });
  document.querySelectorAll('form').forEach(form => { 
    form.addEventListener('change', (e) => { 
      const t = e.target; const currentForm = t.closest('form'); if (!currentForm) return; 
      const toggle = (sel, cond) => { const f = currentForm.querySelector(sel); if(f) f.style.display = cond ? (f.classList.contains('form-row') ? 'grid' : 'block') : 'none'; }; 
      if (t.classList.contains('js-hujjat-turi')) { toggle('.js-passport-fields', t.value === 'Pasport'); toggle('.js-metrka-fields', t.value === 'Metrka'); toggle('.js-chet-el-fields', t.value === 'Chet el fuqarosi'); }
      else if (t.classList.contains('js-xonadon-turi')) { toggle('.js-kop-qavatli-fields', t.value === 'kop_qavatli'); toggle('.js-xovli-fields', t.value === 'xovli'); }
      else if (t.classList.contains('js-street-select')) { const grp = currentForm.querySelector(`.js-other-street-group[data-type="${t.dataset.type}"]`); if (grp) grp.style.display = t.value === 'Boshqa' ? 'block' : 'none'; }
      else if (t.classList.contains('js-social-status')) { toggle('.js-shariy-info', t.value === 'Shariy'); }
      else if (t.classList.contains('js-reg-type')) { 
          toggle('.js-vaqtincha-info', t.value === 'Vaqtincha'); 
          toggle('.js-ijara-details', t.value === 'Ijara'); 
          autofillLandlordInfo();
      }
      else if (t.classList.contains('js-shaxs-toifasi')) { toggle('.js-toifa-turi', t.value === 'Ha'); }
      else if (t.matches('[name="toifa_turi"]')) {
          if (t.value === 'PXT') toggle('#pxt-details', t.checked);
          if (t.value === 'Probatsiya') toggle('#probatsiya-details', t.checked);
      }
      else if (t.classList.contains('js-employment-status')) { 
        const s = t.value; 
        ['.js-study-details', '.js-employment-details', '.js-bogcha-details', '.js-disability-group', '.js-migration-details', '.js-returned-migration-details', '.js-unemployed-details'].forEach(sel => { const f = currentForm.querySelector(sel); if (f) f.style.display = 'none'; }); 
        // "Boshqa" ish turi inputini ham yashirish
        const boshqaIsh = currentForm.querySelector('.js-boshqa-ish-input');
        if (boshqaIsh) boshqaIsh.style.display = 'none';
        
        if (['Talaba', "Maktab o'quchisi"].includes(s)) toggle('.js-study-details', true); 
        else if (['Rasmiy band', 'Norasmiy band', 'Tadbirkor'].includes(s)) toggle('.js-employment-details', true); 
        else if (s === "Bog'cha") toggle('.js-bogcha-details', true); 
        else if (s === "Nogironligi bor") toggle('.js-disability-group', true); 
        else if (s === "Migratsiya") toggle('.js-migration-details', true); 
        else if (s === "Migratsiyadan qaytgan") toggle('.js-returned-migration-details', true);
        else if (s === "Ishsiz") toggle('.js-unemployed-details', true);
      }
      // JS-JOB-CATEGORY - "Boshqa" tanlaganda input ko'rsatish
      else if (t.classList.contains('js-job-category')) {
        const boshqaIsh = currentForm.querySelector('.js-boshqa-ish-input');
        if (boshqaIsh) {
            boshqaIsh.style.display = (t.value === 'Boshqa') ? 'block' : 'none';
        }
      }
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê YANGI BO'LIMLAR UCHUN HANDLERLAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      else if (t.classList.contains('js-sudlanganlik')) {
          toggle('.js-sudlanganlik-details', t.value === 'Ha');
      }
      else if (t.classList.contains('js-qurol-egalik')) {
          toggle('.js-qurol-details', t.value === 'Ha');
      }
      else if (t.classList.contains('js-gaz-hisoblagich')) {
          toggle('.js-gaz-litsavoy', t.value === 'Ha' || t.value === 'Aqlli');
      }
      else if (t.classList.contains('js-elektr-hisoblagich')) {
          toggle('.js-elektr-litsavoy', t.value === 'Ha' || t.value === 'Aqlli');
      }
      else if (t.classList.contains('js-suv-hisoblagich')) {
          toggle('.js-suv-litsavoy', t.value === 'Ha' || t.value === 'Aqlli');
      }
      else if (t.classList.contains('js-chiqindi-hisoblagich')) {
          toggle('.js-chiqindi-litsavoy', t.value === 'Ha');
      }
      else if (t.classList.contains('js-avtomobil-bor')) {
          toggle('.js-avtomobil-details', t.value === 'Ha');
      }
    }); 
  });
  const addressInputs = '[name="dom_raqami"], [name="kvartira_raqami"], [name="uy_raqami"], .js-other-street-input';
  let addressCheckTimeout;
  DOM.addForm.addEventListener('input', (e) => {
    if (e.target.matches(addressInputs)) {
        clearTimeout(addressCheckTimeout);
        addressCheckTimeout = setTimeout(() => {
            checkAddressForFamilies();
        }, 300);
    }
  });
  DOM.addForm.addEventListener('change', (e) => {
    if (e.target.matches('[name="xonadon_turi"], .js-street-select, .js-reg-type')) {
        checkAddressForFamilies();
    }
  });
  async function checkAddressForFamilies() {
      await dataReadyPromise;
      autofillLandlordInfo(); 
      const form = DOM.addForm; const type = form.querySelector('[name="xonadon_turi"]').value; if (!type) return; 
      let streetSelect = form.querySelector(`select[name="${type}_kochasi"]`); let streetName = streetSelect ? streetSelect.value : ''; 
      if(streetName==='Boshqa'){ const other = form.querySelector(`.js-other-street-input[data-type="${type}"]`); streetName = other ? other.value.trim() : ''; } 
      const dom = form.querySelector('[name="dom_raqami"]')?.value.trim() || ''; const kv = form.querySelector('[name="kvartira_raqami"]')?.value.trim() || ''; const uy = form.querySelector('[name="uy_raqami"]')?.value.trim() || ''; 
      let fullAddress = ''; 
      if(type==='kop_qavatli' && streetName && dom && kv) fullAddress = `${streetName} ko., ${dom}-dom, ${kv}-kv.`; 
      if(type==='xovli' && streetName && uy) fullAddress = `${streetName} ko., ${uy}-uy`; 
      const suggestionsContainer = document.getElementById('address-family-suggestions'); 
      if (!fullAddress) { suggestionsContainer.style.display = 'none'; return; } 
      const normalizedTargetAddress = normalizeAddress(fullAddress);
      const residents = activeCitizenDatabase.filter(p => p.street && normalizeAddress(p.street) === normalizedTargetAddress);
      if (residents.length > 0) {
          const families = {}; 
          residents.forEach(p => {
              const familyIdentifier = p.family_id || p.jshshir;
              if (familyIdentifier && !families[familyIdentifier]) {
                  const familyHead = residents.find(r => (r.family_id === familyIdentifier) && r.qarindoshligi === "Oila boshi") || p;
                  families[familyIdentifier] = {
                      representative: familyHead,
                      memberCount: residents.filter(r => r.family_id === familyIdentifier).length,
                      type: p.registrationType === 'Ijara' ? 'Ijarachi oilasi' : 'Doimiy yashovchi oila'
                  };
              }
          });
          const uniqueFamilies = Object.values(families);
          if(uniqueFamilies.length > 0) {
              let html = `<h6><i class="fas fa-info-circle"></i> Ushbu manzilda quyidagi oilalar mavjud:</h6>`; 
              uniqueFamilies.forEach(family => {
                  html += `<div class="suggestion-item">
                               <div class="suggestion-item-info">
                                   <span>${family.representative.fio} oilasi</span>
                                   <small>${family.type} (${family.memberCount} kishi)</small>
                               </div>
                               <button type="button" class="btn btn-secondary js-select-family" data-person-unique-id="${family.representative.unique_id}">Shu oilaga qo'shish</button>
                           </div>`; 
              });
              html += `<div class="suggestion-item">
                           <div class="suggestion-item-info">
                               <span>Yangi oila ochish</span>
                               <small>Agar fuqaro yuqoridagi oilalarga tegishli bo'lmasa</small>
                           </div>
                           <button type="button" class="btn btn-secondary js-create-new-family">Yangi oila sifatida qo'shish</button>
                       </div>`; 
              suggestionsContainer.innerHTML = html; 
              suggestionsContainer.style.display = 'block'; 
          }
      } else { 
          suggestionsContainer.style.display = 'none'; 
          DOM.addForm.querySelector('[name="selected_family_id"]').value = ''; 
      } 
  }
  
    async function autofillLandlordInfo() {
      await dataReadyPromise;
      const form = DOM.addForm;
      const landlordFioInput = form.querySelector('[name="uy_egasi_fio"]');
      const landlordPhoneInput = form.querySelector('[name="uy_egasi_telefon"]');
      const landlordDobInput = form.querySelector('[name="uy_egasi_dob"]');

      landlordFioInput.value = '';
      landlordPhoneInput.value = '';
      landlordDobInput.value = '';

      const regType = form.querySelector('[name="registrationType"]').value;
      if (regType !== 'Ijara') return;
      
      const type = form.querySelector('[name="xonadon_turi"]').value; 
      if (!type) return;
      
      let streetSelect = form.querySelector(`select[name="${type}_kochasi"]`);
      let streetName = streetSelect ? streetSelect.value : '';
      if(streetName === 'Boshqa'){ const other = form.querySelector(`.js-other-street-input[data-type="${type}"]`); streetName = other ? other.value.trim() : ''; } 
      
      const dom = form.querySelector('[name="dom_raqami"]')?.value.trim() || '';
      const kv = form.querySelector('[name="kvartira_raqami"]')?.value.trim() || '';
      const uy = form.querySelector('[name="uy_raqami"]')?.value.trim() || ''; 
      
      let fullAddress = ''; 
      if(type === 'kop_qavatli' && streetName && dom && kv) fullAddress = `${streetName} ko., ${dom}-dom, ${kv}-kv.`; 
      if(type === 'xovli' && streetName && uy) fullAddress = `${streetName} ko., ${uy}-uy`;
      
      if (!fullAddress) return;
      
      const normalizedTargetAddress = normalizeAddress(fullAddress);
      
      const owner = activeCitizenDatabase.find(p => 
          p.street && 
          normalizeAddress(p.street) === normalizedTargetAddress && 
          p.registrationType === 'Doimiy' && 
          p.qarindoshligi === 'Oila boshi'
      );

      if (owner) {
          landlordFioInput.value = owner.fio || '';
          landlordPhoneInput.value = (owner.telefon || '').replace('+998', '');
          landlordDobInput.value = formatDate(owner.dob) || '';
          if (owner.fio) {
              showToast("Uy egasi ma'lumotlari avtomatik to'ldirildi!", 'info');
          }
      }
    }

  document.getElementById('address-family-suggestions').addEventListener('click', (e) => { 
    const selectedPersonUniqueIdInput = DOM.addForm.querySelector('[name="selected_family_id"]'); 
    const allBtns = document.querySelectorAll('.suggestion-item .btn'); 
    if (e.target.classList.contains('js-select-family')) { 
      selectedPersonUniqueIdInput.value = e.target.dataset.personUniqueId; 
      showCustomAlert(`Tanlandi! Yangi fuqaro ${e.target.previousElementSibling.querySelector('span').textContent}ga qo'shiladi.`); 
      allBtns.forEach(b => {b.classList.remove('btn-primary'); b.classList.add('btn-secondary');}); 
      e.target.classList.add('btn-primary'); 
      e.target.classList.remove('btn-secondary'); 
    } 
    if (e.target.classList.contains('js-create-new-family')) { 
      selectedPersonUniqueIdInput.value = ''; 
      showCustomAlert("Tanlandi! Yangi fuqaro bu manzilda yangi oila sifatida ro'yxatga olinadi."); 
      allBtns.forEach(b => {b.classList.remove('btn-primary'); b.classList.add('btn-secondary');}); 
      e.target.classList.add('btn-primary'); 
      e.target.classList.remove('btn-secondary'); 
    } 
  });
  document.querySelectorAll('form').forEach(form => { 
    form.addEventListener('keydown', e => { 
      if (e.key === 'Enter' && !e.target.matches('textarea')) { 
        e.preventDefault();
        const currentElement = e.target; 
        const focusableElements = Array.from(form.querySelectorAll('input:not([type="hidden"]), select, textarea')).filter(el => el.offsetParent !== null && !el.disabled); 
        const currentIndex = focusableElements.indexOf(currentElement); 
        if (currentIndex > -1 && currentIndex < focusableElements.length - 1) { focusableElements[currentIndex + 1].focus(); } 
      } 
    }); 
  });
  document.getElementById('problem-yes-btn').addEventListener('click', () => { document.getElementById('problem-choice-buttons').style.display = 'none'; document.getElementById('problem-input-container').style.display = 'block'; document.getElementById('problem-textarea').focus(); });
  document.getElementById('problem-no-btn').addEventListener('click', () => { newCitizenData.izoh = "Yo'q"; newCitizenData.muammo_holati = ''; newCitizenData.muammo_sanasi = ''; finalSubmit(newCitizenData, DOM.addForm); });
  document.getElementById('save-with-problem-btn').addEventListener('click', () => { const problemText = document.getElementById('problem-textarea').value.trim(); newCitizenData.izoh = problemText || 'Mavjud (tavsif kiritilmagan)'; newCitizenData.muammo_holati = 'Jarayonda'; newCitizenData.muammo_sanasi = formatDate(new Date()); finalSubmit(newCitizenData, DOM.addForm); });
  document.getElementById('problem-cancel-btn').addEventListener('click', () => { DOM.problemModal.style.display = 'none'; });
document.getElementById('export-list-csv').addEventListener('click', () => {
    if (!currentDisplayedList || currentDisplayedList.length === 0) {
        return showToast("Eksport uchun ma'lumot yo'q.", 'error');
    }
    const csvHeaders = [...headers];
    const csvContent = [
        csvHeaders.join(';'),
        ...currentDisplayedList.map(p => {
            return csvHeaders.map(header => {
                const value = p[header] === undefined || p[header] === null ? '' : p[header];
                const sanitizedValue = String(value).replace(/"/g, '""');
                return `"${sanitizedValue}"`;
            }).join(';');
        })
    ].join('\n');
    const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `${currentListTitle.replace(/[\s,()]/g, '_')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Excel (CSV) fayl yuklanmoqda...", "success");
    }
});
async function startCamera() {
    showScreen('camera-modal');
    const video = document.getElementById('camera-feed');
    const photoPreview = document.getElementById('photo-preview');
    const snapBtn = document.getElementById('snap-photo-btn');
    const retakeBtn = document.getElementById('retake-photo-btn');
    const saveBtn = document.getElementById('save-photo-btn');
    const switchBtn = document.getElementById('switch-camera-btn');
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
    }
    video.style.display = 'block';
    photoPreview.style.display = 'none';
    snapBtn.classList.remove('hidden');
    switchBtn.classList.remove('hidden');
    retakeBtn.classList.add('hidden');
    saveBtn.classList.add('hidden');
    const constraints = { video: { facingMode: currentFacingMode }, audio: false };
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = cameraStream;
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoInputs = devices.filter(device => device.kind === 'videoinput');
        switchBtn.style.display = videoInputs.length > 1 ? 'inline-flex' : 'none';
    } catch (err) {
        console.error("Kameraga ulanishda xatolik:", err);
        showCustomAlert(`Kameraga ulanib bo'lmadi (${currentFacingMode === 'environment' ? 'orqa' : 'old'}). Qurilmangizda kamera borligini va ruxsat berilganini tekshiring.`);
        stopCamera();
    }
}
document.getElementById('take-photo-btn').addEventListener('click', () => {
    currentCameraTarget = 'citizen';
    currentMeetingData = {};
    currentFacingMode = 'user';
    startCamera();
});
function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    DOM.cameraModal.style.display = 'none';
}
window.startCamera = startCamera;
window.stopCamera = stopCamera;
document.getElementById('switch-camera-btn').addEventListener('click', () => {
    currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
    startCamera();
});
document.getElementById('snap-photo-btn').addEventListener('click', () => {
    const video = document.getElementById('camera-feed');
    const canvas = document.getElementById('photo-canvas');
    const photoPreview = document.getElementById('photo-preview');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg');
    photoPreview.src = dataUrl;
    video.style.display = 'none';
    photoPreview.style.display = 'block';
    document.getElementById('snap-photo-btn').classList.add('hidden');
    document.getElementById('switch-camera-btn').classList.add('hidden');
    document.getElementById('retake-photo-btn').classList.remove('hidden');
    document.getElementById('save-photo-btn').classList.remove('hidden');
});
document.getElementById('retake-photo-btn').addEventListener('click', () => {
    document.getElementById('camera-feed').style.display = 'block';
    document.getElementById('photo-preview').style.display = 'none';
    document.getElementById('snap-photo-btn').classList.remove('hidden');
    document.getElementById('switch-camera-btn').classList.remove('hidden');
    document.getElementById('retake-photo-btn').classList.add('hidden');
    document.getElementById('save-photo-btn').classList.add('hidden');
});
document.getElementById('save-photo-btn').addEventListener('click', async () => {
    const photoPreview = document.getElementById('photo-preview');
    const base64 = photoPreview.src;
    stopCamera();
    goBack();
    if (currentMeetingData.isSolvingProblem) {
        document.getElementById('solve-problem-photo-base64').value = base64;
        const solvePreview = document.getElementById('solve-problem-photo-preview');
        solvePreview.src = base64;
        solvePreview.style.display = 'block';
        currentMeetingData = {};
        return; 
    }
    if (currentMeetingData.unique_id) {
        showToast("Uchrashuv saqlanmoqda...", "info");
        const payloadMeeting = {
            unique_id: currentMeetingData.unique_id,
            rasm_base64: base64,
            meeting_type: currentMeetingData.meeting_type
        };
        const payloadStatusUpdate = { update_unique_id: currentMeetingData.unique_id };
        if (currentMeetingData.meeting_type === 'PXT') {
            payloadStatusUpdate.uchrashuv_sanasi = '';
        } else if (currentMeetingData.meeting_type === 'Probatsiya') {
            payloadStatusUpdate.probatsiya_yakuniy_sana = '';
        }
        const citizenIndex = citizenDatabase.findIndex(p => p.unique_id === payloadMeeting.unique_id);
        if (citizenIndex > -1) {
            try {
                let meetings = JSON.parse(citizenDatabase[citizenIndex].uchrashuvlar_tarixi || '[]');
                meetings.push({ date: formatDate(new Date()), type: currentMeetingData.meeting_type, imageId: "saqlanmoqda..." });
                citizenDatabase[citizenIndex].uchrashuvlar_tarixi = JSON.stringify(meetings);
                if (payloadMeeting.meeting_type === 'PXT') citizenDatabase[citizenIndex].uchrashuv_sanasi = '';
                if (payloadMeeting.meeting_type === 'Probatsiya') citizenDatabase[citizenIndex].probatsiya_yakuniy_sana = '';
            } catch(e) { console.error(e) }
        }
        showScreen('search-view');
        previousScreenStack = ['search-view'];
        checkAndShowNotifications();
        try {
            await apiCall('recordMeeting', payloadMeeting);
            await apiCall('saveCitizen', payloadStatusUpdate);
            showToast("Uchrashuv muvaffaqiyatli saqlandi!", 'success');
            fetchData(false);
        } catch(e) { fetchData(true); } 
        finally { currentMeetingData = {}; }
    } else {
        let form, preview;
        if (currentCameraTarget === 'citizen') {
            form = DOM.addForm;
            preview = document.getElementById('form-photo-preview');
        } else if (currentCameraTarget === 'object') {
            form = DOM.addObjectForm;
            preview = document.getElementById('object-photo-preview');
        } else if (currentCameraTarget === 'staff') {
            form = DOM.addStaffForm;
            preview = document.getElementById('staff-photo-preview');
        }
        if (form && preview) {
            form.querySelector('input[name="photoBase64"]').value = base64;
            preview.src = base64;
            preview.style.display = 'block';
        }
    }
    currentCameraTarget = null;
});
DOM.notificationBell.addEventListener('click', () => {
    renderNotifications();
    showScreen('notification-modal');
});
DOM.notificationModal.addEventListener('click', (e) => {
    if(e.target.closest('#notification-modal-close')) {
        goBack();
    } else if (e.target.closest('.js-start-meeting')) {
        const btn = e.target.closest('.js-start-meeting');
        currentMeetingData = {
            unique_id: btn.dataset.uniqueId,
            meeting_type: btn.dataset.meetingType,
            isSolvingProblem: false
        };
        currentFacingMode = 'user';
        startCamera();
    } else if (e.target.closest('.js-solve-problem')) {
        const btn = e.target.closest('.js-solve-problem');
        const unique_id = btn.dataset.uniqueId;
        document.getElementById('solve-problem-unique-id').value = unique_id;
        document.getElementById('solve-problem-comment').value = '';
        document.getElementById('solve-problem-photo-base64').value = '';
        const preview = document.getElementById('solve-problem-photo-preview');
        preview.style.display = 'none';
        preview.src = '';
        const uploadBtnLabel = document.getElementById('upload-solution-photo-btn-label');
        const allowedUsers = ['2304', '4161', '1909'];
        uploadBtnLabel.style.display = allowedUsers.includes(CURRENT_USER.pass) ? 'inline-flex' : 'none';
        showScreen('solve-problem-modal');
    } else if (e.target.closest('.js-remind-later')) {
        goBack();
        showToast("Eslatma keyinroq qayta ko'rsatiladi.", "info");
    }
});
document.getElementById('take-solution-photo-btn').addEventListener('click', () => {
    currentMeetingData = { isSolvingProblem: true };
    currentFacingMode = 'environment';
    startCamera();
});
document.getElementById('upload-solution-photo-input').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('solve-problem-photo-base64').value = e.target.result;
            const solvePreview = document.getElementById('solve-problem-photo-preview');
            solvePreview.src = e.target.result;
            solvePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        showToast("Faqat rasm formatidagi fayllarni tanlang.", "error");
    }
    event.target.value = '';
});
document.getElementById('solve-problem-modal-close').addEventListener('click', () => goBack());
document.getElementById('save-problem-solution-btn').addEventListener('click', async () => {
    const unique_id = document.getElementById('solve-problem-unique-id').value;
    const comment = document.getElementById('solve-problem-comment').value.trim();
    const photoBase64 = document.getElementById('solve-problem-photo-base64').value;
    if (!comment) return showCustomAlert("Iltimos, yechim haqida izoh kiriting.");
    if (!photoBase64) return showCustomAlert("Iltimos, yechimni tasdiqlovchi rasmga oling yoki galereyadan yuklang.");
    const payloadStatus = {
        update_unique_id: unique_id,
        muammo_holati: 'Hal etildi',
        muammo_yechimi: comment
    };
    const payloadMeeting = {
        unique_id: unique_id,
        rasm_base64: photoBase64,
        meeting_type: 'Muammo Yechimi'
    };
    showToast("Muammo holati yangilanmoqda...", "info");
    const citizenIndex = citizenDatabase.findIndex(p => p.unique_id === unique_id);
    if (citizenIndex > -1) {
        citizenDatabase[citizenIndex].muammo_holati = 'Hal etildi';
        citizenDatabase[citizenIndex].muammo_yechimi = comment;
        try {
            let meetings = JSON.parse(citizenDatabase[citizenIndex].uchrashuvlar_tarixi || '[]');
            meetings.push({ date: formatDate(new Date()), type: 'Muammo Yechimi', imageId: 'saqlanmoqda...' });
            citizenDatabase[citizenIndex].uchrashuvlar_tarixi = JSON.stringify(meetings);
        } catch(e) { console.error(e); }
        checkAndShowNotifications();
        refreshCurrentView(); 
    }
    showScreen('search-view');
    previousScreenStack = ['search-view'];
    try {
        await apiCall('saveCitizen', payloadStatus);
        await apiCall('recordMeeting', payloadMeeting);
        showToast('Muammo muvaffaqiyatli hal etildi!', 'success');
        await fetchData(false);
    } catch (e) {
        fetchData(true);
    }
});
}
/* ================== LOGIN & ON LOAD ================== */
function handleLogin() {
    const enteredPass = DOM.loginPasswordInput.value.trim();
    if (selectedRoleInfo.pass && enteredPass === selectedRoleInfo.pass) {
        CURRENT_USER = { 
            role: selectedRoleInfo.role, 
            access: ROLES[selectedRoleInfo.pass].access, 
            pass: selectedRoleInfo.pass 
        };
        DOM.loginScreen.style.opacity = '0';
        setTimeout(() => {
            DOM.loginScreen.style.display = 'none';
        }, 500);
        DOM.appShell.style.display = 'block';
        document.body.classList.toggle('restricted', CURRENT_USER.access === 'restricted');
        
        // Inspektor roli uchun maxsus ko'rinish
        if (CURRENT_USER.pass === '1983') {
            document.body.setAttribute('data-user-role', 'inspector');
        } else {
            document.body.removeAttribute('data-user-role');
        }
        
        const canViewStats = ['4161', '2304'].includes(CURRENT_USER.pass);
        document.getElementById('staff-stats-tab').classList.toggle('permission-hidden', !canViewStats);
        
        setTimeout(() => {
    initializeApplicationData();
}, 0); 
    } else {
        DOM.loginPasswordError.style.display = 'block';
        setTimeout(() => DOM.loginPasswordError.style.display = 'none', 1500);
        DOM.loginPasswordInput.value = '';
        DOM.loginPasswordInput.focus();
    }
}
function updateClock() {
    const now = new Date();
    const timeEl = document.querySelector('#clock-display .time');
    const dateEl = document.querySelector('#clock-display .date');
    const pad = (num) => String(num).padStart(2, '0');
    if(timeEl) timeEl.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
    if(dateEl) dateEl.textContent = `${pad(now.getDate())}.${pad(now.getMonth() + 1)}.${now.getFullYear()}`;
}

// Vaqtga qarab salom berish
function updateGreeting() {
    const greetingEl = document.getElementById('greeting-message');
    if (!greetingEl) return;
    
    const hour = new Date().getHours();
    let greeting = '';
    let emoji = '';
    let motivation = '';
    
    if (hour >= 5 && hour < 12) {
        greeting = 'Xayrli tong';
        emoji = 'üåÖ';
        motivation = 'Bugungi kuningiz barakali o\'tsin!';
    } else if (hour >= 12 && hour < 17) {
        greeting = 'Xayrli kun';
        emoji = '‚òÄÔ∏è';
        motivation = 'Ish kuningiz unumli o\'tsin!';
    } else if (hour >= 17 && hour < 21) {
        greeting = 'Xayrli kech';
        emoji = 'üåÜ';
        motivation = 'Oqshom yoqimli o\'tsin!';
    } else {
        greeting = 'Xayrli tun';
        emoji = 'üåô';
        motivation = 'Tushlaringiz yoqimli bo\'lsin!';
    }
    
    greetingEl.innerHTML = `${emoji} <strong>${greeting}!</strong> ${motivation}`;
}

// Qor yog'ishi animatsiyasi
function createSnowfall(containerId = 'snowfall-container') {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Agar allaqachon qor bo'lsa, qayta yaratmaymiz
    if (container.children.length > 0) return;
    
    const snowflakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚úª', '‚úº', '‚ùâ', '‚Ä¢'];
    const snowCount = containerId === 'global-snowfall' ? 30 : 50; // Global uchun kamroq
    
    for (let i = 0; i < snowCount; i++) {
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        snowflake.innerHTML = snowflakes[Math.floor(Math.random() * snowflakes.length)];
        snowflake.style.left = Math.random() * 100 + '%';
        snowflake.style.fontSize = (Math.random() * 15 + 8) + 'px';
        snowflake.style.opacity = Math.random() * 0.6 + 0.4;
        snowflake.style.animationDuration = (Math.random() * 5 + 5) + 's';
        snowflake.style.animationDelay = (Math.random() * 5) + 's';
        container.appendChild(snowflake);
    }
}

// Global qorni yaratish
function initGlobalSnowfall() {
    createSnowfall('global-snowfall');
}

function checkSystemStatus() {
    const statusEl = document.getElementById('system-status');
    if (!statusEl) return;
    if (navigator.onLine) {
        statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Baza bilan aloqa mavjud';
        statusEl.className = 'online';
    } else {
        statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Avtonom rejim';
        statusEl.className = 'offline';
    }
}
document.addEventListener('DOMContentLoaded',()=>{
    initializeSelects();
    setupEventListeners();
    setupSignaturePad();
    const roleGrid = document.getElementById('role-selection-grid');
    const roleSelectionView = document.getElementById('role-selection-view');
    const passwordView = document.getElementById('password-view');
    for (const passKey in ROLES) {
        const role = ROLES[passKey];
        const btn = document.createElement('button');
        btn.className = 'role-btn';
        btn.textContent = role.role;
        btn.dataset.pass = passKey;
        btn.dataset.roleName = role.role;
        roleGrid.appendChild(btn);
    }
    roleGrid.addEventListener('click', (e) => {
        if (e.target.classList.contains('role-btn')) {
            const btn = e.target;
            selectedRoleInfo = {
                pass: btn.dataset.pass,
                role: btn.dataset.roleName
            };
            document.getElementById('selected-role-display').textContent = `Sizning rolingiz: ${selectedRoleInfo.role}`;
            roleSelectionView.classList.add('hidden');
            passwordView.classList.remove('hidden');
            DOM.loginPasswordInput.focus();
        }
    });
    document.getElementById('back-to-role-selection').addEventListener('click', () => {
        passwordView.classList.add('hidden');
        roleSelectionView.classList.remove('hidden');
        DOM.loginPasswordInput.value = '';
        DOM.loginPasswordError.style.display = 'none';
        selectedRoleInfo = {};
    });
    updateClock();
    updateGreeting();
    createSnowfall('snowfall-container'); // Login uchun qor
    initGlobalSnowfall(); // Global qor - butun ilova uchun
    setInterval(updateClock, 1000);
    setInterval(updateGreeting, 60000); // Har daqiqada yangilash
    checkSystemStatus();
    window.addEventListener('online', checkSystemStatus);
    window.addEventListener('offline', checkSystemStatus);
    const quotes = [
        "üéÑ Yangi 2026-yil muborak bo'lsin!",
        "‚ú® Yangi yilda barcha orzularingiz amalga oshsin!",
        "üéÖ Oilangizga baxt-saodat tilaymiz!",
        "‚ùÑÔ∏è Qishki sovuqda ham dillaringiz iliq bo'lsin!",
        "üéÅ Yangi yil yangi umidlar olib kelsin!"
    ];
    document.getElementById('quote-of-the-day').textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
    const savedTheme=localStorage.getItem('theme')||(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
    document.documentElement.setAttribute('data-theme',savedTheme);
    document.querySelector('#theme-switcher').innerHTML=savedTheme==='dark'?'<i class="fas fa-sun"></i>':'<i class="fas fa-moon"></i>';
    DOM.loginSubmitBtn.addEventListener('click',handleLogin);
    DOM.loginPasswordInput.addEventListener('keypress',(e)=>{if(e.key==='Enter')handleLogin();});
    DOM.loginPasswordInput.addEventListener('input',()=>{DOM.loginPasswordError.style.display='none';if(DOM.loginPasswordInput.value.length===4)handleLogin();});
    document.querySelector('#fab-add-citizen')?.addEventListener('click',()=>{resetFormToCreateMode();showScreen('add-view');});
    
    // Ob'ektlar moduli listenerlarini qo'shish (keyingi scriptdan keyin)
    setTimeout(() => {
        if (typeof setupObjectModuleListeners === 'function') {
            setupObjectModuleListeners();
        }
    }, 0);
});
</script>
<!-- ========================================================== -->
<!-- IJTMOIY OB'EKTLAR MODULI UCHUN MAXSUS SCRIPT QISMI -->
<!-- ========================================================== -->
<script>
let objectCurrentStep = 1;
function setupObjectModuleListeners() {
    // FAB tugmasi
    document.getElementById('fab-show-objects').addEventListener('click', displayObjectStats);
    // Yangi ob'ekt qo'shish tugmasi (statistika oynasida)
    document.getElementById('add-new-object-btn').addEventListener('click', () => {
        resetAddObjectForm();
        showScreen('add-object-modal');
    });
    // Formadagi navigatsiya tugmalari
    const objFormContainer = DOM.addObjectModal.querySelector('.modal-box');
    objFormContainer.querySelector('.js-next-step').addEventListener('click', () => {
        const miss = validateForm(DOM.addObjectForm, objectCurrentStep);
        if(miss.length > 0) return showCustomAlert(`Iltimos, joriy bosqichdagi maydonlarni to'ldiring:<br> - ${miss.join('<br> - ')}`);
        if (objectCurrentStep < 3) navigateToStep(objectCurrentStep + 1, objFormContainer, 3);
    });
    objFormContainer.querySelector('.js-prev-step').addEventListener('click', () => {
        if (objectCurrentStep > 1) navigateToStep(objectCurrentStep - 1, objFormContainer, 3);
    });
    // Ob'ekt formasidagi o'zgarishlar
    DOM.addObjectForm.querySelector('[name="orgType"]').addEventListener('change', (e) => {
        const stirField = document.getElementById('stir-field');
        stirField.style.display = ['MCHJ (Yuridik shaxs)', 'YaTT (Yakka tartibdagi tadbirkor)'].includes(e.target.value) ? 'block' : 'none';
    });

    const takeObjectPhotoBtn = document.getElementById('take-object-photo-btn');
    const takeStaffPhotoBtn = document.getElementById('take-staff-photo-btn');

    if (takeObjectPhotoBtn) {
        takeObjectPhotoBtn.addEventListener('click', () => {
            currentCameraTarget = 'object';
            currentFacingMode = 'environment';
            startCamera();
        });
    }

    if (takeStaffPhotoBtn) {
        takeStaffPhotoBtn.addEventListener('click', () => {
            currentCameraTarget = 'staff';
            currentFacingMode = 'user';
            startCamera();
        });
    }

    document.getElementById('get-location-btn').addEventListener('click', getLocation);
    document.getElementById('add-staff-btn').addEventListener('click', () => {
        DOM.addStaffForm.reset();
        DOM.addStaffForm.querySelector('input[name="photoBase64"]').value = '';
        DOM.addStaffForm.querySelector('input[name="signatureBase64"]').value = '';
        document.getElementById('staff-photo-preview').style.display = 'none';
        document.getElementById('add-staff-form-signature-preview').innerHTML = '';
        showScreen('add-staff-modal');
    });
    document.getElementById('save-staff-member-btn').addEventListener('click', () => {
        const form = DOM.addStaffForm;
        const fio = form.querySelector('[name="fio"]').value.trim();
        const position = form.querySelector('[name="position"]').value;
        if (!fio || !position) return showCustomAlert("Xodimning F.I.O.si va Lavozimini kiritish majburiy.");
        const fd = new FormData(form);
        const staffData = {};
        for (const [key, value] of fd.entries()) { staffData[key] = value.trim(); }
        staffData.staffId = `staff_${Date.now()}`;
        staffData.passport = (staffData.passport_series || '').toUpperCase() + (staffData.passport_number || '');
        tempStaffList.push(staffData);
        renderTempStaffList();
        goBack();
    });
    document.querySelector('.js-save-object').addEventListener('click', saveObject);
    document.getElementById('js-download-object-pdf').addEventListener('click', (e) => {
        const contentDiv = e.target.closest('.modal-box').querySelector('#object-details-content');
        if (contentDiv && contentDiv.dataset.objectId) {
            const objectId = contentDiv.dataset.objectId;
            generateObjectPdf(objectId);
        }
    });
    document.getElementById('js-download-staff-pdf').addEventListener('click', (e) => {
        const contentDiv = e.target.closest('.modal-box').querySelector('#staff-details-content');
        if (contentDiv && contentDiv.dataset.staffId) {
            const staffId = contentDiv.dataset.staffId;
            generateStaffPdf(staffId);
        }
    });
    document.getElementById('export-objects-csv').addEventListener('click', exportObjectsToCSV);
}
function resetAddObjectForm() {
    DOM.addObjectForm.reset();
    tempStaffList = [];
    renderTempStaffList();
    document.getElementById('object-photo-preview').style.display = 'none';
    document.getElementById('stir-field').style.display = 'none';
    const objFormContainer = DOM.addObjectModal.querySelector('.modal-box');
    navigateToStep(1, objFormContainer, 3);
}
function updateLocalObjectDatabase(objectData, staffList) {
    socialObjectsDatabase.push(objectData);
    if (staffList && staffList.length > 0) {
        objectStaffDatabase.push(...staffList);
    }
    localStorage.setItem('databases', JSON.stringify({
        citizenDatabase,
        socialObjectsDatabase,
        objectStaffDatabase
    }));
}
// <<<<<<< MANA SHU YERDAN NUSXA OLING >>>>>>>

async function saveObject() {
    const miss = validateForm(DOM.addObjectForm);
    if (miss.length > 0) {
        return showCustomAlert(`Iltimos, barcha majburiy maydonlarni to'ldiring:<br> - ${miss.join('<br> - ')}`);
    }

    const fd = new FormData(DOM.addObjectForm);
    const objectData = {};
    for (const [key, value] of fd.entries()) { objectData[key] = value; }
    objectData.isSelfBuilt = DOM.addObjectForm.querySelector('[name="isSelfBuilt"]').checked ? 'Ha' : 'Yo\'q';
    objectData.objectId = `obj_${Date.now()}`;
    objectData.regDate = formatDate(new Date());
    
    // Xodimlarga ham vaqtinchalik ID beramiz
    const staffWithIds = tempStaffList.map(staff => ({...staff, staffId: staff.staffId || `staff_${Date.now()}_${Math.random()}`}));
    const payload = { object: objectData, staff: staffWithIds };

    // 1. Darhol lokal saqlash va interfeysni bo'shatish
    updateLocalObjectDatabase(payload.object, payload.staff);
    showToast("Ob'ekt qurilmaga saqlandi!", 'success');
    resetAddObjectForm();
    
    // Ob'ektlar statistikasini yangilash
    displayObjectStats();
    
    goBack();

    // 2. Orqa fonda server bilan sinxronizatsiya
    showToast("Baza bilan sinxronizatsiya qilinmoqda...", 'info');
    try {
        const result = await apiCall('saveObject', payload, false);
        showToast("Ob'ekt muvaffaqiyatli sinxronizatsiya qilindi!", 'success');

        // 3. QAYTA YUKLASH O'RNIGA, AQLLI BIRLASHTIRISH
        // Serverdan qaytgan havolalarni lokal bazadagi ma'lumotga qo'shamiz
        
        // Ob'ektni topib, unga serverdan kelgan linklarni qo'shamiz
        const objectIndex = socialObjectsDatabase.findIndex(o => o.objectId === payload.object.objectId);
        if (objectIndex > -1) {
            // Object.assign() mavjud ma'lumotni (Base64) o'chirmay, yangisini (link) qo'shadi
            socialObjectsDatabase[objectIndex] = Object.assign(
                socialObjectsDatabase[objectIndex], 
                result.data.object
            );
        }

        // Xuddi shu ishni xodimlar uchun ham qilamiz
        if (result.data.staff && result.data.staff.length > 0) {
            result.data.staff.forEach(serverStaff => {
                const staffIndex = objectStaffDatabase.findIndex(s => s.staffId === serverStaff.staffId);
                if (staffIndex > -1) {
                    objectStaffDatabase[staffIndex] = Object.assign(
                        objectStaffDatabase[staffIndex],
                        serverStaff
                    );
                }
            });
        }

        // Birlashgan to'liq ma'lumotni localStorage ga qayta saqlaymiz
        localStorage.setItem('databases', JSON.stringify({
            citizenDatabase,
            socialObjectsDatabase,
            objectStaffDatabase
        }));

    } catch (e) {
        showToast("Ob'ektni sinxronizatsiya qilishda xatolik. Keyinroq qayta uriniladi.", 'error');
        // Xatolik yuz bersa ham, ma'lumot lokal saqlanib qoladi.
    }
}

// <<<<<<< SHU YERGACHA NUSXA OLING >>>>>>>
function renderTempStaffList() {
    const container = document.getElementById('staff-list-container');
    if(tempStaffList.length === 0) {
        container.innerHTML = '<p style="text-align:center; color: var(--text-light); padding: 1rem;">Hali xodim qo\'shilmadi.</p>';
        return;
    }
    container.innerHTML = tempStaffList.map((staff, index) => `
        <div class="staff-list-item">
            <div class="staff-info">${staff.fio} <span>(${staff.position})</span></div>
            <i class="fas fa-trash-alt remove-staff-btn" data-index="${index}" title="O'chirish"></i>
        </div>
    `).join('');
    container.querySelectorAll('.remove-staff-btn').forEach(btn => {
        btn.onclick = () => {
            tempStaffList.splice(btn.dataset.index, 1);
            renderTempStaffList();
        }
    });
}
function getLocation() {
    if (!navigator.geolocation) {
        return showCustomAlert("Sizning qurilmangizda geolokatsiya funksiyasi mavjud emas.", "Xatolik");
    } 
    const btn = document.getElementById('get-location-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aniqlanmoqda...';
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const { latitude, longitude } = position.coords;
            DOM.addObjectForm.querySelector('[name="location"]').value = `${latitude},${longitude}`;
            btn.innerHTML = '<i class="fas fa-check-circle"></i> Joylashuv aniqlandi!';
            showToast("Joylashuv muvaffaqiyatli aniqlandi!");
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Joylashuvni aniqlash';
            }, 3000);
        },
        () => {
            showCustomAlert("Joylashuvni aniqlab bo'lmadi. GPS yoqilganiga va ruxsat berilganiga ishonch hosil qiling.", "Xatolik");
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Joylashuvni aniqlash';
        }
    );
}
function displayObjectStats() {
    const grid = document.getElementById('objects-summary-grid');
    if (!grid) return;
    
    // Debug
    console.log('=== displayObjectStats ===');
    console.log('socialObjectsDatabase:', socialObjectsDatabase);
    console.log('Ob\'ektlar soni:', socialObjectsDatabase.length);
    
    const totalObjects = socialObjectsDatabase.length;
    let totalJobs = socialObjectsDatabase.reduce((sum, obj) => sum + (Number(obj.officialStaff) || 0) + (Number(obj.selfEmployedStaff) || 0) + (Number(obj.unofficialStaff) || 0), 0);
    const undocumented = socialObjectsDatabase.filter(o => o.hasDocuments === 'Mavjud emas' || o.isSelfBuilt === 'Ha').length;
    
    let html = `
        <div class="summary-stat-card full-width js-object-stat-card" data-category="all-objects" style="grid-column: 1 / -1; cursor: pointer;">
            <div class="icon"><i class="fas fa-building"></i></div>
            <div class="number">${totalObjects}</div>
            <div class="label">Jami Ob'ektlar</div>
        </div>
    `;
    
    if (totalObjects > 0) {
        html += `
            <div class="summary-stat-card js-object-stat-card" data-category="total-jobs">
                <div class="icon"><i class="fas fa-users-cog"></i></div>
                <div class="number">${totalJobs}</div>
                <div class="label">Jami Ish O'rinlari</div>
            </div>
            <div class="summary-stat-card js-object-stat-card" data-category="undocumented">
                <div class="icon"><i class="fas fa-file-excel"></i></div>
                <div class="number">${undocumented}</div>
                <div class="label">Hujjatsiz/O'zboshimcha</div>
            </div>
        `;
        
        for (const category in OBJECT_CATEGORIES) {
            const count = socialObjectsDatabase.filter(o => o.mainCategory === category).length;
            if(count > 0) {
                html += `<div class="summary-stat-card js-object-stat-card" data-category="${category}">
                    <div class="icon"><i class="fas ${OBJECT_CATEGORIES[category]}"></i></div>
                    <div class="number">${count}</div>
                    <div class="label">${category}</div>
                </div>`;
            }
        }
    }
    
    grid.innerHTML = html;
    showScreen('objects-stats-modal');
}

// EVENT DELEGATION - Ob'ekt statistikasi kartochkalari uchun
document.addEventListener('click', function(e) {
    const card = e.target.closest('.js-object-stat-card');
    if (!card) return;
    
    const category = card.dataset.category;
    console.log('=== Ob\'ekt kategoriyasi bosildi ===');
    console.log('Kategoriya:', category);
    console.log('socialObjectsDatabase hozir:', socialObjectsDatabase);
    console.log('Ob\'ektlar soni:', socialObjectsDatabase.length);
    
    let list = [];
    let title = card.querySelector('.label').textContent;
    
    if(category === 'all-objects') {
        // To'g'ridan-to'g'ri socialObjectsDatabase dan olish
        list = socialObjectsDatabase.slice(); // Copy
        title = 'Jami Ob\'ektlar';
        console.log('all-objects tanlandi, list:', list);
    } else if(category === 'total-jobs') {
        displayJobsReport();
        return;
    } else if(category === 'undocumented') {
        list = socialObjectsDatabase.filter(o => o.hasDocuments === 'Mavjud emas' || o.isSelfBuilt === 'Ha');
    } else {
        list = socialObjectsDatabase.filter(o => o.mainCategory === category);
    }
    
    console.log('Tanlangan ro\'yxat:', list);
    console.log('Ro\'yxat uzunligi:', list.length);
    
    if (list.length > 0) {
        displayObjectList(list, title);
    } else {
        showToast('Bu kategoriyada ob\'ekt yo\'q', 'info');
    }
});

function displayObjectList(list, title) {
    console.log('=== displayObjectList boshlandi ===');
    console.log('Kelgan list:', list);
    console.log('List turi:', typeof list);
    console.log('List Array mi:', Array.isArray(list));
    console.log('List uzunligi:', list ? list.length : 'null');
    
    // List tekshirish
    if (!list || !Array.isArray(list)) {
        console.error('List noto\'g\'ri format!');
        showToast('Ro\'yxat formati noto\'g\'ri', 'error');
        return;
    }
    
    if (list.length === 0) {
        console.log('List bo\'sh');
        showToast('Ro\'yxat bo\'sh', 'info');
        return;
    }
    
    currentDisplayedList = list;
    currentListTitle = title;
    
    // DOM elementlarini olish
    const modal = document.getElementById('full-list-modal');
    const titleEl = document.getElementById('full-list-title');
    const containerEl = document.getElementById('full-list-table-container');
    const exportListBtn = document.getElementById('export-list-csv');
    const exportObjBtn = document.getElementById('export-objects-csv');
    
    console.log('Modal:', modal);
    console.log('Title element:', titleEl);
    console.log('Container element:', containerEl);
    
    if (!modal || !titleEl || !containerEl) {
        console.error('DOM elementlari topilmadi!');
        return;
    }
    
    // Sarlavha va tugmalarni sozlash
    titleEl.innerHTML = `${title} (<span>${list.length}</span>)`;
    if (exportListBtn) exportListBtn.style.display = 'none';
    if (exportObjBtn) exportObjBtn.style.display = 'inline-flex';
    
    // HTML yaratish
    let html = `<button class="btn btn-secondary js-back-to-previous-view" style="width:auto; margin-bottom:1.5rem; margin-top:0;"><i class="fas fa-arrow-left"></i> Orqaga</button>`;
    
    // Har bir ob'ekt uchun karta
    for (let i = 0; i < list.length; i++) {
        const obj = list[i];
        console.log('Ob\'ekt yaratilmoqda #' + i + ':', obj);
        
        if (!obj) {
            console.log('Ob\'ekt null yoki undefined');
            continue;
        }
        
        const cardHtml = createObjectCardHTML(obj);
        html += cardHtml;
    }
    
    console.log('Jami HTML yaratildi, uzunligi:', html.length);
    
    // Konteynerga qo'shish
    containerEl.innerHTML = html;
    
    // Modalni ochish - to'g'ridan-to'g'ri
    modal.style.display = 'flex';
    console.log('Modal ochildi');
}
function displayJobsReport(){
    const title = "Ish O'rinlari Bo'yicha Hisobot";
    DOM.fullListTitle.innerHTML = `${title}`;
    let html = `<button class="btn btn-secondary js-back-to-previous-view" style="width:auto; margin-bottom:1.5rem; margin-top:0;"><i class="fas fa-arrow-left"></i> Orqaga</button>`;
    const sortedObjects = [...socialObjectsDatabase].sort((a,b) => {
        const totalA = (Number(a.officialStaff) || 0) + (Number(a.selfEmployedStaff) || 0) + (Number(a.unofficialStaff) || 0);
        const totalB = (Number(b.officialStaff) || 0) + (Number(b.selfEmployedStaff) || 0) + (Number(b.unofficialStaff) || 0);
        return totalB - totalA;
    });
    html += sortedObjects.map(obj => {
        const totalStaff = (Number(obj.officialStaff) || 0) + (Number(obj.selfEmployedStaff) || 0) + (Number(obj.unofficialStaff) || 0);
        return `<div class="object-result-card" data-object-id="${obj.objectId}"><div class="card-icon"><i class="fas ${OBJECT_CATEGORIES[obj.mainCategory] || 'fa-question-circle'}"></i></div><div class="card-content"><h4>${obj.objectName}</h4><p>Ishchilar soni: ${totalStaff}</p></div><div class="card-actions"><button class="btn btn-secondary-outline js-object-details-btn"><i class="fas fa-eye"></i></button></div></div>`;
    }).join('');
    DOM.fullListTableContainer.innerHTML = html;
    showScreen('full-list-modal');
}
function createObjectCardHTML(obj) {
    if (!obj) return '';
    
    const director = objectStaffDatabase ? objectStaffDatabase.find(s => s.objectId === obj.objectId && s.position === 'Direktor') : null;
    const totalStaff = (Number(obj.officialStaff) || 0) + (Number(obj.selfEmployedStaff) || 0) + (Number(obj.unofficialStaff) || 0);
    
    // Rasm uchun photoLink yoki photoBase64
    let photoHtml = '';
    if (obj.photoLink) {
        photoHtml = `<img src="https://lh3.googleusercontent.com/d/${obj.photoLink}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary-glow);" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div style="display:none;width:80px;height:80px;align-items:center;justify-content:center;background:var(--primary-glow);border-radius:50%;"><i class="fas fa-store" style="font-size:2rem;color:var(--primary-color);"></i></div>`;
    } else if (obj.photoBase64) {
        photoHtml = `<img src="${obj.photoBase64}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary-glow);">`;
    } else {
        photoHtml = `<div style="width:80px;height:80px;display:flex;align-items:center;justify-content:center;background:var(--primary-glow);border-radius:50%;"><i class="fas fa-store" style="font-size:2rem;color:var(--primary-color);"></i></div>`;
    }
    
    return `
    <div class="result-card" data-object-id="${obj.objectId}" style="display:flex !important;gap:1.5rem;align-items:flex-start;background:var(--surface-color);padding:1.5rem;border:1px solid var(--border-color);border-radius:12px;margin-bottom:1rem;border-left:4px solid #f59e0b;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
        <div style="flex-shrink:0;">
            ${photoHtml}
        </div>
        <div style="flex-grow:1;min-width:0;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">
                <h3 style="margin:0;font-size:1.25rem;color:var(--primary-color);font-weight:600;">${obj.objectName || 'Nomsiz ob\'ekt'}</h3>
                <span style="background:rgba(245,158,11,0.15);color:#f59e0b;padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;">${obj.specificType || obj.mainCategory || 'Turi'}</span>
            </div>
            <table style="width:100%;border-collapse:collapse;font-size:.95rem;">
                <tr><td style="padding:.5rem 0;color:var(--text-light);width:35%;">üìç Manzil</td><td style="font-weight:600;color:var(--text-dark);">${obj.address || 'Kiritilmagan'}</td></tr>
                <tr><td style="padding:.5rem 0;color:var(--text-light);">üë§ Rahbar</td><td style="font-weight:600;color:var(--text-dark);">${director ? director.fio : 'Kiritilmagan'}</td></tr>
                <tr><td style="padding:.5rem 0;color:var(--text-light);">üë• Ishchilar</td><td style="font-weight:600;color:var(--text-dark);">${totalStaff} kishi</td></tr>
            </table>
            <div style="margin-top:1rem;">
                <button class="btn btn-secondary-outline js-object-details-btn" style="width:100%;padding:0.6rem 1rem;border:1px solid var(--border-color);background:transparent;color:var(--text-dark);border-radius:8px;cursor:pointer;"><i class="fas fa-eye"></i> To'liq ma'lumot</button>
            </div>
        </div>
    </div>`;
}
document.body.addEventListener('click', (e) => {
    if (e.target.closest('.js-object-details-btn')) {
        const card = e.target.closest('.result-card') || e.target.closest('.object-result-card');
        const objectId = card.dataset.objectId;
        displayObjectDetails(objectId);
    }
    if (e.target.closest('.staff-member-card')) {
        const staffId = e.target.closest('.staff-member-card').dataset.staffId;
        displayStaffDetails(staffId);
    }
});
function displayObjectDetails(objectId) {
    const obj = socialObjectsDatabase.find(o => o.objectId === objectId);
    if (!obj) return;
    const staff = objectStaffDatabase.filter(s => s.objectId === objectId);

    const render = (label, value) => {
        const val = value ? String(value).trim() : '';
        if (!val || val.toLowerCase() === 'yo\'q') return '';
        if (label === 'Joylashuvi' && val) {
            return `<div class="data-item"><span class="data-label">${label}</span><span class="data-value location-link" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${val}', '_blank')">Xaritada ko'rish</span></div>`;
        }
        return `<div class="data-item"><span class="data-label">${label}</span><span class="data-value">${val}</span></div>`;
    };

    // Faqat ICHKARISINI yangilaymiz, tashqi divning id'sini takrorlamaymiz
    // Rasm uchun photoLink yoki photoBase64 ni tekshirish
    const photoSrc = obj.photoLink 
        ? `https://lh3.googleusercontent.com/d/${obj.photoLink}` 
        : (obj.photoBase64 ? obj.photoBase64 : null);
    
    let html = `
        <div class="profile-header">
            ${photoSrc ? `<img src="${photoSrc}" class="profile-pic js-view-profile-pic">` : '<div class="avatar-placeholder" style="width: 140px; height: 140px; margin: 0 auto 1rem; border-radius: 50%; background: var(--primary-glow); display: flex; align-items: center; justify-content: center;"><i class="fas fa-store" style="font-size: 3rem; color: var(--primary-color);"></i></div>'}
            <div class="profile-name">${obj.objectName}</div>
        </div>
        <div class="section-title">Umumiy ma'lumotlar</div>
        <div class="data-grid">
            ${render("Asosiy Kategoriya", obj.mainCategory)}
            ${render("Aniq Turi", obj.specificType)}
            ${render("Manzili", obj.address)}
            ${render("Joylashuvi", obj.location)}
        </div>
        <div class="section-title">Yuridik ma'lumotlar</div>
        <div class="data-grid">
            ${render("Tashkiliy shakli", obj.orgType)}
            ${render("STIR (INN)", obj.stir)}
            ${render("Hujjatlar", obj.hasDocuments)}
            ${render("O'zboshimcha", obj.isSelfBuilt)}
        </div>
        <div class="section-title">Bandlik</div>
        <div class="data-grid">
            ${render("Rasmiy ishchilar", obj.officialStaff)}
            ${render("O'zini band qilganlar", obj.selfEmployedStaff)}
            ${render("Norasmiy ishchilar", obj.unofficialStaff)}
        </div>
    `;

    if (staff.length > 0) {
        html += `<div class="section-title staff-section">Xodimlar (${staff.length})</div>`;
        staff.forEach(s => {
            html += `
            <div class="staff-member-card" data-staff-id="${s.staffId}">
                <div class="staff-avatar">
                    ${s.photoLink ? 
                        `<img src="https://lh3.googleusercontent.com/d/${s.photoLink}" class="js-view-profile-pic" style="width: 50px; height: 50px; border-radius: 50%;" onerror="this.onerror=null; this.parentElement.innerHTML = '<div class=\\'avatar-placeholder-sm\\'><i class=\\'fas fa-user-tie\\'></i></div>';">` : 
                        '<div class="avatar-placeholder-sm" style="width: 50px; height: 50px; font-size: 1.5rem;"><i class="fas fa-user-tie"></i></div>'
                    }
                </div>
                <div class="staff-details">
                    <div class="staff-name">${s.fio}</div>
                    <div class="staff-position">${s.position} - ${s.phone || ''}</div>
                </div>
            </div>`;
        });
    }

    const container = DOM.objectDetailsModal.querySelector('#object-details-content');
    container.dataset.objectId = objectId;     // MUHIM QATOR
    container.innerHTML = html;               // Faqat ichini yangilaymiz

    showScreen('object-details-modal');
}
function displayStaffDetails(staffId) {
    const staff = objectStaffDatabase.find(s => s.staffId === staffId);
    if (!staff) return;

    const render = (label, value) => {
        const val = value ? String(value).trim() : '';
        if (!val || val.toLowerCase() === 'yo\'q') return '';
        return `<div class="data-item">
                    <span class="data-label">${label}</span>
                    <span class="data-value">${val}</span>
                </div>`;
    };

    // Endi HTML ichida data-staff-id bermaymiz
    let html = `
        <div class="profile-header">
            ${staff.photoLink 
                ? `<img src="https://lh3.googleusercontent.com/d/${staff.photoLink}" class="profile-pic js-view-profile-pic">` 
                : ''
            }
            <div class="profile-name">${staff.fio}</div>
        </div>
        <div class="section-title">Shaxsiy ma'lumotlar</div>
        <div class="data-grid">
            ${render("Lavozimi", staff.position)}
            ${render("Telefon", staff.phone)}
            ${render("Pasport", staff.passport)}
            ${render("JSHSHIR", staff.jshshir)}
            ${render("Tug'ilgan sana", formatDate(staff.dob))}
        </div>
    `;

    if (staff.signatureLink) {
        html += `
            <div class="section-title">Imzo</div>
            <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: var(--radius-md);">
                <img src="https://lh3.googleusercontent.com/d/${staff.signatureLink}" 
                     style="max-height: 80px; background: #fff; border-radius: 4px;">
            </div>`;
    }

    const container = DOM.staffDetailsModal.querySelector('#staff-details-content');
    container.dataset.staffId = staffId;   // MUHIM QATOR
    container.innerHTML = html;

    showScreen('staff-details-modal');
}
// <<<<<<< MANA SHU YERDAN NUSXA OLING >>>>>>>

function generateObjectPdf(objectId) {
    showLoader(true);
    const obj = socialObjectsDatabase.find(o => o.objectId === objectId);
    const staffList = objectStaffDatabase.filter(s => s.objectId === objectId);
    if (!obj) {
        showLoader(false);
        return showCustomAlert("PDF yaratish uchun ob'ekt ma'lumotlari topilmadi.", "Xatolik");
    }
    const render = (label, value) => {
        const val = value ? String(value).trim() : '';
        if (!val || val.toLowerCase() === 'yo\'q') return '';
        return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid #eeeeee; font-size: 10pt;">
                    <span style="color: #444444; width: 40%;">${label}</span>
                    <span style="font-weight: 600; color: #000000; font-family: 'Inter', sans-serif; text-align: right; width: 60%;">${val}</span>
                </div>`;
    };
    
    // YANGILANGAN QISM: Ob'ekt rasmini to'g'ri topish
    let objPhotoHtml = '';
    const objPhotoSrc = obj.photoBase64 ? obj.photoBase64 : (obj.photoLink ? `https://lh3.googleusercontent.com/d/${obj.photoLink}` : null);
    if (objPhotoSrc) {
        objPhotoHtml = `<img src="${objPhotoSrc}" style="width: 100px; height: 100px; border-radius: 8px; object-fit: cover; border: 3px solid #eeeeee; margin-bottom: 10px;" ${obj.photoLink ? 'crossorigin="anonymous"' : ''}>`;
    }
    
    let fullHtml = `<div style="font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000000; width: 210mm; min-height: 297mm; padding: 15mm; box-sizing: border-box;">
        <div style="text-align: center; margin-bottom: 15px;">
            ${objPhotoHtml}
            <div style="font-size: 18pt; font-weight: bold; color: #000000; padding-bottom: 10px; border-bottom: 1.5px solid #333333;">${obj.objectName || ''}</div>
        </div>
        <div style="font-size: 12pt; font-weight: 600; color: #000000; margin-top: 15px; margin-bottom: 5px; padding-bottom: 4px; border-bottom: 1px solid #cccccc;">Umumiy ma'lumotlar</div>
        <div>${render("Asosiy Kategoriya", obj.mainCategory)}${render("Aniq Turi", obj.specificType)}${render("Manzili", obj.address)}</div>
        <div style="font-size: 12pt; font-weight: 600; color: #000000; margin-top: 15px; margin-bottom: 5px; padding-bottom: 4px; border-bottom: 1px solid #cccccc;">Yuridik ma'lumotlar</div>
        <div>${render("Tashkiliy shakli", obj.orgType)}${render("STIR (INN)", obj.stir)}${render("Hujjatlar", obj.hasDocuments)}${render("O'zboshimcha", obj.isSelfBuilt)}</div>
        <div style="font-size: 12pt; font-weight: 600; color: #000000; margin-top: 15px; margin-bottom: 5px; padding-bottom: 4px; border-bottom: 1px solid #cccccc;">Bandlik</div>
        <div>${render("Rasmiy ishchilar", obj.officialStaff)}${render("O'zini band qilganlar", obj.selfEmployedStaff)}${render("Norasmiy ishchilar", obj.unofficialStaff)}</div>`;
    
    if (staffList.length > 0) {
        fullHtml += `<div style="font-size: 12pt; font-weight: 600; color: #000000; margin-top: 15px; margin-bottom: 10px; padding-bottom: 4px; border-bottom: 1px solid #cccccc;">Xodimlar (${staffList.length} ta)</div>`;
        staffList.forEach((s, idx) => {
            // YANGILANGAN QISM: Xodim imzosini to'g'ri topish
            let signatureHtml = '';
            const signatureSrc = s.signatureBase64 ? s.signatureBase64 : (s.signatureLink ? `https://lh3.googleusercontent.com/d/${s.signatureLink}` : null);
            if (signatureSrc) {
                signatureHtml = `<img src="${signatureSrc}" style="max-height: 50px; background: #fff; border: 1px solid #ccc; padding: 4px; border-radius: 4px;" ${s.signatureLink ? 'crossorigin="anonymous"' : ''}>`;
            }

            fullHtml += `<div style="padding: 10px; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px; background: #fafafa; border-radius: 6px;">
                            <div style="font-weight: bold; color: #000; margin-bottom: 5px;">${idx+1}. ${s.fio}</div>
                            ${s.position ? `<div style="color: #666; font-size: 9pt; margin-bottom: 3px;">Lavozim: ${s.position}</div>` : ''}
                            ${s.phone ? `<div style="color: #666; font-size: 9pt; margin-bottom: 3px;">Telefon: ${s.phone}</div>` : ''}
                            ${signatureHtml ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; text-align: center;"><div style="font-size: 8pt; color: #888; margin-bottom: 5px;">Imzo:</div>${signatureHtml}</div>` : ''}
                         </div>`;
        });
    }
    fullHtml += `</div>`;
    const name = (obj.objectName || 'obyekt_malumoti').replace(/[\\/:*?"<>|]/g, '_');
    const opt = { margin: 0, filename: `${name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, letterRendering: true, backgroundColor: '#ffffff' }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
    html2pdf().from(fullHtml).set(opt).save().then(() => {
        showLoader(false);
        showToast("PDF fayl muvaffaqiyatli yuklandi!");
    }).catch(err => {
        showLoader(false);
        showCustomAlert("PDF yaratishda xatolik yuz berdi.", "Xatolik");
        console.error(err);
    });
}

// <<<<<<< SHU YERGACHA NUSXA OLING >>>>>>>
// <<<<<<< MANA SHU YERDAN NUSXA OLING >>>>>>>

function generateStaffPdf(staffId) {
    showLoader(true);
    const staff = objectStaffDatabase.find(s => s.staffId === staffId);
    if (!staff) {
        showLoader(false);
        return showCustomAlert("PDF yaratish uchun xodim ma'lumotlari topilmadi.", "Xatolik");
    }
    const render = (label, value) => {
        const val = value ? String(value).trim() : '';
        if (!val || val.toLowerCase() === 'yo\'q') return '';
        return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eeeeee; font-size: 11pt;">
                    <span style="color: #444444; width: 40%; font-weight: 600;">${label}</span>
                    <span style="font-weight: 700; color: #000000; font-family: 'Inter', sans-serif; text-align: right; width: 60%;">${val}</span>
                </div>`;
    };
    
    // YANGILANGAN QISM: Xodim rasmini to'g'ri topish
    let photoHtml = '';
    const photoSrc = staff.photoBase64 ? staff.photoBase64 : (staff.photoLink ? `https://lh3.googleusercontent.com/d/${staff.photoLink}` : null);
    if (photoSrc) {
        photoHtml = `<img src="${photoSrc}" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #7c3aed; margin-bottom: 15px;" ${staff.photoLink ? 'crossorigin="anonymous"' : ''}>`;
    }
    
    let fullHtml = `<div style="font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000000; width: 210mm; min-height: 297mm; padding: 20mm; box-sizing: border-box;">
        <div style="text-align: center; margin-bottom: 20px;">
            ${photoHtml}
            <div style="font-size: 22pt; font-weight: bold; color: #000000; padding-bottom: 15px; border-bottom: 3px solid #7c3aed;">${staff.fio || ''}</div>
            <div style="font-size: 14pt; color: #666; margin-top: 10px;">${staff.position || ''}</div>
        </div>
        <div style="font-size: 14pt; font-weight: 700; color: #7c3aed; margin-top: 20px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #cccccc;">Shaxsiy ma'lumotlar</div>
        <div>${render("Lavozimi", staff.position)}${render("Telefon", staff.phone)}${render("Pasport", staff.passport)}${render("JSHSHIR", staff.jshshir)}${render("Tug'ilgan sana", formatDate(staff.dob))}</div>`;
    
    // YANGILANGAN QISM: Xodim imzosini to'g'ri topish
    const signatureSrc = staff.signatureBase64 ? staff.signatureBase64 : (staff.signatureLink ? `https://lh3.googleusercontent.com/d/${staff.signatureLink}` : null);
    if (signatureSrc) {
        fullHtml += `<div style="font-size: 14pt; font-weight: 700; color: #7c3aed; margin-top: 30px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #cccccc;">Imzo namunasi</div>
          <div style="text-align: center; padding: 20px; background: #f5f5f5; border-radius: 12px;">
            <img src="${signatureSrc}" style="max-height: 120px; background: #fff; border-radius: 8px; padding: 10px; border: 2px solid #7c3aed;" ${staff.signatureLink ? 'crossorigin="anonymous"' : ''}>
          </div>`;
    }
    
    fullHtml += `<div style="margin-top: 40px; text-align: center; font-size: 9pt; color: #888; border-top: 2px solid #eee; padding-top: 20px;">
        <strong>O'zbegim MFY</strong> - Xodimlar Boshqaruv Tizimi<br>
        Yaratilgan sana: ${formatDate(new Date())}
      </div></div>`;
    const name = (staff.fio || 'xodim_malumoti').replace(/[\\/:*?"<>|]/g, '_');
    const opt = { margin: 0, filename: `${name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, letterRendering: true, backgroundColor: '#ffffff' }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
    html2pdf().from(fullHtml).set(opt).save().then(() => {
        showLoader(false);
        showToast("Xodim PDF fayli muvaffaqiyatli yuklandi!");
    }).catch(err => {
        showLoader(false);
        showCustomAlert("PDF yaratishda xatolik yuz berdi.", "Xatolik");
        console.error(err);
    });
}

// <<<<<<< SHU YERGACHA NUSXA OLING >>>>>>>
function exportObjectsToCSV() {
    if (!currentDisplayedList || currentDisplayedList.length === 0) {
        return showToast("Eksport uchun ma'lumot yo'q.", 'error');
    }
    const csvHeaders = ['objectName', 'mainCategory', 'specificType', 'address', 'orgType', 'stir', 'hasDocuments', 'isSelfBuilt', 'officialStaff', 'selfEmployedStaff', 'unofficialStaff', 'location'];
    const csvHeadersLabels = ['Ob\'ekt nomi', 'Kategoriya', 'Turi', 'Manzil', 'Tashkiliy shakl', 'STIR', 'Hujjatlar', 'O\'zboshimcha', 'Rasmiy', 'O\'zini band qilgan', 'Norasmiy', 'Joylashuv'];
    const csvContent = [
        csvHeadersLabels.join(';'),
        ...currentDisplayedList.map(obj => {
            return csvHeaders.map(header => {
                const value = obj[header] === undefined || obj[header] === null ? '' : obj[header];
                const sanitizedValue = String(value).replace(/"/g, '""');
                return `"${sanitizedValue}"`;
            }).join(';');
        })
    ].join('\n');
    const blob = new Blob([`\uFEFF${csvContent}`], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement("a");
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `${currentListTitle.replace(/[\s,()]/g, '_')}_Obyektlar.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Excel (CSV) fayl yuklanmoqda...", "success");
    }
}
/* ========================================================== */
/* IMZO QO'YISH FUNKSIYALARI (YANGILANGAN) */
/* ========================================================== */
function setupSignaturePad() {
    const canvas = document.getElementById('signature-pad-canvas');
    let signaturePadInstance = null;

    function resizeCanvas() {
        const modalBox = canvas.closest('.modal-box');
        if (!modalBox) return;
        const displayWidth = Math.min(modalBox.clientWidth - 64, 900);
        const displayHeight = window.innerWidth < 768 ? 300 : 400;
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = displayWidth * ratio;
        canvas.height = displayHeight * ratio;
        canvas.style.width = `${displayWidth}px`;
        canvas.style.height = `${displayHeight}px`;
        const ctx = canvas.getContext('2d');
        ctx.scale(ratio, ratio);
        if (signaturePadInstance) signaturePadInstance.clear();
    }

    window.addEventListener('resize', resizeCanvas);

    document.body.addEventListener('click', e => {
        if (e.target.closest('.js-add-signature')) {
            currentSignatureFormId = e.target.closest('.js-add-signature').dataset.formId;
            if (signaturePadInstance) signaturePadInstance.off();
            showScreen('signature-modal');
            
            setTimeout(() => {
                resizeCanvas();
                signaturePadInstance = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)',
                    minWidth: 0.5,
                    maxWidth: 2.5,
                    velocityFilterWeight: 0.7,
                    throttle: 0
                });
            }, 150);
        }
    });

    document.getElementById('signature-clear-btn').addEventListener('click', () => {
        if (signaturePadInstance) signaturePadInstance.clear();
    });

    document.getElementById('signature-save-btn').addEventListener('click', () => {
        if (!signaturePadInstance || signaturePadInstance.isEmpty()) {
            return showCustomAlert("Iltimos, avval imzo qoldiring.");
        }
        const dataURL = signaturePadInstance.toDataURL('image/png');
        const form = document.getElementById(currentSignatureFormId);
        if (form) {
            form.querySelector('input[name="signatureBase64"]').value = dataURL;
            const previewContainer = document.getElementById(`${currentSignatureFormId}-signature-preview`);
            previewContainer.innerHTML = `<p>Imzo saqlandi:</p><img src="${dataURL}" alt="Imzo">`;
        }
        goBack();
    });
}

/* ========================================================== */
/* KO'P QAVATLI UYLAR KONFIGURATSIYASI */
/* ========================================================== */

const APARTMENT_BUILDINGS = {
    '6': { name: '6-dom', total: 42 },
    '7': { name: '7-dom', total: 42 },
    '8': { name: '8-dom', total: 42 },
    '9': { name: '9-dom', total: 42 },
    '10': { name: '10-dom', total: 42 },
    'lermontov10': { name: 'Lermontov 10-dom', total: 15 },
    '11': { name: '11-dom', total: 42 },
    '12': { name: '12-dom', total: 42 },
    '13': { name: '13-dom', total: 42 },
    '13a': { name: 'A.Temur 13a-dom', total: 50 },
    '14': { name: 'Lermontov 14-dom', total: 150, blocks: { '14a': [1, 50], '14b': [51, 100], '14c': [101, 150] } },
    '14a': { name: 'Lermontov 14a-blok', total: 50, parent: '14', range: [1, 50] },
    '14b': { name: 'Lermontov 14b-blok', total: 50, parent: '14', range: [51, 100] },
    '14c': { name: 'Lermontov 14c-blok', total: 50, parent: '14', range: [101, 150] },
    '15': { name: '15-dom', total: 42 },
    '16': { name: '16-dom', total: 42 },
    '17': { name: '17-dom', total: 42 },
    '21': { name: '21-dom', total: 80 },
    '22': { name: '22-dom', total: 80 },
    '23': { name: '23-dom', total: 80 },
    '24': { name: '24-dom', total: 80 },
    '28': { name: 'Mashrab 28-dom', total: 72 },
    '30': { name: 'Mashrab 30-dom', total: 72 },
    '39b': { name: 'Lermontov 39b-dom', total: 34 }
};

function getRegisteredApartments(domNumber) {
    const baza = activeCitizenDatabase || [];
    const registeredApartments = new Set();
    const domNum = String(domNumber);
    
    baza.forEach(p => {
        const street = (p.street || '').toLowerCase();
        
        // Turli formatlarni tekshirish
        const domPatterns = [
            domNum + '-dom',
            domNum + ' dom',
            domNum + '-uy',
            domNum + ' uy',
            'dom-' + domNum,
            'dom ' + domNum,
            domNum + 'dom',
            domNum + 'uy'
        ];
        
        const hasDom = domPatterns.some(pattern => street.includes(pattern));
        
        if (hasDom) {
            // Xonadon raqamini topish - turli formatlar
            const kvPatterns = [
                /(\d+)[\s-]*(kv|xonadon|xon)/i,
                /kv[\s-]*(\d+)/i,
                /xonadon[\s-]*(\d+)/i,
                /(\d+)[\s-]*xona/i
            ];
            
            for (const pattern of kvPatterns) {
                const match = street.match(pattern);
                if (match) {
                    const kvNum = parseInt(match[1]);
                    if (kvNum > 0 && kvNum <= 200) { // Reasonable apartment number
                        registeredApartments.add(kvNum);
                        break;
                    }
                }
            }
        }
    });
    
    return registeredApartments;
}

function getUnregisteredApartments(domNumber) {
    const config = APARTMENT_BUILDINGS[String(domNumber)];
    if (!config) return { name: '', registered: 0, unregistered: 0, total: 0, missing: [], found: [] };
    
    const registered = getRegisteredApartments(domNumber);
    const total = config.total;
    const missing = [];
    const found = Array.from(registered).sort((a, b) => a - b);
    
    for (let i = 1; i <= total; i++) {
        if (!registered.has(i)) {
            missing.push(i);
        }
    }
    
    return {
        name: config.name,
        registered: registered.size,
        unregistered: missing.length,
        total: total,
        missing: missing,
        found: found
    };
}

/* ========================================================== */
/* JSHSHIR DAN SANA VA JINS ANIQLASH */
/* ========================================================== */

function parseJSHSHIR(jshshir) {
    if (!jshshir || jshshir.length !== 14) return null;
    
    const genderDigit = parseInt(jshshir[0]);
    let gender = '';
    let centuryOffset = 0;
    
    if (genderDigit === 1 || genderDigit === 2) {
        centuryOffset = 1800;
        gender = genderDigit === 1 ? 'Erkak' : 'Ayol';
    } else if (genderDigit === 3 || genderDigit === 4) {
        centuryOffset = 1900;
        gender = genderDigit === 3 ? 'Erkak' : 'Ayol';
    } else if (genderDigit === 5 || genderDigit === 6) {
        centuryOffset = 2000;
        gender = genderDigit === 5 ? 'Erkak' : 'Ayol';
    }
    
    const day = jshshir.substring(1, 3);
    const month = jshshir.substring(3, 5);
    const year = centuryOffset + parseInt(jshshir.substring(5, 7));
    
    return {
        gender: gender,
        dob: `${day}.${month}.${year}`
    };
}

// JSHSHIR inputga event listener
document.addEventListener('input', (e) => {
    if (e.target.name === 'jshshir' && e.target.value.length === 14) {
        const parsed = parseJSHSHIR(e.target.value);
        if (parsed) {
            const form = e.target.closest('form');
            if (form) {
                const dobInput = form.querySelector('[name="dob"]');
                const genderSelect = form.querySelector('[name="jinsi"]');
                if (dobInput && !dobInput.value) dobInput.value = parsed.dob;
                if (genderSelect && !genderSelect.value) genderSelect.value = parsed.gender;
                showToast(`JSHSHIR dan aniqlandi: ${parsed.gender}, ${parsed.dob}`);
            }
        }
    }
});

/* ========================================================== */
/* RISK-SKORING TIZIMI */
/* ========================================================== */

function calculateRiskScore(person) {
    let score = 0;
    let factors = [];
    
    // Ishsiz bo'lsa
    if (person.employmentStatus === 'Ishsiz') {
        score += 25;
        factors.push('Ishsiz');
    }
    
    // Ajrashgan bo'lsa
    if (person.socialStatus === 'Ajrashgan' || person.socialStatus === 'Ajrim yoqasida') {
        score += 15;
        factors.push('Ajrashgan/Ajrim yoqasida');
    }
    
    // Ijarada yashasa
    if (person.registrationType === 'Ijara') {
        score += 10;
        factors.push('Ijarada yashaydi');
    }
    
    // Muammosi bo'lsa
    if (person.izoh && String(person.izoh).toLowerCase() !== 'yo\'q' && person.izoh.trim() !== '') {
        score += 20;
        factors.push('Muammosi bor');
    }
    
    // Nogironligi bo'lsa
    if (person.employmentStatus === 'Nogironligi bor' || person.disabilityGroup) {
        score += 15;
        factors.push('Nogironligi bor');
    }
    
    // Shubhali shaxs bo'lsa
    if (person.shubhali_shaxs === 'Ha' || person.shaxs_toifasi === 'Ha') {
        score += 30;
        factors.push('Nazoratda');
    }
    
    let level = 'Past xavf';
    let color = '#10b981';
    
    if (score >= 50) {
        level = 'YUQORI XAVF';
        color = '#ef4444';
    } else if (score >= 25) {
        level = 'O\'rta xavf';
        color = '#f59e0b';
    }
    
    return { score, level, color, factors };
}

/* ========================================================== */
/* XARITA (LEAFLET) */
/* ========================================================== */

let mapInstance = null;
let mapMarkers = [];

function initializeMap() {
    const container = document.getElementById('map-container');
    if (!container) return;
    
    if (mapInstance) {
        mapInstance.remove();
        mapInstance = null;
    }
    
    // Toshkent koordinatalari
    const defaultLat = 41.311081;
    const defaultLng = 69.279737;
    
    mapInstance = L.map('map-container').setView([defaultLat, defaultLng], 15);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 19
    }).addTo(mapInstance);
    
    // Mahalla markazi
    L.marker([defaultLat, defaultLng], {
        icon: L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: #3b82f6; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.4); border: 3px solid white;"><i class="fas fa-home"></i></div>',
            iconSize: [45, 45]
        })
    }).addTo(mapInstance).bindPopup('<strong>üè† Mahalla Markazi</strong><br>Toshkent shahri');
    
    loadMapMarkers('all');
    setupMapFilterButtons();
}

// Xarita filtri tugmalari uchun event listener
function setupMapFilterButtons() {
    const container1 = document.getElementById('map-filter-buttons');
    const container2 = document.getElementById('map-filter-buttons-2');
    
    function handleFilterClick(e) {
        const btn = e.target.closest('.map-filter-btn');
        if (!btn) return;
        
        const filter = btn.dataset.filter;
        if (!filter) return;
        
        // Active klassini barcha tugmalardan olib tashlash
        document.querySelectorAll('.map-filter-btn').forEach(b => {
            b.classList.remove('active');
            b.style.boxShadow = 'none';
            b.style.transform = 'scale(1)';
        });
        
        // Yangi active tugmani belgilash
        btn.classList.add('active');
        btn.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
        btn.style.transform = 'scale(1.05)';
        
        // Xaritani filtrlash
        if (mapInstance) {
            loadMapMarkers(filter);
        }
    }
    
    if (container1) container1.addEventListener('click', handleFilterClick);
    if (container2) container2.addEventListener('click', handleFilterClick);
}

function loadMapMarkers(filter) {
    if (!mapInstance) return;
    
    mapMarkers.forEach(m => m.remove());
    mapMarkers = [];
    
    const citizens = activeCitizenDatabase || [];
    const objects = socialObjectsDatabase || [];
    const infoContainer = document.getElementById('map-info-container');
    
    if (infoContainer) infoContainer.style.display = 'none';
    
    const baseLat = 41.311081;
    const baseLng = 69.279737;
    
    // OB'EKTLAR
    if (filter === 'all' || filter === 'objects') {
        objects.forEach((obj, i) => {
            let lat, lng;
            if (obj.location) {
                [lat, lng] = obj.location.split(',').map(Number);
            } else {
                lat = baseLat + (Math.random() - 0.5) * 0.01;
                lng = baseLng + (Math.random() - 0.5) * 0.01;
            }
            
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #f59e0b; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><i class="fas fa-store"></i></div>`,
                    iconSize: [32, 32]
                })
            }).addTo(mapInstance);
            
            marker.bindPopup(`<strong>${obj.objectName || 'Ob\'ekt'}</strong><br>üìç ${obj.address || ''}<br>üè∑Ô∏è ${obj.mainCategory || ''}`);
            mapMarkers.push(marker);
        });
    }
    
    // ISHSIZLAR
    if (filter === 'all' || filter === 'unemployed') {
        const ishsizlar = citizens.filter(p => p.employmentStatus === 'Ishsiz');
        ishsizlar.forEach(p => {
            const lat = baseLat + (Math.random() - 0.5) * 0.012;
            const lng = baseLng + (Math.random() - 0.5) * 0.012;
            
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: #ef4444; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-user"></i></div>',
                    iconSize: [28, 28]
                })
            }).addTo(mapInstance);
            
            marker.bindPopup(`<strong>${p.fio || ''}</strong><br>üìç ${p.street || ''}<br>üíº Ishsiz`);
            mapMarkers.push(marker);
        });
        
        if (filter === 'unemployed' && infoContainer) {
            // Kategoriyalarga ajratish
            const erkaklar = ishsizlar.filter(p => p.jinsi === 'Erkak');
            const ayollar = ishsizlar.filter(p => p.jinsi === 'Ayol');
            const yoshlar = ishsizlar.filter(p => { const age = getAge(p.dob); return age >= 18 && age <= 30; });
            
            infoContainer.style.display = 'block';
            infoContainer.innerHTML = `
                <div style="background: var(--surface-color); padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color);">
                    <h4 style="margin: 0 0 1rem 0; color: #ef4444;"><i class="fas fa-user-times"></i> Ishsizlar: ${ishsizlar.length} kishi</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <span style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; box-shadow: 0 2px 8px rgba(59,130,246,0.3);">üë® Erkaklar: ${erkaklar.length}</span>
                        <span style="background: linear-gradient(135deg, #ec4899, #f472b6); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; box-shadow: 0 2px 8px rgba(236,72,153,0.3);">üë© Ayollar: ${ayollar.length}</span>
                        <span style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; box-shadow: 0 2px 8px rgba(245,158,11,0.3);">‚ö° Yoshlar (18-30): ${yoshlar.length}</span>
                    </div>
                    
                    <!-- ERKAKLAR -->
                    <div style="margin-bottom: 1rem;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 0.5rem 1rem; border-radius: 10px 10px 0 0; font-weight: 600;">
                            <i class="fas fa-male"></i> Erkaklar (${erkaklar.length})
                        </div>
                        <div style="max-height: 120px; overflow-y: auto; background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.2); border-top: none; border-radius: 0 0 10px 10px; padding: 0.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                                ${erkaklar.map(p => `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="window.openCitizenFromMap('${p.unique_id}')">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #60a5fa); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : '<i class="fas fa-user" style="color: white; font-size: 12px;"></i>'}
                                        </div>
                                        <div style="min-width: 0; overflow: hidden;">
                                            <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.fio || ''}</div>
                                            <div style="font-size: 0.7rem; color: #3b82f6;">${getAge(p.dob) || '?'} yosh</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- AYOLLAR -->
                    <div>
                        <div style="background: linear-gradient(135deg, #ec4899, #db2777); color: white; padding: 0.5rem 1rem; border-radius: 10px 10px 0 0; font-weight: 600;">
                            <i class="fas fa-female"></i> Ayollar (${ayollar.length})
                        </div>
                        <div style="max-height: 120px; overflow-y: auto; background: rgba(236,72,153,0.05); border: 1px solid rgba(236,72,153,0.2); border-top: none; border-radius: 0 0 10px 10px; padding: 0.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                                ${ayollar.map(p => `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="window.openCitizenFromMap('${p.unique_id}')">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #ec4899, #f472b6); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : '<i class="fas fa-user" style="color: white; font-size: 12px;"></i>'}
                                        </div>
                                        <div style="min-width: 0; overflow: hidden;">
                                            <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.fio || ''}</div>
                                            <div style="font-size: 0.7rem; color: #ec4899;">${getAge(p.dob) || '?'} yosh</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // IJARACHILAR
    if (filter === 'all' || filter === 'renters') {
        const ijarachilar = citizens.filter(p => p.registrationType === 'Ijara');
        
        const byAddress = {};
        ijarachilar.forEach(p => {
            const addr = p.street || 'Noma\'lum';
            if (!byAddress[addr]) byAddress[addr] = [];
            byAddress[addr].push(p);
        });
        
        Object.entries(byAddress).forEach(([addr, people]) => {
            const lat = baseLat + (Math.random() - 0.5) * 0.012;
            const lng = baseLng + (Math.random() - 0.5) * 0.012;
            
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #ec4899; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${people.length}</div>`,
                    iconSize: [30, 30]
                })
            }).addTo(mapInstance);
            
            marker.bindPopup(`<strong>üè† ${addr}</strong><br>${people.length} ta ijarachi`);
            mapMarkers.push(marker);
        });
        
        if (filter === 'renters' && infoContainer) {
            // Manzillar bo'yicha guruhlash va saralash
            const sortedAddresses = Object.entries(byAddress).sort((a, b) => b[1].length - a[1].length);
            
            infoContainer.style.display = 'block';
            infoContainer.innerHTML = `
                <div style="background: var(--surface-color); padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color);">
                    <h4 style="margin: 0 0 1rem 0; color: #ec4899;"><i class="fas fa-key"></i> Ijarachilar: ${ijarachilar.length} kishi (${Object.keys(byAddress).length} manzilda)</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${sortedAddresses.map(([addr, people]) => `
                            <div style="margin-bottom: 1rem;">
                                <div style="background: linear-gradient(135deg, #ec4899, #db2777); color: white; padding: 0.5rem 1rem; border-radius: 10px 10px 0 0; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                                    <span><i class="fas fa-map-marker-alt"></i> ${addr}</span>
                                    <span style="background: white; color: #ec4899; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.85rem;">${people.length}</span>
                                </div>
                                <div style="background: rgba(236,72,153,0.05); border: 1px solid rgba(236,72,153,0.2); border-top: none; border-radius: 0 0 10px 10px; padding: 0.5rem;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                                        ${people.map(p => `
                                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="window.openCitizenFromMap('${p.unique_id}')">
                                                <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #ec4899, #f472b6); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                                    ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : '<i class="fas fa-user" style="color: white; font-size: 12px;"></i>'}
                                                </div>
                                                <div style="min-width: 0; overflow: hidden;">
                                                    <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.fio || ''}</div>
                                                    <div style="font-size: 0.7rem; color: #ec4899;">Ijarachi</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    }
    
    // BAND FUQAROLAR
    if (filter === 'all' || filter === 'employed') {
        const bandlar = citizens.filter(p => ['Rasmiy band', 'Norasmiy band', 'Tadbirkor'].includes(p.employmentStatus));
        
        bandlar.forEach(p => {
            const lat = baseLat + (Math.random() - 0.5) * 0.012;
            const lng = baseLng + (Math.random() - 0.5) * 0.012;
            
            let bgColor = '#10b981';
            if (p.employmentStatus === 'Norasmiy band') bgColor = '#f59e0b';
            if (p.employmentStatus === 'Tadbirkor') bgColor = '#8b5cf6';
            
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: ${bgColor}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-briefcase"></i></div>`,
                    iconSize: [28, 28]
                })
            }).addTo(mapInstance);
            
            marker.bindPopup(`<strong>${p.fio || ''}</strong><br>üìç ${p.street || ''}<br>üíº ${p.employmentStatus || ''}`);
            mapMarkers.push(marker);
        });
        
        if (filter === 'employed' && infoContainer) {
            const rasmiy = bandlar.filter(p => p.employmentStatus === 'Rasmiy band');
            const norasmiy = bandlar.filter(p => p.employmentStatus === 'Norasmiy band');
            const tadbirkor = bandlar.filter(p => p.employmentStatus === 'Tadbirkor');
            
            infoContainer.style.display = 'block';
            infoContainer.innerHTML = `
                <div style="background: var(--surface-color); padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color);">
                    <h4 style="margin: 0 0 1rem 0; color: #10b981;"><i class="fas fa-briefcase"></i> Band fuqarolar: ${bandlar.length} kishi</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <span style="background: linear-gradient(135deg, #10b981, #34d399); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; box-shadow: 0 2px 8px rgba(16,185,129,0.3);">‚úì Rasmiy: ${rasmiy.length}</span>
                        <span style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; box-shadow: 0 2px 8px rgba(245,158,11,0.3);">‚ö° Norasmiy: ${norasmiy.length}</span>
                        <span style="background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; box-shadow: 0 2px 8px rgba(139,92,246,0.3);">üè™ Tadbirkor: ${tadbirkor.length}</span>
                    </div>
                    
                    <!-- RASMIY BAND -->
                    <div style="margin-bottom: 1rem;">
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 0.5rem 1rem; border-radius: 10px 10px 0 0; font-weight: 600;">
                            <i class="fas fa-building"></i> Rasmiy bandlar (${rasmiy.length})
                        </div>
                        <div style="max-height: 150px; overflow-y: auto; background: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.2); border-top: none; border-radius: 0 0 10px 10px; padding: 0.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                                ${rasmiy.map(p => `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="window.openCitizenFromMap('${p.unique_id}')" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #34d399); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : '<i class="fas fa-user" style="color: white; font-size: 12px;"></i>'}
                                        </div>
                                        <div style="min-width: 0; overflow: hidden;">
                                            <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.fio || ''}</div>
                                            <div style="font-size: 0.7rem; color: #10b981;">Rasmiy band</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- NORASMIY BAND -->
                    <div style="margin-bottom: 1rem;">
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.5rem 1rem; border-radius: 10px 10px 0 0; font-weight: 600;">
                            <i class="fas fa-tools"></i> Norasmiy bandlar (${norasmiy.length})
                        </div>
                        <div style="max-height: 150px; overflow-y: auto; background: rgba(245,158,11,0.05); border: 1px solid rgba(245,158,11,0.2); border-top: none; border-radius: 0 0 10px 10px; padding: 0.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                                ${norasmiy.map(p => `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="window.openCitizenFromMap('${p.unique_id}')" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b, #fbbf24); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : '<i class="fas fa-user" style="color: white; font-size: 12px;"></i>'}
                                        </div>
                                        <div style="min-width: 0; overflow: hidden;">
                                            <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.fio || ''}</div>
                                            <div style="font-size: 0.7rem; color: #f59e0b;">Norasmiy band</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- TADBIRKORLAR -->
                    <div>
                        <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 0.5rem 1rem; border-radius: 10px 10px 0 0; font-weight: 600;">
                            <i class="fas fa-store"></i> Tadbirkorlar (${tadbirkor.length})
                        </div>
                        <div style="max-height: 150px; overflow-y: auto; background: rgba(139,92,246,0.05); border: 1px solid rgba(139,92,246,0.2); border-top: none; border-radius: 0 0 10px 10px; padding: 0.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                                ${tadbirkor.map(p => `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="window.openCitizenFromMap('${p.unique_id}')" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #8b5cf6, #a78bfa); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : '<i class="fas fa-user" style="color: white; font-size: 12px;"></i>'}
                                        </div>
                                        <div style="min-width: 0; overflow: hidden;">
                                            <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.fio || ''}</div>
                                            <div style="font-size: 0.7rem; color: #8b5cf6;">Tadbirkor</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // Helper function for showing info
    function showFilterInfo(title, color, icon, list, extraInfo = '') {
        if (!infoContainer) return;
        infoContainer.style.display = 'block';
        
        // Kategoriyalarga ajratish
        const erkaklar = list.filter(p => p.jinsi === 'Erkak');
        const ayollar = list.filter(p => p.jinsi === 'Ayol');
        
        infoContainer.innerHTML = `
            <div style="background: var(--surface-color); padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color);">
                <h4 style="margin: 0 0 1rem 0; color: ${color};"><i class="fas fa-${icon}"></i> ${title}: ${list.length} kishi ${extraInfo}</h4>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <span style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; font-size: 0.85rem;">üë® Erkaklar: ${erkaklar.length}</span>
                    <span style="background: linear-gradient(135deg, #ec4899, #f472b6); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; font-size: 0.85rem;">üë© Ayollar: ${ayollar.length}</span>
                </div>
                <div style="max-height: 350px; overflow-y: auto;">
                    <!-- ERKAKLAR -->
                    ${erkaklar.length > 0 ? `
                    <div style="margin-bottom: 1rem;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 0.5rem 1rem; border-radius: 10px 10px 0 0; font-weight: 600; font-size: 0.9rem;">
                            <i class="fas fa-male"></i> Erkaklar (${erkaklar.length})
                        </div>
                        <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-top: none; border-radius: 0 0 10px 10px; padding: 0.5rem; max-height: 150px; overflow-y: auto;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                                ${erkaklar.map(p => `
                                    <div class="filter-citizen-card" onclick="window.openCitizenFromMap('${p.unique_id}')" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--surface-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; border-left: 3px solid #3b82f6; border: 1px solid var(--border-color);">
                                        <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #60a5fa); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">` : '<i class="fas fa-user" style="color: white; font-size: 14px;"></i>'}
                                        </div>
                                        <div style="min-width: 0; overflow: hidden;">
                                            <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color);">${p.fio || ''}</div>
                                            <div style="font-size: 0.7rem; color: #3b82f6;">${getAge(p.dob) || '?'} yosh ${p.employmentStatus ? '‚Ä¢ ' + p.employmentStatus : ''}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- AYOLLAR -->
                    ${ayollar.length > 0 ? `
                    <div>
                        <div style="background: linear-gradient(135deg, #ec4899, #db2777); color: white; padding: 0.5rem 1rem; border-radius: 10px 10px 0 0; font-weight: 600; font-size: 0.9rem;">
                            <i class="fas fa-female"></i> Ayollar (${ayollar.length})
                        </div>
                        <div style="background: rgba(236,72,153,0.1); border: 1px solid rgba(236,72,153,0.3); border-top: none; border-radius: 0 0 10px 10px; padding: 0.5rem; max-height: 150px; overflow-y: auto;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                                ${ayollar.map(p => `
                                    <div class="filter-citizen-card" onclick="window.openCitizenFromMap('${p.unique_id}')" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--surface-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; border-left: 3px solid #ec4899; border: 1px solid var(--border-color);">
                                        <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #ec4899, #f472b6); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">` : '<i class="fas fa-user" style="color: white; font-size: 14px;"></i>'}
                                        </div>
                                        <div style="min-width: 0; overflow: hidden;">
                                            <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color);">${p.fio || ''}</div>
                                            <div style="font-size: 0.7rem; color: #ec4899;">${getAge(p.dob) || '?'} yosh ${p.employmentStatus ? '‚Ä¢ ' + p.employmentStatus : ''}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // NEET YOSHLAR
    if (filter === 'neet') {
        const neetYoshlar = citizens.filter(p => {
            const age = getAge(p.dob);
            const isNeetAge = age >= 18 && age <= 30;
            const isUnemployed = p.employmentStatus === 'Ishsiz' || !p.employmentStatus;
            const isNotStudent = p.employmentStatus !== "Talaba/O'quvchi" && p.employmentStatus !== "Talaba" && p.employmentStatus !== "Maktab o'quchisi";
            return isNeetAge && isUnemployed && isNotStudent;
        });
        neetYoshlar.forEach(p => {
            const lat = baseLat + (Math.random() - 0.5) * 0.012;
            const lng = baseLng + (Math.random() - 0.5) * 0.012;
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #dc2626; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-exclamation-triangle"></i></div>`,
                    iconSize: [28, 28]
                })
            }).addTo(mapInstance);
            marker.bindPopup(`<strong>${p.fio || ''}</strong><br>üìç ${p.street || ''}<br>‚ö†Ô∏è NEET (${getAge(p.dob)} yosh)`);
            mapMarkers.push(marker);
        });
        showFilterInfo('NEET Yoshlar (18-30)', '#dc2626', 'exclamation-triangle', neetYoshlar);
    }
    
    // YUQORI XAVFLI
    if (filter === 'risk') {
        const xavflilar = citizens.filter(p => {
            const risk = calculateRiskScore(p);
            return risk.level === 'YUQORI XAVF' || risk.level === "O'rta xavf";
        });
        xavflilar.forEach(p => {
            const lat = baseLat + (Math.random() - 0.5) * 0.012;
            const lng = baseLng + (Math.random() - 0.5) * 0.012;
            const risk = calculateRiskScore(p);
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: ${risk.color}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-shield-alt"></i></div>`,
                    iconSize: [28, 28]
                })
            }).addTo(mapInstance);
            marker.bindPopup(`<strong>${p.fio || ''}</strong><br>üìç ${p.street || ''}<br>‚ö†Ô∏è ${risk.level} (${risk.score} ball)`);
            mapMarkers.push(marker);
        });
        
        // Kategoriyalarga ajratish
        const yuqoriXavf = xavflilar.filter(p => calculateRiskScore(p).level === 'YUQORI XAVF');
        const ortaXavf = xavflilar.filter(p => calculateRiskScore(p).level === "O'rta xavf");
        
        if (infoContainer) {
            infoContainer.style.display = 'block';
            infoContainer.innerHTML = `
                <div style="background: var(--surface-color); padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color);">
                    <h4 style="margin: 0 0 1rem 0; color: #ef4444;"><i class="fas fa-shield-alt"></i> Xavfli fuqarolar: ${xavflilar.length} kishi</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <span style="background: linear-gradient(135deg, #dc2626, #ef4444); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; box-shadow: 0 2px 8px rgba(220,38,38,0.3);">üî¥ Yuqori xavf: ${yuqoriXavf.length}</span>
                        <span style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; box-shadow: 0 2px 8px rgba(245,158,11,0.3);">üü° O'rta xavf: ${ortaXavf.length}</span>
                    </div>
                    
                    <!-- YUQORI XAVF -->
                    <div style="margin-bottom: 1rem;">
                        <div style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; padding: 0.5rem 1rem; border-radius: 10px 10px 0 0; font-weight: 600;">
                            <i class="fas fa-exclamation-circle"></i> Yuqori xavf darajasi (${yuqoriXavf.length})
                        </div>
                        <div style="max-height: 150px; overflow-y: auto; background: rgba(220,38,38,0.05); border: 1px solid rgba(220,38,38,0.2); border-top: none; border-radius: 0 0 10px 10px; padding: 0.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                                ${yuqoriXavf.map(p => {
                                    const risk = calculateRiskScore(p);
                                    return `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 8px; cursor: pointer; border-left: 3px solid #dc2626;" onclick="window.openCitizenFromMap('${p.unique_id}')">
                                        <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #dc2626, #ef4444); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">` : '<i class="fas fa-user" style="color: white; font-size: 12px;"></i>'}
                                        </div>
                                        <div style="min-width: 0; overflow: hidden;">
                                            <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.fio || ''}</div>
                                            <div style="font-size: 0.7rem; color: #dc2626;">${risk.score} ball - ${risk.factors.slice(0, 2).join(', ')}</div>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- O'RTA XAVF -->
                    <div>
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.5rem 1rem; border-radius: 10px 10px 0 0; font-weight: 600;">
                            <i class="fas fa-exclamation-triangle"></i> O'rta xavf darajasi (${ortaXavf.length})
                        </div>
                        <div style="max-height: 150px; overflow-y: auto; background: rgba(245,158,11,0.05); border: 1px solid rgba(245,158,11,0.2); border-top: none; border-radius: 0 0 10px 10px; padding: 0.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                                ${ortaXavf.map(p => {
                                    const risk = calculateRiskScore(p);
                                    return `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 8px; cursor: pointer; border-left: 3px solid #f59e0b;" onclick="window.openCitizenFromMap('${p.unique_id}')">
                                        <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b, #fbbf24); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                            ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">` : '<i class="fas fa-user" style="color: white; font-size: 12px;"></i>'}
                                        </div>
                                        <div style="min-width: 0; overflow: hidden;">
                                            <div style="font-weight: 600; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.fio || ''}</div>
                                            <div style="font-size: 0.7rem; color: #f59e0b;">${risk.score} ball - ${risk.factors.slice(0, 2).join(', ')}</div>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // AYOLLAR DAFTARI
    if (filter === 'ayollar-daftari') {
        const ayollar = citizens.filter(p => p.ayollar_daftari === "Ro'yxatda turadi" || p.ayollar_daftari === "Ro'yxatga olish kerak");
        ayollar.forEach(p => {
            const lat = baseLat + (Math.random() - 0.5) * 0.012;
            const lng = baseLng + (Math.random() - 0.5) * 0.012;
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #ec4899; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-female"></i></div>`,
                    iconSize: [28, 28]
                })
            }).addTo(mapInstance);
            marker.bindPopup(`<strong>${p.fio || ''}</strong><br>üìç ${p.street || ''}<br>üë© ${p.ayollar_daftari}`);
            mapMarkers.push(marker);
        });
        showFilterInfo('Ayollar daftari', '#ec4899', 'female', ayollar);
    }
    
    // YOSHLAR DAFTARI
    if (filter === 'yoshlar-daftari') {
        const yoshlar = citizens.filter(p => p.yoshlar_daftari === "Ro'yxatda turadi" || p.yoshlar_daftari === "Ro'yxatga olish kerak");
        yoshlar.forEach(p => {
            const lat = baseLat + (Math.random() - 0.5) * 0.012;
            const lng = baseLng + (Math.random() - 0.5) * 0.012;
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #8b5cf6; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-user-graduate"></i></div>`,
                    iconSize: [28, 28]
                })
            }).addTo(mapInstance);
            marker.bindPopup(`<strong>${p.fio || ''}</strong><br>üìç ${p.street || ''}<br>üéì ${p.yoshlar_daftari}`);
            mapMarkers.push(marker);
        });
        showFilterInfo('Yoshlar daftari', '#8b5cf6', 'user-graduate', yoshlar);
    }
    
    // MODDIY YORDAM
    if (filter === 'moddiy-yordam') {
        const moddiy = citizens.filter(p => p.moddiy_yordam === 'Bola puli oladi' || p.moddiy_yordam === 'Nafaqa oladi');
        moddiy.forEach(p => {
            const lat = baseLat + (Math.random() - 0.5) * 0.012;
            const lng = baseLng + (Math.random() - 0.5) * 0.012;
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #10b981; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-hand-holding-usd"></i></div>`,
                    iconSize: [28, 28]
                })
            }).addTo(mapInstance);
            marker.bindPopup(`<strong>${p.fio || ''}</strong><br>üìç ${p.street || ''}<br>üí∞ ${p.moddiy_yordam}`);
            mapMarkers.push(marker);
        });
        showFilterInfo('Moddiy yordam/Bola puli', '#10b981', 'hand-holding-usd', moddiy);
    }
    
    // MIGRANTLAR
    if (filter === 'migrants') {
        const migrantlar = citizens.filter(p => p.employmentStatus === 'Migratsiya');
        migrantlar.forEach(p => {
            const lat = baseLat + (Math.random() - 0.5) * 0.012;
            const lng = baseLng + (Math.random() - 0.5) * 0.012;
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #0ea5e9; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-plane-departure"></i></div>`,
                    iconSize: [28, 28]
                })
            }).addTo(mapInstance);
            marker.bindPopup(`<strong>${p.fio || ''}</strong><br>üìç ${p.street || ''}<br>‚úàÔ∏è ${p.migration_country || 'Migratsiyada'}`);
            mapMarkers.push(marker);
        });
        showFilterInfo('Migrantlar', '#0ea5e9', 'plane-departure', migrantlar);
    }
    
    // NOGIRONLAR
    if (filter === 'disabled') {
        const nogironlar = citizens.filter(p => p.employmentStatus === 'Nogironligi bor' || (p.disabilityGroup && p.disabilityGroup !== "Yo'q"));
        nogironlar.forEach(p => {
            const lat = baseLat + (Math.random() - 0.5) * 0.012;
            const lng = baseLng + (Math.random() - 0.5) * 0.012;
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #06b6d4; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-wheelchair"></i></div>`,
                    iconSize: [28, 28]
                })
            }).addTo(mapInstance);
            marker.bindPopup(`<strong>${p.fio || ''}</strong><br>üìç ${p.street || ''}<br>‚ôø ${p.disabilityGroup || 'Nogironligi bor'}`);
            mapMarkers.push(marker);
        });
        showFilterInfo('Nogironlar', '#06b6d4', 'wheelchair', nogironlar);
    }
}

/* ========================================================== */
/* ANALITIKA - GRAFIKLAR VA BANDLIK */
/* ========================================================== */

let chartInstances = {};

function initializeAnalytics() {
    const baza = activeCitizenDatabase || [];
    
    // Eski chartlarni tozalash
    Object.values(chartInstances).forEach(chart => chart?.destroy());
    chartInstances = {};
    
    // Statistikalar
    const total = baza.length;
    const employed = baza.filter(p => ['Rasmiy band', 'Norasmiy band', 'Tadbirkor'].includes(p.employmentStatus)).length;
    const unemployed = baza.filter(p => p.employmentStatus === 'Ishsiz').length;
    const renters = baza.filter(p => p.registrationType === 'Ijara').length;
    
    // YANGI STATISTIKALAR
    const avtomobil = baza.filter(p => p.avtomobil_bor === 'Ha').length;
    const telegramYoq = baza.filter(p => p.telegram_azo === "Yo'q").length;
    const aliment = baza.filter(p => p.aliment_muammo === 'Ha').length;
    const yuridik = baza.filter(p => p.yuridik_maslahat === 'Ha').length;
    const daromadPast = baza.filter(p => p.oylik_daromad === '2 mln gacha').length;
    const ishlovchiYoq = baza.filter(p => p.ishlovchilar_soni === '0').length;
    const gazAqlli = baza.filter(p => p.gaz_hisoblagich === 'Aqlli').length;
    const isitishYoq = baza.filter(p => p.isitish_tizimi === "Yo'q").length;
    
    document.getElementById('analytics-total').textContent = total;
    document.getElementById('analytics-employed').textContent = employed;
    document.getElementById('analytics-unemployed').textContent = unemployed;
    document.getElementById('analytics-renters').textContent = renters;
    
    // YANGI STATISTIKALAR
    const avtomobilEl = document.getElementById('analytics-avtomobil');
    const telegramEl = document.getElementById('analytics-telegram-yoq');
    const alimentEl = document.getElementById('analytics-aliment');
    const yuridikEl = document.getElementById('analytics-yuridik');
    const daromadEl = document.getElementById('analytics-daromad-past');
    const ishlovchiEl = document.getElementById('analytics-ishlovchi-yoq');
    const gazEl = document.getElementById('analytics-gaz-aqlli');
    const isitishEl = document.getElementById('analytics-isitish-yoq');
    
    if (avtomobilEl) avtomobilEl.textContent = avtomobil;
    if (telegramEl) telegramEl.textContent = telegramYoq;
    if (alimentEl) alimentEl.textContent = aliment;
    if (yuridikEl) yuridikEl.textContent = yuridik;
    if (daromadEl) daromadEl.textContent = daromadPast;
    if (ishlovchiEl) ishlovchiEl.textContent = ishlovchiYoq;
    if (gazEl) gazEl.textContent = gazAqlli;
    if (isitishEl) isitishEl.textContent = isitishYoq;
    
    // INSPEKTOR STATISTIKALARI (faqat maxsus rollar uchun)
    const inspectorUsers = ['2304', '2528', '4161', '1909', '1983'];
    const inspectorSection = document.getElementById('inspector-analytics-section');
    if (inspectorSection && inspectorUsers.includes(CURRENT_USER.pass)) {
        inspectorSection.style.display = 'block';
        
        const pxt = baza.filter(p => p.toifa_turi === 'PXT').length;
        const probatsiya = baza.filter(p => p.toifa_turi === 'Probatsiya').length;
        const sudlangan = baza.filter(p => p.sudlanganlik === 'Ha').length;
        const qurol = baza.filter(p => p.qurol_egalik === 'Ha').length;
        const shubhali = baza.filter(p => p.shubhali_shaxs === 'Ha').length;
        const toifadagi = baza.filter(p => p.shaxs_toifasi === 'Ha').length;
        const jazodanQaytgan = baza.filter(p => p.jazo_qaytgan_sana).length;
        
        const pxtEl = document.getElementById('analytics-pxt');
        const probatsiyaEl = document.getElementById('analytics-probatsiya');
        const sudlanganEl = document.getElementById('analytics-sudlangan');
        const qurolEl = document.getElementById('analytics-qurol');
        const shubhaliEl = document.getElementById('analytics-shubhali');
        const toifadagiEl = document.getElementById('analytics-toifadagi');
        const jazodanQaytganEl = document.getElementById('analytics-jazodan-qaytgan');
        
        if (pxtEl) pxtEl.textContent = pxt;
        if (probatsiyaEl) probatsiyaEl.textContent = probatsiya;
        if (sudlanganEl) sudlanganEl.textContent = sudlangan;
        if (qurolEl) qurolEl.textContent = qurol;
        if (shubhaliEl) shubhaliEl.textContent = shubhali;
        if (toifadagiEl) toifadagiEl.textContent = toifadagi;
        if (jazodanQaytganEl) jazodanQaytganEl.textContent = jazodanQaytgan;
    } else if (inspectorSection) {
        inspectorSection.style.display = 'none';
    }
    
    // IJTIMOIY DAFTARLAR STATISTIKASI
    const ayollarDaftari = baza.filter(p => p.ayollar_daftari === "Ro'yxatda turadi" || p.ayollar_daftari === "Ro'yxatga olish kerak").length;
    const yoshlarDaftari = baza.filter(p => p.yoshlar_daftari === "Ro'yxatda turadi" || p.yoshlar_daftari === "Ro'yxatga olish kerak").length;
    const moddiyYordam = baza.filter(p => p.moddiy_yordam === 'Bola puli oladi' || p.moddiy_yordam === 'Nafaqa oladi').length;
    const migrantlar = baza.filter(p => p.employmentStatus === 'Migratsiya').length;
    const nogironlar = baza.filter(p => p.employmentStatus === 'Nogironligi bor' || (p.disabilityGroup && p.disabilityGroup !== "Yo'q")).length;
    
    const ayollarDaftariEl = document.getElementById('analytics-ayollar-daftari');
    const yoshlarDaftariEl = document.getElementById('analytics-yoshlar-daftari');
    const moddiyYordamEl = document.getElementById('analytics-moddiy-yordam');
    const migrantlarEl = document.getElementById('analytics-migrants');
    const nogironlarEl = document.getElementById('analytics-disabled');
    
    if (ayollarDaftariEl) ayollarDaftariEl.textContent = ayollarDaftari;
    if (yoshlarDaftariEl) yoshlarDaftariEl.textContent = yoshlarDaftari;
    if (moddiyYordamEl) moddiyYordamEl.textContent = moddiyYordam;
    if (migrantlarEl) migrantlarEl.textContent = migrantlar;
    if (nogironlarEl) nogironlarEl.textContent = nogironlar;
    
    // Jinsi chart
    const genderCtx = document.getElementById('gender-chart')?.getContext('2d');
    if (genderCtx) {
        const erkaklar = baza.filter(p => p.jinsi === 'Erkak').length;
        const ayollar = baza.filter(p => p.jinsi === 'Ayol').length;
        
        chartInstances.gender = new Chart(genderCtx, {
            type: 'doughnut',
            data: {
                labels: ['Erkaklar', 'Ayollar'],
                datasets: [{
                    data: [erkaklar, ayollar],
                    backgroundColor: ['#3b82f6', '#ec4899'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
    
    // Yosh chart
    const ageCtx = document.getElementById('age-chart')?.getContext('2d');
    if (ageCtx) {
        const ageGroups = { '0-18': 0, '18-25': 0, '25-35': 0, '35-50': 0, '50-65': 0, '65+': 0 };
        
        baza.forEach(p => {
            const yosh = getAge(p.dob);
            if (!yosh) return;
            if (yosh < 18) ageGroups['0-18']++;
            else if (yosh < 25) ageGroups['18-25']++;
            else if (yosh < 35) ageGroups['25-35']++;
            else if (yosh < 50) ageGroups['35-50']++;
            else if (yosh < 65) ageGroups['50-65']++;
            else ageGroups['65+']++;
        });
        
        chartInstances.age = new Chart(ageCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(ageGroups),
                datasets: [{
                    label: 'Soni',
                    data: Object.values(ageGroups),
                    backgroundColor: '#8b5cf6',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }
    // ==========================================
// ANALITIKA TUGMALARI UCHUN TUZATISH
// ==========================================

// 1. Kategoriya bosilganda (Tepada rangli 4 ta va pastdagi 2 ta katta kartochka)
window.showCategoryDetail = function(category) {
    // Bazani tekshiramiz
    if (!activeCitizenDatabase || activeCitizenDatabase.length === 0) {
        showToast("Bazada ma'lumot yo'q!", "error");
        return;
    }

    const baza = activeCitizenDatabase;
    let list = [];
    let title = '';

    // Filtrlash logikasi
    switch(category) {
        case 'all':
            list = baza;
            title = 'Jami aholi ro\'yxati';
            break;
        case 'band':
            list = baza.filter(p => ['Rasmiy band', 'Norasmiy band', 'Tadbirkor'].includes(p.employmentStatus));
            title = 'Band fuqarolar ro\'yxati';
            break;
        case 'ishsiz':
            list = baza.filter(p => p.employmentStatus === 'Ishsiz');
            title = 'Ishsizlar ro\'yxati';
            break;
        case 'ijara':
            list = baza.filter(p => p.registrationType === 'Ijara');
            title = 'Ijarachilar ro\'yxati';
            break;
        case 'neet':
            list = baza.filter(p => {
                const yosh = getAge(p.dob);
                if (!yosh || yosh < 18 || yosh > 30) return false;
                return ['Ishsiz', 'Uy bekasi'].includes(p.employmentStatus);
            });
            title = 'NEET Yoshlar (Ishsiz, o\'qimaydi)';
            break;
        case 'risk':
            list = baza.filter(p => {
                const risk = calculateRiskScore(p);
                return risk.level === 'YUQORI XAVF';
            });
            title = 'Yuqori xavf guruhidagi fuqarolar';
            break;
        // YANGI KATEGORIYALAR
        case 'avtomobil':
            list = baza.filter(p => p.avtomobil_bor === 'Ha');
            title = 'Avtomobil egalari';
            break;
        case 'telegram-yoq':
            list = baza.filter(p => p.telegram_azo === "Yo'q");
            title = 'Telegram kanaliga a\'zo bo\'lmaganlar';
            break;
        case 'aliment':
            list = baza.filter(p => p.aliment_muammo === 'Ha');
            title = 'Aliment muammosi borlar';
            break;
        case 'yuridik':
            list = baza.filter(p => p.yuridik_maslahat === 'Ha');
            title = 'Yuridik maslahat keraklar';
            break;
        case 'daromad-past':
            list = baza.filter(p => p.oylik_daromad === '2 mln gacha');
            title = 'Past daromadli oilalar';
            break;
        case 'ishlovchi-yoq':
            list = baza.filter(p => p.ishlovchilar_soni === '0');
            title = 'Hech kim ishlamaydigan oilalar';
            break;
        case 'gaz-aqlli':
            list = baza.filter(p => p.gaz_hisoblagich === 'Aqlli');
            title = 'Aqlli gaz hisoblagichi borlar';
            break;
        case 'isitish-yoq':
            list = baza.filter(p => p.isitish_tizimi === "Yo'q");
            title = 'Isitish tizimi yo\'q uylar';
            break;
        // INSPEKTOR KATEGORIYALARI
        case 'pxt':
            list = baza.filter(p => p.toifa_turi === 'PXT');
            title = 'PXT nazoratidagi shaxslar';
            break;
        case 'probatsiya':
            list = baza.filter(p => p.toifa_turi === 'Probatsiya');
            title = 'Probatsiyadagi shaxslar';
            break;
        case 'sudlangan':
            list = baza.filter(p => p.sudlanganlik === 'Ha');
            title = 'Sudlanganlar ro\'yxati';
            break;
        case 'qurol':
            list = baza.filter(p => p.qurol_egalik === 'Ha');
            title = 'Qurol egalari ro\'yxati';
            break;
        case 'shubhali':
            list = baza.filter(p => p.shubhali_shaxs === 'Ha');
            title = 'Shubhali shaxslar ro\'yxati';
            break;
        case 'toifadagi':
            list = baza.filter(p => p.shaxs_toifasi === 'Ha');
            title = 'Toifadagi shaxslar ro\'yxati';
            break;
        case 'jazodan-qaytgan':
            list = baza.filter(p => p.jazo_qaytgan_sana);
            title = 'Jazodan qaytganlar ro\'yxati';
            break;
        default:
            list = [];
    }

    // Ro'yxatni ochish
    if (list.length > 0) {
        showDetailList(list, title);
    } else {
        showToast("Bu kategoriyada fuqarolar topilmadi.", "info");
    }
};
// ==========================================
// ANALITIKA TUGMALARI UCHUN TUZATISH (TO'G'RI VERSIYA)
// ==========================================

// 1. Ro'yxatni ko'rsatadigan yordamchi funksiya (global)
function showDetailList(list, title) {
    if (!list || list.length === 0) {
        showToast('Bu toifada fuqaro topilmadi', 'info');
        return;
    }
    
    // Keyinchalik Excelga yuklash uchun ro'yxatni saqlab qo'yamiz
    window.currentDetailList = list;
    window.currentDetailTitle = title;
    
    const modal = document.getElementById('detail-list-modal');
    const titleEl = document.getElementById('detail-list-title');
    const content = document.getElementById('detail-list-content');
    
    if (!modal || !titleEl || !content) {
        console.error('Batafsil ro\'yxat uchun modal oyna topilmadi!');
        return;
    }
    
    titleEl.innerHTML = `<i class="fas fa-users"></i> ${title} <span style="background:var(--primary-color); color:#fff; padding:2px 8px; border-radius:10px; font-size:0.8em; margin-left: 0.5rem;">${list.length}</span>`;
    
    content.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem;">
            ${list.map(p => {
                const risk = calculateRiskScore(p);
                return `
                <div class="analytics-citizen-card" data-unique-id="${p.unique_id}" style="display: flex; gap: 1rem; padding: 1rem; background: var(--bg-color); border-radius: 12px; border: 1px solid var(--border-color); border-left: 4px solid ${risk.color}; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                    <div style="width: 70px; height: 70px; border-radius: 50%; background: var(--surface-color); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid ${risk.color}; flex-shrink: 0;">
                        ${p.rasm_link ? `<img src="https://lh3.googleusercontent.com/d/${p.rasm_link}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\' style=\\'color: var(--text-light); font-size: 1.5rem;\\'></i>'">` : `<i class="fas fa-user" style="color: var(--text-light); font-size: 1.5rem;"></i>`}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 700; font-size: 1rem; color: var(--text-dark); margin-bottom: 0.25rem;">${p.fio || 'Noma\'lum'}</div>
                        <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.25rem;"><i class="fas fa-map-marker-alt" style="width: 14px;"></i> ${p.street || 'Manzil kiritilmagan'}</div>
                        <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.25rem;"><i class="fas fa-user" style="width: 14px;"></i> ${p.jinsi || ''} | ${getAge(p.dob) || '?'} yosh | ${p.employmentStatus || ''}</div>
                        <div style="font-size: 0.8rem; color: var(--text-light);"><i class="fas fa-id-card" style="width: 14px;"></i> ${p.jshshir || ''}</div>
                        ${p.telefon ? `<div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <a href="tel:${p.telefon}" onclick="event.stopPropagation()" style="text-decoration: none; color: var(--primary-color); font-size: 0.8rem; padding: 0.25rem 0.5rem; background: var(--primary-glow); border-radius: 6px;"><i class="fas fa-phone"></i> ${p.telefon}</a>
                        </div>` : ''}
                        <div style="margin-top: 0.5rem;"><span style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: ${risk.color}20; color: ${risk.color}; border-radius: 4px; font-weight: 600;">${risk.level}</span></div>
                    </div>
                </div>
            `}).join('')}
        </div>
    `;
    
    // Har bir kartochkani bosib fuqaro detallarini ko'rish
    content.querySelectorAll('.analytics-citizen-card').forEach(card => {
        card.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') return; // Telefon linkni bosganida modal ochilmasin
            const uniqueId = card.dataset.uniqueId;
            const person = activeCitizenDatabase.find(p => p.unique_id === uniqueId);
            if (person) {
                showCitizenDetails(person);
            }
        });
    });
    
    document.getElementById('analytics-modal').style.display = 'none';
    showScreen('detail-list-modal');
}

// Fuqaro tafsilotlarini ko'rsatish funksiyasi (analitikadan) - GLOBAL
window.showCitizenDetails = function(person) {
    if (!person) {
        console.log('showCitizenDetails: person not found');
        return;
    }
    console.log('showCitizenDetails:', person.fio);
    
    // Detail list modalini yopish (agar ochiq bo'lsa)
    const detailListModal = document.getElementById('detail-list-modal');
    if (detailListModal && detailListModal.style.display !== 'none') {
        detailListModal.style.display = 'none';
    }
    
    // Xarita modalini yopish (agar ochiq bo'lsa)
    const mapModal = document.getElementById('objects-stats-modal');
    if (mapModal && mapModal.style.display !== 'none') {
        mapModal.style.display = 'none';
    }
    
    // Details modalini ochish
    showScreen('details-modal');
    DOM.detailsContent.innerHTML = createFullDetailsHTML(person);
}

// GLOBAL: Xaritadan fuqaroni ochish funksiyasi
window.openCitizenFromMap = function(uniqueId) {
    console.log('openCitizenFromMap chaqirildi:', uniqueId);
    
    // Vibration (mobil uchun)
    if (navigator.vibrate) {
        navigator.vibrate(50);
    }
    
    const person = activeCitizenDatabase.find(function(c) { return c.unique_id === uniqueId; });
    if (person) {
        console.log('Fuqaro topildi:', person.fio);
        
        // Xarita modalini yopish
        const objectsModal = document.getElementById('objects-stats-modal');
        if (objectsModal) {
            objectsModal.style.display = 'none';
        }
        
        // Details modalini ochish
        window.showCitizenDetails(person);
    } else {
        console.log('Fuqaro topilmadi:', uniqueId);
        showToast('Fuqaro topilmadi', 'error');
    }
};


// 2. Kategoriya kartochkalari uchun funksiya (global)
window.showCategoryDetail = function(category) {
    if (!activeCitizenDatabase || activeCitizenDatabase.length === 0) {
        showToast("Bazada ma'lumot yo'q!", "error");
        return;
    }

    const baza = activeCitizenDatabase;
    let list = [];
    let title = '';

    switch(category) {
        case 'all':
            list = baza;
            title = 'Jami aholi ro\'yxati';
            break;
        case 'band':
            list = baza.filter(p => ['Rasmiy band', 'Norasmiy band', 'Tadbirkor'].includes(p.employmentStatus));
            title = 'Band fuqarolar ro\'yxati';
            break;
        case 'ishsiz':
            list = baza.filter(p => p.employmentStatus === 'Ishsiz');
            title = 'Ishsizlar ro\'yxati';
            break;
        case 'ijara':
            list = baza.filter(p => p.registrationType === 'Ijara');
            title = 'Ijarachilar ro\'yxati';
            break;
        case 'neet':
            list = baza.filter(p => {
                const yosh = getAge(p.dob);
                if (!yosh || yosh < 18 || yosh > 30) return false;
                return ['Ishsiz', 'Uy bekasi'].includes(p.employmentStatus);
            });
            title = 'NEET Yoshlar (Ishsiz, o\'qimaydi)';
            break;
        case 'risk':
            list = baza.filter(p => {
                const risk = calculateRiskScore(p);
                return risk.level === 'YUQORI XAVF';
            });
            title = 'Yuqori xavf guruhidagi fuqarolar';
            break;
        // YANGI KATEGORIYALAR
        case 'avtomobil':
            list = baza.filter(p => p.avtomobil_bor === 'Ha');
            title = 'Avtomobil egalari';
            break;
        case 'telegram-yoq':
            list = baza.filter(p => p.telegram_azo === "Yo'q");
            title = 'Telegram kanaliga a\'zo bo\'lmaganlar';
            break;
        case 'aliment':
            list = baza.filter(p => p.aliment_muammo === 'Ha');
            title = 'Aliment muammosi borlar';
            break;
        case 'yuridik':
            list = baza.filter(p => p.yuridik_maslahat === 'Ha');
            title = 'Yuridik maslahat keraklar';
            break;
        case 'daromad-past':
            list = baza.filter(p => p.oylik_daromad === '2 mln gacha');
            title = 'Past daromadli oilalar';
            break;
        case 'ishlovchi-yoq':
            list = baza.filter(p => p.ishlovchilar_soni === '0');
            title = 'Hech kim ishlamaydigan oilalar';
            break;
        case 'gaz-aqlli':
            list = baza.filter(p => p.gaz_hisoblagich === 'Aqlli');
            title = 'Aqlli gaz hisoblagichi borlar';
            break;
        case 'isitish-yoq':
            list = baza.filter(p => p.isitish_tizimi === "Yo'q");
            title = 'Isitish tizimi yo\'q uylar';
            break;
        // INSPEKTOR KATEGORIYALARI
        case 'pxt':
            list = baza.filter(p => p.toifa_turi === 'PXT');
            title = 'PXT nazoratidagi shaxslar';
            break;
        case 'probatsiya':
            list = baza.filter(p => p.toifa_turi === 'Probatsiya');
            title = 'Probatsiyadagi shaxslar';
            break;
        case 'sudlangan':
            list = baza.filter(p => p.sudlanganlik === 'Ha');
            title = 'Sudlanganlar ro\'yxati';
            break;
        case 'qurol':
            list = baza.filter(p => p.qurol_egalik === 'Ha');
            title = 'Qurol egalari ro\'yxati';
            break;
        case 'shubhali':
            list = baza.filter(p => p.shubhali_shaxs === 'Ha');
            title = 'Shubhali shaxslar ro\'yxati';
            break;
        case 'toifadagi':
            list = baza.filter(p => p.shaxs_toifasi === 'Ha');
            title = 'Toifadagi shaxslar ro\'yxati';
            break;
        case 'jazodan-qaytgan':
            list = baza.filter(p => p.jazo_qaytgan_sana);
            title = 'Jazodan qaytganlar ro\'yxati';
            break;
        // IJTIMOIY DAFTARLAR KATEGORIYALARI
        case 'ayollar-daftari':
            list = baza.filter(p => p.ayollar_daftari === "Ro'yxatda turadi" || p.ayollar_daftari === "Ro'yxatga olish kerak");
            title = 'Ayollar daftari a\'zolari';
            break;
        case 'yoshlar-daftari':
            list = baza.filter(p => p.yoshlar_daftari === "Ro'yxatda turadi" || p.yoshlar_daftari === "Ro'yxatga olish kerak");
            title = 'Yoshlar daftari a\'zolari';
            break;
        case 'moddiy-yordam':
            list = baza.filter(p => p.moddiy_yordam === 'Bola puli oladi' || p.moddiy_yordam === 'Nafaqa oladi');
            title = 'Moddiy yordam oluvchilar';
            break;
        case 'migrants':
            list = baza.filter(p => p.employmentStatus === 'Migratsiya');
            title = 'Migrantlar ro\'yxati';
            break;
        case 'disabled':
            list = baza.filter(p => p.employmentStatus === 'Nogironligi bor' || (p.disabilityGroup && p.disabilityGroup !== "Yo'q"));
            title = 'Nogironlar ro\'yxati';
            break;
        case 'xavfli':
            list = baza.filter(p => {
                const risk = calculateRiskScore(p);
                return risk.level === 'YUQORI XAVF' || risk.level === "O'rta xavf";
            });
            title = 'Xavfli fuqarolar ro\'yxati';
            break;
        default:
            list = [];
    }
    
    showDetailList(list, title);
};

// 3. Bandlik kartochkalari uchun funksiya (global)
window.openEmploymentDetail = function(status) {
    if (!activeCitizenDatabase) return;
    const cleanStatus = status.replace(/\\'/g, "'");
    const list = activeCitizenDatabase.filter(p => p.employmentStatus === cleanStatus);
    showDetailList(list, `${cleanStatus} bo'yicha ro'yxat`);
};

// 4. Excelga eksport qilish funksiyasi (global)
function exportToCSV(data, filename) {
    if (!data || data.length === 0) {
        showToast('Eksport uchun ma\'lumot yo\'q', 'info');
        return;
    }
    
    const headers = ['F.I.O.', 'Manzil', 'Jinsi', 'Tug\'ilgan sana', 'Yoshi', 'JSHSHIR', 'Telefon', 'Bandlik holati', 'Ijtimoiy holat'];
    let csvContent = '\uFEFF' + headers.join(';') + '\n';
    
    data.forEach(p => {
        const row = [
            p.fio || '',
            p.street || '',
            p.jinsi || '',
            formatDate(p.dob) || '',
            getAge(p.dob) || '',
            p.jshshir || '',
            p.telefon || '',
            p.employmentStatus || '',
            p.socialStatus || ''
        ];
        csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(';') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename.replace(/[\s:]/g, '_')}_${new Date().toLocaleDateString('uz')}.csv`;
    link.click();
    showToast('Excel fayl yuklab olindi!', 'success');
}

// 5. Zaxiralash va tiklash funksiyalari (global)
function backupData() {
    const data = {
        timestamp: new Date().toISOString(),
        version: '2.1', // Versiyani yangilash mumkin
        citizenDatabase: citizenDatabase,
        socialObjectsDatabase: socialObjectsDatabase,
        objectStaffDatabase: objectStaffDatabase
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `mahalla_backup_${new Date().toLocaleDateString('uz').replace(/\./g, '-')}.json`;
    link.click();
    showToast('Ma\'lumotlar zaxiralandi!');
}

function restoreData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (data.citizenDatabase) {
                citizenDatabase = data.citizenDatabase;
                activeCitizenDatabase = citizenDatabase.filter(c => c.arxiv_holati !== 'arxiv');
                window.activeCitizenDatabase = activeCitizenDatabase;
                archivedCitizenDatabase = citizenDatabase.filter(c => c.arxiv_holati === 'arxiv');
            }
            if (data.socialObjectsDatabase) socialObjectsDatabase = data.socialObjectsDatabase;
            if (data.objectStaffDatabase) objectStaffDatabase = data.objectStaffDatabase;
            
            localStorage.setItem('databases', JSON.stringify({ 
                citizenDatabase, 
                socialObjectsDatabase, 
                objectStaffDatabase 
            }));
            
            showToast(`Ma'lumotlar tiklandi! ${citizenDatabase.length} ta fuqaro yuklandi.`, 'success');
            // Kerak bo'lsa, statistikalarni yangilash
            // updateHomeScreenStats(); // Agar shunday funksiya bo'lsa
        } catch (err) {
            showCustomAlert('Faylni o\'qishda xatolik: ' + err.message, 'Xatolik');
        }
    };
    input.click();
}

// 6. DOM yuklangandan so'ng tugmalarga event listenerlarni qo'shish
document.addEventListener('DOMContentLoaded', () => {
    // Orqaga tugmasi (batafsil ro'yxat oynasida)
    document.querySelector('#detail-list-modal .js-back-to-previous-view').onclick = function() {
        document.getElementById('detail-list-modal').style.display = 'none';
        document.getElementById('analytics-modal').style.display = 'flex'; // Analitika oynasiga qaytish
    };
    
    // Zaxiralash va tiklash tugmalari
    document.getElementById('btn-backup-data')?.addEventListener('click', backupData);
    document.getElementById('btn-restore-data')?.addEventListener('click', restoreData);

    // Excel eksport tugmalari
    document.getElementById('export-detail-list-excel')?.addEventListener('click', () => {
        if (window.currentDetailList) {
            exportToCSV(window.currentDetailList, window.currentDetailTitle || 'Royxat');
        } else {
            showToast('Eksport uchun ro\'yxat mavjud emas', 'info');
        }
    });
    
    document.getElementById('export-analytics-excel')?.addEventListener('click', () => {
        exportToCSV(activeCitizenDatabase, 'Barcha_fuqarolar_hisoboti');
    });

    document.getElementById('export-employment-excel')?.addEventListener('click', () => {
        exportToCSV(activeCitizenDatabase, 'Bandlik_hisoboti');
    });
});
// 2. Bandlik turlari bosilganda (Mayda katakchalar)
window.openEmploymentDetail = function(status) {
    if (!activeCitizenDatabase) return;
    
    // Status nomidagi maxsus belgilarni to'g'irlash (masalan: o'quvchi)
    const cleanStatus = status.replace(/\\'/g, "'");
    
    const list = activeCitizenDatabase.filter(p => p.employmentStatus === cleanStatus);
    
    if (list.length > 0) {
        showDetailList(list, `${cleanStatus} bo'yicha ro'yxat`);
    } else {
        showToast("Ma'lumot topilmadi", "info");
    }
};

// 3. Ro'yxatni ko'rsatish funksiyasi (Yangi oyna ochadi)
// Bu funksiya pastda to'liqroq versiyasi bilan almashtirildi

// 4. "Orqaga" tugmasi uchun (detail-list-modal ichidagi)
document.querySelector('#detail-list-modal .js-back-to-previous-view').onclick = function() {
    document.getElementById('detail-list-modal').style.display = 'none';
    document.getElementById('analytics-modal').style.display = 'flex'; // Analitikaga qaytish
};

// 5. Zaxira va Excel tugmalarini ishga tushirish (DOM yuklangandan keyin)
document.addEventListener('DOMContentLoaded', () => {
    // Backup
    document.getElementById('btn-backup-data')?.addEventListener('click', backupData);
    // Restore
    document.getElementById('btn-restore-data')?.addEventListener('click', restoreData);
    // Excel (Analitika ichidagi)
    document.getElementById('export-analytics-excel')?.addEventListener('click', () => {
        if(activeCitizenDatabase) exportToCSV(activeCitizenDatabase, "Barcha_Aholi");
    });
});
    // Bandlik kartochkalari
    renderEmploymentCards();
    
    // NEET yoshlar - 18-30 yosh, ishlamaydi, o'qimaydi (Ishsiz yoki Uy bekasi)
    const neetYoshlar = baza.filter(p => {
        const yosh = getAge(p.dob);
        if (!yosh || yosh < 18 || yosh > 30) return false;
        // Faqat ishsiz yoki uy bekasi bo'lgan yoshlar
        const neetHolatlar = ['Ishsiz', 'Uy bekasi'];
        return neetHolatlar.includes(p.employmentStatus);
    });
    
    const neetEl = document.getElementById('analytics-neet');
    if (neetEl) neetEl.textContent = neetYoshlar.length;
    
    const highRisk = baza.filter(p => {
        const risk = calculateRiskScore(p);
        return risk.level === 'YUQORI XAVF';
    });
    
    const highRiskEl = document.getElementById('analytics-highrisk');
    if (highRiskEl) highRiskEl.textContent = highRisk.length;
}

function renderEmploymentCards() {
    const baza = activeCitizenDatabase || [];
    const container = document.getElementById('employment-cards-grid');
    if (!container) return;
    
    const statuses = [
        { key: 'Rasmiy band', icon: 'fa-briefcase', color: '#10b981' },
        { key: 'Talaba', icon: 'fa-graduation-cap', color: '#3b82f6' },
        { key: 'Uy bekasi', icon: 'fa-home', color: '#0d9488' },
        { key: 'Nafaqada', icon: 'fa-user-clock', color: '#8b5cf6' },
        { key: 'Norasmiy band', icon: 'fa-tools', color: '#f59e0b' },
        { key: 'Tadbirkor', icon: 'fa-store', color: '#ec4899' },
        { key: 'Maktab o\'quchisi', icon: 'fa-school', color: '#06b6d4' },
        { key: 'Ishsiz', icon: 'fa-user-times', color: '#ef4444' },
        { key: 'Ona qaramog\'ida', icon: 'fa-baby', color: '#84cc16' },
        { key: 'Dekret', icon: 'fa-baby-carriage', color: '#f472b6' },
        { key: 'Migratsiyadan qaytgan', icon: 'fa-plane-arrival', color: '#64748b' },
        { key: 'Migratsiya', icon: 'fa-plane-departure', color: '#94a3b8' },
        { key: 'Nogironligi bor', icon: 'fa-wheelchair', color: '#78716c' },
        { key: 'Bog\'cha', icon: 'fa-child', color: '#a3e635' }
    ];
    
    let html = '';
    statuses.forEach(s => {
        const count = baza.filter(p => p.employmentStatus === s.key).length;
        if (count > 0) {
            const escapedKey = s.key.replace(/'/g, "\\'");
            html += `
                <div class="employment-card" style="background: ${s.color}15; border: 1px solid ${s.color}40; border-radius: 12px; padding: 1rem; cursor: pointer; transition: all 0.3s;" onclick="openEmploymentDetail('${escapedKey}')" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 5px 15px ${s.color}30'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: ${s.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${s.icon}" style="color: white;"></i>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${s.color};">${count}</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">${s.key}</div>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
}

// =====================================================
// BATAFSIL RO'YXAT FUNKSIYALARI
// =====================================================

function openEmploymentDetail(status) {
    const baza = activeCitizenDatabase || [];
    const list = baza.filter(p => p.employmentStatus === status);
    showDetailList(list, status + ': ' + list.length + ' kishi');
}

// showDetailList - birlashtirilgan funksiya (ikkinchi versiyani o'chirib tashlaymiz)

// =====================================================
// ZAXIRALASH VA TIKLASH FUNKSIYALARI
// =====================================================

function backupData() {
    const data = {
        timestamp: new Date().toISOString(),
        version: '2.0',
        citizenDatabase: citizenDatabase,
        socialObjectsDatabase: socialObjectsDatabase,
        objectStaffDatabase: objectStaffDatabase
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `mahalla_backup_${new Date().toLocaleDateString('uz').replace(/\./g, '-')}.json`;
    link.click();
    showToast('Ma\'lumotlar zaxiralandi!');
}

function restoreData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (data.citizenDatabase) {
                citizenDatabase = data.citizenDatabase;
                activeCitizenDatabase = citizenDatabase.filter(c => c.status !== 'archived');
                window.activeCitizenDatabase = activeCitizenDatabase;
                archivedCitizenDatabase = citizenDatabase.filter(c => c.status === 'archived');
            }
            if (data.socialObjectsDatabase) socialObjectsDatabase = data.socialObjectsDatabase;
            if (data.objectStaffDatabase) objectStaffDatabase = data.objectStaffDatabase;
            
            localStorage.setItem('databases', JSON.stringify({ 
                citizenDatabase, 
                socialObjectsDatabase, 
                objectStaffDatabase 
            }));
            
            showToast('Ma\'lumotlar tiklandi! ' + citizenDatabase.length + ' ta fuqaro yuklandi.');
            updateHomeScreenStats();
        } catch (err) {
            showCustomAlert('Faylni o\'qishda xatolik: ' + err.message, 'Xatolik');
        }
    };
    input.click();
}

// Backup/Restore tugmalari
document.getElementById('btn-backup-data')?.addEventListener('click', backupData);
document.getElementById('btn-restore-data')?.addEventListener('click', restoreData);

// Detail Excel export
document.getElementById('export-detail-list-excel')?.addEventListener('click', () => {
    if (window.currentDetailList) {
        exportToCSV(window.currentDetailList, window.currentDetailTitle || 'Royxat');
    }
});

// Analytics Excel export
document.getElementById('export-analytics-excel')?.addEventListener('click', () => {
    exportToCSV(activeCitizenDatabase, 'Barcha_fuqarolar');
});

// Employment Excel export
document.getElementById('export-employment-excel')?.addEventListener('click', () => {
    exportToCSV(activeCitizenDatabase, 'Bandlik_hisoboti');
});

// EXCEL EXPORT FUNKSIYALARI
function exportToCSV(data, filename) {
    if (!data || data.length === 0) {
        showToast('Eksport uchun ma\'lumot yo\'q');
        return;
    }
    
    const headers = ['F.I.O.', 'Manzil', 'Jinsi', 'Tug\'ilgan sana', 'Yoshi', 'JSHSHIR', 'Telefon', 'Bandlik holati', 'Ijtimoiy holat'];
    
    let csvContent = '\uFEFF' + headers.join(';') + '\n';
    
    data.forEach(p => {
        const row = [
            p.fio || '',
            p.street || '',
            p.jinsi || '',
            formatDate(p.dob) || '',
            getAge(p.dob) || '',
            p.jshshir || '',
            p.telefon || '',
            p.employmentStatus || '',
            p.socialStatus || ''
        ];
        csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(';') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toLocaleDateString('uz')}.csv`;
    link.click();
    showToast('Excel fayl yuklab olindi!');
}

/* ========================================================== */
/* AI YORDAMCHI - TO'LIQ BAZA INTEGRATSIYASI */
/* ========================================================== */

const OPENAI_API_KEY = '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';

async function getAIResponse(message) {
    const baza = activeCitizenDatabase || [];
    const msg = message.toLowerCase().trim();
    const total = baza.length;
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ASOSIY STATISTIKALAR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const erkaklar = baza.filter(p => p.jinsi === 'Erkak');
    const ayollar = baza.filter(p => p.jinsi === 'Ayol');
    const ishsizlar = baza.filter(p => p.employmentStatus === 'Ishsiz');
    const rasmiyBand = baza.filter(p => p.employmentStatus === 'Rasmiy band');
    const norasmiyBand = baza.filter(p => p.employmentStatus === 'Norasmiy band');
    const tadbirkorlar = baza.filter(p => p.employmentStatus === 'Tadbirkor');
    const talabalar = baza.filter(p => p.employmentStatus === 'Talaba');
    const migrantlar = baza.filter(p => p.employmentStatus === 'Migratsiya');
    const nafaqaxorlar = baza.filter(p => p.employmentStatus === 'Nafaqada');
    const ijarachilar = baza.filter(p => p.registrationType === 'Ijara');
    const doimiylar = baza.filter(p => p.registrationType === 'Doimiy' || !p.registrationType);
    const maktabOquvchi = baza.filter(p => p.employmentStatus === "Maktab o'quchisi");
    const uyBekasi = baza.filter(p => p.employmentStatus === 'Uy bekasi');
    const nogironlar = baza.filter(p => p.employmentStatus === 'Nogironligi bor');
    const oilaBoshilari = baza.filter(p => p.familyRole === 'Oila boshi');
    
    // Band fuqarolar (rasmiy + norasmiy + tadbirkor)
    const bandlar = baza.filter(p => ['Rasmiy band', 'Norasmiy band', 'Tadbirkor'].includes(p.employmentStatus));
    
    // Yoshlar (18-35 yosh)
    const yoshlar = baza.filter(p => {
        const yosh = getAge(p.dob);
        return yosh && yosh >= 18 && yosh <= 35;
    });
    
    // NEET yoshlar
    const neetYoshlar = baza.filter(p => {
        const yosh = getAge(p.dob);
        return yosh && yosh >= 18 && yosh <= 30 && ['Ishsiz', 'Uy bekasi'].includes(p.employmentStatus);
    });
    
    const yuqoriXavf = baza.filter(p => calculateRiskScore(p).level === 'YUQORI XAVF');
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // XONADON STATISTIKASI (dom + hovli)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function getXonadonStats() {
        const stats = [];
        if (typeof APARTMENT_BUILDINGS === 'undefined') return stats;
        
        for (const domNum in APARTMENT_BUILDINGS) {
            const config = APARTMENT_BUILDINGS[domNum];
            const domPeople = baza.filter(p => {
                const street = (p.street || '').toLowerCase();
                return street.includes(domNum + '-dom') || street.includes(domNum + ' dom') || 
                       street.includes(domNum + '-uy') || street.includes(domNum + ' uy');
            });
            
            const apartments = new Set();
            domPeople.forEach(p => {
                const match = (p.street || '').match(/(\d+)\s*[-]?\s*(kv|xonadon)/i);
                if (match) apartments.add(parseInt(match[1]));
            });
            
            stats.push({
                dom: domNum,
                name: config.name || (domNum + '-dom'),
                total: config.total || 36,
                registered: apartments.size,
                notRegistered: (config.total || 36) - apartments.size,
                people: domPeople.length,
                percent: Math.round((apartments.size / (config.total || 36)) * 100)
            });
        }
        
        // Hovlidagi xonadonlar (ko'cha, uy formatida)
        const hovliPeople = baza.filter(p => {
            const street = (p.street || '').toLowerCase();
            return street.includes('ko.') || street.includes("ko'") || street.includes('uy');
        });
        
        const hovliAddresses = new Set();
        hovliPeople.forEach(p => {
            const street = (p.street || '').toLowerCase();
            hovliAddresses.add(street.split(',')[0].trim());
        });
        
        return stats;
    }
    
    const domStats = getXonadonStats();
    const totalApartments = domStats.reduce((s, d) => s + d.total, 0);
    const registeredApartments = domStats.reduce((s, d) => s + d.registered, 0);
    
    // Jami xonadonlar (dom + hovli)
    const allAddresses = new Set();
    baza.forEach(p => {
        if (p.street) allAddresses.add(p.street.toLowerCase().trim());
    });
    const totalXonadonlar = allAddresses.size;
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUQARO KARTOCHKASI (registrationType bilan)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function card(p) {
        const risk = calculateRiskScore(p);
        const regType = p.registrationType === 'Ijara' ? 'üè† Ijarachi' : 'üè° Doimiy';
        return `<div style="background:var(--bg-color);border-radius:10px;padding:12px;margin:8px 0;border-left:4px solid ${risk.color};">
            <strong>${p.fio || 'Nomalum'}</strong> <span style="font-size:0.8rem;color:#666;">[${regType}]</span><br>
            üìç ${p.street || 'Manzil yoq'}<br>
            üë§ ${p.jinsi || ''} | ${getAge(p.dob) || '?'} yosh | üìÖ ${formatDate(p.dob) || ''}<br>
            üíº ${p.employmentStatus || 'Nomalum'}${p.familyRole ? ' | üë®‚Äçüë©‚Äçüëß ' + p.familyRole : ''}<br>
            ${p.telefon ? 'üì± ' + p.telefon + '<br>' : ''}
            ${p.jshshir ? 'üÜî ' + p.jshshir + '<br>' : ''}
        </div>`;
    }
    
    // TO'LIQ RO'YXAT (hamma fuqarolar)
    function showList(list, title) {
        let result = `üìã <strong>${title} (${list.length} ta):</strong><br><br>`;
        list.forEach(p => { result += card(p); });
        return result;
    }
    
    // MANZIL BO'YICHA GURUHLANGAN RO'YXAT
    function showGroupedByAddress(list, title) {
        // Manzil bo'yicha guruhlash
        const byAddress = {};
        list.forEach(p => {
            const addr = p.street || 'Manzil nomalum';
            if (!byAddress[addr]) byAddress[addr] = [];
            byAddress[addr].push(p);
        });
        
        let result = `üìã <strong>${title} (${list.length} ta, ${Object.keys(byAddress).length} manzilda):</strong><br><br>`;
        
        // Har bir manzil uchun
        Object.keys(byAddress).sort().forEach(addr => {
            const people = byAddress[addr];
            const oilaBoshi = people.find(p => p.familyRole === 'Oila boshi');
            const others = people.filter(p => p.familyRole !== 'Oila boshi');
            
            result += `<div style="background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:12px;padding:12px;margin:12px 0;border:1px solid #0ea5e9;">`;
            result += `<div style="background:#0ea5e9;color:white;padding:8px 12px;border-radius:8px;margin:-12px -12px 12px -12px;font-weight:bold;">`;
            result += `üìç ${addr} <span style="float:right;background:white;color:#0ea5e9;padding:2px 8px;border-radius:10px;">${people.length} kishi</span></div>`;
            
            // Oila boshi birinchi
            if (oilaBoshi) {
                result += `<div style="background:#fef3c7;border-radius:8px;padding:10px;margin-bottom:8px;border-left:4px solid #f59e0b;">`;
                result += `<strong>üë®‚Äçüë©‚Äçüëß OILA BOSHI:</strong><br>`;
                result += `<strong>${oilaBoshi.fio}</strong><br>`;
                result += `üë§ ${oilaBoshi.jinsi || ''} | ${getAge(oilaBoshi.dob) || '?'} yosh | üìÖ ${formatDate(oilaBoshi.dob) || ''}<br>`;
                result += `üíº ${oilaBoshi.employmentStatus || ''} | ${oilaBoshi.registrationType === 'Ijara' ? 'üè† Ijarachi' : 'üè° Doimiy'}<br>`;
                if (oilaBoshi.telefon) result += `üì± ${oilaBoshi.telefon}<br>`;
                result += `</div>`;
            }
            
            // Boshqa oila a'zolari
            if (others.length > 0) {
                result += `<div style="margin-top:8px;"><strong>Oila a'zolari (${others.length}):</strong></div>`;
                others.forEach(p => {
                    result += `<div style="background:white;border-radius:8px;padding:8px;margin:4px 0;border-left:3px solid #10b981;">`;
                    result += `<strong>${p.fio}</strong><br>`;
                    result += `üë§ ${p.jinsi || ''} | ${getAge(p.dob) || '?'} yosh | üíº ${p.employmentStatus || ''}<br>`;
                    result += `${p.registrationType === 'Ijara' ? 'üè† Ijarachi' : 'üè° Doimiy'}`;
                    if (p.telefon) result += ` | üì± ${p.telefon}`;
                    result += `</div>`;
                });
            }
            result += `</div>`;
        });
        
        return result;
    }
    
    // Domdan fuqaro topish
    function getDomPeople(domNum) {
        return baza.filter(p => {
            const street = (p.street || '').toLowerCase();
            return street.includes(domNum + '-dom') || street.includes(domNum + ' dom') || 
                   street.includes(domNum + '-uy') || street.includes(domNum + ' uy');
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 1. SALOM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (msg.includes('salom') || msg.includes('assalom') || msg === 'hi' || msg === 'hello') {
        return `Vaalaykum assalom! üëã<br><br>
            Men <strong>O'zbegim AI</strong> yordamchisiman.<br>
            üìä Bazada <strong>${total}</strong> ta fuqaro bor.<br><br>
            <strong>Savol bering:</strong><br>
            ‚Ä¢ "Boynazarov" - ism bo'yicha<br>
            ‚Ä¢ "27 yosh" - yosh bo'yicha<br>
            ‚Ä¢ "band" - band fuqarolar<br>
            ‚Ä¢ "ijarachilar" - ijarachilar ro'yxati<br>
            ‚Ä¢ "yoshlar" - 18-35 yoshlilar<br>
            ‚Ä¢ "oilalar" - oila boshilari<br>
            ‚Ä¢ "10 dom" - dom statistikasi<br>
            ‚Ä¢ "statistika" - umumiy holat`;
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 2. IJARACHILAR (manzil bo'yicha guruhlangan)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (msg.includes('ijarachi')) {
        if (ijarachilar.length > 0) {
            return showGroupedByAddress(ijarachilar, 'Ijarachilar');
        } else {
            return `‚ùå Bazada ijarachi topilmadi.`;
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 3. BAND FUQAROLAR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (msg === 'band' || msg.includes('bandlar') || msg.includes('band fuqaro') || msg.includes('ishlaydigan')) {
        if (bandlar.length > 0) {
            let result = `üíº <strong>Band fuqarolar (${bandlar.length} ta):</strong><br><br>`;
            result += `<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;">`;
            result += `<span style="background:#10b981;color:white;padding:5px 12px;border-radius:15px;">‚úì Rasmiy: ${rasmiyBand.length}</span>`;
            result += `<span style="background:#f59e0b;color:white;padding:5px 12px;border-radius:15px;">‚ö° Norasmiy: ${norasmiyBand.length}</span>`;
            result += `<span style="background:#8b5cf6;color:white;padding:5px 12px;border-radius:15px;">üè™ Tadbirkor: ${tadbirkorlar.length}</span>`;
            result += `</div>`;
            bandlar.forEach(p => { result += card(p); });
            return result;
        } else {
            return `‚ùå Bazada band fuqaro topilmadi.`;
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 4. YOSH BO'YICHA QIDIRISH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const yoshMatch = msg.match(/(\d+)\s*(yosh|yoshli|yoshdagi|ga kirgan)/i);
    if (yoshMatch) {
        const targetYosh = parseInt(yoshMatch[1]);
        let filtered = baza.filter(p => getAge(p.dob) === targetYosh);
        let title = `${targetYosh} yoshdagi fuqarolar`;
        
        if (msg.includes('erkak') || msg.includes('o\'g\'il') || msg.includes('yigit')) {
            filtered = filtered.filter(p => p.jinsi === 'Erkak');
            title = `${targetYosh} yoshdagi erkaklar`;
        } else if (msg.includes('ayol') || msg.includes('qiz') || msg.includes('xotin')) {
            filtered = filtered.filter(p => p.jinsi === 'Ayol');
            title = `${targetYosh} yoshdagi ayollar`;
        }
        
        if (filtered.length > 0) {
            return showList(filtered, title);
        } else {
            return `‚ùå <strong>${title}</strong> topilmadi.`;
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 5. DOM + ISM KOMBINATSIYASI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const domIsmMatch = msg.match(/(\d+)\s*[-]?\s*(dom|uy)\s+(.+)/i);
    if (domIsmMatch) {
        const domNum = domIsmMatch[1];
        const ismQuery = domIsmMatch[3].trim().toLowerCase();
        
        if (ismQuery.length >= 2) {
            const domPeople = getDomPeople(domNum);
            const filtered = domPeople.filter(p => {
                const fio = (p.fio || '').toLowerCase();
                return fio.includes(ismQuery);
            });
            
            if (filtered.length > 0) {
                return showList(filtered, `${domNum}-domda "${ismQuery}" nomli fuqarolar`);
            } else {
                return `‚ùå <strong>${domNum}-dom</strong>da <strong>"${ismQuery}"</strong> nomli fuqaro topilmadi.`;
            }
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 6. DOM STATISTIKASI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const domMatch = msg.match(/(\d+)\s*[-]?\s*(dom|uy)/i);
    if (domMatch && !domIsmMatch) {
        const domNum = domMatch[1];
        const dom = domStats.find(d => d.dom === domNum);
        
        if (dom) {
            const domPeople = getDomPeople(domNum);
            
            let result = `üè† <strong>${dom.name} statistikasi:</strong><br><br>`;
            result += `üìä Jami xonadonlar: <strong>${dom.total}</strong> ta<br>`;
            result += `‚úÖ Xatlovdan o'tgan: <strong>${dom.registered}</strong> ta (${dom.percent}%)<br>`;
            result += `‚ùå O'tmagan: <strong>${dom.notRegistered}</strong> ta<br>`;
            result += `üë• Fuqarolar soni: <strong>${domPeople.length}</strong> kishi<br><br>`;
            
            if (domPeople.length > 0) {
                result += `<strong>Fuqarolar:</strong><br>`;
                domPeople.forEach(p => { result += card(p); });
            }
            return result;
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 7. YOSHLAR RO'YXATI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (msg.includes('yoshlar') || msg === 'yosh') {
        return showList(yoshlar, 'Yoshlar (18-35 yosh)');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 8. OILALAR RO'YXATI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (msg.includes('oila') || msg.includes('oilalar')) {
        if (oilaBoshilari.length > 0) {
            return showList(oilaBoshilari, 'Oila boshilari');
        } else {
            const kattalar = baza.filter(p => getAge(p.dob) >= 30);
            return showList(kattalar, 'Kattalar (30+ yosh)');
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 9. XONADONLAR XATLOV HOLATI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (msg.includes('xonadon') || msg.includes('xatlov') || msg.includes('kvartira')) {
        let result = `üè† <strong>Xonadonlar xatlov statistikasi:</strong><br><br>`;
        result += `üìä <strong>Umumiy:</strong><br>`;
        result += `&nbsp;&nbsp;‚îú‚îÄ Jami noyob manzillar: <strong>${totalXonadonlar}</strong> ta<br>`;
        result += `&nbsp;&nbsp;‚îú‚îÄ Ko'p qavatli uylar: <strong>${registeredApartments}/${totalApartments}</strong> xatlovdan o'tgan<br>`;
        result += `&nbsp;&nbsp;‚îî‚îÄ O'rtacha: ${Math.round(registeredApartments/totalApartments*100)}%<br><br>`;
        
        domStats.forEach(d => {
            const color = d.percent >= 80 ? '#10b981' : d.percent >= 50 ? '#f59e0b' : '#ef4444';
            result += `<div style="margin:6px 0;padding:10px;background:var(--bg-color);border-radius:8px;border-left:4px solid ${color};">
                <strong>${d.name}</strong><br>
                ‚úÖ O'tgan: <strong>${d.registered}</strong>/${d.total} (${d.percent}%)<br>
                ‚ùå O'tmagan: <strong>${d.notRegistered}</strong> ta | üë• ${d.people} kishi
            </div>`;
        });
        return result;
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 10. UMUMIY STATISTIKA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (msg.includes('statistika') || msg.includes('holat') || msg.includes('umumiy') || msg.includes('hisobot')) {
        return `üìä <strong>Mahalla statistikasi:</strong><br><br>
            üë• <strong>Jami aholi:</strong> ${total} kishi<br>
            &nbsp;&nbsp;‚îú‚îÄ üë® Erkaklar: ${erkaklar.length}<br>
            &nbsp;&nbsp;‚îî‚îÄ üë© Ayollar: ${ayollar.length}<br><br>
            üè† <strong>Ro'yxatdan o'tish turi:</strong><br>
            &nbsp;&nbsp;‚îú‚îÄ üè° Doimiy: ${doimiylar.length}<br>
            &nbsp;&nbsp;‚îî‚îÄ üè† Ijarachi: ${ijarachilar.length}<br><br>
            üíº <strong>Bandlik:</strong><br>
            &nbsp;&nbsp;‚îú‚îÄ ‚úÖ Rasmiy band: ${rasmiyBand.length}<br>
            &nbsp;&nbsp;‚îú‚îÄ ‚ö° Norasmiy band: ${norasmiyBand.length}<br>
            &nbsp;&nbsp;‚îú‚îÄ üè™ Tadbirkor: ${tadbirkorlar.length}<br>
            &nbsp;&nbsp;‚îú‚îÄ ‚ùå Ishsiz: ${ishsizlar.length}<br>
            &nbsp;&nbsp;‚îú‚îÄ üéì Talaba: ${talabalar.length}<br>
            &nbsp;&nbsp;‚îú‚îÄ üìö Maktab o'quvchi: ${maktabOquvchi.length}<br>
            &nbsp;&nbsp;‚îú‚îÄ ‚úàÔ∏è Migrant: ${migrantlar.length}<br>
            &nbsp;&nbsp;‚îú‚îÄ üë¥ Nafaqada: ${nafaqaxorlar.length}<br>
            &nbsp;&nbsp;‚îú‚îÄ ‚ôø Nogironlar: ${nogironlar.length}<br>
            &nbsp;&nbsp;‚îî‚îÄ üè† Uy bekasi: ${uyBekasi.length}<br><br>
            ‚ö†Ô∏è <strong>Diqqat:</strong><br>
            &nbsp;&nbsp;‚îú‚îÄ NEET yoshlar: ${neetYoshlar.length}<br>
            &nbsp;&nbsp;‚îî‚îÄ Yuqori xavf: ${yuqoriXavf.length}<br><br>
            üèòÔ∏è <strong>Xonadonlar:</strong><br>
            &nbsp;&nbsp;‚îú‚îÄ Jami manzillar: ${totalXonadonlar}<br>
            &nbsp;&nbsp;‚îî‚îÄ Ko'p qavatli: ${registeredApartments}/${totalApartments}`;
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 11. TOIFALAR BO'YICHA RO'YXATLAR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let list = null, title = '';
    
    if (msg.includes('ishsiz')) { list = ishsizlar; title = 'Ishsizlar'; }
    else if (msg.includes('migrant')) { list = migrantlar; title = 'Migrantlar'; }
    else if (msg.includes('talaba')) { list = talabalar; title = 'Talabalar'; }
    else if (msg.includes('nafaqa')) { list = nafaqaxorlar; title = "Nafaqaxo'rlar"; }
    else if (msg.includes('neet')) { list = neetYoshlar; title = 'NEET yoshlar (18-30)'; }
    else if (msg.includes('xavf') || msg.includes('risk')) { list = yuqoriXavf; title = 'Yuqori xavfdagilar'; }
    else if (msg.includes('tadbirkor')) { list = tadbirkorlar; title = 'Tadbirkorlar'; }
    else if (msg.includes('nogiron')) { list = nogironlar; title = 'Nogironlar'; }
    else if (msg.includes('uy bekasi')) { list = uyBekasi; title = 'Uy bekalari'; }
    else if (msg.includes('maktab')) { list = maktabOquvchi; title = "Maktab o'quvchilari"; }
    else if (msg.includes('doimiy')) { list = doimiylar; title = 'Doimiy fuqarolar'; }
    else if (msg.includes('rasmiy') && !msg.includes('norasmiy')) { list = rasmiyBand; title = 'Rasmiy bandlar'; }
    else if (msg.includes('norasmiy')) { list = norasmiyBand; title = 'Norasmiy bandlar'; }
    else if (msg.includes('erkak') && !msg.match(/\d+/)) { list = erkaklar; title = 'Erkaklar'; }
    else if ((msg.includes('ayol') || msg.includes('qiz')) && !msg.match(/\d+/)) { list = ayollar; title = 'Ayollar'; }
    
    if (list && list.length > 0) {
        return showList(list, title);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 12. SANA BO'YICHA QIDIRISH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const dateMatch = msg.match(/(\d{2})[\.\/](\d{2})[\.\/](\d{4})/);
    if (dateMatch) {
        const searchDate = dateMatch[0];
        const found = baza.filter(p => {
            const dob = formatDate(p.dob) || '';
            return dob.includes(searchDate);
        });
        
        if (found.length > 0) {
            return showList(found, `${searchDate} sanasida tug'ilganlar`);
        } else {
            return `‚ùå <strong>${searchDate}</strong> sanasida tug'ilgan fuqaro topilmadi.`;
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 13. JSHSHIR BO'YICHA QIDIRISH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const jshshirMatch = msg.match(/(\d{14})/);
    if (jshshirMatch) {
        const jshshir = jshshirMatch[1];
        const found = baza.filter(p => (p.jshshir || '').includes(jshshir));
        
        if (found.length > 0) {
            return showList(found, `JSHSHIR ${jshshir}`);
        } else {
            return `‚ùå JSHSHIR <strong>${jshshir}</strong> bo'yicha fuqaro topilmadi.`;
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 14. ISM/FAMILIYA BO'YICHA QIDIRISH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const cleanQuery = msg.replace(/degan|fuqaro|bormi|bor|kishi|odam|haqida|ismli|topib|ber|ko'rsat|kim|qayerda|yashaydi|ro'yxat|royhat|royhati|\?/gi, '').trim();
    
    if (cleanQuery.length >= 2) {
        const words = cleanQuery.split(/\s+/).filter(w => w.length >= 2);
        
        const found = baza.filter(p => {
            const fio = (p.fio || '').toLowerCase();
            const street = (p.street || '').toLowerCase();
            
            for (const word of words) {
                if (fio.includes(word) || street.includes(word)) return true;
            }
            return false;
        });
        
        if (found.length > 0) {
            return showList(found, `"${cleanQuery}" bo'yicha topildi`);
        } else {
            return `‚ùå <strong>"${cleanQuery}"</strong> bo'yicha fuqaro topilmadi.<br><br>
                <strong>Quyidagilarni sinab ko'ring:</strong><br>
                ‚Ä¢ "band" - band fuqarolar<br>
                ‚Ä¢ "yoshlar" - 18-35 yoshlilar<br>
                ‚Ä¢ "statistika" - umumiy holat`;
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 15. YORDAM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    return `ü§ñ <strong>Men sizga yordam bera olaman!</strong><br><br>
        üìä Bazada <strong>${total}</strong> ta fuqaro bor.<br><br>
        <strong>Quyidagilarni yozing:</strong><br>
        ‚Ä¢ <strong>"band"</strong> - band fuqarolar ro'yxati<br>
        ‚Ä¢ <strong>"ijarachilar"</strong> - ijarachilar (oilalar bo'yicha)<br>
        ‚Ä¢ <strong>"ishsizlar"</strong> - ishsizlar ro'yxati<br>
        ‚Ä¢ <strong>"yoshlar"</strong> - 18-35 yoshlilar<br>
        ‚Ä¢ <strong>"27 yosh"</strong> - aniq yoshdagilar<br>
        ‚Ä¢ <strong>"10 dom"</strong> - dom statistikasi<br>
        ‚Ä¢ <strong>"statistika"</strong> - umumiy holat<br>
        ‚Ä¢ <strong>Ism</strong> - "Boynazarov"`;
}
function formatAIResponse(text) {
    let formatted = text;
    formatted = formatted.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
    formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
    formatted = formatted.replace(/\n\n/g, '<br><br>');
    formatted = formatted.replace(/\n/g, '<br>');
    return formatted;
}

function initializeAIChat() {
    const aiInput = document.getElementById('ai-chat-input');
    const aiSendBtn = document.getElementById('ai-send-btn');
    const aiChatBody = document.getElementById('ai-chat-body');
    
    if (!aiInput || !aiSendBtn || !aiChatBody) return;
    
    // Avvalgi event listenerlarni olib tashlash
    const newSendBtn = aiSendBtn.cloneNode(true);
    aiSendBtn.parentNode.replaceChild(newSendBtn, aiSendBtn);
    
    const newInput = aiInput.cloneNode(true);
    aiInput.parentNode.replaceChild(newInput, aiInput);
    
    const sendMessage = async () => {
        const input = document.getElementById('ai-chat-input');
        const body = document.getElementById('ai-chat-body');
        const message = input.value.trim();
        if (!message) return;
        
        // User xabari
        body.innerHTML += `
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.75rem 1rem; border-radius: 12px 12px 0 12px; max-width: 85%;">
                    ${message}
                </div>
            </div>
        `;
        input.value = '';
        body.scrollTop = body.scrollHeight;
        
        // Typing indicator
        const typingId = 'typing-' + Date.now();
        body.innerHTML += `
            <div id="${typingId}" style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-brain" style="color: white;"></i>
                </div>
                <div style="background: var(--surface-color); padding: 0.75rem 1rem; border-radius: 0 12px 12px 12px;">
                    <i class="fas fa-circle-notch fa-spin"></i> AI tahlil qilmoqda...
                </div>
            </div>
        `;
        body.scrollTop = body.scrollHeight;
        
        // AI javob
        const response = await getAIResponse(message);
        
        document.getElementById(typingId)?.remove();
        
        body.innerHTML += `
            <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-brain" style="color: white;"></i>
                </div>
                <div style="background: var(--surface-color); padding: 0.75rem 1rem; border-radius: 0 12px 12px 12px; max-width: 90%; box-shadow: var(--shadow-sm);">
                    ${response}
                </div>
            </div>
        `;
        body.scrollTop = body.scrollHeight;
    };
    
    document.getElementById('ai-send-btn').onclick = sendMessage;
    document.getElementById('ai-chat-input').onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
}

/* ========================================================== */
/* EVENT LISTENERS */
/* ========================================================== */

// Analitika tugmasi
document.getElementById('fab-analytics')?.addEventListener('click', async () => {
    await dataReadyPromise;
    const modal = document.getElementById('analytics-modal');
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(initializeAnalytics, 100);
    }
});

// AI tugmasi
document.getElementById('fab-show-ai')?.addEventListener('click', async () => {
    await dataReadyPromise;
    const modal = document.getElementById('ai-chat-modal');
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(initializeAIChat, 100);
    }
});

// Xaritani ob'ektlar bilan birga ochish
const originalDisplayObjectStats = displayObjectStats;
displayObjectStats = function() {
    originalDisplayObjectStats();
    setTimeout(initializeMap, 300);
};

// ========================================================== 
// AQLLI MA'LUMOT KIRITISH TIZIMI (Smart Data Entry)
// ========================================================== 

// 1. JSHSHIR dublikat tekshiruvi (real-time)
function setupSmartDataEntry() {
    // JSHSHIR inputlari uchun listener
    document.querySelectorAll('input[name="jshshir"]').forEach(input => {
        // Eski alertni o'chirish
        const existingAlert = input.parentElement.querySelector('.smart-alert');
        if (existingAlert) existingAlert.remove();
        
        // Alert konteyner qo'shish
        let alertDiv = document.createElement('div');
        alertDiv.className = 'smart-alert';
        alertDiv.style.display = 'none';
        alertDiv.innerHTML = '<span class="smart-alert-icon">üîç</span><span class="smart-alert-text"></span>';
        input.parentElement.appendChild(alertDiv);
        
        // Eski listener ni olib tashlash
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
        
        newInput.addEventListener('input', function() {
            const jshshir = this.value.trim();
            alertDiv.style.display = 'none';
            
            // Faqat 14 ta raqam kiritilganda tekshirish
            if (jshshir.length === 14) {
                // Hozir tahrirlanayotgan shaxsni chiqarib tashlash
                const currentEditId = document.querySelector('input[name="update_unique_id"]')?.value;
                const found = (activeCitizenDatabase || citizenDatabase || []).find(p => 
                    String(p.jshshir || '') === jshshir && p.unique_id !== currentEditId
                );
                
                if (found) {
                    alertDiv.className = 'smart-alert';
                    alertDiv.innerHTML = `
                        <span class="smart-alert-icon">üîç</span>
                        <span class="smart-alert-text">
                            <strong>Diqqat!</strong> Bu JSHSHIR bazada mavjud: 
                            <span class="smart-alert-link" onclick="showCitizenDetails(activeCitizenDatabase.find(p => p.jshshir === '${found.jshshir}'))">${found.fio || 'Noma\'lum'}</span>
                        </span>
                    `;
                    alertDiv.style.display = 'block';
                }
            }
        });
    });
    
    // 2. Ijtimoiy holat tavsiyalari
    document.querySelectorAll('select[name="socialStatus"]').forEach(select => {
        select.addEventListener('change', function() {
            const status = this.value;
            const form = this.closest('form');
            const jinsi = form?.querySelector('select[name="jinsi"]')?.value || 
                         form?.querySelector('input[name="jinsi"]')?.value;
            
            let alertDiv = this.parentElement.querySelector('.smart-alert');
            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.className = 'smart-alert info';
                this.parentElement.appendChild(alertDiv);
            }
            
            alertDiv.style.display = 'none';
            
            // Ayollar daftari tavsiyasi
            if ((status === 'Ajrashgan' || status === 'Beva') && jinsi === 'Ayol') {
                alertDiv.className = 'smart-alert info';
                alertDiv.innerHTML = `
                    <span class="smart-alert-icon">üí°</span>
                    <span class="smart-alert-text">
                        <strong>Tavsiya:</strong> Bu fuqaroni <strong>"Ayollar daftari"</strong>ga nomzod sifatida ko'rib chiqing.
                        <button type="button" onclick="this.closest('.smart-alert').style.display='none'; document.querySelector('select[name=\\'ayollar_daftari\\']').value='Ro\\'yxatga olish kerak';" 
                                style="margin-left: 0.5rem; background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                            Ha, belgilash
                        </button>
                    </span>
                `;
                alertDiv.style.display = 'block';
            }
        });
    });
    
    // 3. Bandlik holati - Yoshlar daftari tavsiyasi
    document.querySelectorAll('select[name="employmentStatus"]').forEach(select => {
        select.addEventListener('change', function() {
            const status = this.value;
            const form = this.closest('form');
            const dobInput = form?.querySelector('input[name="dob"]');
            const dob = dobInput?.value;
            
            let alertDiv = this.parentElement.querySelector('.smart-alert');
            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.className = 'smart-alert info';
                this.parentElement.appendChild(alertDiv);
            }
            
            alertDiv.style.display = 'none';
            
            if (status === 'Ishsiz' && dob) {
                const age = getAge(dob);
                if (age >= 18 && age <= 30) {
                    alertDiv.className = 'smart-alert';
                    alertDiv.innerHTML = `
                        <span class="smart-alert-icon">‚ö†Ô∏è</span>
                        <span class="smart-alert-text">
                            <strong>NEET holati!</strong> Bu fuqaro 18-30 yosh oralig'ida va ishsiz. 
                            <strong>"Yoshlar daftari"</strong>ga qo'shishni ko'rib chiqing.
                            <button type="button" onclick="this.closest('.smart-alert').style.display='none'; document.querySelector('select[name=\\'yoshlar_daftari\\']').value='Ro\\'yxatga olish kerak';" 
                                    style="margin-left: 0.5rem; background: #f59e0b; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                Yoshlar daftariga
                            </button>
                        </span>
                    `;
                    alertDiv.style.display = 'block';
                }
            }
        });
    });
    
    // 4. Manzil bo'yicha ogohlantirish
    document.querySelectorAll('select[name="apartment"]').forEach(select => {
        select.addEventListener('change', function() {
            const apartment = this.value;
            if (!apartment) return;
            
            const baza = activeCitizenDatabase || citizenDatabase || [];
            const sameAddressPeople = baza.filter(p => p.apartment === apartment);
            
            let alertDiv = this.parentElement.querySelector('.smart-alert');
            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.className = 'smart-alert';
                this.parentElement.appendChild(alertDiv);
            }
            
            alertDiv.style.display = 'none';
            
            if (sameAddressPeople.length > 0) {
                // Ijtimoiy muammoli oila bormi?
                const hasIssue = sameAddressPeople.some(p => 
                    p.izoh || p.moddiy_yordam === 'Nafaqa oladi' || p.moddiy_yordam === 'Bola puli oladi'
                );
                
                if (hasIssue) {
                    alertDiv.className = 'smart-alert danger';
                    alertDiv.innerHTML = `
                        <span class="smart-alert-icon">‚ö†Ô∏è</span>
                        <span class="smart-alert-text">
                            <strong>Diqqat!</strong> Bu xonada ${sameAddressPeople.length} nafar fuqaro yashaydi va alohida e'tiborga muhtoj.
                            Yangi fuqaroning ijtimoiy holatini sinchkovlik bilan o'rganing.
                        </span>
                    `;
                    alertDiv.style.display = 'block';
                } else if (sameAddressPeople.length >= 3) {
                    alertDiv.className = 'smart-alert info';
                    alertDiv.innerHTML = `
                        <span class="smart-alert-icon">‚ÑπÔ∏è</span>
                        <span class="smart-alert-text">
                            Bu xonada allaqachon <strong>${sameAddressPeople.length}</strong> nafar fuqaro ro'yxatdan o'tgan: 
                            ${sameAddressPeople.slice(0, 3).map(p => p.fio?.split(' ')[0]).join(', ')}${sameAddressPeople.length > 3 ? '...' : ''}
                        </span>
                    `;
                    alertDiv.style.display = 'block';
                }
            }
        });
    });
}

// Smart Data Entry ni ishga tushirish
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(setupSmartDataEntry, 500);
});

// Modal ochilganda ham setup qilish
const originalShowScreen = showScreen;
showScreen = function(screenName) {
    originalShowScreen(screenName);
    if (screenName === 'add-view' || screenName === 'add-family-modal') {
        setTimeout(setupSmartDataEntry, 100);
    }
};

</script>
<!-- ========================================================== -->
<!-- SERVICE WORKER & OFFLINE STORAGE -->
<!-- ========================================================== -->
<script>
// PWA O'RNATISH
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Install button ko'rsatish (agar kerak bo'lsa)
    console.log('PWA o\'rnatish mumkin');
});

// OFFLINE STORAGE - IndexedDB
const DB_NAME = 'OzbegimOfflineDB';
const DB_VERSION = 1;
let offlineDB = null;

function initOfflineDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            offlineDB = request.result;
            resolve(offlineDB);
        };
        
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            
            // Offline saqlangan fuqarolar
            if (!db.objectStoreNames.contains('pendingCitizens')) {
                db.createObjectStore('pendingCitizens', { keyPath: 'tempId', autoIncrement: true });
            }
            
            // Offline o'zgartirishlar
            if (!db.objectStoreNames.contains('pendingUpdates')) {
                db.createObjectStore('pendingUpdates', { keyPath: 'tempId', autoIncrement: true });
            }
            
            // Cache qilingan baza
            if (!db.objectStoreNames.contains('cachedDatabase')) {
                db.createObjectStore('cachedDatabase', { keyPath: 'id' });
            }
        };
    });
}

// Offline fuqaro qo'shish
async function saveOfflineCitizen(citizenData) {
    if (!offlineDB) await initOfflineDB();
    
    return new Promise((resolve, reject) => {
        const transaction = offlineDB.transaction(['pendingCitizens'], 'readwrite');
        const store = transaction.objectStore('pendingCitizens');
        
        citizenData.savedAt = new Date().toISOString();
        citizenData.synced = false;
        
        const request = store.add(citizenData);
        request.onsuccess = () => {
            showToast('üì¥ Offline saqlandi. Internet kelganda sync bo\'ladi.', 'warning');
            resolve(request.result);
        };
        request.onerror = () => reject(request.error);
    });
}

// Pending fuqarolar sonini olish
async function getPendingCount() {
    if (!offlineDB) await initOfflineDB();
    
    return new Promise((resolve) => {
        const transaction = offlineDB.transaction(['pendingCitizens'], 'readonly');
        const store = transaction.objectStore('pendingCitizens');
        const request = store.count();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => resolve(0);
    });
}

// Pending fuqarolarni sync qilish
async function syncPendingCitizens() {
    if (!navigator.onLine) return;
    if (!offlineDB) await initOfflineDB();
    
    const transaction = offlineDB.transaction(['pendingCitizens'], 'readwrite');
    const store = transaction.objectStore('pendingCitizens');
    const request = store.getAll();
    
    request.onsuccess = async () => {
        const pendingItems = request.result;
        if (pendingItems.length === 0) return;
        
        showToast(`üîÑ ${pendingItems.length} ta fuqaroni sinxronlash...`, 'info');
        
        for (const item of pendingItems) {
            try {
                // Google Sheets ga yuborish
                if (typeof submitToGoogleSheets === 'function') {
                    await submitToGoogleSheets(item);
                }
                // Muvaffaqiyatli bo'lsa o'chirish
                store.delete(item.tempId);
            } catch (error) {
                console.error('Sync xatosi:', error);
            }
        }
        
        showToast('‚úÖ Sinxronlash tugadi!', 'success');
    };
}

// Internet holatini kuzatish
window.addEventListener('online', () => {
    showToast('üåê Internet qayta ulandi!', 'success');
    syncPendingCitizens();
});

window.addEventListener('offline', () => {
    showToast('üì¥ Oflayn rejim. Ma\'lumotlar lokal saqlanadi.', 'warning');
});

// MICRO-INTERACTIONS - Vibration API
function vibrate(pattern = 50) {
    if (navigator.vibrate) {
        navigator.vibrate(pattern);
    }
}

// Barcha tugmalarga vibration qo'shish
document.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn, .fab, .role-btn, .map-filter-btn, .search-option-btn');
    if (btn) {
        vibrate(30);
    }
});

// Offline indikator
function updateOfflineIndicator() {
    const indicator = document.getElementById('offline-indicator');
    if (!indicator) {
        const div = document.createElement('div');
        div.id = 'offline-indicator';
        div.style.cssText = 'position:fixed;top:0;left:0;right:0;padding:8px;text-align:center;font-size:0.85rem;font-weight:600;z-index:99999;transition:transform 0.3s;';
        document.body.appendChild(div);
    }
    
    const el = document.getElementById('offline-indicator');
    if (navigator.onLine) {
        el.style.transform = 'translateY(-100%)';
        el.style.background = '#10b981';
        el.style.color = 'white';
        el.innerHTML = 'üåê Online';
    } else {
        el.style.transform = 'translateY(0)';
        el.style.background = '#f59e0b';
        el.style.color = 'white';
        el.innerHTML = 'üì¥ Oflayn rejim - Ma\'lumotlar lokal saqlanmoqda';
    }
}

// Init
document.addEventListener('DOMContentLoaded', async () => {
    await initOfflineDB();
    updateOfflineIndicator();
    
    // Pending count ko'rsatish
    const pendingCount = await getPendingCount();
    if (pendingCount > 0) {
        showToast(`üìù ${pendingCount} ta sinxronlanmagan fuqaro bor`, 'info');
    }
});

window.addEventListener('online', updateOfflineIndicator);
window.addEventListener('offline', updateOfflineIndicator);
</script>

</body>
</html>
